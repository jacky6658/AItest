<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>AI短影音顧問｜AIJob智能</title>
  <style>
    :root{
      --primary:#2563eb; --primary-600:#1d4ed8;
      --bg:#ffffff; --muted:#f5f7fb; --border:#e6e8ef;
      --text:#0f172a; --text-muted:#64748b;
      --ok:#16a34a; --err:#dc2626; --shadow:0 6px 18px rgba(2,12,27,0.08);
      --radius:14px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC, Helvetica Neue, Arial;
      background:var(--bg); color:var(--text); line-height:1.6; font-size:16px;
      -webkit-text-size-adjust:100%;
      touch-action:manipulation;
    }
    a{ color:var(--primary); text-decoration:none; }
    .container{ max-width:1200px; margin:0 auto; padding:16px; }

    /* ========= Topbar ========= */
    .topbar{ position:sticky; top:0; z-index:50; background:rgba(255,255,255,0.9); backdrop-filter:saturate(180%) blur(8px); border-bottom:1px solid var(--border); }
    .topbar-inner{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 16px; flex-wrap:wrap; }
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:800;
      margin:0 auto;                 /* 置中 */
      font-size:20px;                /* 放大一點 */
    }
    .brand .logo{ width:22px; height:22px; border-radius:4px; object-fit:cover; box-shadow:0 0 0 3px rgba(37,99,235,0.15); }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-inline:auto; }
    .tab{ padding:8px 12px; border:1px solid var(--border); border-radius:999px; background:#fff; color:var(--text); cursor:pointer; transition:all .15s; font-weight:600; font-size:14px; }
    .tab.active{ background:var(--primary); border-color:var(--primary); color:#fff; box-shadow:var(--shadow); }

    /* ========= Cards / Panels ========= */
    .hero{ display:grid; grid-template-columns:1fr; gap:16px; padding:20px 16px; }
    .hero-title{ font-size:28px; font-weight:800; letter-spacing:.2px; }
    .hero-sub{ color:var(--text-muted); margin-top:4px; }
    .grid-cards{ display:grid; grid-template-columns:1fr; gap:16px; margin-top:20px; }
    .card{ background:linear-gradient(180deg,#fff,#f9fbff); border:1px solid var(--border); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow); display:flex; flex-direction:column; gap:12px; min-height:160px; }
    .card h3{ margin:0; font-size:20px; }
    .card p{ margin:0; color:var(--text-muted); }
    .card .actions{ margin-top:auto; display:flex; gap:10px; }

    .layout{ display:grid; grid-template-columns:7fr 5fr; gap:16px; padding:16px; }
    .panel{ background:#fff; border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; }
    .panel-head{ padding:12px 14px; border-bottom:1px solid var(--border); display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; }
    .panel-title{ font-weight:800; display:flex; align-items:center; gap:8px; }

    /* 設定區 */
    .settings{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .settings .field{ display:flex; align-items:center; gap:6px; background:var(--muted); border:1px solid var(--border); border-radius:10px; padding:6px 8px; }
    .settings input[type="text"], .settings select, .settings input[type="number"]{ border:none; background:transparent; outline:none; padding:4px; min-width:90px; font-size:16px; }
    .settings .check{ display:flex; align-items:center; gap:6px; }
    .settings.collapsed{ display:none; }
    .toggle-settings{ margin-left:auto; border:1px solid var(--border); background:#fff; padding:6px 10px; border-radius:10px; cursor:pointer; font-weight:700; font-size:13px; display:inline-flex; align-items:center; gap:6px; }
    .toggle-settings:hover{ box-shadow:var(--shadow); }
    .chev{ display:inline-block; transition:transform .2s ease; }
    .toggle-settings[aria-expanded="false"] .chev{ transform:rotate(-90deg); }

    /* Chat */
    .chat-wrap{ display:flex; flex-direction:column; height:62vh; }
    .chat-scroll{ flex:1; overflow:auto; padding:14px; display:flex; flex-direction:column; gap:10px; background:var(--muted); }
    .msg{ max-width:80%; padding:10px 12px; border-radius:14px; border:1px solid var(--border); background:#fff; box-shadow:var(--shadow); }
    .msg.user{ margin-left:auto; background:#eef4ff; border-color:#dbe6ff; }
    .msg .meta{ font-size:12px; color:var(--text-muted); margin-bottom:4px; }
    .inputbar{ display:flex; gap:8px; padding:10px; border-top:1px solid var(--border); background:#fff; }
    textarea{ flex:1; resize:none; border:1px solid var(--border); border-radius:12px; padding:10px 12px; min-height:46px; max-height:160px; font-size:16px; line-height:1.5; }

    .right-wrap{ display:flex; flex-direction:column; height:62vh; }
    .right-scroll{ flex:1; overflow:auto; padding:14px; display:flex; flex-direction:column; gap:10px; background:var(--muted); }
    .toolbar{ display:flex; gap:8px; padding:10px; border-top:1px solid var(--border); background:#fff; flex-wrap:wrap; }

    .segment-card{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px; box-shadow:var(--shadow); }
    .segment-head{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:6px; }
    .seg-title{ font-weight:700; }
    .seg-meta{ color:var(--text-muted); font-size:13px; }
    .seg-actions{ display:flex; gap:6px; }

    .timeline{ border:1px dashed var(--border); border-radius:12px; padding:12px; background:#fff; }
    .timeline-item{ display:flex; justify-content:space-between; gap:12px; padding:8px 0; border-bottom:1px solid var(--border); }
    .timeline-item:last-child{ border-bottom:none; }

    .copy-card{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px; box-shadow:var(--shadow); }
    .copy-card h4{ margin:4px 0 8px; }
    .muted{ color:var(--text-muted); font-size:14px; }

    .chips{ display:flex; gap:8px; flex-wrap:wrap; padding:10px 14px; border-top:1px solid var(--border); background:#fff; }
    .chip{ padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#fff; cursor:pointer; font-size:13px; }
    .chip:hover{ border-color:var(--primary); color:var(--primary); }

    .btn{ padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:#fff; cursor:pointer; font-weight:700; font-size:15px; display:inline-flex; align-items:center; gap:6px; transition:all .15s; min-height:42px; }
    .btn:hover{ transform:translateY(-1px); box-shadow:var(--shadow); }
    .btn.primary{ background:var(--primary); border-color:var(--primary); color:#fff; }
    .btn.primary:disabled{ opacity:.6; cursor:not-allowed; }
    .btn.ghost{ background:transparent; }
    .btn.ok{ background:var(--ok); border-color:var(--ok); color:#fff; }
    .btn.err{ background:var(--err); border-color:var(--err); color:#fff; }
    .btn.small{ padding:8px 10px; font-size:14px; min-height:38px; }

    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:20px; background:#111827; color:#fff; padding:10px 14px; border-radius:10px; font-size:14px; box-shadow:var(--shadow); opacity:0; pointer-events:none; transition:opacity .25s; z-index:100; }
    .toast.show{ opacity:1; }

    /* 手機工具列：改為 .show 才顯示（首頁/指南不顯示） */
    .drawer{ position:fixed; left:0; right:0; bottom:0; background:#fff; border-top:1px solid var(--border); padding:10px; display:none; gap:8px; z-index:45; }
    .drawer.show{ display:flex; flex-wrap:wrap; }

    .site-footer{ border-top:1px solid var(--border); margin-top:24px; background:#fff; }
    .copyright{ color:var(--text-muted); font-size:14px; padding:12px 0 16px; text-align:center; } /* 置中 */

    @media (min-width:880px){ .grid-cards{ grid-template-columns:repeat(2,1fr); } }
    @media (min-width:1200px){ .hero-title{ font-size:32px; } }
    @media (max-width:1199px){ .layout{ grid-template-columns:1fr; } }
    @media (max-width:767px){
      .btn{ min-height:44px; }
      .btn.small{ min-height:40px; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner container">
      <div class="brand">
        <img class="logo" alt="AIJob logo" src="https://static.wixstatic.com/media/9705bb_4edf6b22c58f4275bc9bae42891acb49~mv2.png"/>
        AI短影音顧問｜AIJob智能
      </div>
      <div class="tabs">
        <button class="tab active" data-page="home">首頁</button>
        <button class="tab" data-page="script">腳本模式</button>
        <button class="tab" data-page="copy">文案模式</button>
        <button class="tab" data-page="guide">說明/指南</button>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-inline:auto">
        <button class="btn small ghost" id="btn-toggle-mock" title="切換本地模擬回應">Mock: Off</button>
      </div>
    </div>
  </div>

  <main id="page-home" class="container">
    <section class="hero">
      <div>
        <div class="hero-title">選擇你的任務</div>
        <div class="hero-sub">輸入主題→AI 推理行業爆款要素→與你對話共創。介面簡約、行動友善。</div>
      </div>

      <div class="grid-cards">
        <article class="card">
          <h3>與 AI 討論「腳本」</h3>
          <p>用對話快速修正：秒數時間軸＋對白＋畫面建議＋鏡位＋CTA；支援卡片檢視、時間軸與微調。</p>
          <div class="actions">
            <button class="btn primary" data-go="script">開始腳本模式</button>
            <button class="btn ghost" data-go="guide">看操作說明</button>
          </div>
        </article>

        <article class="card">
          <h3>與 AI 討論「文案」</h3>
          <p>產出主貼文、開頭金句、Hashtags 與 CTA；可一鍵複製，適合 IG／FB／LinkedIn／YouTube 說明文字。</p>
          <div class="actions">
            <button class="btn primary" data-go="copy">開始文案模式</button>
            <button class="btn ghost" data-go="guide">看操作說明</button>
          </div>
        </article>
      </div>

      <!-- 一鍵快速生成（demo） -->
      <details class="card" style="margin:0">
        <summary style="cursor:pointer; font-weight:700">⚡ 一鍵快速生成（展示用）</summary>
        <p style="margin:8px 0 0; color:#475569">
          想先看成果？用「一鍵快速生成」出一版草稿，再用上方模式微調。適合初次嘗試、需要快速丟給同事或客戶看的情境。
        </p>
        <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap">
          <input id="adv-input" type="text" placeholder="輸入一句需求（例：健身品牌 Reels 30 秒、強調活力）" style="flex:1; min-width:260px; padding:10px; border:1px solid var(--border); border-radius:10px" />
          <button class="btn" id="adv-run">一鍵產生腳本</button>
        </div>
        <pre id="adv-out" class="muted" style="white-space:pre-wrap; margin-top:10px"></pre>
      </details>
    </section>
  </main>

  <!-- 腳本頁 -->
  <section id="page-script" class="container" style="display:none">
    <div class="layout">
      <div class="panel">
        <div class="panel-head">
          <div class="panel-title">聊天協作（腳本）</div>
          <button class="toggle-settings" id="toggleSettingsScript" aria-expanded="false"><span class="chev">▾</span> ⚙️ 設定</button>
        </div>
        <div class="panel-head" id="settingsScriptWrap" style="border-top:0; border-bottom:1px solid var(--border);">
          <div class="settings collapsed" id="settingsScript">
            <div class="field"><span class="muted">user_id</span><input id="userId" type="text" /></div>
            <div class="field"><span class="muted">tone</span>
              <select id="toneSel"><option value="neutral">neutral</option><option>friendly</option><option>energetic</option><option>professional</option></select>
            </div>
            <div class="field"><span class="muted">lang</span>
              <select id="langSel"><option value="zh-TW">zh-TW</option><option value="zh-CN">zh-CN</option><option value="en">en</option></select>
            </div>
            <div class="field"><span class="muted">style</span>
              <select id="styleSel"><option value="concise">concise</option><option value="storytelling">storytelling</option><option value="educational">educational</option></select>
            </div>
            <div class="field"><span class="muted">max_len</span><input id="lenSel" type="number" min="200" max="2000" step="50" value="800" /></div>
            <label class="check"><input type="checkbox" id="rememberChk" /> 記住</label>
            <button class="btn small" id="btn-save-prefs">更新偏好</button>
          </div>
        </div>

        <div class="chat-wrap">
          <div id="chatScript" class="chat-scroll"></div>
          <div class="chips" id="chipsScript">
            <span class="muted">快速模板：</span>
            <button class="chip" data-insert="行業: 電商｜平台: Reels｜時長: 30秒｜目標: 購買｜主題: 夏季新品開箱">電商·30秒·購買</button>
            <button class="chip" data-insert="行業: 餐飲｜平台: TikTok｜時長: 15秒｜目標: 導流｜主題: 招牌菜賣點">餐飲·15秒·導流</button>
            <button class="chip" data-insert="行業: 教育｜平台: Shorts｜時長: 60秒｜目標: 品牌記憶｜主題: 課程亮點">教育·60秒·品牌</button>
          </div>
          <div class="inputbar">
            <textarea id="inputScript" placeholder="輸入主題/目標/受眾/平台/時長/語氣…（Enter 送出，Shift+Enter 換行）"></textarea>
            <button class="btn primary" id="sendScript">送出</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-head">
          <div class="panel-title">腳本分段 / 時間軸</div>
          <div class="settings" style="gap:8px">
            <button class="btn small" id="copyAllScript">複製全部</button>
            <button class="btn small" id="clearScript">清空</button>
            <button class="btn small ok" id="thumbUpScript">👍</button>
            <button class="btn small err" id="thumbDownScript">👎</button>
          </div>
        </div>
        <div class="right-wrap">
          <div id="segmentsWrap" class="right-scroll"></div>
          <div class="toolbar">
            <button class="btn" id="buildTimeline">生成時間軸</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- 文案頁 -->
  <section id="page-copy" class="container" style="display:none">
    <div class="layout">
      <div class="panel">
        <div class="panel-head">
          <div class="panel-title">聊天協作（文案）</div>
          <button class="toggle-settings" id="toggleSettingsCopy" aria-expanded="false"><span class="chev">▾</span> ⚙️ 設定</button>
        </div>
        <div class="panel-head" id="settingsCopyWrap" style="border-top:0; border-bottom:1px solid var(--border);">
          <div class="settings collapsed" id="settingsCopy">
            <div class="field"><span class="muted">user_id</span><input id="userId2" type="text" /></div>
            <div class="field"><span class="muted">tone</span>
              <select id="toneSel2"><option value="neutral">neutral</option><option>friendly</option><option>energetic</option><option>professional</option></select>
            </div>
            <div class="field"><span class="muted">lang</span>
              <select id="langSel2"><option value="zh-TW">zh-TW</option><option value="zh-CN">zh-CN</option><option value="en">en</option></select>
            </div>
            <div class="field"><span class="muted">style</span>
              <select id="styleSel2"><option value="concise">concise</option><option value="storytelling">storytelling</option><option value="educational">educational</option></select>
            </div>
            <div class="field"><span class="muted">max_len</span><input id="lenSel2" type="number" min="200" max="2000" step="50" value="600" /></div>
            <label class="check"><input type="checkbox" id="rememberChk2" /> 記住</label>
            <button class="btn small" id="btn-save-prefs2">更新偏好</button>
          </div>
        </div>

        <div class="chat-wrap">
          <div id="chatCopy" class="chat-scroll"></div>
          <div class="chips" id="chipsCopy">
            <span class="muted">快速模板：</span>
            <button class="chip" data-insert="主題: 入魂馬卡嗆嗆錠｜受眾: 男性視角｜平台: IG｜語氣: 活力｜CTA: 追蹤 + 點連結">健身·IG·品牌</button>
            <button class="chip" data-insert="主題: 週末輕旅行｜受眾: 年輕族群｜平台: TikTok｜語氣: 輕快｜CTA: 看更多行程">旅遊·TikTok·導流</button>
            <button class="chip" data-insert="主題: SaaS 白皮書｜受眾: 企業決策者｜平台: LinkedIn｜語氣: 專業｜CTA: 下載白皮書">B2B SaaS·LinkedIn·Leads</button>
          </div>
          <div style="display:flex; gap:8px; padding:8px 10px; border-top:1px solid var(--border); background:#fff; align-items:center;">
            <input id="topicCopy" placeholder="主題（產品/服務/活動名稱，例如：入魂馬卡嗆嗆錠）" style="flex:1; padding:10px; border:1px solid var(--border); border-radius:12px; font-size:16px;" />
          </div>
          <div class="inputbar">
            <textarea id="inputCopy" placeholder="輸入受眾/平台/語氣/CTA…（Enter 送出，Shift+Enter 換行）"></textarea>
            <button class="btn primary" id="sendCopy">送出</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-head">
          <div class="panel-title">文案模組</div>
          <div class="settings" style="gap:8px">
            <button class="btn small" id="copyAllCopy">複製全部</button>
            <button class="btn small" id="clearCopy">清空</button>
            <button class="btn small ok" id="thumbUpCopy">👍</button>
            <button class="btn small err" id="thumbDownCopy">👎</button>
          </div>
        </div>
        <div class="right-wrap">
          <div id="copyWrap" class="right-scroll"></div>
          <div class="toolbar"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- 說明/指南 -->
  <section id="page-guide" class="container" style="display:none; padding-top:16px">
    <article class="card" style="margin-bottom:12px">
      <h3>🧠 兩種模式的用途</h3>
      <p>依你的需求選擇「腳本模式」或「文案模式」。兩者都能用對話微調，越聊越準。</p>
    </article>

    <article class="card" style="margin-bottom:12px">
      <h3>📜 腳本模式</h3>
      <p><b>適合</b>想製作【Reels／短影音腳本】的使用者。輸入主題、受眾、目標（導流／銷售／品牌曝光），系統會自動生成：</p>
      <ul>
        <li>🎤 可直接對鏡頭念的【對白】</li>
        <li>📽 對應的【畫面建議】</li>
        <li>🧱 按照時間區間分段（開場 Hook → 主體 → 收尾 CTA）</li>
      </ul>
    </article>

    <article class="card" style="margin-bottom:12px">
      <h3>✍️ 文案模式</h3>
      <p><b>適合</b>想產出【貼文／簡介／行銷文案】的使用者。輸入主題與需求，系統會幫你生成：</p>
      <ul>
        <li>📢 貼文主文／開頭金句</li>
        <li>🧠 段落架構（引起興趣 → 說明價值 → 行動呼籲）</li>
        <li>📝 適合搭配 IG／FB／LinkedIn／YouTube Shorts 的說明文字</li>
      </ul>
    </article>

    <article class="card" style="margin-bottom:12px">
      <h3>🪄 使用小技巧</h3>
      <ul>
        <li>🎯 目標：導流／銷售／品牌曝光</li>
        <li>🧑‍🤝‍🧑 受眾：你要對誰說話</li>
        <li>📝 主題或商品</li>
        <li>⏱ 時長或篇幅（例：30 秒 Reels、60 秒教學片）</li>
      </ul>
      <p>想要更多段落或細節，可在主題後加上提示，例如：「請產出三段主體內容」、「畫面描述要更豐富」。</p>
    </article>

    <article class="card">
      <h3>🧰 Mock 模式（右上角「Mock: Off」按鈕）</h3>
      <ul>
        <li>當後端暫時不可用、或你離線展示時，點一下切換為 <b>Mock: On</b>，系統會用示範資料回應。</li>
        <li>再次點擊可關閉，回到真實後端。</li>
        <li>提示：Mock 僅供測試展示，不會把資料寫入你的資料庫。</li>
      </ul>
    </article>
  </section>

  <!-- 手機底部工具列（僅在腳本/文案頁顯示時以 .show 開啟） -->
  <div class="drawer" id="drawer">
    <button class="btn small" data-act="copyAll">複製全部</button>
    <button class="btn small" data-act="clear">清空</button>
    <button class="btn small ok" data-act="up">👍</button>
    <button class="btn small err" data-act="down">👎</button>
  </div>

  <footer class="site-footer">
    <div class="container">
      <div class="copyright">© 2025 AIJobSchool 版權所有</div>
    </div>
  </footer>

  <div id="toast" class="toast">已複製</div>

<script>
  const API_BASE = 'https://aijobvideobackend.zeabur.app';
  const DEFAULT_USER_ID = `web-${Math.random().toString(36).slice(2,8)}`;
  let MOCK_MODE = false;

  const state = {
    sessionIdScript:'', sessionIdCopy:'', userId: DEFAULT_USER_ID,
    messagesScript:[], messagesCopy:[], segments:[], copy:null,
  };

  const $ = sel=>document.querySelector(sel);
  const $$ = sel=>document.querySelectorAll(sel);
  const drawer = $('#drawer');

  function fmtTS(d=new Date()){ const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`; }
  function showToast(m){ const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1500); }
  function copyText(s){ navigator.clipboard.writeText(s).then(()=>showToast('已複製')); }
  const val = sel=>$(sel).value;

  /* ====== API（含 Mock） ====== */
  async function apiChatGenerate(payload){
    if(MOCK_MODE){
      const last = payload.messages[payload.messages.length-1]?.content || '';
      const isCopy = payload.mode==='copy';
      await new Promise(r=>setTimeout(r,400));
      if(isCopy){
        return {
          session_id: payload.session_id || 'mock-copy',
          assistant_message: '這是模擬文案：已依你的需求產生初稿。',
          segments:[],
          copy:{
            main_copy:`主貼文：${payload.topic ? `【${payload.topic}】` : ''}${last}\n精神回歸！⚡️ 今天就行動！`,
            alternates:['🔥 今天就開始','💡 其實只要這樣做','👉 你也可以'],
            hashtags:['#行銷','#AI','#文案','#社群經營'],
            cta:'立即點連結 🔗'
          }
        };
      }else{
        return {
          session_id: payload.session_id || 'mock-script',
          assistant_message:'這是模擬腳本：初稿完成。',
          segments:[
            { start_sec:0, end_sec:5, type:'hook', camera:'CU', dialog:`開場鉤子：${last.slice(0,20)}…`, visual:'快切 B-roll + 動態字卡', cta:'' },
            { start_sec:5, end_sec:25, type:'value', camera:'MS', dialog:'三點賣點清單 + punch line', visual:'產品/數據圖/對比畫面', cta:'' },
            { start_sec:25, end_sec:30, type:'cta', camera:'WS', dialog:'口播 CTA', visual:'大字卡+Logo', cta:'點連結領取' }
          ],
          copy:null
        };
      }
    }
    const res = await fetch(`${API_BASE}/chat_generate`,{
      method:'POST', headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    const json = await res.json().catch(()=>({ error:'invalid_json' }));
    if(!res.ok) throw new Error(json?.assistant_message || json?.error || `HTTP ${res.status}`);
    return json;
  }

  async function apiUpdatePrefs({ user_id, prefs }){
    if(MOCK_MODE){ await new Promise(r=>setTimeout(r,150)); return { ok:true }; }
    const r = await fetch(`${API_BASE}/update_prefs`,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ user_id, prefs }) });
    if(!r.ok) throw new Error(`HTTP ${r.status}`); return r.json();
  }
  async function apiGenerateScript({ user_input, previous_segments }){
    if(MOCK_MODE){ await new Promise(r=>setTimeout(r,300)); return { segments:[{start_sec:0,end_sec:10,type:'hook',camera:'CU',dialog:'模擬舊流程片段',visual:'素材拼接',cta:''}] }; }
    const r = await fetch(`${API_BASE}/generate_script`,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ user_input, previous_segments }) });
    if(!r.ok) throw new Error(`HTTP ${r.status}`); return r.json();
  }

  /* ====== NAV：切換頁面 + 控制手機工具列顯示 ====== */
  const pages = ['home','script','copy','guide'];
  $$('.tab').forEach(b=>b.onclick=()=>goPage(b.dataset.page));
  $$('[data-go]').forEach(b=>b.onclick=()=>goPage(b.dataset.go));
  function goPage(name){
    pages.forEach(p=>{
      $(`#page-${p}`).style.display = (p===name)?'block':'none';
      document.querySelector(`.tab[data-page="${p}"]`).classList.toggle('active', p===name);
    });
    // 只有腳本/文案頁顯示手機工具列
    if(name==='script' || name==='copy'){ drawer.classList.add('show'); } else { drawer.classList.remove('show'); }
  }

  /* ====== 設定（預設隱藏） ====== */
  const userIdInput = $('#userId');
  const userIdInput2 = $('#userId2');
  userIdInput.value = state.userId; userIdInput2.value = state.userId;
  userIdInput.onchange = e=>{ state.userId = e.target.value || DEFAULT_USER_ID; userIdInput2.value = state.userId; };
  userIdInput2.onchange = e=>{ state.userId = e.target.value || DEFAULT_USER_ID; userIdInput.value = state.userId; };

  $('#btn-save-prefs').onclick = async()=>{
    const prefs = { tone:val('#toneSel'), language:val('#langSel'), writing_style:val('#styleSel'), max_length:parseInt(val('#lenSel')||800,10) };
    try{ await apiUpdatePrefs({ user_id: state.userId, prefs }); showToast('已更新偏好'); }catch(e){ showToast(`更新失敗：${e.message}`); }
  };
  $('#btn-save-prefs2').onclick = async()=>{
    const prefs = { tone:val('#toneSel2'), language:val('#langSel2'), writing_style:val('#styleSel2'), max_length:parseInt(val('#lenSel2')||600,10) };
    try{ await apiUpdatePrefs({ user_id: state.userId, prefs }); showToast('已更新偏好'); }catch(e){ showToast(`更新失敗：${e.message}`); }
  };

  function bindToggle(btnId, settingsId){
    const btn=$(btnId), box=$(settingsId);
    btn.addEventListener('click', ()=>{
      const ex = btn.getAttribute('aria-expanded')==='true';
      btn.setAttribute('aria-expanded', String(!ex));
      box.classList.toggle('collapsed');
    });
  }
  bindToggle('#toggleSettingsScript','#settingsScript');
  bindToggle('#toggleSettingsCopy','#settingsCopy');

  /* ====== 對話送出 ====== */
  const inputScript = $('#inputScript');
  const inputCopy   = $('#inputCopy');
  $('#sendScript').onclick = ()=>sendChat('script');
  $('#sendCopy').onclick   = ()=>sendChat('copy');
  inputScript.addEventListener('keydown',e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendChat('script'); } });
  inputCopy  .addEventListener('keydown',e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendChat('copy'); } });

  $('#chipsScript').onclick = e=>{ if(e.target.classList.contains('chip')){ inputScript.value = e.target.dataset.insert; inputScript.focus(); } };
  $('#chipsCopy').onclick   = e=>{ if(e.target.classList.contains('chip')){ inputCopy.value   = e.target.dataset.insert; inputCopy.focus(); } };

  /* ====== 渲染（略：與上一版一致） ====== */
  const chatScriptEl=$('#chatScript'); const chatCopyEl=$('#chatCopy');
  function appendMsg(el, role, content){
    const div=document.createElement('div'); div.className='msg ' + (role==='user'?'user':''); div.innerHTML=`<div class="meta">${role} · ${fmtTS()}</div><div>${escapeHTML(content)}</div>`; el.appendChild(div); el.scrollTop=el.scrollHeight;
  }
  function escapeHTML(s){ return (s||'').replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;"," >":"&gt;","\"":"&quot;"}[c])); }

  const segmentsWrap=$('#segmentsWrap');
  function renderSegments(){
    segmentsWrap.innerHTML='';
    if(!state.segments?.length){ const empty=document.createElement('div'); empty.className='segment-card muted'; empty.textContent='尚無片段。請輸入更具體的秒數/場景/目標。'; segmentsWrap.appendChild(empty); return; }
    state.segments.forEach((s,i)=>{
      if(s.start_sec==null||s.end_sec==null){ s.start_sec=i*6; s.end_sec=i*6+6; }
      const card=document.createElement('div'); card.className='segment-card';
      card.innerHTML = `
        <div class="segment-head">
          <div class="seg-title">#${i+1} ${s.type||'segment'} <span class="seg-meta">${s.start_sec}s–${s.end_sec}s · 鏡位 ${s.camera||'-'}</span></div>
          <div class="seg-actions">
            <button class="btn small" data-act="copy" data-idx="${i}">複製</button>
            <button class="btn small" data-act="tweak" data-idx="${i}">微調</button>
            <button class="btn small err" data-act="del" data-idx="${i}">刪除</button>
          </div>
        </div>
        <div class="muted">對白</div><div>${escapeHTML(s.dialog||'')}</div>
        <div class="muted" style="margin-top:6px">畫面感</div><div>${escapeHTML(s.visual||'')}</div>
        <div class="muted" style="margin-top:6px">CTA</div><div>${escapeHTML(s.cta||'')}</div>`;
      segmentsWrap.appendChild(card);
    });
  }
  segmentsWrap.onclick = e=>{
    const b=e.target.closest('button'); if(!b) return;
    const idx=+b.dataset.idx, seg=state.segments[idx];
    if(b.dataset.act==='copy'){ copyText(segmentToText(seg)); }
    if(b.dataset.act==='del'){ state.segments.splice(idx,1); renderSegments(); }
    if(b.dataset.act==='tweak'){
      const nd=prompt('微調對白（留空略過）',seg.dialog||''); if(nd!=null && nd!=='') seg.dialog=nd;
      const nv=prompt('微調畫面（留空略過）',seg.visual||''); if(nv!=null && nv!=='') seg.visual=nv;
      const nc=prompt('微調 CTA（留空略過）',seg.cta||''); if(nc!=null && nc!=='') seg.cta=nc;
      renderSegments();
    }
  };
  function segmentToText(s){ return `(${s.start_sec}s–${s.end_sec}s) [${s.type||'-'}] camera:${s.camera||'-'}\n台詞:${s.dialog||''}\n畫面:${s.visual||''}\nCTA:${s.cta||''}`; }

  const copyWrap=$('#copyWrap');
  function renderCopy(){
    copyWrap.innerHTML='';
    if(!state.copy){ const empty=document.createElement('div'); empty.className='copy-card muted'; empty.textContent='尚無文案。請描述平台/受眾/語氣/CTA，並填「主題」。'; copyWrap.appendChild(empty); return; }
    const { main_copy, alternates=[], hashtags=[], cta='' } = state.copy;
    const main=document.createElement('div'); main.className='copy-card';
    main.innerHTML=`<h4>主貼文</h4><pre style="white-space:pre-wrap">${(main_copy||'').replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]))}</pre><div class="seg-actions" style="margin-top:8px"><button class="btn small" id="cp-main">複製</button></div>`;
    const alt=document.createElement('div'); alt.className='copy-card'; alt.innerHTML=`<h4>備選開頭</h4><ul>${alternates.map(a=>`<li>${a}</li>`).join('')}</ul>`;
    const tag=document.createElement('div'); tag.className='copy-card'; tag.innerHTML=`<h4>Hashtags</h4><div>${hashtags.map(h=>`<span class="chip">${h}</span>`).join(' ')}</div>`;
    const ctaEl=document.createElement('div'); ctaEl.className='copy-card'; ctaEl.innerHTML=`<h4>CTA</h4><div>${cta}</div><div class="seg-actions" style="margin-top:8px"><button class="btn small" id="cp-all">複製全部</button></div>`;
    copyWrap.append(main,alt,tag,ctaEl);
    $('#cp-main').onclick=()=>copyText(main_copy||'');
    $('#cp-all').onclick =()=>copyText(copyToText(state.copy));
  }
  function copyToText(c){
    const out=[]; out.push('【主貼文】',c.main_copy||'','\n【備選開頭】'); (c.alternates||[]).forEach((a,i)=>out.push(`${i+1}. ${a}`));
    out.push('\n【Hashtags】',(c.hashtags||[]).join(' '),'\n【CTA】',c.cta||''); return out.join('\n');
  }

  // 清空/複製/回饋
  $('#copyAllScript').onclick=()=>{ if(!state.segments?.length) return showToast('無可複製內容'); copyText(state.segments.map(segmentToText).join('\n\n')); };
  $('#clearScript').onclick =()=>{ state.segments=[]; renderSegments(); };
  $('#thumbUpScript').onclick =()=>doFeedback('thumbs_up');
  $('#thumbDownScript').onclick=()=>doFeedback('thumbs_down');
  $('#copyAllCopy').onclick =()=>{ if(!state.copy) return showToast('無可複製內容'); copyText(copyToText(state.copy)); };
  $('#clearCopy').onclick   =()=>{ state.copy=null; renderCopy(); };
  $('#thumbUpCopy').onclick =()=>doFeedback('thumbs_up');
  $('#thumbDownCopy').onclick=()=>doFeedback('thumbs_down');
  async function doFeedback(kind){ showToast('已送出回饋'); }

  // 手機抽屜
  drawer.onclick = e=>{
    const act=e.target?.dataset?.act; if(!act) return;
    const inCopy=$('#page-copy').style.display==='block';
    if(act==='copyAll') (inCopy?$('#copyAllCopy'):$('#copyAllScript')).click();
    if(act==='clear')   (inCopy?$('#clearCopy'):$('#clearScript')).click();
    if(act==='up') doFeedback('thumbs_up');
    if(act==='down') doFeedback('thumbs_down');
  };

  // 發送聊天
  async function sendChat(which){
    const isScript = (which==='script');
    const input = isScript ? $('#inputScript') : $('#inputCopy');
    const chatEl = isScript ? $('#chatScript') : $('#chatCopy');
    const remember = isScript ? $('#rememberChk').checked : $('#rememberChk2').checked;
    const text = (input.value||'').trim(); if(!text) return showToast('請先輸入內容');

    (isScript?state.messagesScript:state.messagesCopy).push({ role:'user', content:text, ts:Date.now() });
    appendMsg(chatEl,'user',text);
    input.value='';

    const messages = (isScript?state.messagesScript:state.messagesCopy).slice(-20).map(m=>({ role:m.role, content:m.content }));
    const btn = isScript? $('#sendScript') : $('#sendCopy');
    const old = btn.textContent; btn.disabled=true; btn.textContent='生成中…';

    const payload = {
      user_id: state.userId,
      session_id: isScript ? state.sessionIdScript : state.sessionIdCopy,
      mode: isScript ? 'script' : 'copy',
      topic: (!isScript ? ($('#topicCopy').value||'').trim() : undefined),
      messages,
      previous_segments: isScript ? (state.segments||[]) : [],
      remember
    };

    try{
      const resp = await apiChatGenerate(payload);
      if(isScript) state.sessionIdScript = resp.session_id || state.sessionIdScript;
      else         state.sessionIdCopy   = resp.session_id || state.sessionIdCopy;

      const assistant = resp.assistant_message || '(無回覆)';
      (isScript?state.messagesScript:state.messagesCopy).push({ role:'assistant', content:assistant, ts:Date.now() });
      appendMsg(chatEl,'assistant',assistant);

      if(Array.isArray(resp.segments)) { state.segments = resp.segments; renderSegments(); }
      if(resp.copy){ state.copy = resp.copy; renderCopy(); }
    }catch(e){
      appendMsg(chatEl,'assistant',`❌ 錯誤：${e.message}`);
      showToast(`發生錯誤：${e.message}`);
    }finally{
      btn.disabled=false; btn.textContent=old;
    }
  }

  // 一鍵快速生成（示範）
  $('#adv-run').onclick = async()=>{
    const out=$('#adv-out');
    const text=$('#adv-input').value.trim(); if(!text) return;
    out.textContent='生成中…';
    try{
      const r=await apiGenerateScript({ user_input:text, previous_segments: state.segments });
      out.textContent=JSON.stringify(r,null,2);
      if(r.segments){ state.segments=r.segments; renderSegments(); }
    }catch(e){ out.textContent=`錯誤：${e.message}`; }
  };

  // Mock 切換
  const mockBtn=$('#btn-toggle-mock');
  mockBtn.onclick=()=>{ MOCK_MODE=!MOCK_MODE; mockBtn.textContent=`Mock: ${MOCK_MODE?'On':'Off'}`; showToast(`Mock ${MOCK_MODE?'已開啟':'已關閉'}`); };

  // 初始：首頁不顯示手機工具列
  renderSegments(); renderCopy();
</script>
</body>
</html>
