<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AIçŸ­å½±éŸ³é¡§å•ï½œAIJobæ™ºèƒ½</title>
  <!--
  READMEï¼ˆå…§åµŒæ–¼æª”é ­è¨»è§£ï¼‰
  ==============================================
  æœ¬æª”ç‚ºã€ŒçŸ­å½±éŸ³é¡§å• AIã€å–®æª”å‰ç«¯ï¼ˆindex.htmlï¼‰ï¼Œå¯ç›´æ¥é–‹å•Ÿã€‚

  â–¶ ä¸€éµåˆ‡æ›å¾Œç«¯ï¼šè«‹ä¿®æ”¹æª”æ¡ˆé ‚éƒ¨çš„ const API_BASEã€‚
     - é è¨­ç‚º https://aijobvideobackend.zeabur.app

  â–¶ Mock é–‹é—œï¼šå°‡ const MOCK_MODE è¨­ç‚º true å¯å•Ÿç”¨æœ¬åœ°æ¨¡æ“¬å›æ‡‰ï¼ˆé›¢ç·šæˆ–å¾Œç«¯æœªå°±ç·’æ™‚æ¸¬è©¦ï¼‰ã€‚

  â–¶ åŒ¯å‡º Wordï¼šé»å³ä¸Šå·¥å…·åˆ—ã€ŒåŒ¯å‡º Wordã€ï¼›æœƒå°‡ã€å°è©±ç´€éŒ„ã€‘+ã€ç•¶å‰ç”¢ç‰©ï¼ˆè…³æœ¬/æ–‡æ¡ˆï¼‰ã€‘ä¸€èµ·è¼¸å‡ºæˆ .docxã€‚

  â–¶ API å€ï¼ˆå‹¿æ”¹ï¼‰èˆ‡ UI å€ï¼ˆå¯æ”¹ï¼‰ï¼šç¨‹å¼ç¢¼å…§ä»¥æ˜ç¢ºè¨»è§£åˆ†ç•Œã€‚

  â–¶ éµç›¤æ“ä½œï¼šEnter é€å‡ºã€Shift+Enter æ›è¡Œã€‚

  â–¶ RWDï¼š
     - â‰¥1200pxï¼šå·¦å³ 7/5 æ¬„
     - 768â€“1199pxï¼šä¸Šä¸‹å †ç–Šï¼ˆä¸Šï¼šèŠå¤©ï¼Œä¸‹ï¼šçµæœï¼‰
     - <768pxï¼šå–®æ¬„ï¼Œå·¥å…·åˆ—æ”¶åˆç‚ºåº•éƒ¨æŠ½å±œ

  â–¶ å¾Œç«¯ APIï¼ˆä¸å¯è®Šæ›´ï¼‰ï¼š
     POST /chat_generate (Body: { user_id?, session_id?, messages:[{role,content}], previous_segments?, remember? })
     POST /feedback      (Body: { user_id?, kind:"thumbs_up"|"thumbs_down", note? })
     POST /update_prefs  (Body: { user_id?, prefs:{ tone?, language?, writing_style?, max_length? } })
     POST /generate_script(Body: { user_input, previous_segments })

  ==============================================
  -->
  <style>
    /* === åŸºæœ¬ä¸»é¡Œè®Šæ•¸ï¼ˆå¯æ”¹ï¼‰ === */
    :root{
      --primary:#2563eb;   /* ä¸»è‰²ï¼šè— */
      --primary-600:#1d4ed8;
      --bg:#ffffff;        /* èƒŒæ™¯ */
      --muted:#f5f7fb;     /* æŸ”å’Œåº• */
      --border:#e6e8ef;    /* åˆ†å‰²ç·š */
      --text:#0f172a;      /* ä¸»è¦å­—è‰² */
      --text-muted:#64748b;/* æ¬¡è¦å­—è‰² */
      --ok:#16a34a;        /* æˆåŠŸ */
      --err:#dc2626;       /* éŒ¯èª¤ */
      --shadow:0 6px 18px rgba(2,12,27,0.08);
      --radius:14px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background:var(--bg); color:var(--text); line-height:1.6; font-size:16px;
    }
    a{ color:var(--primary); text-decoration:none; }
    .container{ max-width:1200px; margin:0 auto; padding:16px; }

    /* === é ‚éƒ¨å°è¦½ === */
    .topbar{
      position:sticky; top:0; z-index:50; background:rgba(255,255,255,0.9); backdrop-filter:saturate(180%) blur(8px);
      border-bottom:1px solid var(--border);
    }
    .topbar-inner{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 16px; }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:700; }
    .brand .dot{ width:10px; height:10px; background:var(--primary); border-radius:50%; box-shadow:0 0 0 4px rgba(37,99,235,0.2); }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .tab{
      padding:8px 12px; border:1px solid var(--border); border-radius:999px; background:#fff; color:var(--text);
      cursor:pointer; transition:all .15s; font-weight:600; font-size:14px;
    }
    .tab.active{ background:var(--primary); border-color:var(--primary); color:#fff; box-shadow:var(--shadow); }

    /* === é¦–é å¡ç‰‡ === */
    .hero{ display:grid; grid-template-columns:1fr; gap:16px; padding:20px 16px; }
    .hero-title{ font-size:28px; font-weight:800; letter-spacing:.2px; }
    .hero-sub{ color:var(--text-muted); margin-top:4px; }
    .grid-cards{ display:grid; grid-template-columns:1fr; gap:16px; margin-top:20px; }
    .card{
      background:linear-gradient(180deg,#fff, #f9fbff); border:1px solid var(--border); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow);
      display:flex; flex-direction:column; gap:12px; min-height:160px;
    }
    .card h3{ margin:0; font-size:20px; }
    .card p{ margin:0; color:var(--text-muted); }
    .card .actions{ margin-top:auto; display:flex; gap:10px; }

    /* === ä¸»ç‰ˆé¢ === */
    .layout{
      display:grid; grid-template-columns:7fr 5fr; gap:16px; padding:16px;
    }
    .panel{ background:#fff; border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; }
    .panel-head{
      padding:12px 14px; border-bottom:1px solid var(--border);
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
    }
    .panel-title{ font-weight:800; display:flex; align-items:center; gap:8px; }

    /* è¨­å®šå€ï¼ˆå·¦ä¸Šï¼‰ */
    .settings{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .settings .field{ display:flex; align-items:center; gap:6px; background:var(--muted); border:1px solid var(--border); border-radius:10px; padding:6px 8px; }
    .settings input[type="text"], .settings select, .settings input[type="number"]{
      border:none; background:transparent; outline:none; padding:4px; min-width:90px; font-size:14px;
    }
    .settings .check{ display:flex; align-items:center; gap:6px; }
    .settings.collapsed{ display:none; }  /* â† å¯éš±è— */

    /* è¨­å®šåˆ‡æ›æŒ‰éˆ• */
    .toggle-settings{
      margin-left:auto;
      border:1px solid var(--border);
      background:#fff;
      padding:6px 10px; border-radius:10px; cursor:pointer; font-weight:700; font-size:13px;
      display:inline-flex; align-items:center; gap:6px;
    }
    .toggle-settings:hover{ box-shadow:var(--shadow); }
    .chev{ display:inline-block; transition:transform .2s ease; }
    .toggle-settings[aria-expanded="false"] .chev{ transform:rotate(-90deg); }

    /* å°è©±å€ */
    .chat-wrap{ display:flex; flex-direction:column; height:62vh; }
    .chat-scroll{ flex:1; overflow:auto; padding:14px; display:flex; flex-direction:column; gap:10px; background:var(--muted); }
    .msg{ max-width:80%; padding:10px 12px; border-radius:14px; border:1px solid var(--border); background:#fff; box-shadow:var(--shadow); }
    .msg.user{ margin-left:auto; background:#eef4ff; border-color:#dbe6ff; }
    .msg .meta{ font-size:12px; color:var(--text-muted); margin-bottom:4px; }
    .inputbar{ display:flex; gap:8px; padding:10px; border-top:1px solid var(--border); background:#fff; }
    textarea{ flex:1; resize:none; border:1px solid var(--border); border-radius:12px; padding:10px 12px; min-height:46px; max-height:160px; font-size:15px; line-height:1.5; }

    /* å³å´çµæœï¼šè…³æœ¬å¡èˆ‡æ™‚é–“è»¸ */
    .right-wrap{ display:flex; flex-direction:column; height:62vh; }
    .right-scroll{ flex:1; overflow:auto; padding:14px; display:flex; flex-direction:column; gap:10px; background:var(--muted); }
    .toolbar{ display:flex; gap:8px; padding:10px; border-top:1px solid var(--border); background:#fff; flex-wrap:wrap; }

    .segment-card{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px; box-shadow:var(--shadow); }
    .segment-head{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:6px; }
    .seg-title{ font-weight:700; }
    .seg-meta{ color:var(--text-muted); font-size:13px; }
    .seg-actions{ display:flex; gap:6px; }
    .timeline{ border:1px dashed var(--border); border-radius:12px; padding:12px; background:#fff; }
    .timeline-item{ display:flex; justify-content:space-between; gap:12px; padding:8px 0; border-bottom:1px solid var(--border); }
    .timeline-item:last-child{ border-bottom:none; }

    /* æ–‡æ¡ˆå¡ */
    .copy-card{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px; box-shadow:var(--shadow); }
    .copy-card h4{ margin:4px 0 8px; }
    .muted{ color:var(--text-muted); font-size:14px; }

    /* å»ºè­° chips */
    .chips{ display:flex; gap:8px; flex-wrap:wrap; padding:10px 14px; border-top:1px solid var(--border); background:#fff; }
    .chip{ padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#fff; cursor:pointer; font-size:13px; }
    .chip:hover{ border-color:var(--primary); color:var(--primary); }

    /* æŒ‰éˆ•æ¨£å¼ */
    .btn{ 
      padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:#fff; cursor:pointer; font-weight:700; font-size:14px; display:inline-flex; align-items:center; gap:6px; transition:all .15s; 
    }
    .btn:hover{ transform:translateY(-1px); box-shadow:var(--shadow); }
    .btn.primary{ background:var(--primary); border-color:var(--primary); color:#fff; }
    .btn.primary:disabled{ opacity:.6; cursor:not-allowed; }
    .btn.ghost{ background:transparent; }
    .btn.ok{ background:var(--ok); border-color:var(--ok); color:#fff; }
    .btn.err{ background:var(--err); border-color:var(--err); color:#fff; }
    .btn.small{ padding:6px 8px; font-size:13px; }

    /* Toast */
    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:20px; background:#111827; color:#fff; padding:10px 14px; border-radius:10px; font-size:14px; box-shadow:var(--shadow); opacity:0; pointer-events:none; transition:opacity .25s; z-index:100; }
    .toast.show{ opacity:1; }

    /* åº•éƒ¨æŠ½å±œï¼ˆæ‰‹æ©Ÿå·¥å…·åˆ—ï¼‰ */
    .drawer{ position:fixed; left:0; right:0; bottom:0; background:#fff; border-top:1px solid var(--border); padding:10px; display:none; gap:8px; z-index:45; }

    /* é€²éšå€ï¼ˆèˆŠæµç¨‹ï¼‰ */
    details.adv{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:10px 12px; }
    details.adv summary{ cursor:pointer; font-weight:700; }

    /* RWD */
    @media (min-width: 880px){ .grid-cards{ grid-template-columns: repeat(2,1fr); } }
    @media (min-width: 1200px){ .hero-title{ font-size:32px; } }
    @media (max-width: 1199px){ .layout{ grid-template-columns: 1fr; } }
    @media (max-width: 767px){ 
      .topbar-inner{ flex-direction:column; align-items:flex-start; gap:6px; }
      .chat-wrap,.right-wrap{ height:auto; max-height:64vh; }
      .drawer{ display:flex; flex-wrap:wrap; }
      .toolbar{ display:none; }
      .settings{ gap:6px; }
    }
  </style>
  <!-- åŒ¯å‡º Word éœ€è¦çš„å¥—ä»¶ -->
  <script src="https://unpkg.com/docx@8.1.4/build/index.js"></script>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner container">
      <div class="brand"><span class="dot"></span>AIçŸ­å½±éŸ³é¡§å•ï½œAIJobæ™ºèƒ½</div>
      <div class="tabs">
        <button class="tab active" data-page="home">é¦–é </button>
        <button class="tab" data-page="script">è…³æœ¬æ¨¡å¼</button>
        <button class="tab" data-page="copy">æ–‡æ¡ˆæ¨¡å¼</button>
        <button class="tab" data-page="guide">èªªæ˜/æŒ‡å—</button>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn small" id="btn-export">åŒ¯å‡º Word</button>
        <button class="btn small ghost" id="btn-toggle-mock" title="åˆ‡æ›æœ¬åœ°æ¨¡æ“¬å›æ‡‰">Mock: Off</button>
      </div>
    </div>
  </div>

  <main id="page-home" class="container">
    <section class="hero">
      <div>
        <div class="hero-title">é¸æ“‡ä½ çš„ä»»å‹™</div>
        <div class="hero-sub">è¼¸å…¥ä¸»é¡Œâ†’AI æ¨ç†è¡Œæ¥­çˆ†æ¬¾è¦ç´ â†’èˆ‡ä½ å°è©±å…±å‰µã€‚ä»‹é¢ç°¡ç´„ã€è¡Œå‹•å‹å–„ã€‚</div>
      </div>
      <div class="grid-cards">
        <article class="card">
          <h3>ç”Ÿæˆã€Œè…³æœ¬ã€</h3>
          <p>æ™‚é–“è»¸ï¼ˆç§’æ•¸ï¼‰ï¼‹å°è©ï¼‹ç•«é¢æ„Ÿï¼‹é¡ä½ cameraï¼‹CTAã€‚æ”¯æ´å¡ç‰‡ã€æ™‚é–“è»¸æª¢è¦–èˆ‡å¾®èª¿ã€‚</p>
          <div class="actions">
            <button class="btn primary" data-go="script">é–‹å§‹è…³æœ¬æ¨¡å¼</button>
            <button class="btn ghost" data-go="guide">çœ‹æ“ä½œèªªæ˜</button>
          </div>
        </article>
        <article class="card">
          <h3>ç”Ÿæˆã€Œæ–‡æ¡ˆã€</h3>
          <p>ä¸»è²¼æ–‡ã€å‚™é¸é–‹é ­ã€Hashtags èˆ‡ CTAï¼Œä¸€éµè¤‡è£½ã€åŒ¯å‡º Wordã€‚</p>
          <div class="actions">
            <button class="btn primary" data-go="copy">é–‹å§‹æ–‡æ¡ˆæ¨¡å¼</button>
            <button class="btn ghost" data-go="guide">çœ‹æ“ä½œèªªæ˜</button>
          </div>
        </article>
      </div>

      <details class="adv" style="margin-top:10px">
        <summary>é€²éšï¼šèˆŠæµç¨‹ï¼ˆ/generate_scriptï¼‰</summary>
        <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap">
          <input id="adv-input" type="text" placeholder="è¼¸å…¥ä¸€å¥éœ€æ±‚â€¦" style="flex:1; min-width:260px; padding:10px; border:1px solid var(--border); border-radius:10px" />
          <button class="btn" id="adv-run">å‘¼å« /generate_script</button>
        </div>
        <pre id="adv-out" class="muted" style="white-space:pre-wrap; margin-top:10px"></pre>
      </details>
    </section>
  </main>

  <section id="page-script" class="container" style="display:none">
    <div class="layout">
      <!-- å·¦ï¼šèŠå¤©å€ -->
      <div class="panel">
        <div class="panel-head">
          <div class="panel-title">èŠå¤©å”ä½œï¼ˆè…³æœ¬ï¼‰</div>
          <button class="toggle-settings" id="toggleSettingsScript" aria-expanded="true" aria-controls="settingsScript">
            <span class="chev">â–¾</span> âš™ï¸ è¨­å®š
          </button>
        </div>
        <div class="panel-head" id="settingsScriptWrap" style="border-top:0; border-bottom:1px solid var(--border);">
          <div class="settings" id="settingsScript">
            <div class="field"><span class="muted">user_id</span><input id="userId" type="text" /></div>
            <div class="field"><span class="muted">tone</span>
              <select id="toneSel"><option value="neutral">neutral</option><option>friendly</option><option>energetic</option><option>professional</option></select>
            </div>
            <div class="field"><span class="muted">lang</span>
              <select id="langSel"><option value="zh-TW">zh-TW</option><option value="zh-CN">zh-CN</option><option value="en">en</option></select>
            </div>
            <div class="field"><span class="muted">style</span>
              <select id="styleSel"><option value="concise">concise</option><option value="storytelling">storytelling</option><option value="educational">educational</option></select>
            </div>
            <div class="field"><span class="muted">max_len</span><input id="lenSel" type="number" min="200" max="2000" step="50" value="800" /></div>
            <label class="check"><input type="checkbox" id="rememberChk" /> è¨˜ä½</label>
            <button class="btn small" id="btn-save-prefs">æ›´æ–°åå¥½</button>
          </div>
        </div>

        <div class="chat-wrap">
          <div id="chatScript" class="chat-scroll"></div>
          <div class="chips" id="chipsScript">
            <span class="muted">å¿«é€Ÿæ¨¡æ¿ï¼š</span>
            <button class="chip" data-insert="è¡Œæ¥­: é›»å•†ï½œå¹³å°: Reelsï½œæ™‚é•·: 30ç§’ï½œç›®æ¨™: è³¼è²·ï½œä¸»é¡Œ: å¤å­£æ–°å“é–‹ç®±">é›»å•†Â·30ç§’Â·è³¼è²·</button>
            <button class="chip" data-insert="è¡Œæ¥­: é¤é£²ï½œå¹³å°: TikTokï½œæ™‚é•·: 15ç§’ï½œç›®æ¨™: å°æµï½œä¸»é¡Œ: æ‹›ç‰Œèœè³£é»">é¤é£²Â·15ç§’Â·å°æµ</button>
            <button class="chip" data-insert="è¡Œæ¥­: æ•™è‚²ï½œå¹³å°: Shortsï½œæ™‚é•·: 60ç§’ï½œç›®æ¨™: å“ç‰Œè¨˜æ†¶ï½œä¸»é¡Œ: èª²ç¨‹äº®é»">æ•™è‚²Â·60ç§’Â·å“ç‰Œ</button>
          </div>
          <div class="inputbar">
            <textarea id="inputScript" placeholder="è¼¸å…¥ä¸»é¡Œ/ç›®æ¨™/å—çœ¾/å¹³å°/æ™‚é•·/èªæ°£â€¦"></textarea>
            <button class="btn primary" id="sendScript">é€å‡º</button>
          </div>
        </div>
      </div>

      <!-- å³ï¼šè…³æœ¬çµæœ -->
      <div class="panel">
        <div class="panel-head">
          <div class="panel-title">è…³æœ¬åˆ†æ®µ / æ™‚é–“è»¸</div>
          <div class="settings" style="gap:8px">
            <button class="btn small" id="copyAllScript">è¤‡è£½å…¨éƒ¨</button>
            <button class="btn small" id="clearScript">æ¸…ç©º</button>
            <button class="btn small ok" id="thumbUpScript">ğŸ‘</button>
            <button class="btn small err" id="thumbDownScript">ğŸ‘</button>
          </div>
        </div>
        <div class="right-wrap">
          <div id="segmentsWrap" class="right-scroll"></div>
          <div class="toolbar">
            <button class="btn" id="buildTimeline">ç”Ÿæˆæ™‚é–“è»¸</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="page-copy" class="container" style="display:none">
    <div class="layout">
      <!-- å·¦ï¼šèŠå¤©å€ -->
      <div class="panel">
        <div class="panel-head">
          <div class="panel-title">èŠå¤©å”ä½œï¼ˆæ–‡æ¡ˆï¼‰</div>
          <button class="toggle-settings" id="toggleSettingsCopy" aria-expanded="true" aria-controls="settingsCopy">
            <span class="chev">â–¾</span> âš™ï¸ è¨­å®š
          </button>
        </div>
        <div class="panel-head" id="settingsCopyWrap" style="border-top:0; border-bottom:1px solid var(--border);">
          <div class="settings" id="settingsCopy">
            <div class="field"><span class="muted">user_id</span><input id="userId2" type="text" /></div>
            <div class="field"><span class="muted">tone</span>
              <select id="toneSel2"><option value="neutral">neutral</option><option>friendly</option><option>energetic</option><option>professional</option></select>
            </div>
            <div class="field"><span class="muted">lang</span>
              <select id="langSel2"><option value="zh-TW">zh-TW</option><option value="zh-CN">zh-CN</option><option value="en">en</option></select>
            </div>
            <div class="field"><span class="muted">style</span>
              <select id="styleSel2"><option value="concise">concise</option><option value="storytelling">storytelling</option><option value="educational">educational</option></select>
            </div>
            <div class="field"><span class="muted">max_len</span><input id="lenSel2" type="number" min="200" max="2000" step="50" value="600" /></div>
            <label class="check"><input type="checkbox" id="rememberChk2" /> è¨˜ä½</label>
            <button class="btn small" id="btn-save-prefs2">æ›´æ–°åå¥½</button>
          </div>
        </div>

        <div class="chat-wrap">
          <div id="chatCopy" class="chat-scroll"></div>
          <div class="chips" id="chipsCopy">
            <span class="muted">å¿«é€Ÿæ¨¡æ¿ï¼š</span>
            <button class="chip" data-insert="è¡Œæ¥­: å¥èº«ï½œå¹³å°: IG Reelsï½œæ™‚é•·: 30ç§’ï½œç›®æ¨™: å“ç‰Œè¨˜æ†¶ï½œä¸»é¡Œ: 30å¤©æŒ‘æˆ°">å¥èº«Â·30ç§’Â·å“ç‰Œ</button>
            <button class="chip" data-insert="è¡Œæ¥­: æ—…éŠï½œå¹³å°: TikTokï½œæ™‚é•·: 60ç§’ï½œç›®æ¨™: å°æµï½œä¸»é¡Œ: ç§˜å¢ƒæ¨è–¦">æ—…éŠÂ·60ç§’Â·å°æµ</button>
            <button class="chip" data-insert="è¡Œæ¥­: B2B SaaSï½œå¹³å°: LinkedInï½œæ™‚é•·: 60ç§’ï½œç›®æ¨™: æ½›åœ¨å®¢æˆ¶ï½œä¸»é¡Œ: çœæ™‚è‡ªå‹•åŒ–">B2B SaaSÂ·å®¢æˆ¶</button>
          </div>
          <div class="inputbar">
            <textarea id="inputCopy" placeholder="è¼¸å…¥ä¸»é¡Œ/å—çœ¾/å¹³å°/èªæ°£â€¦"></textarea>
            <button class="btn primary" id="sendCopy">é€å‡º</button>
          </div>
        </div>
      </div>

      <!-- å³ï¼šæ–‡æ¡ˆçµæœ -->
      <div class="panel">
        <div class="panel-head">
          <div class="panel-title">æ–‡æ¡ˆæ¨¡çµ„</div>
          <div class="settings" style="gap:8px">
            <button class="btn small" id="copyAllCopy">è¤‡è£½å…¨éƒ¨</button>
            <button class="btn small" id="clearCopy">æ¸…ç©º</button>
            <button class="btn small ok" id="thumbUpCopy">ğŸ‘</button>
            <button class="btn small err" id="thumbDownCopy">ğŸ‘</button>
          </div>
        </div>
        <div class="right-wrap">
          <div id="copyWrap" class="right-scroll"></div>
          <div class="toolbar"></div>
        </div>
      </div>
    </div>
  </section>

  <section id="page-guide" class="container" style="display:none; padding-top:16px">
    <article class="card" style="margin-bottom:12px">
      <h3>å·¥ä½œåŸç†èˆ‡éš±ç§</h3>
      <p>ä½ è¼¸å…¥çš„ä¸»é¡Œèˆ‡éœ€æ±‚æœƒé€é <code>/chat_generate</code> é€çµ¦å¾Œç«¯ LLMï¼Œç”±æ¨¡å‹æ¨ç†è¡Œæ¥­èˆ‡çˆ†æ¬¾è¦ç´ ä¸¦ç”¢å‡ºè…³æœ¬æˆ–æ–‡æ¡ˆã€‚åƒ…åœ¨å‹¾é¸ã€Œè¨˜ä½ã€æ™‚æ‰æœƒæ”œå¸¶ <code>remember: true</code>ã€‚</p>
    </article>
    <article class="card" style="margin-bottom:12px">
      <h3>å¦‚ä½•è®“æ•ˆæœæ›´å¥½</h3>
      <ul>
        <li>æ˜ç¢ºå‘ŠçŸ¥ï¼šè¡Œæ¥­ã€å¹³å°ï¼ˆReels/Shorts/TikTokâ€¦ï¼‰ã€æ™‚é•·ï¼ˆ15/30/60ç§’ï¼‰ã€ç›®æ¨™ï¼ˆå°æµ/è³¼è²·/å“ç‰Œï¼‰ã€‚</li>
        <li>æä¾›ç”¢å“/æœå‹™è³£é»ã€ä¸»è¦å—çœ¾ã€é ç®—èˆ‡å£æ’­/å­—å¹•éœ€æ±‚ã€‚</li>
        <li>å¤šè¼ªå°è©±å¾®èª¿ï¼šå¯è¦æ±‚å¢åŠ é–‹å ´é‰¤å­ã€ç¯€å¥ã€æ”¶å°¾ CTAã€‚</li>
      </ul>
    </article>
    <article class="card">
      <h3>å¸¸è¦‹éŒ¯èª¤</h3>
      <ul>
        <li><b>405</b>ï¼šæ–¹æ³•éŒ¯èª¤ã€‚è«‹ç¢ºèªåªç”¨ POST ä¸¦æ­£ç¢º URLã€‚</li>
        <li><b>CORS</b>ï¼šè«‹åœ¨å¾Œç«¯é–‹æ”¾ä¾†æºæˆ–æ”¹ç”¨åŒç¶²åŸŸåå‘ä»£ç†ã€‚</li>
        <li><b>500/è¶…æ™‚</b>ï¼šä¼ºæœå™¨å¿™ç¢Œæˆ–è¼¸å…¥éé•·ï¼Œè«‹ç¨å¾Œé‡è©¦æˆ–ç¸®çŸ­è¨Šæ¯ã€‚</li>
      </ul>
    </article>
  </section>

  <!-- æ‰‹æ©Ÿåº•éƒ¨æŠ½å±œï¼ˆå·¥å…·åˆ—ï¼‰ -->
  <div class="drawer" id="drawer">
    <button class="btn small" data-act="copyAll">è¤‡è£½å…¨éƒ¨</button>
    <button class="btn small" data-act="clear">æ¸…ç©º</button>
    <button class="btn small ok" data-act="up">ğŸ‘</button>
    <button class="btn small err" data-act="down">ğŸ‘</button>
    <button class="btn small" id="drawer-export">åŒ¯å‡º Word</button>
  </div>

  <div id="toast" class="toast">å·²è¤‡è£½</div>

<script>
  // ================================
  // å¸¸æ•¸é›†ä¸­ç®¡ç†ï¼ˆå¯æ”¹ï¼‰
  // ================================
  const API_BASE = 'https://aijobvideobackend.zeabur.app'; // â† æ›å¾Œç«¯åªè¦æ”¹é€™è¡Œ
  const DEFAULT_USER_ID = `web-${Math.random().toString(36).slice(2,8)}`;
  const THEME = { primary: '#2563eb' };
  let MOCK_MODE = false; // â† é»å³ä¸Šè§’æŒ‰éˆ•å¯åˆ‡æ›

  // å…¨åŸŸç‹€æ…‹
  const state = {
    sessionIdScript: '',
    sessionIdCopy: '',
    userId: DEFAULT_USER_ID,
    messagesScript: [], // {role, content, ts}
    messagesCopy: [],
    segments: [], // è…³æœ¬åˆ†æ®µï¼ˆå³å´ï¼‰
    copy: null,   // æ–‡æ¡ˆç”¢ç‰©ï¼ˆå³å´ï¼‰
  };

  // å·¥å…·ï¼šæ™‚é–“æ ¼å¼
  function fmtTS(d=new Date()){
    const pad=n=>String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
  function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1500); }
  function copyText(text){ navigator.clipboard.writeText(text).then(()=>showToast('å·²è¤‡è£½')); }

  // ================================
  // === API å€ï¼ˆå‹¿æ”¹ï¼‰ ===
  // ================================
  async function apiChatGenerate({ user_id, session_id, messages, previous_segments, remember }){
    if(MOCK_MODE){
      // æ¨¡æ“¬ï¼šæ ¹æ“šæœ€å¾Œä¸€å‰‡ä½¿ç”¨è€…è¨Šæ¯ç”¢ç”Ÿå‡çµæœ
      const last = messages[messages.length-1]?.content || '';
      const segs = [
        { start_sec:0, end_sec:5, type:'hook', camera:'CU', dialog:`é–‹å ´é‰¤å­ï¼š${last.slice(0,20)}â€¦`, visual:'å¿«é€Ÿå‰ªè¼¯+å‹•æ…‹å­—å¹•', cta:'' },
        { start_sec:5, end_sec:12, type:'value', camera:'MS', dialog:'ä¸‰å€‹é‡é»èªªæ˜', visual:'å°ç„¦ç”¢å“/æ•¸æ“šåœ–', cta:'' },
        { start_sec:12, end_sec:20, type:'cta', camera:'WS', dialog:'è¡Œå‹•å‘¼ç±²å£æ’­', visual:'å¤§å­—å¡+Logo', cta:'é»æ“Šé€£çµé ˜å–' }
      ];
      const copy = {
        main_copy: `ä¸»è²¼æ–‡ï¼š${last}\nå¸¶å‡ºè³£é»èˆ‡æ‰¿è«¾ã€‚`,
        alternates: ['é–‹é ­Aï¼šæŠ“ç—›é»','é–‹é ­Bï¼šä¸Ÿæ•¸æ“š','é–‹é ­Cï¼šè¬›æ•…äº‹'],
        hashtags: ['#çŸ­å½±éŸ³','#è¡ŒéŠ·','#AI'],
        cta: 'ç«‹å³ç§è¨Š / é»é€£çµ'
      };
      await new Promise(r=>setTimeout(r,600));
      return { session_id: session_id || 'mock-session', assistant_message: 'é€™æ˜¯æ¨¡æ“¬å›è¦†ï¼šå·²ä¾ä½ çš„éœ€æ±‚ç”¢ç”Ÿåˆç¨¿å–”ã€‚', segments: segs, copy };
    }
    const res = await fetch(`${API_BASE}/chat_generate`,{
      method:'POST', headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ user_id, session_id, messages, previous_segments, remember })
    });
    const json = await res.json().catch(()=>({ error:'invalid_json' }));
    if(!res.ok){ throw new Error(json?.error || `HTTP ${res.status}`); } // â† 404/å…¶å®ƒæœƒèµ°åˆ°é€™ï¼ŒUI é¡¯ç¤º âŒ éŒ¯èª¤ï¼šHTTP 404
    return json;
  }

  async function apiFeedback({ user_id, kind, note }){
    if(MOCK_MODE){ await new Promise(r=>setTimeout(r,200)); return { ok:true }; }
    const res = await fetch(`${API_BASE}/feedback`,{
      method:'POST', headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ user_id, kind, note })
    });
    const json = await res.json().catch(()=>({ error:'invalid_json' }));
    if(!res.ok){ throw new Error(json?.error || `HTTP ${res.status}`); }
    return json;
  }

  async function apiUpdatePrefs({ user_id, prefs }){
    if(MOCK_MODE){ await new Promise(r=>setTimeout(r,200)); return { ok:true }; }
    const res = await fetch(`${API_BASE}/update_prefs`,{
      method:'POST', headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ user_id, prefs })
    });
    const json = await res.json().catch(()=>({ error:'invalid_json' }));
    if(!res.ok){ throw new Error(json?.error || `HTTP ${res.status}`); }
    return json;
  }

  async function apiGenerateScript({ user_input, previous_segments }){
    if(MOCK_MODE){ await new Promise(r=>setTimeout(r,400)); return { segments:[{start_sec:0,end_sec:10,type:'hook',camera:'CU',dialog:'æ¨¡æ“¬èˆŠæµç¨‹ç‰‡æ®µ',visual:'ç´ ææ‹¼æ¥',cta:''}] };
    }
    const res = await fetch(`${API_BASE}/generate_script`,{
      method:'POST', headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ user_input, previous_segments })
    });
    const json = await res.json().catch(()=>({ error:'invalid_json' }));
    if(!res.ok){ throw new Error(json?.error || `HTTP ${res.status}`); }
    return json;
  }
  // === API å€çµæŸ ===

  // ================================
  // === UI å€ï¼ˆå¯æ”¹ï¼‰ ===
  // ================================
  const pages = ['home','script','copy','guide'];
  const tabEls = document.querySelectorAll('.tab');
  tabEls.forEach(btn=>btn.addEventListener('click',()=>goPage(btn.dataset.page)));
  document.querySelectorAll('[data-go]').forEach(b=>b.onclick=()=>goPage(b.dataset.go));
  function goPage(name){
    pages.forEach(p=>{
      document.getElementById(`page-${p}`).style.display = (p===name)?'block':'none';
      document.querySelector(`.tab[data-page="${p}"]`).classList.toggle('active', p===name);
    });
  }

  // åˆå§‹ user_id
  const userIdInput = document.getElementById('userId');
  const userIdInput2 = document.getElementById('userId2');
  userIdInput.value = state.userId; userIdInput2.value = state.userId;
  userIdInput.addEventListener('change', e=>{ state.userId = e.target.value || DEFAULT_USER_ID; userIdInput2.value = state.userId; });
  userIdInput2.addEventListener('change', e=>{ state.userId = e.target.value || DEFAULT_USER_ID; userIdInput.value = state.userId; });

  // åå¥½æ›´æ–°
  document.getElementById('btn-save-prefs').onclick = async()=>{
    const prefs = collectPrefs('#toneSel','#langSel','#styleSel','#lenSel');
    try{ await apiUpdatePrefs({ user_id: state.userId, prefs }); showToast('å·²æ›´æ–°åå¥½'); }
    catch(err){ showToast(`æ›´æ–°å¤±æ•—ï¼š${err.message}`); }
  };
  document.getElementById('btn-save-prefs2').onclick = async()=>{
    const prefs = collectPrefs('#toneSel2','#langSel2','#styleSel2','#lenSel2');
    try{ await apiUpdatePrefs({ user_id: state.userId, prefs }); showToast('å·²æ›´æ–°åå¥½'); }
    catch(err){ showToast(`æ›´æ–°å¤±æ•—ï¼š${err.message}`); }
  };
  function collectPrefs(t,l,s,m){
    return { tone: val(t), language: val(l), writing_style: val(s), max_length: parseInt(val(m)||600,10) };
  }
  const val = sel=>document.querySelector(sel).value;

  // è¨­å®šæ”¶åˆ/å±•é–‹
  function bindToggle(btnId, settingsId){
    const btn = document.getElementById(btnId);
    const settings = document.getElementById(settingsId);
    btn.addEventListener('click', ()=>{
      const expanded = btn.getAttribute('aria-expanded') === 'true';
      btn.setAttribute('aria-expanded', String(!expanded));
      settings.classList.toggle('collapsed', expanded);
    });
  }
  bindToggle('toggleSettingsScript','settingsScript');
  bindToggle('toggleSettingsCopy','settingsCopy');

  // é€å‡ºï¼ˆè…³æœ¬ï¼‰
  const sendBtnScript = document.getElementById('sendScript');
  const inputScript = document.getElementById('inputScript');
  const rememberChk = document.getElementById('rememberChk');
  const chatScriptEl = document.getElementById('chatScript');
  sendBtnScript.onclick = ()=> sendChat('script');
  inputScript.addEventListener('keydown',e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendChat('script'); } });

  // é€å‡ºï¼ˆæ–‡æ¡ˆï¼‰
  const sendBtnCopy = document.getElementById('sendCopy');
  const inputCopy = document.getElementById('inputCopy');
  const rememberChk2 = document.getElementById('rememberChk2');
  const chatCopyEl = document.getElementById('chatCopy');
  sendBtnCopy.onclick = ()=> sendChat('copy');
  inputCopy.addEventListener('keydown',e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendChat('copy'); } });

  // å¿«é€Ÿæ¨¡æ¿ chips
  document.getElementById('chipsScript').addEventListener('click',e=>{
    if(e.target.classList.contains('chip')){ inputScript.value = e.target.dataset.insert; inputScript.focus(); }
  });
  document.getElementById('chipsCopy').addEventListener('click',e=>{
    if(e.target.classList.contains('chip')){ inputCopy.value = e.target.dataset.insert; inputCopy.focus(); }
  });

  // æ¸²æŸ“å°è©±
  function appendMsg(el, role, content){
    const div = document.createElement('div');
    div.className = 'msg ' + (role==='user'?'user':'');
    div.innerHTML = `<div class="meta">${role} Â· ${fmtTS()}</div><div>${escapeHTML(content)}</div>`;
    el.appendChild(div); el.scrollTop = el.scrollHeight;
  }
  function escapeHTML(s){ return s.replace(/[&<>\"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }

  // æ¸²æŸ“è…³æœ¬åˆ†æ®µ
  const segmentsWrap = document.getElementById('segmentsWrap');
  function renderSegments(){
    segmentsWrap.innerHTML = '';
    if(!state.segments?.length){
      const empty = document.createElement('div');
      empty.className = 'segment-card muted';
      empty.innerHTML = 'å°šç„¡ç‰‡æ®µã€‚æç¤ºï¼šè«‹æ›´å…·é«”æè¿°ç‰‡é ­/å ´æ™¯/ç‰‡å°¾æˆ–æŒ‡å®šç§’æ•¸ã€‚';
      segmentsWrap.appendChild(empty);
      return;
    }
    state.segments.forEach((s,idx)=>{
      // è‹¥ç§’æ•¸ä¸å­˜åœ¨ï¼Œé€²è¡Œæš«åˆ†é…ï¼ˆ5â€“10ç§’ï¼‰
      if(s.start_sec==null||s.end_sec==null){ const base = (idx*6); s.start_sec = base; s.end_sec = base+6; }
      const card = document.createElement('div');
      card.className = 'segment-card';
      card.innerHTML = `
        <div class="segment-head">
          <div class="seg-title">#${idx+1} ${s.type||'segment'} <span class="seg-meta">${s.start_sec}sâ€“${s.end_sec}s Â· é¡ä½ ${s.camera||'-'}</span></div>
          <div class="seg-actions">
            <button class="btn small" data-act="add-tl" data-idx="${idx}">åŠ å…¥æ™‚é–“è»¸</button>
            <button class="btn small" data-act="copy" data-idx="${idx}">è¤‡è£½</button>
            <button class="btn small" data-act="tweak" data-idx="${idx}">å¾®èª¿</button>
            <button class="btn small err" data-act="del" data-idx="${idx}">åˆªé™¤</button>
          </div>
        </div>
        <div class="muted">å°ç™½</div><div>${escapeHTML(s.dialog||'')}</div>
        <div class="muted" style="margin-top:6px">ç•«é¢æ„Ÿ</div><div>${escapeHTML(s.visual||'')}</div>
        <div class="muted" style="margin-top:6px">CTA</div><div>${escapeHTML(s.cta||'')}</div>
      `;
      segmentsWrap.appendChild(card);
    });
  }
  segmentsWrap.addEventListener('click', e=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const idx = +btn.dataset.idx;
    const act = btn.dataset.act;
    const seg = state.segments[idx];
    if(!seg) return;
    if(act==='copy'){
      copyText(segmentToText(seg));
    } else if(act==='del'){
      state.segments.splice(idx,1); renderSegments();
    } else if(act==='tweak'){
      const nd = prompt('å¾®èª¿å°ç™½ï¼ˆç•™ç©ºç•¥éï¼‰', seg.dialog||''); if(nd!=null && nd!=='') seg.dialog = nd;
      const nv = prompt('å¾®èª¿ç•«é¢ï¼ˆç•™ç©ºç•¥éï¼‰', seg.visual||''); if(nv!=null && nv!=='') seg.visual = nv;
      const nc = prompt('å¾®èª¿ CTAï¼ˆç•™ç©ºç•¥éï¼‰', seg.cta||''); if(nc!=null && nc!=='') seg.cta = nc;
      renderSegments();
    } else if(act==='add-tl'){
      buildTimeline(); showToast('å·²åŠ å…¥æ™‚é–“æª”');
    }
  });
  function segmentToText(s){
    return `(${s.start_sec}sâ€“${s.end_sec}s) [${s.type||'-'}] camera:${s.camera||'-'}\nå°è©:${s.dialog||''}\nç•«é¢:${s.visual||''}\nCTA:${s.cta||''}`;
  }

  // æ™‚é–“è»¸
  const buildBtn = document.getElementById('buildTimeline');
  buildBtn.onclick = buildTimeline;
  function buildTimeline(){
    if(!state.segments?.length){ showToast('æ²’æœ‰ç‰‡æ®µå¯å»ºæ™‚é–“è»¸'); return; }
    const box = document.createElement('div');
    box.className='timeline';
    box.innerHTML = `<div class="muted">æ™‚é–“è»¸ï¼ˆåºè™Ÿ / å€é–“ / é¡å‹ / æ‘˜è¦ï¼‰</div>`;
    state.segments.forEach((s,i)=>{
      const item = document.createElement('div');
      item.className='timeline-item';
      const summary = (s.dialog||'').slice(0,32).replace(/\n/g,' ');
      item.innerHTML = `<div>#${i+1}</div><div>${s.start_sec}sâ€“${s.end_sec}s</div><div>${s.type||'-'}</div><div class="muted">${escapeHTML(summary)}</div>`;
      box.appendChild(item);
    });
    segmentsWrap.prepend(box);
  }

  // æ–‡æ¡ˆæ¸²æŸ“
  const copyWrap = document.getElementById('copyWrap');
  function renderCopy(){
    copyWrap.innerHTML='';
    if(!state.copy){
      const empty = document.createElement('div'); empty.className='copy-card muted'; empty.textContent='å°šç„¡æ–‡æ¡ˆã€‚è«‹æè¿°å¹³å°/å—çœ¾/èªæ°£/ç›®æ¨™ã€‚'; copyWrap.appendChild(empty); return;
    }
    const { main_copy, alternates=[], hashtags=[], cta='' } = state.copy;
    const main = document.createElement('div');
    main.className='copy-card';
    main.innerHTML = `<h4>ä¸»è²¼æ–‡</h4><pre style="white-space:pre-wrap">${escapeHTML(main_copy||'')}</pre><div class="seg-actions" style="margin-top:8px"><button class="btn small" id="cp-main">è¤‡è£½</button></div>`;

    const alt = document.createElement('div');
    alt.className='copy-card';
    alt.innerHTML = `<h4>å‚™é¸é–‹é ­</h4><ul>${alternates.map(a=>`<li>${escapeHTML(a)}</li>`).join('')}</ul>`;

    const tag = document.createElement('div');
    tag.className='copy-card';
    tag.innerHTML = `<h4>Hashtags</h4><div>${hashtags.map(h=>`<span class="chip">${escapeHTML(h)}</span>`).join(' ')}</div>`;

    const ctaEl = document.createElement('div');
    ctaEl.className='copy-card';
    ctaEl.innerHTML = `<h4>CTA</h4><div>${escapeHTML(cta)}</div><div class="seg-actions" style="margin-top:8px"><button class="btn small" id="cp-all">è¤‡è£½å…¨éƒ¨</button></div>`;

    copyWrap.append(main,alt,tag,ctaEl);

    document.getElementById('cp-main').onclick = ()=>copyText(main_copy||'');
    document.getElementById('cp-all').onclick = ()=>copyText(copyToText(state.copy));
  }
  function copyToText(c){
    const lines = [];
    lines.push('ã€ä¸»è²¼æ–‡ã€‘'); lines.push(c.main_copy||'');
    lines.push('\nã€å‚™é¸é–‹é ­ã€‘'); (c.alternates||[]).forEach((a,i)=>lines.push(`${i+1}. ${a}`));
    lines.push('\nã€Hashtagsã€‘'); lines.push((c.hashtags||[]).join(' '));
    lines.push('\nã€CTAã€‘'); lines.push(c.cta||'');
    return lines.join('\n');
  }

  // æ¸…ç©º/è¤‡è£½å…¨éƒ¨/å›é¥‹
  document.getElementById('copyAllScript').onclick = ()=>{
    if(!state.segments?.length){ showToast('ç„¡å¯è¤‡è£½å…§å®¹'); return; }
    const all = state.segments.map(segmentToText).join('\n\n'); copyText(all);
  };
  document.getElementById('clearScript').onclick = ()=>{ state.segments=[]; renderSegments(); };
  document.getElementById('thumbUpScript').onclick = ()=>doFeedback('thumbs_up');
  document.getElementById('thumbDownScript').onclick = ()=>doFeedback('thumbs_down');

  document.getElementById('copyAllCopy').onclick = ()=>{
    if(!state.copy){ showToast('ç„¡å¯è¤‡è£½å…§å®¹'); return; }
    copyText(copyToText(state.copy));
  };
  document.getElementById('clearCopy').onclick = ()=>{ state.copy=null; renderCopy(); };
  document.getElementById('thumbUpCopy').onclick = ()=>doFeedback('thumbs_up');
  document.getElementById('thumbDownCopy').onclick = ()=>doFeedback('thumbs_down');

  async function doFeedback(kind){
    try{ await apiFeedback({ user_id: state.userId, kind }); showToast('å·²é€å‡ºå›é¥‹'); }
    catch(e){ showToast(`å›é¥‹å¤±æ•—ï¼š${e.message}`); }
  }

  // æ‰‹æ©ŸæŠ½å±œæŒ‰éˆ•ä»£ç†
  document.getElementById('drawer').addEventListener('click',e=>{
    const act = e.target?.dataset?.act; if(!act) return;
    if(act==='copyAll'){
      const inCopyPage = document.getElementById('page-copy').style.display==='block';
      if(inCopyPage) document.getElementById('copyAllCopy').click(); else document.getElementById('copyAllScript').click();
    } else if(act==='clear'){
      const inCopyPage = document.getElementById('page-copy').style.display==='block';
      if(inCopyPage) document.getElementById('clearCopy').click(); else document.getElementById('clearScript').click();
    } else if(act==='up'){
      doFeedback('thumbs_up');
    } else if(act==='down'){
      doFeedback('thumbs_down');
    }
  });
  document.getElementById('drawer-export').onclick = ()=> document.getElementById('btn-export').click();

  // ç™¼é€èŠå¤©ï¼ˆå…©æ¨¡å¼å…±ç”¨ï¼‰
  async function sendChat(mode){
    const isScript = mode==='script';
    const input = isScript ? inputScript : inputCopy;
    const chatEl = isScript ? chatScriptEl : chatCopyEl;
    const remember = isScript ? rememberChk.checked : rememberChk2.checked;
    const sessionId = isScript ? state.sessionIdScript : state.sessionIdCopy;

    const text = (input.value||'').trim(); if(!text){ showToast('è«‹å…ˆè¼¸å…¥å…§å®¹'); return; }

    // æ–°å¢ä½¿ç”¨è€…è¨Šæ¯
    (isScript?state.messagesScript:state.messagesCopy).push({ role:'user', content:text, ts:Date.now() });
    appendMsg(chatEl,'user',text);
    input.value='';

    // æº–å‚™ messagesï¼ˆåƒ…é€æœ€å¾Œ 20 å‰‡ï¼‰
    const messages = (isScript?state.messagesScript:state.messagesCopy).slice(-20).map(m=>({ role:m.role, content:m.content }));

    // UI loading
    const btn = isScript? sendBtnScript : sendBtnCopy; const oldLabel = btn.textContent; btn.disabled=true; btn.textContent='ç”Ÿæˆä¸­â€¦';

    try{
      const resp = await apiChatGenerate({ user_id: state.userId, session_id: sessionId, messages, previous_segments: state.segments, remember });
      // ä¿å­˜ session_id
      if(isScript){ state.sessionIdScript = resp.session_id || state.sessionIdScript; } else { state.sessionIdCopy = resp.session_id || state.sessionIdCopy; }

      // é¡¯ç¤º assistant_message
      const assistant = resp.assistant_message || '(ç„¡å›è¦†)';
      (isScript?state.messagesScript:state.messagesCopy).push({ role:'assistant', content:assistant, ts:Date.now() });
      appendMsg(chatEl,'assistant',assistant);

      // è‹¥å›å‚³ segments / copyï¼Œæ¸²æŸ“å³å´
      if(resp.segments && Array.isArray(resp.segments)){
        state.segments = resp.segments;
        renderSegments();
      }
      if(resp.copy){ state.copy = resp.copy; renderCopy(); }
    }catch(err){
      appendMsg(chatEl,'assistant',`âŒ éŒ¯èª¤ï¼š${err.message}`);
      showToast(`ç™¼ç”ŸéŒ¯èª¤ï¼š${err.message}`);
    }finally{
      btn.disabled=false; btn.textContent=oldLabel;
    }
  }

  // èˆŠæµç¨‹æ¸¬è©¦
  document.getElementById('adv-run').onclick = async()=>{
    const out = document.getElementById('adv-out');
    const text = document.getElementById('adv-input').value.trim(); if(!text) return;
    out.textContent = 'å‘¼å«ä¸­â€¦';
    try{
      const r = await apiGenerateScript({ user_input:text, previous_segments: state.segments });
      out.textContent = JSON.stringify(r,null,2);
      if(r.segments){ state.segments = r.segments; renderSegments(); }
    }catch(e){ out.textContent = `éŒ¯èª¤ï¼š${e.message}`; }
  };

  // åŒ¯å‡º Wordï¼ˆå°è©± + ç”¢ç‰©ï¼‰
  document.getElementById('btn-export').onclick = exportDocx;
  async function exportDocx(){
    const { Document, Packer, Paragraph, TextRun, HeadingLevel } = docx;

    function para(text, opts={}){ return new Paragraph({ children:[ new TextRun({ text, ...opts }) ] }); }
    function h1(text){ return new Paragraph({ text, heading: HeadingLevel.HEADING_1 }); }
    function h2(text){ return new Paragraph({ text, heading: HeadingLevel.HEADING_2 }); }

    const parts = [];
    parts.push(h1('çŸ­å½±éŸ³é¡§å• AI å°ˆæ¡ˆåŒ¯å‡º'));
    parts.push(para(`è¼¸å‡ºæ™‚é–“ï¼š${fmtTS()}`));
    parts.push(para(' '));

    // å°è©±ç´€éŒ„
    parts.push(h2('ä¸€ã€å°è©±ç´€éŒ„ï¼ˆè…³æœ¬æ¨¡å¼ï¼‰'));
    state.messagesScript.forEach(m=>{ parts.push(para(`${m.role} | ${new Date(m.ts).toLocaleString()}\n${m.content}`)); });
    parts.push(para(' '));
    parts.push(h2('äºŒã€å°è©±ç´€éŒ„ï¼ˆæ–‡æ¡ˆæ¨¡å¼ï¼‰'));
    state.messagesCopy.forEach(m=>{ parts.push(para(`${m.role} | ${new Date(m.ts).toLocaleString()}\n${m.content}`)); });

    // è…³æœ¬åˆ†æ®µ
    parts.push(para(' '));
    parts.push(h2('ä¸‰ã€è…³æœ¬åˆ†æ®µ'));
    if(state.segments?.length){
      state.segments.forEach((s,i)=>{
        parts.push(para(`#${i+1} ${s.type||'segment'} (${s.start_sec||0}sâ€“${s.end_sec||0}s) camera:${s.camera||'-'}`));
        if(s.dialog) parts.push(para(`å°è©ï¼š${s.dialog}`));
        if(s.visual) parts.push(para(`ç•«é¢ï¼š${s.visual}`));
        if(s.cta) parts.push(para(`CTAï¼š${s.cta}`));
        parts.push(para(' '));
      });
    }else{
      parts.push(para('ï¼ˆç„¡ç‰‡æ®µï¼‰'));
    }

    // æ–‡æ¡ˆæ¨¡çµ„
    parts.push(para(' '));
    parts.push(h2('å››ã€æ–‡æ¡ˆæ¨¡çµ„'));
    if(state.copy){
      parts.push(para('ã€ä¸»è²¼æ–‡ã€‘')); parts.push(para(state.copy.main_copy||''));
      parts.push(para(' '));
      parts.push(para('ã€å‚™é¸é–‹é ­ã€‘'));
      (state.copy.alternates||[]).forEach((a,i)=>parts.push(para(`${i+1}. ${a}`)));
      parts.push(para(' '));
      parts.push(para('ã€Hashtagsã€‘')); parts.push(para((state.copy.hashtags||[]).join(' ')));
      parts.push(para(' '));
      parts.push(para('ã€CTAã€‘')); parts.push(para(state.copy.cta||''));
    } else {
      parts.push(para('ï¼ˆç„¡æ–‡æ¡ˆï¼‰'));
    }

    const doc = new Document({ sections:[{ properties:{}, children: parts }] });
    const blob = await Packer.toBlob(doc);
    const dt = new Date();
    const pad=n=>String(n).padStart(2,'0');
    const filename = `script_export_${dt.getFullYear()}${pad(dt.getMonth()+1)}${pad(dt.getDate())}_${pad(dt.getHours())}${pad(dt.getMinutes())}.docx`;
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
  }

  // äº‹ä»¶ï¼šè¤‡è£½å…¨éƒ¨ï¼ˆå¿«æ·éµï¼‰
  document.addEventListener('keydown',e=>{
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='b'){
      const isCopy = document.getElementById('page-copy').style.display==='block';
      if(isCopy) document.getElementById('copyAllCopy').click(); else document.getElementById('copyAllScript').click();
    }
  });

  // åˆ‡æ› Mock
  const mockBtn = document.getElementById('btn-toggle-mock');
  mockBtn.onclick = ()=>{ MOCK_MODE=!MOCK_MODE; mockBtn.textContent = `Mock: ${MOCK_MODE? 'On':'Off'}`; showToast(`Mock ${MOCK_MODE?'å·²é–‹å•Ÿ':'å·²é—œé–‰'}`); };

  // åˆå§‹æ¸²æŸ“
  renderSegments();
  renderCopy();
</script>
</body>
</html>

