<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>AI短影音顧問｜AIJob智能</title>
  <style>
    :root{ --primary:#2563eb; --primary-600:#1d4ed8; --bg:#ffffff; --muted:#f5f7fb; --border:#e6e8ef; --text:#0f172a; --text-muted:#64748b; --ok:#16a34a; --err:#dc2626; --shadow:0 6px 18px rgba(2,12,27,0.08); --radius:14px; }
    *{ box-sizing:border-box; } html,body{ height:100%; }
    body{ margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC,Helvetica Neue,Arial; background:var(--bg); color:var(--text); line-height:1.6; font-size:16px; -webkit-text-size-adjust:100%; touch-action:manipulation; }
    a{ color:var(--primary); text-decoration:none; }
    .container{ max-width:1200px; margin:0 auto; padding:16px; }
    .topbar{ position:sticky; top:0; z-index:50; background:rgba(255,255,255,0.9); backdrop-filter:saturate(180%) blur(8px); border-bottom:1px solid var(--border); }
    .topbar-inner{ display:flex; flex-direction:column; align-items:center; gap:10px; padding:12px 16px; }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:800; font-size:22px; }
    .brand .logo{ width:20px; height:20px; border-radius:4px; object-fit:cover; box-shadow:0 0 0 3px rgba(37,99,235,0.15); }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .tab{ padding:8px 12px; border:1px solid var(--border); border-radius:999px; background:#fff; color:var(--text); cursor:pointer; transition:all .15s; font-weight:600; font-size:14px; }
    .tab.active{ background:var(--primary); border-color:var(--primary); color:#fff; box-shadow:var(--shadow); }

    .layout{ display:grid; grid-template-columns:7fr 5fr; gap:16px; padding:16px; }
    .panel{ background:#fff; border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; }
    .panel-head{ padding:12px 14px; border-bottom:1px solid var(--border); display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; }
    .panel-title{ font-weight:800; display:flex; align-items:center; gap:8px; }
    .settings{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .settings .field{ display:flex; align-items:center; gap:6px; background:var(--muted); border:1px solid var(--border); border-radius:10px; padding:6px 8px; }
    .settings input[type="text"], .settings select, .settings input[type="number"]{ border:none; background:transparent; outline:none; padding:4px; min-width:90px; font-size:16px; }
    .settings .check{ display:flex; align-items:center; gap:6px; }
    .settings.collapsed{ display:none; }
    .toggle-settings{ margin-left:auto; border:1px solid var(--border); background:#fff; padding:6px 10px; border-radius:10px; cursor:pointer; font-weight:700; font-size:13px; display:inline-flex; align-items:center; gap:6px; }
    .toggle-settings:hover{ box-shadow:var(--shadow); }
    .chev{ display:inline-block; transition:transform .2s ease; }
    .toggle-settings[aria-expanded="false"] .chev{ transform:rotate(-90deg); }

    .chat-wrap{ display:flex; flex-direction:column; height:62vh; }
    .chat-scroll{ flex:1; overflow:auto; padding:14px; display:flex; flex-direction:column; gap:10px; background:var(--muted); }
    .msg{ max-width:80%; padding:10px 12px; border-radius:14px; border:1px solid var(--border); background:#fff; box-shadow:var(--shadow); }
    .msg.user{ margin-left:auto; background:#eef4ff; border-color:#dbe6ff; }
    .msg .meta{ font-size:12px; color:var(--text-muted); margin-bottom:4px; }
    .inputbar{ display:flex; gap:8px; padding:10px; border-top:1px solid var(--border); background:#fff; }
    textarea{ flex:1; resize:none; border:1px solid var(--border); border-radius:12px; padding:10px 12px; min-height:46px; max-height:160px; font-size:16px; line-height:1.5; }

    .right-wrap{ display:flex; flex-direction:column; height:62vh; }
    .right-scroll{ flex:1; overflow:auto; padding:14px; display:flex; flex-direction:column; gap:10px; background:var(--muted); }
    .segment-card{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px; box-shadow:var(--shadow); }
    .segment-head{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:6px; }
    .seg-title{ font-weight:700; } .seg-meta{ color:var(--text-muted); font-size:13px; }
    .seg-actions{ display:flex; gap:6px; }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; padding:10px 14px; border-top:1px solid var(--border); background:#fff; }
    .chip{ padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#fff; cursor:pointer; font-size:13px; }
    .chip:hover{ border-color:var(--primary); color:var(--primary); }

    .btn{ padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:#fff; cursor:pointer; font-weight:700; font-size:15px; display:inline-flex; align-items:center; gap:6px; transition:all .15s; min-height:42px; }
    .btn:hover{ transform:translateY(-1px); box-shadow:var(--shadow); }
    .btn.primary{ background:var(--primary); border-color:var(--primary); color:#fff; }
    .btn.small{ padding:8px 10px; font-size:14px; min-height:36px; }

    /* 模板按鈕藍底白字（選取） */
    .segctl .group{ display:flex; gap:6px; background:var(--muted); border:1px solid var(--border); border-radius:12px; padding:6px; overflow:auto; }
    .segctl .group label{ padding:0; }
    .segctl .group input{ display:none; }
    .segctl .group span{ display:inline-block; padding:6px 10px; border-radius:999px; cursor:pointer; border:1px solid transparent; white-space:nowrap; }
    .segctl .group input:checked + span{ background:var(--primary); color:#fff; border-color:var(--primary); box-shadow:var(--shadow); }

    @media (max-width:1199px){ .layout{ grid-template-columns:1fr; } }
    @media (max-width:767px){ .chat-wrap,.right-wrap{ height:auto; max-height:64vh; } }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner container">
      <div class="brand">
        <img class="logo" alt="AIJob logo" src="https://static.wixstatic.com/media/9705bb_4edf6b22c58f4275bc9bae42891acb49~mv2.png"/>
        AI短影音顧問｜AIJob智能
      </div>
      <div class="tabs">
        <button class="tab active" data-page="script">腳本模式</button>
        <button class="tab" data-page="copy">文案模式</button>
        <button class="tab" data-page="guide">說明/指南</button>
      </div>
    </div>
  </div>

  <section id="page-script" class="container">
    <div class="layout">
      <div class="panel">
        <div class="panel-head">
          <div class="panel-title">聊天協作（腳本）</div>
          <div class="mode-wrap">
            <div class="segctl">
              <div class="group" id="modeGroup">
                <label><input type="radio" name="scriptMode" value="guide" checked><span>✍️ 引導模式</span></label>
                <label><input type="radio" name="scriptMode" value="free"><span>💬 自由模式</span></label>
              </div>
            </div>
            <button class="toggle-settings" id="toggleSettingsScript" aria-expanded="false"><span class="chev">▾</span> ⚙️ 設定</button>
          </div>
        </div>

        <!-- 模板＋秒數（僅引導模式顯示；但現在只是設定，不發訊息） -->
        <div class="panel-head" id="guideBar" style="border-top:0; border-bottom:1px solid var(--border);">
          <div class="segctl">
            <div class="group" id="tplGroup" aria-label="模板結構">
              <label><input type="radio" name="tpl" value="A" checked><span>A 三段式</span></label>
              <label><input type="radio" name="tpl" value="B"><span>B 問題解決</span></label>
              <label><input type="radio" name="tpl" value="C"><span>C Before-After</span></label>
              <label><input type="radio" name="tpl" value="D"><span>D 教學</span></label>
              <label><input type="radio" name="tpl" value="E"><span>E 敘事</span></label>
              <label><input type="radio" name="tpl" value="F"><span>F 爆點連發</span></label>
            </div>
            <div class="group" id="durGroup" aria-label="時長">
              <label><input type="radio" name="dur" value="30" checked><span>30 秒</span></label>
              <label><input type="radio" name="dur" value="60"><span>60 秒</span></label>
            </div>
            <button class="btn small" id="btnStartGuide">套用設定並開始</button>
          </div>
        </div>

        <!-- 設定（預設隱藏） -->
        <div class="panel-head" id="settingsScriptWrap" style="border-top:0; border-bottom:1px solid var(--border);">
          <div class="settings collapsed" id="settingsScript">
            <div class="field"><span class="muted">user_id</span><input id="userId" type="text" /></div>
            <div class="field"><span class="muted">tone</span>
              <select id="toneSel"><option value="neutral">neutral</option><option>friendly</option><option>energetic</option><option>professional</option></select>
            </div>
            <div class="field"><span class="muted">lang</span>
              <select id="langSel"><option value="zh-TW">zh-TW</option><option value="zh-CN">zh-CN</option><option value="en">en</option></select>
            </div>
            <div class="field"><span class="muted">style</span>
              <select id="styleSel"><option value="concise">concise</option><option value="storytelling">storytelling</option><option value="educational">educational</option></select>
            </div>
            <div class="field"><span class="muted">max_len</span><input id="lenSel" type="number" min="200" max="2000" step="50" value="800" /></div>
            <label class="check"><input type="checkbox" id="rememberChk" /> 記住</label>
            <button class="btn small" id="btn-save-prefs">更新偏好</button>
          </div>
        </div>

        <div class="chat-wrap">
          <div id="chatScript" class="chat-scroll"></div>
          <div class="chips" id="chipsScript"></div>
          <div class="inputbar">
            <textarea id="inputScript" placeholder="輸入主題/目標/受眾/平台/時長/語氣…（按鈕送出；Shift+Enter 換行）"></textarea>
            <button class="btn primary" id="sendScript">送出</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-head">
          <div class="panel-title">腳本分段 / 時間軸</div>
          <div class="settings" style="gap:8px">
            <button class="btn small" id="copyAllScript">複製全部</button>
            <button class="btn small" id="clearScript">清空</button>
          </div>
        </div>
        <div class="right-wrap">
          <div id="segmentsWrap" class="right-scroll"></div>
        </div>
      </div>
    </div>
  </section>

  <section id="page-copy" class="container" style="display:none">
    <!-- 你原本的文案頁維持；可日後合併到腳本文案頁 -->
  </section>

  <section id="page-guide" class="container" style="display:none; padding-top:16px">
    <article class="panel" style="padding:12px">
      <div class="panel-title" style="padding:12px">✍️ 說明／指南</div>
      <div style="padding:0 14px 14px; color:#475569">
        新手沒想法 → <b>引導模式</b> 先選「結構＋時長」，我會一步步問答並用知識庫給建議，最後生成腳本。<br/>
        已有想法 → <b>自由模式</b> 直接聊，我會依照知識庫與你的偏好回覆與調整。
      </div>
    </article>
  </section>

  <div id="toast" class="toast" style="position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;font-size:14px;box-shadow:0 6px 18px rgba(2,12,27,0.08);opacity:0;pointer-events:none;transition:opacity .25s;z-index:100;">已複製</div>

  <script>
  const API_BASE = 'https://aijobvideobackend.zeabur.app';
  const DEFAULT_USER_ID = localStorage.getItem('user_id') || (()=>{ const id=`web-${Math.random().toString(36).slice(2,8)}`; localStorage.setItem('user_id', id); return id; })();

  // ---- 狀態 ----
  const state = {
    userId: DEFAULT_USER_ID,
    scriptMode: 'guide',          // guide | free
    templateType: 'A',
    duration: 30,
    sessionIdScript: `web-${Math.random().toString(36).slice(2,8)}`,
    segments: []
  };

  // ---- 小工具 ----
  function fmtTS(d=new Date()){ const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`; }
  function escapeHTML(s){ return (s||'').replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }
  function showToast(m){ const t=document.getElementById('toast'); t.textContent=m; t.style.opacity=1; setTimeout(()=>t.style.opacity=0,1500); }
  function appendMsg(el, role, content){ const div=document.createElement('div'); div.className='msg '+(role==='user'?'user':''); div.innerHTML=`<div class="meta">${role} · ${fmtTS()}</div><div>${escapeHTML(content)}</div>`; el.appendChild(div); el.scrollTop=el.scrollHeight; }

  // ---- 初始：只顯示歡迎，不自動問 Q1/Q2 ----
  const chatScript = document.getElementById('chatScript');
  appendMsg(chatScript,'assistant','👋 歡迎使用腳本模式！\n— 新手沒想法 → 請用【引導模式】，先選結構＋時長，我會一步步問答並給建議。\n— 已有想法 → 切到【自由模式】直接聊，你說想做什麼，我來補齊腳本與畫面建議。');

  // ---- 模式切換 ----
  document.getElementById('modeGroup').addEventListener('change', e=>{
    if(e.target.name!=='scriptMode') return;
    state.scriptMode = e.target.value;
    document.getElementById('guideBar').style.display = (state.scriptMode==='guide')?'block':'none';
    renderChips();
  });

  // ---- 模板/時長選擇 ----
  document.getElementById('tplGroup').addEventListener('change', e=>{ if(e.target.name==='tpl') state.templateType=e.target.value; });
  document.getElementById('durGroup').addEventListener('change', e=>{ if(e.target.name==='dur') state.duration=parseInt(e.target.value,10); });

  // ---- 套用偏好：只記錄，不發訊息 ----
  document.getElementById('btnStartGuide').onclick = async ()=>{
    try{
      const body = { user_id: state.userId, template_type: state.templateType, duration: state.duration };
      const r = await fetch(`${API_BASE}/set_prefs`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
      if(!r.ok) throw new Error('設定失敗');
      showToast('已套用偏好（結構/秒數）');
    }catch(e){ showToast('設定失敗'); }
  };

  // ---- 展開/收合設定 ----
  document.getElementById('toggleSettingsScript').onclick=()=>{
    const box=document.getElementById('settingsScript'); const t=document.getElementById('toggleSettingsScript');
    const open = box.classList.contains('collapsed');
    box.classList.toggle('collapsed', !open);
    t.setAttribute('aria-expanded', open?'true':'false');
  };
  document.getElementById('userId').value=state.userId;
  document.getElementById('userId').onchange=e=>{ state.userId=e.target.value || DEFAULT_USER_ID; };

  // ---- 快速問題（依模式） ----
  function renderChips(){
    const wrap=document.getElementById('chipsScript'); wrap.innerHTML='';
    if(state.scriptMode==='guide'){
      const hint=document.createElement('span'); hint.style.color='#64748b'; hint.textContent='已套用的模板與時長 → 直接輸入主題開始對談'; wrap.appendChild(hint);
    }else{
      const list = [
        '幫我把這個想法拆成 60 秒腳本，Hook 要很強：',
        '先解釋 A~F 結構差異並建議我該選哪一種，主題：',
        '請用 6 段 60 秒，對白口語＋畫面具體，最後給 CTA：'
      ];
      list.forEach(q=>{ const b=document.createElement('button'); b.className='chip'; b.textContent=q; b.onclick=()=>{ const t=document.getElementById('inputScript'); t.value=q; t.focus(); }; wrap.appendChild(b); });
    }
  }
  renderChips();

  // ---- 送出 ----
  document.getElementById('sendScript').onclick = async ()=>{
    const textarea=document.getElementById('inputScript'); const text=(textarea.value||'').trim(); if(!text){ showToast('請先輸入內容'); return; }
    appendMsg(chatScript,'user',text); textarea.value='';

    // 引導：走 chat_qa（現在一開始不自動 Q1/Q2，首次訊息才進入）
    if(state.scriptMode==='guide'){
      try{
        const r=await fetch(`${API_BASE}/chat_qa`,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ session_id: state.sessionIdScript, user_id: state.userId, message: text }) });
        const j=await r.json();
        if(j.assistant_message) appendMsg(chatScript,'assistant',j.assistant_message);
        if(j.segments?.length) { state.segments=j.segments; renderSegments(); }
      }catch(e){ appendMsg(chatScript,'assistant','❌ 連線失敗'); }
      return;
    }

    // 自由：走 chat_generate + free
    try{
      const payload = {
        user_id: state.userId,
        session_id: state.sessionIdScript,
        mode: 'script',
        dialogue_mode: 'free',
        template_type: state.templateType || null,
        duration: state.duration || null,
        messages: [{ role:'user', content:text }],
        previous_segments: state.segments || []
      };
      const r=await fetch(`${API_BASE}/chat_generate`,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
      const j=await r.json();
      if(j.assistant_message) appendMsg(chatScript,'assistant',j.assistant_message);
      if(j.segments?.length){ state.segments=j.segments; renderSegments(); }
    }catch(e){ appendMsg(chatScript,'assistant','❌ 連線失敗'); }
  };

  // ---- 右側分段 ----
  const segmentsWrap=document.getElementById('segmentsWrap');
  function segmentToText(s){ return `(${s.start_sec||'?'}s–${s.end_sec||'?'}s) [${s.type||'-'}] camera:${s.camera||'-'}\n台詞:${s.dialog||''}\n畫面:${s.visual||''}\nCTA:${s.cta||''}`; }
  function renderSegments(){
    segmentsWrap.innerHTML='';
    if(!state.segments?.length){ const empty=document.createElement('div'); empty.className='segment-card'; empty.style.color='#64748b'; empty.textContent='尚無片段。請輸入更具體的秒數/場景/目標。'; segmentsWrap.appendChild(empty); return; }
    state.segments.forEach((s,i)=>{
      if(s.start_sec==null||s.end_sec==null){ s.start_sec=i*6; s.end_sec=i*6+6; }
      const card=document.createElement('div'); card.className='segment-card';
      card.innerHTML=`
        <div class="segment-head">
          <div class="seg-title">#${i+1} ${s.type||'segment'} <span class="seg-meta">${s.start_sec}s–${s.end_sec}s · 鏡位 ${s.camera||'-'}</span></div>
          <div class="seg-actions">
            <button class="btn small" data-act="copy" data-idx="${i}">複製</button>
            <button class="btn small" data-act="tweak" data-idx="${i}">微調</button>
            <button class="btn small" data-act="del" data-idx="${i}">刪除</button>
          </div>
        </div>
        <div style="color:#64748b">對白</div><div>${escapeHTML(s.dialog||'')}</div>
        <div style="color:#64748b;margin-top:6px">畫面感</div><div>${escapeHTML(s.visual||'')}</div>
        <div style="color:#64748b;margin-top:6px">CTA</div><div>${escapeHTML(s.cta||'')}</div>`;
      segmentsWrap.appendChild(card);
    });
  }
  segmentsWrap.onclick=e=>{
    const b=e.target.closest('button'); if(!b) return;
    const idx=+b.dataset.idx, seg=state.segments[idx];
    if(b.dataset.act==='copy'){ navigator.clipboard.writeText(segmentToText(seg)).then(()=>showToast('已複製囉！')); }
    if(b.dataset.act==='del'){ state.segments.splice(idx,1); renderSegments(); }
    if(b.dataset.act==='tweak'){
      const nd=prompt('微調對白（留空略過）',seg.dialog||''); if(nd!=null&&nd!=='') seg.dialog=nd;
      const nv=prompt('微調畫面（留空略過）',seg.visual||''); if(nv!=null&&nv!=='') seg.visual=nv;
      const nc=prompt('微調 CTA（留空略過）',seg.cta||''); if(nc!=null&&nc!=='') seg.cta=nc;
      renderSegments();
    }
  };
  document.getElementById('copyAllScript').onclick=()=>{ if(!state.segments?.length) return showToast('無可複製內容'); navigator.clipboard.writeText(state.segments.map(s=>segmentToText(s)).join('\n\n')).then(()=>showToast('已複製囉！')); };
  document.getElementById('clearScript').onclick=()=>{ state.segments=[]; renderSegments(); };

  // 初始 chips
  renderChips();
  </script>
</body>
</html>
