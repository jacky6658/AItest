<script>
// …前略：保持你原本的變數/函式…

// 依等級決定逾時（beginner 30s / intermediate 45s / advanced 60s）
function levelTimeoutMs(level){
  if (level === "advanced") return 60000;
  if (level === "intermediate") return 45000;
  return 30000;
}

// 具退避重試的呼叫（最多 3 次；1.0s, 2.0s 退避）
async function callApiWithRetry(payload, baseTimeoutMs){
  let lastErr;
  for (let attempt=1; attempt<=3; attempt++){
    const timeout = baseTimeoutMs + (attempt-1)*3000; // 第2/3次再各+3秒保險
    try{
      const res = await fetchWithTimeout(apiEndpoint, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload),
        mode: "cors",
        credentials: "omit"
      }, timeout);

      const raw = await res.text();
      let data = null;
      try{ data = JSON.parse(raw); }catch{}
      if (!res.ok){
        const msg = (data && (data.error || data.message || data.msg)) || raw || `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return data || { message:{ content: raw } };
    }catch(err){
      lastErr = err;
      const isAbortOrTimeout = err?.name === "AbortError" || /aborted|timeout/i.test(String(err));
      if (attempt < 3 && isAbortOrTimeout){
        // 指數退避：1s -> 2s
        await new Promise(r=>setTimeout(r, 1000 * Math.pow(2, attempt-1)));
        continue;
      }
      throw err;
    }
  }
  throw lastErr;
}

async function sendMessage(){
  if(chatLock) return;
  const input=byId("chatInput");
  const text=input.value.trim();
  if(!text) return;
  if(text.length>300){ alert("輸入內容過長，請簡化後再試。"); return; }

  input.value="";
  appendMe(text);
  chatLock=true;
  showLoading(true);

  const level = byId("userLevel").value;
  const payload = {
    user_id: userId,
    user_level: level,
    topic: byId("topic").value.trim(),
    action: window.currentAction || "copywriting",
    notes: byId("notes") ? byId("notes").value.trim() : "",
    messages
  };

  try{
    const data = await callApiWithRetry(payload, levelTimeoutMs(level));
    const ai = data?.message?.content ?? data?.message?.text ?? data?.reply ?? "（無回應內容）";
    messages.push({ role:"assistant", content: ai });
    appendAi(ai);
    if(ai && ai.length>10) lastAiDraft = ai;
  }catch(err){
    let msg = String(err?.message || err);
    if (err?.name === "AbortError" || /aborted|timeout/i.test(msg)){
      msg = "連線逾時或被中斷（可能是冷啟動／回應較長）。";
    }
    appendAi("⚠️ 服務延遲或連線被中斷：" + msg);
    console.error(err);
  }finally{
    showLoading(false);
    chatLock=false;
  }
}
</script>
