<!DOCTYPE html>
<html lang="zh-TW" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>AIJob短影音顧問智能</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- AI Points System - 內嵌樣式 -->
    <style>
        /* 點數系統樣式 */
        .points-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .points-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .points-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
        }
        .points-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
    </style>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Noto Sans TC', 'sans-serif'],
                    },
                    colors: {
                        primary: '#2563EB',
                        'primary-hover': '#1D4ED8',
                        secondary: '#16A34A',
                    }
                }
            }
        }
    </script>
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        /* iOS Safari 字體縮放與輸入框自動放大修正 */
        html { -webkit-text-size-adjust: 100%; }
        /* Safe Area 變數與工具 */
        :root{
          --safe-left: env(safe-area-inset-left, 0px);
          --safe-right: env(safe-area-inset-right, 0px);
          --safe-top: env(safe-area-inset-top, 0px);
          --safe-bottom: env(safe-area-inset-bottom, 0px);
        }
        .safe-x{ padding-left: max(1rem, var(--safe-left)); padding-right: max(1rem, var(--safe-right)); }
        .safe-t{ padding-top: var(--safe-top); }
        .safe-b{ padding-bottom: var(--safe-bottom); }
        /* 鎖背景捲動：登入彈窗開啟時在 <html> 加上 modal-open */
        html.modal-open, html.modal-open body { overflow: hidden; }
        @media (max-width: 480px) {
          input, textarea, select { font-size: 16px !important; }
        }
        .btn-chip {
            padding: 6px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 9999px;
            background: #fff;
            color: #374151;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 13px;
            font-weight: 500;
        }
        .btn-chip:hover {
            border-color: #3b82f6;
            color: #3b82f6;
            background: #f8fafc;
        }
        .dark .btn-chip {
            background: #374151;
            color: #d1d5db;
            border-color: #4b5563;
        }
        .dark .btn-chip:hover {
            border-color: #3b82f6;
            color: #3b82f6;
            background: #1f2937;
        }
        /* 媒體元素防止橫向溢出（iOS Safari 友好） */
        img, video, canvas, svg { max-width: 100%; height: auto; }
    </style>
</head>
<body class="font-sans bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-150">
    <!-- Toast 容器 -->
    <div id="toast-container" class="fixed inset-0 z-50 flex flex-col items-center justify-center gap-3 pointer-events-none"></div>

    <!-- 頂部導覽列 -->
    <nav class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 sticky top-0 z-40 safe-x safe-t">
        <div class="max-w-7xl mx-auto w-full">
            <div class="flex justify-between items-center h-16 relative">
                <!-- Logo -->
                <div class="flex items-center">
                    <a href="#!home" class="focus:outline-none" data-page="home">
                        <h1 class="font-bold text-primary dark:text-white text-lg sm:text-xl md:text-2xl leading-tight">AIJob短影音顧問智能</h1>
                    </a>
                </div>
                
                <!-- 導覽連結 -->
                <div class="hidden md:flex space-x-8" id="nav-links">
                    <a href="#!home" class="nav-link text-gray-700 dark:text-gray-300 hover:text-primary transition-colors duration-150" data-page="home">首頁</a>
                    <a href="#!positioning" class="nav-link text-gray-700 dark:text-gray-300 hover:text-primary transition-colors duration-150" data-page="positioning">AI短影音定位顧問</a>
                    <a href="#!ideation" class="nav-link text-gray-700 dark:text-gray-300 hover:text-primary transition-colors duration-150" data-page="ideation">AI選題小助手</a>
                    <a href="#!script" class="nav-link text-gray-700 dark:text-gray-300 hover:text-primary transition-colors duration-150" data-page="script">AI腳本生成大師</a>
                    <a href="#!guide" class="nav-link text-gray-700 dark:text-gray-300 hover:text-primary transition-colors duration-150" data-page="guide">說明/指南</a>
                </div>

                <!-- 右側按鈕群 -->
                <div class="flex items-center space-x-2 md:space-x-4">
                    <!-- 手機選單 -->
                    <button id="mobile-menu-btn" class="md:hidden p-2 rounded-lg hover:bg-gray-100 hover:text-gray-900 dark:hover:bg-gray-700 dark:hover:text-gray-100 focus:outline-none focus:ring-2 focus:ring-primary" aria-label="開啟選單">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                    </button>
                    <!-- 暗色模式切換 -->
                    <button id="theme-toggle" class="p-2 rounded-lg hover:bg-gray-100 hover:text-gray-900 dark:hover:bg-gray-700 dark:hover:text-gray-100 transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-gray-800" aria-label="切換暗色模式">
                        <svg id="theme-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path id="sun-icon" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                            <path id="moon-icon" class="hidden" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                        </svg>
                    </button>
                    
                    <!-- Credits 顯示（登入後才顯示） -->
                    <div id="nav-credits-wrap" class="hidden items-center text-sm text-gray-500 dark:text-gray-400">
                        <span>Credits: <span id="nav-credits">0</span></span>
                    </div>
                    
                    <!-- 登入按鈕（最右側） -->
                    <div class="relative">
                        <button id="login-btn" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                            登入
                        </button>
                        <!-- 登入後的下拉選單 -->
                        <div id="user-dropdown" class="absolute right-0 top-full mt-2 w-64 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg hidden z-50">
                            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-orange-500 rounded-full flex items-center justify-center text-white font-semibold">
                                        <span id="user-avatar">G</span>
                                    </div>
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900 dark:text-white" id="user-name">Google 用戶</div>
                                        <div class="text-sm text-gray-500 dark:text-gray-400" id="user-email">user@gmail.com</div>
                                    </div>
                                    <button class="text-gray-400 hover:text-gray-600">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="p-2">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">免費</span>
                                    <button class="bg-black text-white text-xs px-3 py-1 rounded hover:bg-gray-800 transition-colors" onclick="showPurchaseModal()">升級</button>
                                </div>
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center space-x-2">
                                        <svg class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                        </svg>
                                        <span class="text-sm text-gray-600 dark:text-gray-400">點數</span>
                                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <div class="flex items-center space-x-1">
                                        <span class="text-sm font-semibold">300</span>
                                        <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div class="space-y-1">
                                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 hover:text-gray-900 dark:hover:bg-gray-700 dark:hover:text-gray-100 rounded">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                        </svg>
                                        <span>知識</span>
                                    </a>
                                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 hover:text-gray-900 dark:hover:bg-gray-700 dark:hover:text-gray-100 rounded">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                        <span>帳戶</span>
                                    </a>
                                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 hover:text-gray-900 dark:hover:bg-gray-700 dark:hover:text-gray-100 rounded">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                        <span>設定</span>
                                    </a>
                                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 hover:text-gray-900 dark:hover:bg-gray-700 dark:hover:text-gray-100 rounded">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                                        </svg>
                                        <span>首頁</span>
                                        <svg class="w-3 h-3 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                        </svg>
                                    </a>
                                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 hover:text-gray-900 dark:hover:bg-gray-700 dark:hover:text-gray-100 rounded">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span>獲取幫助</span>
                                        <svg class="w-3 h-3 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                        </svg>
                                    </a>
                                </div>
                                <div class="border-t border-gray-200 dark:border-gray-700 mt-2 pt-2">
                                    <button id="logout-btn" class="flex items-center space-x-3 px-3 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-gray-700 rounded w-full">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                        </svg>
                                        <span>登出</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 手機下拉選單 -->
            <div id="mobile-menu" class="md:hidden hidden border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
                <div class="px-4 py-3 space-y-2">
                    <a href="#!home" class="block nav-link text-gray-700 dark:text-gray-300 hover:text-primary transition-colors duration-150" data-page="home">首頁</a>
                    <a href="#!positioning" class="block nav-link text-gray-700 dark:text-gray-300 hover:text-primary transition-colors duration-150" data-page="positioning">AI短影音定位顧問</a>
                    <a href="#!ideation" class="block nav-link text-gray-700 dark:text-gray-300 hover:text-primary transition-colors duration-150" data-page="ideation">AI選題小助手</a>
                    <a href="#!script" class="block nav-link text-gray-700 dark:text-gray-300 hover:text-primary transition-colors duration-150" data-page="script">AI腳本生成大師</a>
                    <a href="#!guide" class="block nav-link text-gray-700 dark:text-gray-300 hover:text-primary transition-colors duration-150" data-page="guide">說明/指南</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- 帳號側邊抽屜（登入後） -->
    <div id="drawer-overlay" class="fixed inset-0 bg-black/40 hidden z-40"></div>
    <aside id="account-drawer" class="fixed right-0 top-0 h-full w-80 bg-white dark:bg-gray-800 border-l border-gray-200 dark:border-gray-700 transform translate-x-full transition-transform duration-200 z-50">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div id="acc-avatar" class="w-10 h-10 rounded-full bg-orange-500 text-white flex items-center justify-center font-semibold">A</div>
                <div>
                    <div id="acc-name" class="font-semibold text-gray-900 dark:text-white">使用者</div>
                    <div id="acc-email" class="text-sm text-gray-500 dark:text-gray-400">user@email.com</div>
                </div>
            </div>
            <button id="drawer-close" class="p-2 rounded hover:bg-gray-100 hover:text-gray-900 dark:hover:bg-gray-700 dark:hover:text-gray-100" aria-label="關閉">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>
        <div class="p-4 space-y-4">
            <!-- 方案狀態區塊 -->
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 space-y-3">
            <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">方案狀態</span>
                    <span id="acc-plan" class="text-xs px-2 py-1 rounded bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300">免費</span>
            </div>
                <button id="acc-upgrade" class="w-full px-3 py-2 text-xs bg-black text-white rounded hover:bg-gray-800 transition-colors" onclick="showPurchaseModal()">
                    升級方案
                </button>
            </div>

            <!-- 點數資訊區塊 -->
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 space-y-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <svg class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                        </svg>
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">點數餘額</span>
                    </div>
                    <span id="acc-credits" class="text-lg font-bold text-primary">300</span>
                </div>
                
                <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
                    <span>免費點數</span>
                    <span id="acc-free-credits">0</span>
                </div>
                
                <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
                    <span>每日刷新積分</span>
                    <span>每天 00:00 刷新為 300</span>
                </div>
            </div>

            <!-- 使用統計區塊 -->
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 space-y-3">
                <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">本月使用統計</h4>
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-gray-500 dark:text-gray-400">定位顧問</span>
                        <span id="acc-positioning-count" class="font-medium">0 次</span>
                    </div>
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-gray-500 dark:text-gray-400">選題助手</span>
                        <span id="acc-topics-count" class="font-medium">0 次</span>
                    </div>
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-gray-500 dark:text-gray-400">腳本生成</span>
                        <span id="acc-script-count" class="font-medium">0 次</span>
                    </div>
                </div>
            </div>
            <nav class="pt-2 space-y-1 text-gray-700 dark:text-gray-300">
                <a href="#" class="flex items-center justify-between px-3 py-2 rounded hover:bg-gray-100 hover:text-gray-900 dark:hover:bg-gray-700 dark:hover:text-gray-100">
                    <span>知識</span>
                </a>
                <a href="#" class="flex items-center justify-between px-3 py-2 rounded hover:bg-gray-100 hover:text-gray-900 dark:hover:bg-gray-700 dark:hover:text-gray-100">
                    <span>帳戶</span>
                </a>
                <a href="#" class="flex items-center justify-between px-3 py-2 rounded hover:bg-gray-100 hover:text-gray-900 dark:hover:bg-gray-700 dark:hover:text-gray-100">
                    <span>設定</span>
                </a>
                <a href="#!home" class="flex items-center justify-between px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700">
                    <span>首頁</span>
                </a>
                <a href="#" class="flex items-center justify-between px-3 py-2 rounded hover:bg-gray-100 hover:text-gray-900 dark:hover:bg-gray-700 dark:hover:text-gray-100">
                    <span>獲取幫助</span>
                </a>
            </nav>
        </div>
        <div class="mt-auto p-4 border-t border-gray-200 dark:border-gray-700">
            <button id="drawer-logout-btn" class="w-full flex items-center justify-center gap-2 px-4 py-2 rounded bg-red-50 text-red-600 hover:bg-red-100 dark:bg-gray-700 dark:text-red-400">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                登出
            </button>
        </div>
    </aside>


    <!-- 購買彈窗 -->
    <div id="purchase-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[100] hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full max-h-[80vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-white">選擇訂閱方案</h3>
                    <button onclick="closePurchaseModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div id="purchase-plans" class="space-y-4">
                    <!-- 方案選項將由JavaScript動態生成 -->
                </div>
                
                <div class="mt-6 text-center">
                    <button onclick="closePurchaseModal()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 付款頁面 -->
    <div id="payment-page" class="fixed inset-0 bg-gray-50 dark:bg-gray-900 z-[100] hidden overflow-y-auto">
        <div class="min-h-screen flex items-center justify-center p-3 sm:p-4 safe-x safe-t safe-b">
            <div class="max-w-2xl w-full">
                <!-- 付款頁面標題 -->
                <div class="relative text-center mb-6 sm:mb-8">
                    <!-- 手機版關閉按鈕 -->
                    <button id="payment-close-mobile" class="absolute left-0 top-0 md:hidden p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white mb-2">完成付款</h1>
                    <p class="text-sm sm:text-base text-gray-600 dark:text-gray-400">選擇您的付款方式來完成購買</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8">
                    <!-- 左側：訂單詳情 -->
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-4 sm:p-6">
                        <h2 class="text-lg sm:text-xl font-semibold text-gray-900 dark:text-white mb-4">訂單詳情</h2>
                        
                        <!-- 選中的方案 -->
                        <div id="selected-plan" class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 sm:p-4 mb-4">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0">
                                <div class="flex-1">
                                    <h3 id="plan-name" class="font-medium text-gray-900 dark:text-white text-base sm:text-lg">標準包</h3>
                                    <p id="plan-description" class="text-xs sm:text-sm text-gray-500 dark:text-gray-400">1,000 點數</p>
                                </div>
                                <div class="text-left sm:text-right">
                                    <div id="plan-price" class="text-lg sm:text-xl font-bold text-primary">NT$ 1,099</div>
                                    <div id="plan-credits" class="text-xs sm:text-sm text-gray-500 dark:text-gray-400">1,000 點數</div>
                                </div>
                            </div>
                        </div>

                        <!-- 訂單摘要 -->
                        <div class="space-y-3">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600 dark:text-gray-400">方案費用</span>
                                <span id="subtotal" class="text-gray-900 dark:text-white">NT$ 1,099</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600 dark:text-gray-400">手續費</span>
                                <span class="text-gray-900 dark:text-white">NT$ 0</span>
                            </div>
                            <div class="border-t border-gray-200 dark:border-gray-700 pt-3">
                                <div class="flex justify-between text-lg font-semibold">
                                    <span class="text-gray-900 dark:text-white">總計</span>
                                    <span id="total-amount" class="text-primary">NT$ 1,099</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 右側：付款方式 -->
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-4 sm:p-6">
                        <h2 class="text-lg sm:text-xl font-semibold text-gray-900 dark:text-white mb-4">選擇付款方式</h2>
                        
                        <div class="space-y-3 sm:space-y-4">
                            <!-- 信用卡 -->
                            <label class="flex items-center p-3 sm:p-4 border border-gray-200 dark:border-gray-700 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors active:bg-gray-100 dark:active:bg-gray-600">
                                <input type="radio" name="payment-method" value="credit-card" class="sr-only" checked>
                                <div class="flex items-center space-x-3 w-full">
                                    <div class="w-5 h-5 sm:w-6 sm:h-6 border-2 border-primary rounded-full flex items-center justify-center flex-shrink-0">
                                        <div class="w-2 h-2 sm:w-3 sm:h-3 bg-primary rounded-full"></div>
                                    </div>
                                    <div class="flex items-center space-x-2 flex-1">
                                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-gray-600 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2zm0 2v12h16V6H4zm2 2h12v2H6V8zm0 4h8v2H6v-2z"/>
                                        </svg>
                                        <span class="text-gray-900 dark:text-white text-sm sm:text-base">信用卡</span>
                                    </div>
                                </div>
                            </label>

                            <!-- LINE Pay -->
                            <label class="flex items-center p-3 sm:p-4 border border-gray-200 dark:border-gray-700 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors active:bg-gray-100 dark:active:bg-gray-600">
                                <input type="radio" name="payment-method" value="line-pay" class="sr-only">
                                <div class="flex items-center space-x-3 w-full">
                                    <div class="w-5 h-5 sm:w-6 sm:h-6 border-2 border-gray-300 dark:border-gray-600 rounded-full flex-shrink-0"></div>
                                    <div class="flex items-center space-x-2 flex-1">
                                        <div class="w-5 h-5 sm:w-6 sm:h-6 bg-green-500 rounded flex items-center justify-center flex-shrink-0">
                                            <span class="text-white text-xs font-bold">L</span>
                                        </div>
                                        <span class="text-gray-900 dark:text-white text-sm sm:text-base">LINE Pay</span>
                                    </div>
                                </div>
                            </label>

                            <!-- 街口支付 -->
                            <label class="flex items-center p-3 sm:p-4 border border-gray-200 dark:border-gray-700 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors active:bg-gray-100 dark:active:bg-gray-600">
                                <input type="radio" name="payment-method" value="jkopay" class="sr-only">
                                <div class="flex items-center space-x-3 w-full">
                                    <div class="w-5 h-5 sm:w-6 sm:h-6 border-2 border-gray-300 dark:border-gray-600 rounded-full flex-shrink-0"></div>
                                    <div class="flex items-center space-x-2 flex-1">
                                        <div class="w-5 h-5 sm:w-6 sm:h-6 bg-blue-500 rounded flex items-center justify-center flex-shrink-0">
                                            <span class="text-white text-xs font-bold">街</span>
                                        </div>
                                        <span class="text-gray-900 dark:text-white text-sm sm:text-base">街口支付</span>
                                    </div>
                                </div>
                            </label>

                            <!-- ATM轉帳 -->
                            <label class="flex items-center p-3 sm:p-4 border border-gray-200 dark:border-gray-700 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors active:bg-gray-100 dark:active:bg-gray-600">
                                <input type="radio" name="payment-method" value="atm" class="sr-only">
                                <div class="flex items-center space-x-3 w-full">
                                    <div class="w-5 h-5 sm:w-6 sm:h-6 border-2 border-gray-300 dark:border-gray-600 rounded-full flex-shrink-0"></div>
                                    <div class="flex items-center space-x-2 flex-1">
                                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-gray-600 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 2v2H4V6h16zm0 4v6H4v-6h16z"/>
                                        </svg>
                                        <span class="text-gray-900 dark:text-white text-sm sm:text-base">ATM轉帳</span>
                                    </div>
                                </div>
                            </label>
                        </div>

                        <!-- 付款按鈕 -->
                        <div class="mt-6 sm:mt-8 space-y-3 sm:space-y-4">
                            <button id="proceed-payment" class="w-full bg-primary text-white py-3 sm:py-4 px-6 rounded-lg hover:bg-primary-hover transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 active:bg-primary-hover text-sm sm:text-base font-medium">
                                確認付款
                            </button>
                            <button id="back-to-plans" class="w-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 py-3 sm:py-4 px-6 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors duration-200 active:bg-gray-200 dark:active:bg-gray-600 text-sm sm:text-base">
                                返回選擇方案
                            </button>
                        </div>

                        <!-- 安全提示 -->
                        <div class="mt-4 sm:mt-6 text-center">
                            <div class="flex items-center justify-center space-x-2 text-xs sm:text-sm text-gray-500 dark:text-gray-400">
                                <svg class="w-3 h-3 sm:w-4 sm:h-4 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>
                                </svg>
                                <span>安全加密，保障您的付款安全</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 帳戶視窗 -->
    <div id="account-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[100] hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <!-- 標題列 -->
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">帳戶管理</h2>
                    <button id="account-modal-close" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- 左側：個人資料 -->
                    <div class="space-y-6">
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">個人資料</h3>
                            
                            <!-- 頭像區域 -->
                            <div class="flex items-center space-x-4 mb-6">
                                <div id="account-avatar-large" class="w-16 h-16 rounded-full bg-orange-500 text-white flex items-center justify-center font-bold text-xl">A</div>
                                <div>
                                    <button class="text-sm text-primary hover:text-primary-hover">更換頭像</button>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">支援 JPG, PNG 格式</p>
                                </div>
                            </div>

                            <!-- 基本資料表單 -->
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">姓名</label>
                                    <input type="text" id="account-name-input" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-800 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="請輸入姓名">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">電子郵件</label>
                                    <input type="email" id="account-email-input" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-800 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="請輸入電子郵件" readonly>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">電話號碼</label>
                                    <input type="tel" id="account-phone-input" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-800 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="請輸入電話號碼">
                                </div>
                            </div>

                            <div class="mt-6 flex space-x-3">
                                <button id="save-profile" class="flex-1 bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary-hover transition-colors">儲存變更</button>
                                <button id="cancel-profile" class="flex-1 bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-300 py-2 px-4 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-500 transition-colors">取消</button>
                            </div>
                        </div>

                        <!-- 密碼變更 -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">密碼設定</h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">目前密碼</label>
                                    <input type="password" id="current-password" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-800 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="請輸入目前密碼">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">新密碼</label>
                                    <input type="password" id="new-password" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-800 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="請輸入新密碼">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">確認新密碼</label>
                                    <input type="password" id="confirm-password" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-800 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="請再次輸入新密碼">
                                </div>
                            </div>

                            <div class="mt-6">
                                <button id="change-password" class="w-full bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">變更密碼</button>
                            </div>
                        </div>
                    </div>

                    <!-- 右側：帳戶資訊 -->
                    <div class="space-y-6">
                        <!-- 方案資訊 -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">方案資訊</h3>
                            
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">目前方案</span>
                                    <span id="account-current-plan" class="px-3 py-1 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-full text-sm">免費</span>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">點數餘額</span>
                                    <span id="account-current-credits" class="text-lg font-bold text-primary">300</span>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">註冊日期</span>
                                    <span id="account-register-date" class="text-gray-900 dark:text-white">2024-01-15</span>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">最後登入</span>
                                    <span id="account-last-login" class="text-gray-900 dark:text-white">2024-01-20 14:30</span>
                                </div>
                            </div>

                            <div class="mt-6 space-y-2">
                                <button id="upgrade-plan-btn" class="w-full bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary-hover transition-colors">升級方案</button>
                                <button id="quick-charge-btn" class="w-full bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">⚡ 快速充值</button>
                            </div>
                        </div>

                        <!-- 使用統計 -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">使用統計</h3>
                            
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">本月使用次數</span>
                                    <span id="account-monthly-usage" class="text-gray-900 dark:text-white">15 次</span>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">定位顧問</span>
                                    <span id="account-positioning-usage" class="text-gray-900 dark:text-white">5 次</span>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">選題助手</span>
                                    <span id="account-topics-usage" class="text-gray-900 dark:text-white">6 次</span>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">腳本生成</span>
                                    <span id="account-script-usage" class="text-gray-900 dark:text-white">4 次</span>
                                </div>
                            </div>
                        </div>

                        <!-- 帳戶操作 -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">帳戶操作</h3>
                            
                            <div class="space-y-3">
                                <button id="export-data" class="w-full text-left px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-lg transition-colors">
                                    <div class="flex items-center space-x-3">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <span>匯出資料</span>
                                    </div>
                                </button>
                                
                                <button id="delete-account" class="w-full text-left px-4 py-3 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors">
                                    <div class="flex items-center space-x-3">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                        <span>刪除帳戶</span>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 設定視窗 -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[100] hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <!-- 標題列 -->
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">系統設定</h2>
                    <button id="settings-modal-close" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- 左側：一般設定 -->
                    <div class="space-y-6">
                        <!-- 外觀設定 -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">外觀設定</h3>
                            
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="text-sm font-medium text-gray-900 dark:text-white">深色模式</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400">切換深色/淺色主題</div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="dark-mode-toggle" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/25 dark:peer-focus:ring-primary/25 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                                    </label>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="text-sm font-medium text-gray-900 dark:text-white">自動切換</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400">根據系統時間自動切換主題</div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="auto-theme-toggle" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/25 dark:peer-focus:ring-primary/25 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- 通知設定 -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">通知設定</h3>
                            
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="text-sm font-medium text-gray-900 dark:text-white">電子郵件通知</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400">接收重要更新和活動通知</div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="email-notifications" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/25 dark:peer-focus:ring-primary/25 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                                    </label>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="text-sm font-medium text-gray-900 dark:text-white">點數不足提醒</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400">點數即將用完時提醒</div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="credit-alerts" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/25 dark:peer-focus:ring-primary/25 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                                    </label>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="text-sm font-medium text-gray-900 dark:text-white">功能更新通知</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400">新功能和改進通知</div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="feature-updates" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/25 dark:peer-focus:ring-primary/25 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 右側：進階設定 -->
                    <div class="space-y-6">
                        <!-- 隱私設定 -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">隱私設定</h3>
                            
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="text-sm font-medium text-gray-900 dark:text-white">資料分析</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400">允許匿名使用資料改善服務</div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="data-analytics" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/25 dark:peer-focus:ring-primary/25 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                                    </label>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="text-sm font-medium text-gray-900 dark:text-white">使用記錄</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400">儲存使用記錄以提供個人化服務</div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="usage-tracking" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/25 dark:peer-focus:ring-primary/25 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- 語言設定 -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">語言設定</h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">介面語言</label>
                                    <select id="language-select" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-800 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <option value="zh-TW">繁體中文</option>
                                        <option value="zh-CN">简体中文</option>
                                        <option value="en">English</option>
                                        <option value="ja">日本語</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">時區</label>
                                    <select id="timezone-select" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-800 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <option value="Asia/Taipei">台北時間 (UTC+8)</option>
                                        <option value="Asia/Shanghai">北京時間 (UTC+8)</option>
                                        <option value="Asia/Tokyo">東京時間 (UTC+9)</option>
                                        <option value="America/New_York">紐約時間 (UTC-5)</option>
                                        <option value="Europe/London">倫敦時間 (UTC+0)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- 系統資訊 -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">系統資訊</h3>
                            
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">版本</span>
                                    <span class="text-gray-900 dark:text-white">v1.0.0</span>
                                </div>
                                
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">最後更新</span>
                                    <span class="text-gray-900 dark:text-white">2024-01-20</span>
                                </div>
                                
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">瀏覽器</span>
                                    <span class="text-gray-900 dark:text-white" id="browser-info">Chrome 120.0</span>
                                </div>
                                
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">作業系統</span>
                                    <span class="text-gray-900 dark:text-white" id="os-info">Windows 11</span>
                                </div>
                            </div>
                        </div>

                        <!-- 操作按鈕 -->
                        <div class="flex space-x-3">
                            <button id="save-settings" class="flex-1 bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary-hover transition-colors">儲存設定</button>
                            <button id="reset-settings" class="flex-1 bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-300 py-2 px-4 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-500 transition-colors">重設</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 快速充值視窗 -->
    <div id="quick-charge-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[100] hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full">
            <div class="p-6">
                <!-- 標題列 -->
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">⚡ 快速充值</h2>
                    <button id="quick-charge-close" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- 充值選項 -->
                <div class="space-y-4">
                    <div class="text-center text-gray-600 dark:text-gray-400 mb-4">
                        選擇充值點數包
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button class="charge-option p-4 border border-gray-200 dark:border-gray-600 rounded-lg hover:border-primary hover:bg-primary/5 transition-colors" data-credits="100">
                            <div class="text-center">
                                <div class="text-lg font-bold text-primary">100</div>
                                <div class="text-xs text-gray-500">點數</div>
                            </div>
                        </button>
                        
                        <button class="charge-option p-4 border border-gray-200 dark:border-gray-600 rounded-lg hover:border-primary hover:bg-primary/5 transition-colors" data-credits="500">
                            <div class="text-center">
                                <div class="text-lg font-bold text-primary">500</div>
                                <div class="text-xs text-gray-500">點數</div>
                            </div>
                        </button>
                        
                        <button class="charge-option p-4 border border-gray-200 dark:border-gray-600 rounded-lg hover:border-primary hover:bg-primary/5 transition-colors" data-credits="1000">
                            <div class="text-center">
                                <div class="text-lg font-bold text-primary">1,000</div>
                                <div class="text-xs text-gray-500">點數</div>
                            </div>
                        </button>
                        
                        <button class="charge-option p-4 border border-gray-200 dark:border-gray-600 rounded-lg hover:border-primary hover:bg-primary/5 transition-colors" data-credits="5000">
                            <div class="text-center">
                                <div class="text-lg font-bold text-primary">5,000</div>
                                <div class="text-xs text-gray-500">點數</div>
                            </div>
                        </button>
                    </div>
                    
                    <!-- 自定義金額 -->
                    <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">自定義金額</label>
                        <div class="flex space-x-2">
                            <input type="number" id="custom-credits" placeholder="輸入點數" min="1" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-800 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                            <button id="custom-charge-btn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-hover transition-colors">充值</button>
                        </div>
                    </div>
                </div>

                <!-- 結果顯示 -->
                <div id="charge-result" class="mt-4 p-3 rounded-lg hidden"></div>
            </div>
        </div>
    </div>

    <!-- Email 登入/註冊 全畫面頁（新） -->
    <div id="email-auth-page" class="fixed inset-0 hidden z-[100]">
        <div id="email-auth-overlay" class="absolute inset-0 bg-gray-900/60"></div>
        <div class="absolute inset-0 flex items-center justify-center p-3 sm:p-4">
            <div class="w-full max-w-2xl bg-white dark:bg-gray-800 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 overflow-y-auto max-h-[80vh]">
                <div class="flex items-center justify-between px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center gap-3">
                        <h3 class="text-lg font-semibold">Email 登入 / 註冊</h3>
                        <span class="text-xs px-2 py-1 rounded bg-primary text-white">Beta</span>
                    </div>
                    <button id="email-auth-close" class="p-2 rounded hover:bg-gray-100 hover:text-gray-900 dark:hover:bg-gray-700 dark:hover:text-gray-100" aria-label="關閉">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2">
                    <!-- 左：登入 -->
                    <div class="p-4 sm:p-6 border-b md:border-b-0 md:border-r border-gray-200 dark:border-gray-700">
                        <div class="mb-4">
                            <h4 class="font-semibold mb-1">已有帳號？登入</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">輸入 Email 或 帳號 與密碼登入。</p>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm mb-1">Email 或 帳號</label>
                                <input id="login-identifier" type="text" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700" placeholder="you@example.com 或 yourname"/>
                            </div>
                            <div>
                                <label class="block text-sm mb-1">密碼</label>
                                <div class="flex items-center gap-2">
                                    <input id="login-password" type="password" class="flex-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700" placeholder="********"/>
                                    <button id="toggle-login-pw" type="button" class="px-2 py-2 rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-50 hover:text-gray-900 dark:hover:bg-gray-700 dark:hover:text-gray-100" aria-label="顯示/隱藏密碼">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8Z"/><circle cx="12" cy="12" r="3"/></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="pt-2 flex flex-wrap items-center justify-end gap-2">
                                <button id="btn-email-login" class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-primary-hover w-full sm:w-auto">登入</button>
                            </div>
                            <div class="flex items-center gap-3 pt-3">
                                <div class="h-px bg-gray-200 dark:bg-gray-700 flex-1"></div>
                                <span class="text-xs text-gray-500">或</span>
                                <div class="h-px bg-gray-200 dark:bg-gray-700 flex-1"></div>
                            </div>
                            <button id="btn-google-login" class="mt-2 w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-50 hover:text-gray-900 dark:hover:bg-gray-700 dark:hover:text-gray-100 flex items-center justify-center gap-2">
                                <span>使用 Google 登入</span>
                            </button>
                        </div>
                    </div>
                    <!-- 右：註冊 -->
                    <div class="p-4 sm:p-6">
                        <div class="mb-4">
                            <h4 class="font-semibold mb-1">沒有帳號？註冊</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">建立帳號需填寫電話、Email、帳號與密碼。</p>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm mb-1">電話</label>
                                <input id="signup-phone" type="tel" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700" placeholder="09xx-xxx-xxx"/>
                            </div>
                            <div>
                                <label class="block text-sm mb-1">Email</label>
                                <input id="signup-email" type="email" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700" placeholder="you@example.com"/>
                            </div>
                            <div>
                                <label class="block text-sm mb-1">帳號</label>
                                <input id="signup-username" type="text" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700" placeholder="yourname"/>
                            </div>
                            <div>
                                <label class="block text-sm mb-1">密碼</label>
                                <div class="flex items-center gap-2">
                                    <input id="signup-password" type="password" class="flex-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700" placeholder="********"/>
                                    <button id="toggle-signup-pw" type="button" class="px-2 py-2 rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-50 hover:text-gray-900 dark:hover:bg-gray-700 dark:hover:text-gray-100" aria-label="顯示/隱藏密碼">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8Z"/><circle cx="12" cy="12" r="3"/></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="pt-2 flex flex-wrap items-center justify-end gap-2">
                                <button id="btn-email-signup" class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-50 hover:text-gray-900 dark:hover:bg-gray-700 dark:hover:text-gray-100 w-full sm:w-auto">建立帳號</button>
                            </div>
                            <div class="flex items-center gap-3 pt-3">
                                <div class="h-px bg-gray-200 dark:bg-gray-700 flex-1"></div>
                                <span class="text-xs text-gray-500">或</span>
                                <div class="h-px bg-gray-200 dark:bg-gray-700 flex-1"></div>
                            </div>
                            <button id="btn-google-signup" class="mt-2 w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center justify-center gap-2">
                                <span>使用 Google 註冊</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 主要內容區域 -->
    <main class="min-h-screen bg-gray-50 dark:bg-gray-900">
        <!-- 首頁 -->
        <div id="page-home" class="page hidden">
            <!-- Hero 區 -->
            <section class="bg-gradient-to-br from-primary to-primary-hover text-white py-20">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                    <h2 class="text-4xl md:text-6xl font-bold mb-6">內容創作，從此簡單</h2>
                    <p class="text-xl md:text-2xl mb-8 opacity-90">三款專業工具，助您打造優質內容</p>
                </div>
            </section>

            <!-- 工具卡片區 -->
            <section class="py-16">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="grid md:grid-cols-3 gap-8">
                        <!-- 定位助手卡片 -->
                        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 hover:shadow-xl transition-all duration-150 active:scale-95">
                            <div class="text-4xl mb-4">🎯</div>
                            <h3 class="text-2xl font-bold mb-4">AI短影音定位顧問</h3>
                            <p class="text-gray-600 dark:text-gray-400 mb-6">透過引導式問答，幫您找到最適合的品牌定位與語氣風格</p>
                            <a href="#!positioning" class="block w-full bg-primary text-white text-center py-3 px-6 rounded-lg hover:bg-primary-hover transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                                開始使用
                            </a>
                        </div>

                        <!-- 選題助手卡片 -->
                        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 hover:shadow-xl transition-all duration-150 active:scale-95">
                            <div class="text-4xl mb-4">💡</div>
                            <h3 class="text-2xl font-bold mb-4">AI選題小助手</h3>
                            <p class="text-gray-600 dark:text-gray-400 mb-6">輸入主題關鍵字，自動產生多個吸睛的內容角度與切入點</p>
                            <a href="#!ideation" class="block w-full bg-primary text-white text-center py-3 px-6 rounded-lg hover:bg-primary-hover transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                                開始使用
                            </a>
                        </div>

                        <!-- 腳本生成器卡片 -->
                        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 hover:shadow-xl transition-all duration-150 active:scale-95">
                            <div class="text-4xl mb-4">📝</div>
                            <h3 class="text-2xl font-bold mb-4">AI腳本生成大師</h3>
                            <p class="text-gray-600 dark:text-gray-400 mb-6">多種模板與時長選擇，快速生成專業的內容腳本</p>
                            <a href="#!script" class="block w-full bg-primary text-white text-center py-3 px-6 rounded-lg hover:bg-primary-hover transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                                開始使用
                            </a>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 訂閱方案區塊 -->
            <section class="py-16 bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-900">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="text-center mb-16">
                        <h2 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-6">
                            選擇適合您的方案
                        </h2>
                        <p class="text-xl text-gray-600 dark:text-gray-300 mb-8">
                            解鎖更多AI功能，提升創作效率
                        </p>
                        <div class="w-24 h-1 bg-primary mx-auto rounded-full"></div>
                    </div>

                    <!-- 點數包方案 -->
                    <div class="mb-16">
                        <h3 class="text-2xl font-bold text-center text-gray-900 dark:text-white mb-8">
                            💎 點數包方案
                        </h3>
                        <div class="grid md:grid-cols-3 gap-8" id="subscription-plans">
                            <!-- 方案卡片將由JavaScript動態生成 -->
                        </div>
                    </div>

                    <!-- 訂閱方案 -->
                    <div class="mb-16">
                        <h3 class="text-2xl font-bold text-center text-gray-900 dark:text-white mb-8">
                            🚀 訂閱方案
                        </h3>
                        <div class="grid md:grid-cols-3 gap-8" id="subscription-plans-advanced">
                            <!-- 進階方案卡片將由JavaScript動態生成 -->
                        </div>
                    </div>

                    <!-- 主要購買按鈕 -->
                    <div class="text-center">
                        <button id="purchase-btn" class="bg-gradient-to-r from-primary to-primary-hover text-white text-xl px-12 py-4 rounded-2xl hover:from-primary-hover hover:to-primary transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-primary focus:ring-opacity-50 shadow-2xl hover:shadow-primary/25 transform hover:-translate-y-1" onclick="showPurchaseModal()">
                            <span class="flex items-center justify-center gap-3">
                                💳 立即購買點數
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                                </svg>
                            </span>
                        </button>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-4">
                            安全支付 • 即時到帳 • 24/7 客服支援
                        </p>
                    </div>
                </div>
            </section>
            
            <!-- 客製化智能體 CTA -->
            <section class="pt-0 pb-8">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8">
                        <h3 class="text-2xl font-bold mb-2">想要客製化您的短影音 AI 智能體嗎？</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">需要專屬功能、品牌語氣、整合後端或流程自動化？我們可協助從規劃到上線。</p>
                        <a class="inline-block bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary-hover" target="_blank" href="https://AIJobschool.short.gy/E49kA8">與我們聯繫（LINE 官方）</a>
                    </div>
                </div>
            </section>
        </div>

        <!-- 定位助手頁面 -->
        <div id="page-positioning" class="page hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="grid lg:grid-cols-12 gap-8">
                    <!-- 左側表單 -->
                    <div id="positioning-left" class="space-y-6 lg:col-span-4">
                        <!-- 功能標題 -->
                        <div class="text-center mb-4">
                            <h2 id="positioning-title" class="text-2xl font-bold text-gray-900 dark:text-white">🎯 AI短影音定位顧問</h2>
                            <p id="positioning-description" class="text-sm text-gray-600 dark:text-gray-400 mt-1">直接與AI對話，描述你的業務與受眾，我會一步步引導你完成定位分析</p>
                        </div>
                        <!-- Tabs: AI 對話 / 一鍵生成 -->
                        <div id="positioning-tabs" class="flex flex-wrap md:flex-nowrap gap-2 mb-3 overflow-x-auto whitespace-nowrap">
                            <button id="tab-positioning-chat" class="shrink-0 px-3 py-1.5 rounded-lg bg-primary text-white hover:bg-primary-hover">AI 對話</button>
                            <button id="tab-positioning-oneclick" class="shrink-0 px-3 py-1.5 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700">一鍵生成</button>
                        </div>
                        <form id="positioning-form" class="space-y-6">
                            <!-- 產業 -->
                            <div>
                                <label for="industry" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">產業類型 *</label>
                                <input type="text" id="industry" name="industry" required
                                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white transition-all duration-150"
                                    placeholder="例如：科技、教育、餐飲、金融...">
                            </div>

                            <!-- 目標受眾 -->
                            <div>
                                <label for="audience" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">目標受眾 *</label>
                                <input type="text" id="audience" name="audience" required
                                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white transition-all duration-150"
                                    placeholder="例如：25-35歲上班族、學生家長、小企業主...">
                            </div>

                            <!-- 主要痛點 -->
                            <div>
                                <label for="pains" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">主要痛點 *</label>
                                <textarea id="pains" name="pains" rows="4" required
                                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white transition-all duration-150"
                                    placeholder="描述您的目標受眾面臨的主要問題或挑戰..."></textarea>
                            </div>

                            <!-- 品牌語氣 -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">品牌語氣 *</label>
                                <div class="grid grid-cols-2 gap-3" role="radiogroup" aria-label="品牌語氣選擇">
                                    <label class="flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
                                        <input type="radio" name="tone" value="professional" class="sr-only" required>
                                        <div class="tone-option w-full text-center py-2">專業</div>
                                    </label>
                                    <label class="flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
                                        <input type="radio" name="tone" value="friendly" class="sr-only" required>
                                        <div class="tone-option w-full text-center py-2">親切</div>
                                    </label>
                                    <label class="flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
                                        <input type="radio" name="tone" value="humorous" class="sr-only" required>
                                        <div class="tone-option w-full text-center py-2">幽默</div>
                                    </label>
                                    <label class="flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
                                        <input type="radio" name="tone" value="authoritative" class="sr-only" required>
                                        <div class="tone-option w-full text-center py-2">權威</div>
                                    </label>
                                </div>
                            </div>

                            <!-- 競品分析 -->
                            <div>
                                <label for="competitors" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">競品分析（選填）</label>
                                <input type="text" id="competitors" name="competitors"
                                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white transition-all duration-150"
                                    placeholder="列出主要競爭對手...">
                            </div>

                            <button type="submit" id="positioning-submit"
                                class="w-full bg-primary text-white py-3 px-6 rounded-lg hover:bg-primary-hover transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed">
                                <span class="submit-text">生成定位摘要</span>
                                <span class="loading-text hidden">
                                    <svg class="loading-spinner w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    生成中...
                                </span>
                            </button>
                        </form>
                    </div>

                    <!-- 右側結果 -->
                    <div class="lg:col-span-8">
                        <!-- 定位 顧問聊天室（強化版） -->
                        <div class="mb-6">
                            <div id="positioning-chat-card" class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden flex flex-col min-h-[500px] md:min-h-[600px] mx-auto max-w-4xl">
                                <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 dark:border-gray-700">
                                    <h3 class="text-lg font-semibold">🎯 AI影音定位顧問</h3>
                                    <button id="chat-clear-positioning" class="text-sm px-3 py-1 rounded-md border border-gray-300 hover:bg-gray-50 dark:border-gray-600">清空對話</button>
                                </div>
                                <div id="chat-positioning" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50 dark:bg-gray-900"></div>
                                <div class="px-4 py-3 border-t border-gray-200 dark:border-gray-700">
                                    <div class="flex flex-wrap gap-2 mb-3 text-sm">
                                        <button class="chip-p btn-chip">業務類型定位</button>
                                        <button class="chip-p btn-chip">目標受眾分析</button>
                                        <button class="chip-p btn-chip">品牌形象定位</button>
                                        <button class="chip-p btn-chip">平台策略建議</button>
                                        <button class="chip-p btn-chip">內容目標設定</button>
                                        <button class="chip-p btn-chip">發文頻率規劃</button>
                                    </div>
                                    <div class="flex gap-2">
                                        <textarea id="chat-input-positioning" rows="2" class="flex-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700 resize-y" placeholder="告訴我你的業務、產品、目標或困惑...（Enter 送出；Shift+Enter 換行）"></textarea>
                                        <button id="chat-send-positioning" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-hover">分析</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="positioning-result" class="hidden">
                            <h3 class="text-xl font-bold mb-4">定位摘要</h3>
                            <div class="space-y-4">
                                <div id="positioning-loading" class="hidden text-center py-6 text-gray-500 dark:text-gray-400">
                                    <svg class="loading-spinner w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    AI 回覆中...
                                </div>
                                <div id="positioning-cards" class="space-y-4"></div>
                                </div>
                                </div>
                        
                        
                        <!-- 一鍵生成面板（沿用既有表單區塊作為一鍵生成輸入）-->
                        <div id="positioning-oneclick-panel" class="hidden">
                            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 min-h-[380px] md:min-h-[500px] flex items-center justify-center text-center">
                                <div>
                                <div class="text-6xl mb-4">🎯</div>
                                <h2 class="text-2xl sm:text-3xl font-bold mb-3">準備開始定位分析</h2>
                                <p class="text-gray-500 dark:text-gray-400">輸入必要資訊後，直接送出即可快速產生定位摘要。</p>
                                <div class="mt-4 space-y-2 text-primary">
                                  <button type="button" class="quick-example-btn hover:text-primary-hover">
                                    快速示例：科技新創公司
                                  </button><br/>
                                  <button type="button" class="quick-example-btn hover:text-primary-hover">
                                    快速示例：線上教育平台
                                  </button><br/>
                                  <button type="button" class="quick-example-btn hover:text-primary-hover">
                                    快速示例：健康食品品牌
                                  </button>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 選題助手頁面 -->
        <div id="page-ideation" class="page hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="grid lg:grid-cols-12 gap-8">
                    <!-- 左側表單 -->
                    <div id="ideation-left" class="space-y-6 lg:col-span-4">
                        <!-- 功能標題 -->
                        <div class="text-center mb-4">
                            <h2 id="ideation-title" class="text-2xl font-bold text-gray-900 dark:text-white">💡 AI選題小助手</h2>
                            <p id="ideation-description" class="text-sm text-gray-600 dark:text-gray-400 mt-1">直接與AI對話，描述你的主題與需求，我會一步步引導你完成選題分析</p>
                        </div>
                        <!-- Tabs: AI 對話 / 一鍵生成 -->
                        <div id="ideation-tabs" class="flex flex-wrap md:flex-nowrap gap-2 mb-3 overflow-x-auto whitespace-nowrap">
                            <button id="tab-ideation-chat" class="shrink-0 px-3 py-1.5 rounded-lg bg-primary text-white hover:bg-primary-hover">AI 對話</button>
                            <button id="tab-ideation-oneclick" class="shrink-0 px-3 py-1.5 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700">一鍵生成</button>
                        </div>
                        <form id="ideation-form" class="space-y-6">
                            <!-- 主題/關鍵字 -->
                            <div>
                                <label for="topic" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">主題/關鍵字 *</label>
                                <input type="text" id="topic" name="topic" required
                                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white transition-all duration-150"
                                    placeholder="例如：減肥、理財、職場技能、親子教育...">
                            </div>

                            <!-- 產出條數 -->
                            <div>
                                <label for="count" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">欲產出條數 *</label>
                                <select id="count" name="count" required
                                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white transition-all duration-150">
                                    <option value="">請選擇</option>
                                    <option value="1">1 條</option>
                                    <option value="2">2 條</option>
                                    <option value="3">3 條</option>
                                    <option value="4">4 條</option>
                                    <option value="5">5 條</option>
                                    <option value="6">6 條</option>
                                    <option value="7">7 條</option>
                                    <option value="8">8 條</option>
                                    <option value="9">9 條</option>
                                    <option value="10">10 條</option>
                                </select>
                            </div>

                            <!-- 避免重複 -->
                            <div class="flex items-center">
                                <input type="checkbox" id="dedupe" name="dedupe" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 dark:border-gray-600 rounded">
                                <label for="dedupe" class="ml-2 text-sm text-gray-700 dark:text-gray-300">避免重複角度</label>
                            </div>

                            <button type="submit" id="ideation-submit"
                                class="w-full bg-primary text-white py-3 px-6 rounded-lg hover:bg-primary-hover transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed">
                                <span class="submit-text">產生選題</span>
                                <span class="loading-text hidden">
                                    <svg class="loading-spinner w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    產生中...
                                </span>
                            </button>
                        </form>
                    </div>

                    <!-- 右側結果 -->
                    <div class="lg:col-span-8">
                        <!-- 選題 聊天室（強化版） -->
                        <div class="mb-6">
                            <div id="ideation-chat-card" class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden min-h-[500px] md:min-h-[500px] flex flex-col mx-auto max-w-4xl">
                                <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 dark:border-gray-700">
                                    <h3 class="text-lg font-semibold">💡 AI選題小助手</h3>
                                    <button id="chat-clear-ideation" class="text-sm px-3 py-1 rounded-md border border-gray-300 hover:bg-gray-50 dark:border-gray-600">清空對話</button>
                                </div>
                                <div id="chat-ideation" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50 dark:bg-gray-900"></div>
                                <div class="px-4 py-3 border-t border-gray-200 dark:border-gray-700">
                                    <div class="flex flex-wrap gap-2 mb-3 text-sm">
                                        <button class="chip-i btn-chip">熱門趨勢</button>
                                        <button class="chip-i btn-chip">教育分享</button>
                                        <button class="chip-i btn-chip">個人故事</button>
                                        <button class="chip-i btn-chip">產品介紹</button>
                                    </div>
                                    <div class="flex gap-2">
                                        <textarea id="chat-input-ideation" rows="2" class="flex-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700 resize-y" placeholder="告訴我你想要什麼類型的選題靈感...（Enter 送出；Shift+Enter 換行）"></textarea>
                                        <button id="chat-send-ideation" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-hover">獲取靈感</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="ideation-result" class="hidden">
                            <h3 class="text-xl font-bold mb-4">選題建議</h3>
                            <div class="space-y-4">
                                <div id="ideation-loading" class="hidden text-center py-6 text-gray-500 dark:text-gray-400">
                                    <svg class="loading-spinner w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    AI 回覆中...
                                </div>
                                <div id="ideation-cards" class="space-y-4"></div>
                            </div>
                        </div>
                        
                        <div id="ideation-empty" class="hidden">
                            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 min-h-[380px] md:min-h-[500px] flex items-center justify-center text-center">
                                <div>
                            <div class="text-6xl mb-4">💡</div>
                                <h2 class="text-2xl sm:text-3xl font-bold mb-3">準備產生創意選題</h2>
                                <p class="text-gray-500 dark:text-gray-400">輸入主題關鍵字，我們將為您產生多個吸睛的角度</p>
                                <div class="mt-4 space-y-2 text-primary">
                                  <button type="button" class="quick-example-btn hover:text-primary-hover">
                                    快速示例：減肥方法
                                  </button><br/>
                                  <button type="button" class="quick-example-btn hover:text-primary-hover">
                                    快速示例：投資理財
                                  </button><br/>
                                  <button type="button" class="quick-example-btn hover:text-primary-hover">
                                    快速示例：職場技能
                                </button>
                                </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 腳本生成器頁面 -->
        <div id="page-script" class="page hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="grid lg:grid-cols-12 gap-8">
                    <!-- 左側控制區 -->
                    <div class="space-y-8 lg:col-span-4">
                        <div>
                            <h2 class="text-3xl font-bold mb-2">AI腳本生成大師</h2>
                            <p class="text-gray-600 dark:text-gray-400">直接與AI對話，描述你的腳本需求與風格，我會一步步引導你完成腳本創作</p>
                        </div>
                    </div>

                    <!-- 右側預覽區 -->
                    <div class="lg:col-span-8">
                        <!-- 切換：AI 對話 / 一鍵生成 -->
                        <div id="script-tabs" class="relative z-10 flex flex-wrap md:flex-nowrap gap-2 mb-3 overflow-x-auto whitespace-nowrap">
                            <button id="tab-script-chat" onclick="window.switchScriptTab && window.switchScriptTab('chat')" class="pointer-events-auto shrink-0 px-3 py-1.5 rounded-lg bg-primary text-white hover:bg-primary-hover">AI 對話</button>
                            <button id="tab-script-oneclick" onclick="window.switchScriptTab && window.switchScriptTab('one')" class="pointer-events-auto shrink-0 px-3 py-1.5 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700">一鍵生成</button>
                        </div>
                        <!-- 腳本 聊天室（強化版） -->
                        <div id="script-chat-panel" class="mb-6">
                            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden mx-auto max-w-4xl">
                                <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 dark:border-gray-700">
                                    <h3 class="text-lg font-semibold">📝 AI腳本生成大師</h3>
                                    <button id="chat-clear-script" class="text-sm px-3 py-1 rounded-md border border-gray-300 hover:bg-gray-50 dark:border-gray-600">清空對話</button>
                                </div>
                                <div id="chat-script" class="h-96 sm:h-96 overflow-y-auto p-4 space-y-3 bg-gray-50 dark:bg-gray-900"></div>
                                <div class="px-4 py-3 border-t border-gray-200 dark:border-gray-700">
                                    <div class="flex flex-wrap gap-2 mb-3 text-sm">
                                        <button class="chip-s btn-chip">如何寫出吸引人的開頭？</button>
                                        <button class="chip-s btn-chip">腳本結構怎麼安排？</button>
                                        <button class="chip-s btn-chip">如何增加觀眾互動？</button>
                                        <button class="chip-s btn-chip">結尾怎麼設計？</button>
                                        <button class="chip-s btn-chip">如何選擇合適的時長？</button>
                                        <button class="chip-s btn-chip">如何讓腳本更有創意？</button>
                                    </div>
                                    <div class="flex gap-2">
                                        <textarea id="chat-input-script" rows="2" class="flex-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700 resize-y" placeholder="輸入主題/目標/受眾/平台/時長/語氣…（Enter 送出；Shift+Enter 換行）"></textarea>
                                        <button id="chat-send-script" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-hover">送出</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- 一鍵生成 面板 -->
                        <div id="script-oneclick-panel" class="hidden mb-6">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- 左側設定 -->
                                <div class="space-y-6">
                                    <!-- 模式選擇卡片 -->
                                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                                        <h3 class="text-lg font-semibold mb-4">模式選擇</h3>
                                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                            <label class="mode-option flex items-center justify-center p-4 rounded-lg border border-gray-300 dark:border-gray-600 cursor-pointer transition-all duration-200 has-[:checked]:border-primary has-[:checked]:bg-primary has-[:checked]:text-white hover:bg-gray-50 dark:hover:bg-gray-700">
                                                <input type="radio" name="script_mode" value="educational" class="hidden" checked>
                                                <span class="text-center">教育型</span>
                                            </label>
                                            <label class="mode-option flex items-center justify-center p-4 rounded-lg border border-gray-300 dark:border-gray-600 cursor-pointer transition-all duration-200 has-[:checked]:border-primary has-[:checked]:bg-primary has-[:checked]:text-white hover:bg-gray-50 dark:hover:bg-gray-700">
                                                <input type="radio" name="script_mode" value="entertainment" class="hidden">
                                                <span class="text-center">娛樂型</span>
                                            </label>
                                            <label class="mode-option flex items-center justify-center p-4 rounded-lg border border-gray-300 dark:border-gray-600 cursor-pointer transition-all duration-200 has-[:checked]:border-primary has-[:checked]:bg-primary has-[:checked]:text-white hover:bg-gray-50 dark:hover:bg-gray-700">
                                                <input type="radio" name="script_mode" value="promotional" class="hidden">
                                                <span class="text-center">推廣型</span>
                                            </label>
                                </div>
                                    </div>

                                    <!-- 模板選擇卡片 -->
                                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                                        <h3 class="text-lg font-semibold mb-4">模板選擇</h3>
                                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                            <label class="template-card flex flex-col items-center p-4 rounded-lg border border-gray-300 dark:border-gray-600 cursor-pointer transition-all duration-200 has-[:checked]:border-primary has-[:checked]:bg-primary has-[:checked]:text-white hover:bg-gray-50 dark:hover:bg-gray-700">
                                                <input type="radio" name="script_template" value="A" class="hidden" checked>
                                                <span class="text-xl mb-2">A</span>
                                                <span class="text-sm">三段式</span>
                                            </label>
                                            <label class="template-card flex flex-col items-center p-4 rounded-lg border border-gray-300 dark:border-gray-600 cursor-pointer transition-all duration-200 has-[:checked]:border-primary has-[:checked]:bg-primary has-[:checked]:text-white hover:bg-gray-50 dark:hover:bg-gray-700">
                                                <input type="radio" name="script_template" value="B" class="hidden">
                                                <span class="text-xl mb-2">B</span>
                                                <span class="text-sm">問題解決</span>
                                            </label>
                                            <label class="template-card flex flex-col items-center p-4 rounded-lg border border-gray-300 dark:border-gray-600 cursor-pointer transition-all duration-200 has-[:checked]:border-primary has-[:checked]:bg-primary has-[:checked]:text-white hover:bg-gray-50 dark:hover:bg-gray-700">
                                                <input type="radio" name="script_template" value="C" class="hidden">
                                                <span class="text-xl mb-2">C</span>
                                                <span class="text-sm">故事敘述</span>
                                            </label>
                            </div>
                        </div>
                        
                                    <!-- 時長選擇卡片 -->
                                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                                        <h3 class="text-lg font-semibold mb-4">時長選擇</h3>
                                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                            <label class="duration-option flex items-center justify-center p-4 rounded-lg border border-gray-300 dark:border-gray-600 cursor-pointer transition-all duration-200 has-[:checked]:border-primary has-[:checked]:bg-primary has-[:checked]:text-white hover:bg-gray-50 dark:hover:bg-gray-700">
                                                <input type="radio" name="script_duration" value="30" class="hidden" checked>
                                                <span class="text-center">30秒</span>
                                            </label>
                                            <label class="duration-option flex items-center justify-center p-4 rounded-lg border border-gray-300 dark:border-gray-600 cursor-pointer transition-all duration-200 has-[:checked]:border-primary has-[:checked]:bg-primary has-[:checked]:text-white hover:bg-gray-50 dark:hover:bg-gray-700">
                                                <input type="radio" name="script_duration" value="60" class="hidden">
                                                <span class="text-center">60秒</span>
                                            </label>
                                            <label class="duration-option flex items-center justify-center p-4 rounded-lg border border-gray-300 dark:border-gray-600 cursor-pointer transition-all duration-200 has-[:checked]:border-primary has-[:checked]:bg-primary has-[:checked]:text-white hover:bg-gray-50 dark:hover:bg-gray-700">
                                                <input type="radio" name="script_duration" value="90" class="hidden">
                                                <span class="text-center">90秒</span>
                                            </label>
                            </div>
                                        
                                        <!-- 套用設定按鈕 -->
                                        <div class="mt-6">
                                            <button id="apply-settings-generate" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-lg transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                                                <span class="apply-text">套用設定並生成腳本</span>
                                                <span class="apply-loading hidden">
                                                    <svg class="loading-spinner w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                                    生成中...
                                                </span>
                                            </button>
                            </div>
                                        </div>
                                    </div>
                                
                                <!-- 右側主題輸入與結果 -->
                                    <div>
                                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 min-h-[380px] md:min-h-[500px] flex flex-col">
                                        <h3 class="text-lg font-semibold mb-4">輸入主題</h3>
                                        <textarea id="script-topic-input" class="flex-1 p-4 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-primary focus:border-primary resize-none" placeholder="請輸入您的腳本主題，例如：如何製作爆款短影音"></textarea>
                                        
                                        <div class="mt-4 flex justify-end">
                                            <button id="oneclick-generate" class="bg-primary text-white py-3 px-6 rounded-lg hover:bg-primary-hover transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2">
                                                <span class="submit-text">生成腳本</span>
                                                <span class="loading-text hidden">
                                                    <svg class="loading-spinner w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                                    </svg>
                                                    生成中...
                                                </span>
                                            </button>
                                        </div>
                                        
                                        <!-- 結果顯示區域 -->
                                        <div id="script-result" class="hidden mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                                            <h4 class="font-semibold text-gray-900 dark:text-white mb-2">生成結果</h4>
                                        <div id="script-content" class="text-gray-600 dark:text-gray-400 whitespace-pre-line"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 說明/指南頁面 -->
        <div id="page-guide" class="page hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-6">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                    <h3 class="text-2xl font-bold mb-2">🎯 AI短影音定位顧問</h3>
                    <h4 class="font-semibold mb-2">功能說明</h4>
                    <p class="text-gray-600 dark:text-gray-400">• <strong>帳號定位分析</strong>：幫助釐清你的業務類型、目標受眾、品牌形象<br/>• <strong>平台策略建議</strong>：根據你的定位推薦最適合的平台<br/>• <strong>內容方向規劃</strong>：建立完整的內容策略基礎<br/>• <strong>定位檔案管理</strong>：自動記錄和更新你的定位資訊</p>
                    <h4 class="font-semibold mt-4 mb-2">使用方式</h4>
                    <p class="text-gray-600 dark:text-gray-400">1️⃣ 點擊「快速問題」開始定位分析<br/>2️⃣ 回答AI的問題，建立你的定位檔案<br/>3️⃣ 使用「🚀 一鍵生成定位」快速建立完整定位<br/>4️⃣ 定位檔案會自動儲存並同步到其他功能</p>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                    <h3 class="text-2xl font-bold mb-2">💡 AI選題小助手</h3>
                    <h4 class="font-semibold mb-2">功能說明</h4>
                    <p class="text-gray-600 dark:text-gray-400">• <strong>個性化選題</strong>：基於你的定位檔案生成相關選題<br/>• <strong>熱點結合</strong>：結合當前熱門話題與你的品牌特色<br/>• <strong>季節性內容</strong>：考慮時節與節日提供適時建議<br/>• <strong>選題類型篩選</strong>：熱門趨勢、教育分享、個人故事、產品介紹</p>
                    <h4 class="font-semibold mt-4 mb-2">使用方式</h4>
                    <p class="text-gray-600 dark:text-gray-400">1️⃣ 先完成定位分析，建立你的定位檔案<br/>2️⃣ 選擇選題類型（熱門趨勢、教育分享等）<br/>3️⃣ 點擊「獲取靈感」獲得個性化選題建議<br/>4️⃣ 查看「今日選題建議」和「歷史記錄」</p>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                    <h3 class="text-2xl font-bold mb-2">📝 AI腳本生成大師</h3>
                    <h4 class="font-semibold mb-2">功能說明</h4>
                    <p class="text-gray-600 dark:text-gray-400">• <strong>一鍵生成腳本</strong>：根據主題快速生成完整腳本<br/>• <strong>引導模式</strong>：選擇結構模板和時長，AI逐步引導<br/>• <strong>自由模式</strong>：自由討論需求，AI提供創意建議<br/>• <strong>多種模板</strong>：支援 A-F 六種腳本結構模板<br/>• <strong>時長靈活</strong>：支援 30 秒與 60 秒腳本</p>
                    <h4 class="font-semibold mt-4 mb-2">使用方式</h4>
                    <p class="text-gray-600 dark:text-gray-400">1️⃣ 一鍵生成：套用設定後輸入主題即可<br/>2️⃣ 引導模式：選擇結構模板與時長，輸入主題開始<br/>3️⃣ 自由模式：直接輸入需求，與 AI 自由討論<br/>4️⃣ 查看「腳本分段/時間軸」</p>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                    <h3 class="text-2xl font-bold mb-2">💾 資料儲存與管理</h3>
                    <p class="text-gray-600 dark:text-gray-400">• <strong>定位檔案</strong>：自動儲存在資料庫中<br/>• <strong>選題建議</strong>：儲存在「今日選題建議」與「歷史記錄」<br/>• <strong>腳本筆記</strong>：儲存在「腳本分段/時間軸」</p>
                    <p class="text-gray-600 dark:text-gray-400 mt-2">所有資料會自動同步到其他功能，讓 AI 能夠根據你的歷史記錄提供更精準的建議。</p>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                    <h3 class="text-2xl font-bold mb-2">🚀 使用建議</h3>
                    <p class="text-gray-600 dark:text-gray-400">1. 先使用定位智能體建立基本定位<br/>2. 再使用選題智能體獲取個性化建議<br/>3. 最後使用腳本生成大師創作具體內容</p>
                </div>
            </div>
        </div>
    </main>

    <!-- 全站頁尾：外部連結 + 版權 -->
    <footer class="border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 mt-8 safe-x safe-b">
        <div class="max-w-7xl mx-auto w-full py-6">
            <div class="flex flex-wrap gap-3 mb-4">
                <a class="px-4 py-2 rounded-full border border-gray-300 dark:border-gray-600 hover:bg-gray-50 hover:text-gray-900 dark:hover:bg-gray-700 dark:hover:text-gray-100 text-gray-700 dark:text-gray-300" target="_blank" href="https://AIJobschool.short.gy/kBmUAL">AIJob YouTube</a>
                <a class="px-4 py-2 rounded-full border border-gray-300 dark:border-gray-600 hover:bg-gray-50 hover:text-gray-900 dark:hover:bg-gray-700 dark:hover:text-gray-100 text-gray-700 dark:text-gray-300" target="_blank" href="https://AIJobschool.short.gy/ytPY3U">AIJob 官方網站</a>
                <a class="px-4 py-2 rounded-full border border-gray-300 dark:border-gray-600 hover:bg-gray-50 hover:text-gray-900 dark:hover:bg-gray-700 dark:hover:text-gray-100 text-gray-700 dark:text-gray-300" target="_blank" href="https://AIJobschool.short.gy/KCYu7z">AIJob 行銷自動化課程</a>
                <a class="px-4 py-2 rounded-full border border-gray-300 dark:border-gray-600 hover:bg-gray-50 hover:text-gray-900 dark:hover:bg-gray-700 dark:hover:text-gray-100 text-gray-700 dark:text-gray-300" target="_blank" href="https://AIJobschool.short.gy/UUwpEG">AIJob Discord社群討論</a>
                <a class="px-4 py-2 rounded-full border border-gray-300 dark:border-gray-600 hover:bg-gray-50 hover:text-gray-900 dark:hover:bg-gray-700 dark:hover:text-gray-100 text-gray-700 dark:text-gray-300" target="_blank" href="https://AIJobschool.short.gy/E49kA8">AIJob LINE官方帳號</a>
            </div>
            <div class="text-center text-gray-500 dark:text-gray-400">© 2025 AIJobSchool 版權所有</div>
        </div>
    </footer>

    <script>
        // API Base（自動偵測本機或雲端）
        const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:8080' : 'https://aijobvideobackend.zeabur.app';
        // 會員 API base（可與主 API 相同）
        const ACCOUNT_API = API_BASE;
        // 功能扣點設定（可依實際調整）
        const CREDIT_COSTS = { positioning: 5, topics: 3, script: 8 };

        // 點數系統 API 調用
        async function fetchWalletInfo() {
            try {
                const response = await fetch(`${API_BASE}/points/wallet`, {
                    credentials: 'include'
                });
                if (response.ok) {
                    const data = await response.json();
                    updateCreditsDisplay(data.balance);
                    return data;
                }
            } catch (error) {
                console.error('獲取錢包資訊失敗:', error);
            }
            return null;
        }

        // 點數系統 UI 更新
        function updateCreditsDisplay(balance) {
            const badge = document.getElementById('points-badge');
            if (badge) {
                badge.textContent = `點數: ${balance || 0}`;
            }
        }

        // 顯示購買模態框
        function showPurchaseModal() {
            const modal = document.getElementById('points-modal');
            if (modal) {
                modal.style.display = 'block';
            }
        }

        // 隱藏購買模態框
        function hidePurchaseModal() {
            const modal = document.getElementById('points-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        async function authorizeUsage(module, mode, count) {
            try {
                const response = await fetch(`${API_BASE}/points/authorize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ module, mode, count })
                });
                if (response.ok) {
                    const data = await response.json();
                    return data;
                }
            } catch (error) {
                console.error('授權檢查失敗:', error);
            }
            return { authorized: false, reason: 'API_ERROR' };
        }

        async function consumePoints(module, mode, count) {
            try {
                const response = await fetch(`${API_BASE}/points/consume`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ 
                        usage_id: `usage_${Date.now()}`,
                        module, 
                        mode, 
                        count,
                        points: CREDIT_COSTS[module] * count
                    })
                });
                if (response.ok) {
                    // 更新本地點數顯示
                    const wallet = await fetchWalletInfo();
                    return true;
                }
            } catch (error) {
                console.error('扣點失敗:', error);
            }
            return false;
        }

        async function fetchPointPacks() {
            try {
                const response = await fetch(`${API_BASE}/points/packs`, {
                    credentials: 'include'
                });
                if (response.ok) {
                    const data = await response.json();
                    return data;
                }
            } catch (error) {
                console.error('獲取點數包失敗:', error);
            }
            return [];
        }

        async function createCheckout(packId) {
            try {
                const response = await fetch(`${API_BASE}/points/checkout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ pack_id: packId })
                });
                if (response.ok) {
                    const data = await response.json();
                    return data;
                }
            } catch (error) {
                console.error('創建訂單失敗:', error);
            }
            return null;
        }

        // 顯示購買彈窗
        async function showPurchaseModal() {
            try {
                const packs = await fetchPointPacks();
                if (packs.length === 0) {
                    showToast('暫無可購買的點數包', 'error');
                    return;
                }
                
                // 使用現有的購買彈窗或創建新的
                if (window.aiPoints && window.aiPoints.showModal) {
                    window.aiPoints.showModal();
                } else {
                    // 簡化的購買彈窗
                    showSimplePurchaseModal(packs);
                }
            } catch (error) {
                console.error('顯示購買彈窗失敗:', error);
                showToast('載入購買頁面失敗', 'error');
            }
        }

        // 簡化購買彈窗
        function showSimplePurchaseModal(packs) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4">購買點數</h3>
                    <div class="space-y-3">
                        ${packs.map(pack => `
                            <div class="border rounded-lg p-3 flex justify-between items-center">
                                <div>
                                    <div class="font-medium">${pack.name}</div>
                                    <div class="text-sm text-gray-600">${pack.points} 點</div>
                                </div>
                                <button onclick="selectPack(${pack.pack_id}, ${pack.price_ntd})" 
                                        class="bg-blue-500 text-white px-4 py-2 rounded">
                                    NT$ ${pack.price_ntd}
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button onclick="this.closest('.fixed').remove()" 
                                class="px-4 py-2 border rounded">取消</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 選擇點數包
        async function selectPack(packId, price) {
            try {
                showToast('正在處理訂單...', 'info');
                const checkout = await createCheckout(packId);
                if (checkout) {
                    showToast('訂單創建成功！', 'success');
                    // 這裡可以跳轉到支付頁面或顯示支付資訊
                    console.log('Checkout URL:', checkout.checkout_url);
                } else {
                    showToast('訂單創建失敗', 'error');
                }
            } catch (error) {
                console.error('選擇點數包失敗:', error);
                showToast('處理失敗', 'error');
            }
        }

        // 全域變數
        let currentPage = 'home';
        let isDarkMode = localStorage.getItem('darkMode') === 'true';

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('開始初始化頁面...');
            initTheme();
            initRouter();
            initMobileMenu();
            initPositioning();
            initIdeation();
            initScript();
            initAuth();
                console.log('基本初始化完成');
            } catch (error) {
                console.error('初始化錯誤:', error);
            }
            // 與後端 Session 對齊，避免 localStorage 殘留導致誤顯示已登入
            (async function syncSession(){
                try{
                    const me = await fetch(`${API_BASE}/me`, { credentials:'include' }).then(r=> r.ok ? r.json() : null);
                    if (me && me.id){
                        localStorage.setItem('isLoggedIn','true');
                        localStorage.setItem('user', JSON.stringify(me));
                    } else {
                        localStorage.setItem('isLoggedIn','false');
                        localStorage.removeItem('user');
                    }
                }catch(_){ /* 忽略網路錯誤 */ }
            })();
            try {
            initChats();
                console.log('聊天功能初始化完成');
            } catch (error) {
                console.error('聊天功能初始化錯誤:', error);
            }
            // 載入錢包資訊
            try {
                fetchWalletInfo();
                console.log('錢包資訊載入完成');
            } catch (error) {
                console.error('錢包資訊載入錯誤:', error);
            }
            loadStoredData();
            adjustPositioningHeights();
            window.addEventListener('resize', adjustPositioningHeights);
        });

        // 全域錯誤處理
        window.addEventListener('error', function(event) {
            console.error('全域 JavaScript 錯誤:', event.error);
            console.error('錯誤位置:', event.filename, '行號:', event.lineno);
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('未處理的 Promise 拒絕:', event.reason);
        });

        // 主題切換功能
        function initTheme() {
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = document.getElementById('theme-icon');
            const sunIcon = document.getElementById('sun-icon');
            const moonIcon = document.getElementById('moon-icon');

            // 設定初始主題
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
                console.log('初始化夜間模式'); // 調試信息
            } else {
                document.documentElement.classList.remove('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
                console.log('初始化日間模式'); // 調試信息
            }

            themeToggle.addEventListener('click', function() {
                isDarkMode = !isDarkMode;
                localStorage.setItem('darkMode', isDarkMode);
                
                console.log('切換夜間模式:', isDarkMode); // 調試信息
                
                if (isDarkMode) {
                    document.documentElement.classList.add('dark');
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                    showToast('已切換到夜間模式', 'success');
                } else {
                    document.documentElement.classList.remove('dark');
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                    showToast('已切換到日間模式', 'success');
                }
                
                // 強制重新渲染
                document.body.offsetHeight;
            });
        }

        // 路由系統
        function initRouter() {
            // 處理導覽連結點擊
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.dataset.page;
                    navigateToPage(page);
                });
            });

            // 處理首頁卡片點擊
            document.querySelectorAll('a[href^="#!"]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('href').replace('#!', '');
                    navigateToPage(page);
                });
            });

            // 監聽瀏覽器前進/後退
            window.addEventListener('hashchange', function() {
                const hash = window.location.hash.replace('#!', '') || 'home';
                navigateToPage(hash);
            });

            // 初始化頁面
            const hash = window.location.hash.replace('#!', '') || 'home';
            navigateToPage(hash);
        }

        function navigateToPage(page) {
            // 隱藏所有頁面
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            
            // 顯示目標頁面
            const targetPage = document.getElementById(`page-${page}`);
            if (targetPage) {
                targetPage.classList.remove('hidden');
                targetPage.classList.add('fade-in');
                currentPage = page;
                
                // 更新 URL
                window.location.hash = `#!${page}`;
                
                // 更新導覽狀態
                updateNavigation(page);
            }
        }

        function updateNavigation(activePage) {
            document.querySelectorAll('.nav-link').forEach(link => {
                if (link.dataset.page === activePage) {
                    link.classList.add('text-primary', 'font-semibold');
                    link.classList.remove('text-gray-700', 'dark:text-gray-300');
                } else {
                    link.classList.remove('text-primary', 'font-semibold');
                    link.classList.add('text-gray-700', 'dark:text-gray-300');
                }
            });
        }

        function initMobileMenu() {
            const btn = document.getElementById('mobile-menu-btn');
            const menu = document.getElementById('mobile-menu');
            if (!btn || !menu) return;
    btn.addEventListener('click', () => menu.classList.toggle('hidden'));
    // 點擊導覽連結自動收合
    menu.querySelectorAll('a').forEach(a => a.addEventListener('click', () => menu.classList.add('hidden')));
    // 點擊外部收合
    document.addEventListener('click', (e) => {
        const within = menu.contains(e.target) || btn.contains(e.target);
        if (!within) menu.classList.add('hidden');
    });
            // 點品牌返回首頁
            const brand = document.querySelector('nav a[data-page="home"]');
            if (brand) brand.addEventListener('click', (e)=>{ e.preventDefault(); navigateToPage('home'); });
        }

        // 快速示例填入功能
        function fillPositioningExample(type) {
            const examples = {
                'tech': {
                    industry: '科技新創',
                    audience: '25-35歲科技從業者、投資人、創業者',
                    painPoints: '技術門檻高、市場競爭激烈、資金需求大、人才招募困難、產品市場契合度不確定'
                },
                'education': {
                    industry: '線上教育',
                    audience: '25-40歲上班族、學生家長、終身學習者',
                    painPoints: '時間有限、學習效果不確定、課程品質參差不齊、缺乏互動性、學習動機不足'
                },
                'health': {
                    industry: '健康食品',
                    audience: '30-50歲注重健康的消費者、健身愛好者、慢性病患者',
                    painPoints: '產品真偽難辨、效果不明顯、價格昂貴、缺乏專業指導、副作用擔憂'
                }
            };
            
            const example = examples[type];
            if (!example) return;
            
            // 填入表單欄位
            const industryInput = document.querySelector('input[name="industry"]');
            const audienceInput = document.querySelector('input[name="audience"]');
            const painPointsInput = document.querySelector('textarea[name="pains"]');
            
            if (industryInput) industryInput.value = example.industry;
            if (audienceInput) audienceInput.value = example.audience;
            if (painPointsInput) painPointsInput.value = example.painPoints;
            
            // 顯示成功提示
            showToast('已填入示例資料', 'success');
        }

        // 簡易登入系統（參考 login.html）
        function initAuth() {
            const loginBtn = document.getElementById('login-btn');
            const dropdown = document.getElementById('user-dropdown');
            const logoutBtn = document.getElementById('logout-btn');
            const drawer = document.getElementById('account-drawer');
            const overlay = document.getElementById('drawer-overlay');
            const drawerClose = document.getElementById('drawer-close');
            const drawerLogout = document.getElementById('drawer-logout-btn');
            const emailOpen = document.getElementById('email-login-open');
            const emailModal = document.getElementById('email-modal');
            const emailClose = document.getElementById('email-modal-close');
            const emailCancel = document.getElementById('email-modal-cancel');
            const emailSubmit = document.getElementById('email-login-submit');
            const emailInput = document.getElementById('email-login-input');
            const emailOverlay = document.getElementById('email-modal-overlay');
            const emailPage = document.getElementById('email-auth-page');
            const emailPageClose = document.getElementById('email-auth-close');
            const emailPageOverlay = document.getElementById('email-auth-overlay');
            const btnEmailLogin = document.getElementById('btn-email-login');
            const btnEmailSignup = document.getElementById('btn-email-signup');
            if (!loginBtn) return;

            function closeEmailPage(){
                if (emailPage) emailPage.classList.add('hidden');
                document.documentElement.classList.remove('modal-open');
            }

            function refreshUserUI() {
                const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                const userRaw = localStorage.getItem('user');
                const creditsWrap = document.getElementById('nav-credits-wrap');
                
                if (isLoggedIn && userRaw) {
                    const u = JSON.parse(userRaw);
                    loginBtn.textContent = u.name || 'Google 用戶';
                    loginBtn.classList.add('bg-orange-100', 'text-orange-800', 'border-orange-200');
                    loginBtn.classList.remove('bg-gray-100', 'text-gray-700');
                    // 顯示 Credits 區塊
                    if (creditsWrap) creditsWrap.classList.remove('hidden');
                    
                    // 更新下拉選單內容
                    document.getElementById('user-name').textContent = u.name || 'Google 用戶';
                    document.getElementById('user-email').textContent = u.email || 'user@gmail.com';
                    document.getElementById('user-avatar').textContent = u.name ? u.name.charAt(0).toUpperCase() : 'G';
                    // 更新抽屜內容
                    document.getElementById('acc-name').textContent = u.name || 'Google 用戶';
                    document.getElementById('acc-email').textContent = u.email || 'user@gmail.com';
                    document.getElementById('acc-avatar').textContent = u.name ? u.name.charAt(0).toUpperCase() : 'G';
                    // 同步後端點數/方案
                    fetchAccountSummary(u).catch(()=>{});
                    // 若本地已有點數，先行顯示（後端回來會覆蓋）
                    if (typeof u.credits === 'number') {
                        const navC = document.getElementById('nav-credits'); if (navC) navC.textContent = u.credits;
                        const accC = document.getElementById('acc-credits'); if (accC) accC.textContent = u.credits;
                    }
                } else {
                    loginBtn.textContent = '登入';
                    loginBtn.classList.remove('bg-orange-100', 'text-orange-800', 'border-orange-200');
                    loginBtn.classList.add('bg-gray-100', 'text-gray-700');
                    // 未登入隱藏 Credits 區塊
                    if (creditsWrap) creditsWrap.classList.add('hidden');
                    // 顯示 Email 登入按鈕（未登入時）
                    if (emailOpen) emailOpen.classList.remove('hidden');
                }
            }

            loginBtn.addEventListener('click', () => {
                const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                if (!isLoggedIn) {
                    // 顯示 Email 全畫面頁（使用者可改點右上角 Google 登入）
                    if (emailPage) {
                        emailPage.classList.remove('hidden');
                        document.documentElement.classList.add('modal-open');
                    }
                } else {
                    // 開啟帳號抽屜
                    drawer.classList.remove('translate-x-full');
                    overlay.classList.remove('hidden');
                }
            });

            // Email 登入 Modal 控制（舊，暫保留）
            function openEmailModal(){ if (emailModal) emailModal.classList.remove('hidden'); emailInput?.focus(); }
            function closeEmailModal(){ if (emailModal) emailModal.classList.add('hidden'); emailInput.value=''; }
            emailOpen?.addEventListener('click', openEmailModal);
            emailClose?.addEventListener('click', closeEmailModal);
            emailCancel?.addEventListener('click', closeEmailModal);
            emailOverlay?.addEventListener('click', closeEmailModal);

            emailSubmit?.addEventListener('click', async () => {
                const email = (emailInput?.value || '').trim();
                if (!email) { showToast('請輸入 Email', 'error'); return; }
                try{
                    const res = await fetch(`${API_BASE}/auth/email/start`, {
                        method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });
                    if (!res.ok) throw new Error('send failed');
                    showToast('已寄出登入連結，請至信箱查收', 'success');
                    closeEmailModal();
                }catch(e){
                    showToast('寄送失敗，請稍後再試', 'error');
                }
            });

            // Email 全畫面頁：關閉
            emailPageClose?.addEventListener('click', closeEmailPage);
            emailPageOverlay?.addEventListener('click', closeEmailPage);
            document.addEventListener('keydown', (e)=>{
                if (e.key === 'Escape' && emailPage && !emailPage.classList.contains('hidden')) {
                    closeEmailPage();
                }
            });

            // Email 登入：POST /auth/login
            btnEmailLogin?.addEventListener('click', async ()=>{
                const identifier = (document.getElementById('login-identifier')?.value||'').trim();
                const password = (document.getElementById('login-password')?.value||'').trim();
                if (!identifier || !password){ showToast('請輸入帳號與密碼', 'error'); return; }
                try{
                    const res = await fetch(`${API_BASE}/auth/login`, { method:'POST', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ identifier, password }) });
                    if (!res.ok) throw new Error('login failed');
                    const me = await fetch(`${API_BASE}/me`, { credentials:'include' }).then(r=>r.ok?r.json():null);
                    if (me){ localStorage.setItem('isLoggedIn','true'); localStorage.setItem('user', JSON.stringify(me)); closeEmailPage(); showToast('登入成功', 'success'); location.reload(); }
                }catch(e){ showToast('登入失敗，請檢查帳密或稍後再試', 'error'); }
            });

            // Email 註冊：POST /auth/signup
            btnEmailSignup?.addEventListener('click', async ()=>{
                const phone = (document.getElementById('signup-phone')?.value||'').trim();
                const email = (document.getElementById('signup-email')?.value||'').trim();
                const username = (document.getElementById('signup-username')?.value||'').trim();
                const password = (document.getElementById('signup-password')?.value||'').trim();
                if (!phone || !email || !username || !password){ showToast('請完整填寫電話/Email/帳號/密碼', 'error'); return; }
                try{
                    const res = await fetch(`${API_BASE}/auth/signup`, { method:'POST', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ phone, email, username, password }) });
                    if (!res.ok) throw new Error('signup failed');
                    showToast('帳號建立成功，請以帳密登入', 'success');
                }catch(e){ showToast('建立帳號失敗，請稍後再試', 'error'); }
            });

            // Google 登入/註冊（皆導向同一 OAuth 起始端點，後端處理不存在帳號時自動建帳）
            async function startGoogle(nextUrl){
                // 先清除現有 session，避免因為已登入而被誤認為成功
                try{ await fetch(`${API_BASE}/logout`, {method:'POST', credentials:'include'}); }catch(_){ }
                const url = `${API_BASE}/auth/google/start?next=${encodeURIComponent(nextUrl||location.href)}`;
                const features = 'width=520,height=640,menubar=no,toolbar=no,location=no,status=no,resizable=yes,scrollbars=yes';
                const popup = window.open(url, 'google_auth', features);
                // 輕量輪詢：等待後端設定好 session cookie 後，自動關閉視窗並刷新父頁
                const timer = setInterval(async ()=>{
                    try{
                        const me = await fetch(`${API_BASE}/me`, { credentials:'include' }).then(r=> r.ok ? r.json() : null);
                        if (me && me.id){
                            localStorage.setItem('isLoggedIn','true');
                            localStorage.setItem('user', JSON.stringify(me));
                            clearInterval(timer);
                            try{ popup && popup.close(); }catch(_){ }
                            location.reload();
                        }
                    }catch(_){ /* 忽略暫時錯誤 */ }
                }, 1000);
                showToast('請在彈窗完成 Google 登入', 'info');
            }
            document.getElementById('btn-google-login')?.addEventListener('click', ()=> startGoogle(location.href));
            document.getElementById('btn-google-signup')?.addEventListener('click', ()=> startGoogle(location.href));

            // 顯示/隱藏密碼
            function bindToggle(btnId, inputId){
                const btn = document.getElementById(btnId);
                const inp = document.getElementById(inputId);
                if (!btn || !inp) return;
                btn.addEventListener('click', ()=>{
                    inp.type = (inp.type === 'password') ? 'text' : 'password';
                });
            }
            bindToggle('toggle-login-pw','login-password');
            bindToggle('toggle-signup-pw','signup-password');

            // 登出功能
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    localStorage.removeItem('user');
                    localStorage.setItem('isLoggedIn', 'false');
                    showToast('已登出', 'success');
                    refreshUserUI();
                    dropdown.classList.add('hidden');
                });
            }

            if (drawerLogout) {
                drawerLogout.addEventListener('click', () => {
                    localStorage.removeItem('user');
                    localStorage.setItem('isLoggedIn', 'false');
                    showToast('已登出', 'success');
                    refreshUserUI();
                    drawer.classList.add('translate-x-full');
                    overlay.classList.add('hidden');
                });
            }

            // 點擊外部關閉下拉選單
            document.addEventListener('click', (e) => {
                if (!loginBtn.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });

            // 抽屜關閉控制
            if (drawerClose) drawerClose.addEventListener('click', () => { drawer.classList.add('translate-x-full'); overlay.classList.add('hidden'); });
            if (overlay) overlay.addEventListener('click', () => { drawer.classList.add('translate-x-full'); overlay.classList.add('hidden'); });

            refreshUserUI();
        }

        // 從後端讀取使用者點數與方案
        async function fetchAccountSummary(user){
            if (!user || !user.id) return;
            try {
                const res = await fetch(`${ACCOUNT_API}/account/summary?user_id=${encodeURIComponent(user.id)}`, { credentials: 'include' });
                const data = await res.json();
                if (!data || data.error) return;
                const credits = typeof data.credits === 'number' ? data.credits : (data.credits?.balance ?? undefined);
                const plan = data.plan || data.subscription || '免費';
                if (credits !== undefined) {
                    const navC = document.getElementById('nav-credits');
                    if (navC) navC.textContent = credits;
                    const accC = document.getElementById('acc-credits');
                    if (accC) accC.textContent = credits;
                    // 也同步到 localStorage 方便模擬扣點
                    const userRaw = localStorage.getItem('user');
                    if (userRaw) {
                        const u = JSON.parse(userRaw); u.credits = credits; localStorage.setItem('user', JSON.stringify(u));
                    }
                }
                const accPlan = document.getElementById('acc-plan');
                if (accPlan) accPlan.textContent = plan;
                
                // 更新使用統計
                updateUsageStats(data.usage_stats || {});
            } catch(e) { /* 忽略錯誤，保持原樣 */ }
        }
        
        // 更新使用統計顯示
        function updateUsageStats(stats) {
            const positioningCount = document.getElementById('acc-positioning-count');
            const topicsCount = document.getElementById('acc-topics-count');
            const scriptCount = document.getElementById('acc-script-count');
            
            if (positioningCount) positioningCount.textContent = `${stats.positioning || 0} 次`;
            if (topicsCount) topicsCount.textContent = `${stats.topics || 0} 次`;
            if (scriptCount) scriptCount.textContent = `${stats.script || 0} 次`;
        }

        // 扣點（前端模擬）
        function tryConsumeCredits(agent){
            const userRaw = localStorage.getItem('user');
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            if (!isLoggedIn || !userRaw) return true; // 未登入就不扣，直接通過
            const u = JSON.parse(userRaw);
            const cost = CREDIT_COSTS[agent] || 0;
            if ((u.credits ?? 0) < cost) {
                showToast(`點數不足，無法執行（需要 ${cost} 點）`, 'error');
                return false;
            }
            u.credits = (u.credits ?? 0) - cost;
            localStorage.setItem('user', JSON.stringify(u));
            const navC = document.getElementById('nav-credits'); if (navC) navC.textContent = u.credits;
            const accC = document.getElementById('acc-credits'); if (accC) accC.textContent = u.credits;
            showToast(`已扣點 ${cost}，剩餘 ${u.credits}`, 'success');
            return true;
        }

        // 測試輔助：在瀏覽器 Console 可呼叫下列方法模擬
        window.setCredits = function(n){
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const userRaw = localStorage.getItem('user');
            if (!isLoggedIn || !userRaw) { showToast('請先登入再設定點數', 'error'); return; }
            const u = JSON.parse(userRaw); u.credits = Number(n)||0; localStorage.setItem('user', JSON.stringify(u));
            const navC = document.getElementById('nav-credits'); if (navC) navC.textContent = u.credits;
            const accC = document.getElementById('acc-credits'); if (accC) accC.textContent = u.credits;
            showToast(`已設定點數為 ${u.credits}`, 'success');
        };
        window.getCredits = function(){
            const userRaw = localStorage.getItem('user');
            const u = userRaw ? JSON.parse(userRaw) : null;
            return u?.credits ?? null;
        };
        window.mockConsume = function(agent){
            if (!tryConsumeCredits(agent||'topics')) return false; return window.getCredits();
        };

        // 串流連線管理全域變數
        let currentEventSource = null;
        let currentWebSocket = null;
        let currentStreamType = null; // 'sse' 或 'websocket'

        // 關閉現有串流連線
        function closeCurrentStream() {
            if (currentEventSource) {
                currentEventSource.close();
                currentEventSource = null;
                console.log('EventSource 連線已關閉');
            }
            if (currentWebSocket) {
                currentWebSocket.close(1000, 'new stream');
                currentWebSocket = null;
                console.log('WebSocket 連線已關閉');
            }
            currentStreamType = null;
        }

        // 頁面關閉/刷新時自動關閉串流
        window.addEventListener('beforeunload', closeCurrentStream);
        window.addEventListener('pagehide', closeCurrentStream);
        window.addEventListener('unload', closeCurrentStream);

        // 頁面可見性變化時關閉串流（用戶切換到其他標籤頁）
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                closeCurrentStream();
            }
        });

        // 暴露全域函數供外部調用
        window.closeCurrentStream = closeCurrentStream;
        window.getCurrentStreamStatus = function() {
            return {
                hasEventSource: currentEventSource !== null,
                hasWebSocket: currentWebSocket !== null,
                streamType: currentStreamType
            };
        };

        // 路由切換時關閉串流（如果使用 SPA 路由）
        if (window.history && window.history.pushState) {
            const originalPushState = window.history.pushState;
            const originalReplaceState = window.history.replaceState;
            
            window.history.pushState = function(...args) {
                closeCurrentStream();
                return originalPushState.apply(this, args);
            };
            
            window.history.replaceState = function(...args) {
                closeCurrentStream();
                return originalReplaceState.apply(this, args);
            };
        }

        // 共用聊天邏輯（前端模擬）
        function initChats() {
            async function callBackend(agent, content) {
                // 發送新提問前先關閉現有串流連線
                closeCurrentStream();
                
                try {
                    const user = JSON.parse(localStorage.getItem('user') || '{}');
                    const userId = user.id || 'web';
                    
                    // 嘗試使用串流 API，優先使用 EventSource，失敗則嘗試 WebSocket，最後回退到普通 API
                    try {
                        return await callBackendStream(agent, content, userId);
                    } catch (streamError) {
                        console.log('EventSource 不可用，嘗試 WebSocket:', streamError);
                        try {
                            return await callBackendWebSocket(agent, content, userId);
                        } catch (wsError) {
                            console.log('WebSocket 不可用，使用普通 API:', wsError);
                            return await callBackendNormal(agent, content, userId);
                        }
                    }
                } catch (e) {
                    console.error('後端連接錯誤:', e);
                    return '（後端不可用，這是前端示範回覆）';
                }
            }

            // 串流 API 調用
            async function callBackendStream(agent, content, userId) {
                return new Promise((resolve, reject) => {
                    const sessionId = `session_${userId}_${Date.now()}`;
                    const streamUrl = `${API_BASE}/api/stream?session_id=${encodeURIComponent(sessionId)}&q=${encodeURIComponent(content)}&agent_type=${encodeURIComponent(agent)}`;
                    
                    // 使用 EventSource 進行串流
                    currentEventSource = new EventSource(streamUrl);
                    currentStreamType = 'sse';
                    
                    let fullResponse = '';
                    let isComplete = false;
                    
                    currentEventSource.onmessage = function(event) {
                        if (event.data === '[DONE]') {
                            currentEventSource.close();
                            currentEventSource = null;
                            currentStreamType = null;
                            if (!isComplete) {
                                isComplete = true;
                                resolve(fullResponse || '（串流完成但無內容）');
                            }
                            return;
                        }
                        
                        if (event.data && !event.data.startsWith('錯誤：')) {
                            fullResponse += event.data;
                            // 可以選擇即時更新 UI，這裡先累積完整回應
                        }
                    };
                    
                    currentEventSource.onerror = function(event) {
                        console.error('EventSource 錯誤:', event);
                        currentEventSource.close();
                        currentEventSource = null;
                        currentStreamType = null;
                        if (!isComplete) {
                            isComplete = true;
                            reject(new Error('串流連線錯誤'));
                        }
                    };
                    
                    // 設定超時
                    setTimeout(() => {
                        if (!isComplete) {
                            isComplete = true;
                            closeCurrentStream();
                            reject(new Error('串流超時'));
                        }
                    }, 30000); // 30秒超時
                });
            }

            // WebSocket API 調用（替代方案）
            async function callBackendWebSocket(agent, content, userId) {
                return new Promise((resolve, reject) => {
                    const sessionId = `session_${userId}_${Date.now()}`;
                    const wsUrl = `${API_BASE.replace('http://', 'ws://').replace('https://', 'wss://')}/api/ws`;
                    
                    // 使用 WebSocket 進行串流
                    currentWebSocket = new WebSocket(wsUrl);
                    currentStreamType = 'websocket';
                    
                    let fullResponse = '';
                    let isComplete = false;
                    
                    currentWebSocket.onopen = function() {
                        // 發送訊息
                        const message = {
                            session_id: sessionId,
                            q: content,
                            agent_type: agent
                        };
                        currentWebSocket.send(JSON.stringify(message));
                    };
                    
                    currentWebSocket.onmessage = function(event) {
                        if (event.data === '[DONE]') {
                            currentWebSocket.close(1000, 'stream complete');
                            currentWebSocket = null;
                            currentStreamType = null;
                            if (!isComplete) {
                                isComplete = true;
                                resolve(fullResponse || '（串流完成但無內容）');
                            }
                            return;
                        }
                        
                        if (event.data && !event.data.startsWith('錯誤：')) {
                            fullResponse += event.data;
                            // 可以選擇即時更新 UI，這裡先累積完整回應
                        }
                    };
                    
                    currentWebSocket.onerror = function(event) {
                        console.error('WebSocket 錯誤:', event);
                        currentWebSocket.close();
                        currentWebSocket = null;
                        currentStreamType = null;
                        if (!isComplete) {
                            isComplete = true;
                            reject(new Error('WebSocket 連線錯誤'));
                        }
                    };
                    
                    currentWebSocket.onclose = function(event) {
                        if (!isComplete && event.code !== 1000) {
                            isComplete = true;
                            reject(new Error('WebSocket 連線關閉'));
                        }
                    };
                    
                    // 設定超時
                    setTimeout(() => {
                        if (!isComplete) {
                            isComplete = true;
                            closeCurrentStream();
                            reject(new Error('WebSocket 超時'));
                        }
                    }, 30000); // 30秒超時
                });
            }

            // 普通 API 調用（回退方案）
            async function callBackendNormal(agent, content, userId) {
                try {
                    const res = await fetch(`${API_BASE}/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: userId,
                            agent_type: agent,
                            messages: [{ role: 'user', content }]
                        })
                    });
                    const data = await res.json();
                    const msg = data.assistant_message || '（後端已回覆，但無內容）';
                    // 將 AI 回覆同步到對應結果區塊（段落分明）
                    try {
                        if (agent === 'script') {
                            const preview = document.getElementById('script-preview');
                            if (preview) {
                                document.getElementById('script-empty').classList.add('hidden');
                                document.getElementById('script-result').classList.remove('hidden');
                                const ctn = document.getElementById('script-content');
                                if (ctn) ctn.textContent = msg; // whitespace-pre-line 已在樣式
                                preview.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        } else if (agent === 'positioning') {
                            const area = document.getElementById('positioning-result');
                            if (area) {
                                area.classList.remove('hidden');
                                // 解析回覆中的三個區塊（品牌定位 / 語氣守則 / 執行建議）
                                let summary = msg;
                                let toneTxt = '';
                                let execTxt = '';
                                const toneIdx = msg.indexOf('語氣守則');
                                const execIdx = msg.indexOf('執行建議');
                                if (toneIdx !== -1) {
                                    summary = msg.slice(0, toneIdx).trim();
                                    if (execIdx !== -1) {
                                        toneTxt = msg.slice(toneIdx).replace(/^語氣守則\s*[:：]?\s*/,'');
                                        toneTxt = toneTxt.slice(0, Math.max(0, toneTxt.indexOf('執行建議'))).trim();
                                    } else {
                                        toneTxt = msg.slice(toneIdx).replace(/^語氣守則\s*[:：]?\s*/,'').trim();
                                    }
                                }
                                if (execIdx !== -1) {
                                    execTxt = msg.slice(execIdx).replace(/^執行建議\s*[:：]?\s*/,'').trim();
                                }

                                // 若仍無執行建議，提供前端 fallback（避免空白）
                                if (!execTxt) {
                                    const industry = (document.getElementById('industry')?.value || '').trim();
                                    const audience = (document.getElementById('audience')?.value || '').trim();
                                    const pains = (document.getElementById('pains')?.value || '').trim();
                                    const lines = [
                                        `內容節奏：每週 3-4 支短片；開頭 2~3 秒破題，結尾加 CTA。`,
                                        `主題安排：以「${pains || '用戶痛點'}」為核心，結合 ${industry || '你的產業'} 案例與實作示範。`,
                                        `平台策略：優先經營 ${audience || '目標受眾'} 常用的平台，固定欄位（教學/案例/QA）輪播。`
                                    ];
                                    execTxt = lines.join('\n');
                                }

                                // 去除重複行（例如重複的「發文頻率」）
                                const dedup = [];
                                const seen = new Set();
                                execTxt.split(/\r?\n/).forEach(l => {
                                    const t = l.trim();
                                    if (!t) return;
                                    const key = t.replace(/^[📌•\-\d\s]+/, '').replace(/：|:/, ':');
                                    if (!seen.has(key)) { seen.add(key); dedup.push(t); }
                                });
                                execTxt = dedup.join('\n');

                                const s = document.getElementById('positioning-summary');
                                if (s) s.textContent = summary || msg;
                                const t = document.getElementById('tone-guidelines');
                                if (t && toneTxt) t.textContent = toneTxt;
                                const e = document.getElementById('execution-suggestions');
                                if (e) e.textContent = execTxt;
                                document.getElementById('positioning-loading')?.classList.add('hidden');
                            }
                        } else if (agent === 'topics') {
                            const area = document.getElementById('ideation-result');
                            const cards = document.getElementById('ideation-cards');
                            if (area && cards) {
                                area.classList.remove('hidden');
                                const card = document.createElement('div');
                                card.className = 'bg-white dark:bg-gray-800 rounded-lg shadow p-4 space-y-2';
                                card.innerHTML = `<div class="font-semibold text-gray-900 dark:text-white mb-1">AI 生成建議</div><div class="text-sm text-gray-600 dark:text-gray-400 whitespace-pre-line">${msg}</div>`;
                                cards.prepend(card);
                                area.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        }
                    } catch (_) {}
                    return msg;
                } catch (e) {
                    console.error('普通 API 調用錯誤:', e);
                    return '（後端不可用，這是前端示範回覆）';
                }
            }

            function bindChat(sendId, inputId, boxId, agent) {
                const send = document.getElementById(sendId);
                const input = document.getElementById(inputId);
                const box = document.getElementById(boxId);
                if (!send || !input || !box) return;
                
                function formatAIResponse(text) {
                    // 將AI回覆格式化為段落分明，使用emoji做段落分配
                    let formatted = text;
                    
                    // 常見的段落分隔符號
                    const separators = [
                        { pattern: /\n\n/g, emoji: '📝' },
                        { pattern: /\n/g, emoji: '💡' },
                        { pattern: /。/g, emoji: '✨' },
                        { pattern: /！/g, emoji: '🎯' },
                        { pattern: /？/g, emoji: '🤔' }
                    ];
                    
                    // 先處理雙換行（段落分隔）
                    formatted = formatted.replace(/\n\n+/g, '\n\n📝 ');
                    
                    // 處理單換行
                    formatted = formatted.replace(/\n(?!\n)/g, '\n💡 ');
                    
                    // 處理句號後的段落
                    formatted = formatted.replace(/。([^。！？\n])/g, '。\n✨ $1');
                    
                    // 處理驚嘆號後的段落
                    formatted = formatted.replace(/！([^。！？\n])/g, '！\n🎯 $1');
                    
                    // 處理問號後的段落
                    formatted = formatted.replace(/？([^。！？\n])/g, '？\n🤔 $1');
                    
                    // 確保每個段落都有適當的間距
                    formatted = formatted.replace(/([📝💡✨🎯🤔]) /g, '$1 ');
                    
                    return formatted;
                }
                
                function append(role, text) {
                    const item = document.createElement('div');
                    item.className = role === 'user' ? 'text-right mb-3' : 'text-left mb-3';
                    const bubble = document.createElement('div');
                    bubble.className = `inline-block px-4 py-3 rounded-lg max-w-[85%] ${role==='user'?'bg-blue-50 text-blue-900':'bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600'} shadow-sm`;
                    
                    if (role === 'ai') {
                        // AI回覆使用格式化的內容
                        const formattedText = formatAIResponse(text);
                        bubble.innerHTML = `<div class="whitespace-pre-line text-sm leading-relaxed">${formattedText}</div>`;
                    } else {
                        // 用戶訊息保持原樣
                        bubble.textContent = text;
                    }
                    
                    item.appendChild(bubble);
                    box.appendChild(item);
                    box.scrollTop = box.scrollHeight;
                }
                
                function appendPending() {
                    const item = document.createElement('div');
                    item.className = 'text-left mb-3';
                    const bubble = document.createElement('div');
                    bubble.className = 'inline-block px-4 py-3 rounded-lg max-w-[85%] bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 shadow-sm flex items-center gap-2';
                    bubble.innerHTML = `<svg class="loading-spinner w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v2m0 12v2m8-8h-2M6 12H4m13.657 6.343l-1.414-1.414M7.757 7.757L6.343 6.343m12.728 0l-1.414 1.414M7.757 16.243l-1.414 1.414"></path></svg><span class="text-sm">AI 回覆中...</span>`;
                    item.appendChild(bubble);
                    box.appendChild(item);
                    box.scrollTop = box.scrollHeight;
                    return item;
                }
                
                send.addEventListener('click', async () => {
                    const v = input.value.trim();
                    if (!v) return;
                    
                    // 點數授權檢查
                    const authResult = await authorizeUsage(agent, 'chat', 1);
                    if (!authResult.authorized) {
                        if (authResult.needTopup) {
                            showPurchaseModal();
                        } else {
                            showToast(`點數不足，無法執行（需要 ${CREDIT_COSTS[agent]} 點）`, 'error');
                        }
                        return;
                    }
                    
                    append('user', v);
                    input.value = '';
                    const pending = appendPending();
                    callBackend(agent, v)
                        .then(async msg => {
                            if (pending && pending.parentNode) pending.parentNode.removeChild(pending);
                            append('ai', msg);
                            // 成功後扣點
                            await consumePoints(agent, 'chat', 1);
                        })
                        .catch(async () => {
                            if (pending && pending.parentNode) pending.parentNode.removeChild(pending);
                            append('ai', '抱歉，目前系統較繁忙，請稍後再試。');
                            // 失敗不扣點
                        });
                });
                // Enter 送出（Shift+Enter 不送出）
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        const v = input.value.trim();
                        if (v) {
                            send.click();
                        }
                    }
                });
            }
            bindChat('chat-send-positioning','chat-input-positioning','chat-positioning','positioning');
            bindChat('chat-send-ideation','chat-input-ideation','chat-ideation','topics');
            bindChat('chat-send-script','chat-input-script','chat-script','script');

            // 清空對話功能
            const clearBtns = [
                {btn: 'chat-clear-positioning', box: 'chat-positioning'},
                {btn: 'chat-clear-ideation', box: 'chat-ideation'},
                {btn: 'chat-clear-script', box: 'chat-script'}
            ];
            clearBtns.forEach(({btn, box}) => {
                const clearBtn = document.getElementById(btn);
                const chatBox = document.getElementById(box);
                if (clearBtn && chatBox) {
                    clearBtn.addEventListener('click', () => chatBox.innerHTML = '');
                }
            });

            // 快速按鈕功能
            document.querySelectorAll('.chip-p').forEach(btn => {
                btn.addEventListener('click', () => {
                    const input = document.getElementById('chat-input-positioning');
                    const send = document.getElementById('chat-send-positioning');
                    const box = document.getElementById('chat-positioning');
                    if (input && send && box) {
                        // 如果是第一次使用，先顯示歡迎訊息
                        if (box.children.length === 0) {
                            const welcomeMsg = `🎯 歡迎使用AI短影音定位顧問！

📝 我是您的專業定位顧問，可以幫助您：
💡 分析業務類型與目標受眾
✨ 建立品牌定位與內容策略
🎯 規劃平台經營方向

🤔 請告訴我您的業務、產品或想法，我會逐步引導您建立完整的定位檔案！`;
                            
                            const item = document.createElement('div');
                            item.className = 'text-left mb-3';
                            const bubble = document.createElement('div');
                            bubble.className = 'inline-block px-4 py-3 rounded-lg max-w-[85%] bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 shadow-sm';
                            const safe = document.createElement('div');
                            safe.className = 'whitespace-pre-line text-sm leading-relaxed';
                            safe.textContent = welcomeMsg;
                            bubble.appendChild(safe);
                            item.appendChild(bubble);
                            box.appendChild(item);
                        }
                        
                        input.value = btn.textContent;
                        send.click();
                    }
                });
            });

            document.querySelectorAll('.chip-i').forEach(btn => {
                btn.addEventListener('click', () => {
                    const input = document.getElementById('chat-input-ideation');
                    const send = document.getElementById('chat-send-ideation');
                    const box = document.getElementById('chat-ideation');
                    if (input && send && box) {
                        // 如果是第一次使用，先顯示歡迎訊息
                        if (box.children.length === 0) {
                            const welcomeMsg = `💡 歡迎使用AI選題小助手！

📝 我可以為您提供：
✨ 個性化選題建議
🎯 熱點結合創意
💡 季節性內容規劃
🤔 多種選題類型篩選

📝 請告訴我您想要什麼類型的選題靈感，我會為您量身打造！`;
                            
                            const item = document.createElement('div');
                            item.className = 'text-left mb-3';
                            const bubble = document.createElement('div');
                            bubble.className = 'inline-block px-4 py-3 rounded-lg max-w-[85%] bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 shadow-sm';
                            const safe2 = document.createElement('div');
                            safe2.className = 'whitespace-pre-line text-sm leading-relaxed';
                            safe2.textContent = welcomeMsg;
                            bubble.appendChild(safe2);
                            item.appendChild(bubble);
                            box.appendChild(item);
                        }
                        
                        input.value = btn.textContent;
                        send.click();
                    }
                });
            });

            document.querySelectorAll('.chip-s').forEach(btn => {
                btn.addEventListener('click', () => {
                    const input = document.getElementById('chat-input-script');
                    const send = document.getElementById('chat-send-script');
                    const box = document.getElementById('chat-script');
                    if (input && send && box) {
                        // 如果是第一次使用，先顯示歡迎訊息
                        if (box.children.length === 0) {
                            const welcomeMsg = `📝 歡迎使用AI腳本生成大師！

🎯 我可以為您提供：
✨ 一鍵生成完整腳本
💡 引導模式逐步創作
📝 自由模式創意討論
🎯 多種模板結構選擇
🤔 30秒與60秒時長支援

📝 請告訴我您的主題、目標、受眾或平台，我會為您量身打造專業腳本！`;
                            
                            const item = document.createElement('div');
                            item.className = 'text-left mb-3';
                            const bubble = document.createElement('div');
                            bubble.className = 'inline-block px-4 py-3 rounded-lg max-w-[85%] bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 shadow-sm';
                            const safe3 = document.createElement('div');
                            safe3.className = 'whitespace-pre-line text-sm leading-relaxed';
                            safe3.textContent = welcomeMsg;
                            bubble.appendChild(safe3);
                            item.appendChild(bubble);
                            box.appendChild(item);
                        }
                        
                        input.value = btn.textContent;
                        send.click();
                    }
                });
            });
            // 進入頁面時在右側聊天框給開場介紹（只顯示一次）
            const ibox = document.getElementById('chat-ideation');
            if (ibox && !ibox.dataset.intro){
                const intro = '嗨！我是 AI 選題小助手。\n我會根據你的定位與需求，提供多元的內容角度與切入點。\n請在左側輸入主題和條數，或直接在下方跟我說你想討論的方向（例如熱門趨勢、教育分享…），我會即時回覆建議。';
                const wrap = document.createElement('div');
                wrap.className = 'text-left mb-3';
                wrap.innerHTML = `<div class=\"inline-block px-3 py-2 rounded-lg bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 shadow-sm whitespace-pre-line\">${intro}</div>`;
                ibox.appendChild(wrap); ibox.dataset.intro = '1';
            }
        }


        // Toast 通知系統
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-600';
            toast.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-2xl fade-in pointer-events-auto`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 2200);
        }

        // 定位助手功能
        function initPositioning() {
            const form = document.getElementById('positioning-form');
            const submitBtn = document.getElementById('positioning-submit');
            const submitText = submitBtn.querySelector('.submit-text');
            const loadingText = submitBtn.querySelector('.loading-text');

            // 語氣選項點擊處理
            document.querySelectorAll('input[name="tone"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    updateToneSelection();
                });
            });

            // 表單提交
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // 驗證必填欄位（tone 以 checked 驗證）
                const requiredFields = ['industry', 'audience', 'pains'];
                let isValid = true;
                
                requiredFields.forEach(field => {
                    const input = form.querySelector(`[name="${field}"]`);
                    if (!input || !input.value.trim()) {
                        isValid = false;
                        if (input) {
                        input.classList.add('border-red-500');
                        setTimeout(() => input.classList.remove('border-red-500'), 3000);
                        }
                    }
                });
                // tone（radio group）需至少選取一個
                const toneChecked = form.querySelector('input[name="tone"]:checked');
                if (!toneChecked) {
                    isValid = false;
                    try {
                        document.querySelectorAll('.tone-option').forEach(opt => {
                            const wrap = opt.parentElement;
                            if (wrap) {
                                wrap.classList.add('border-red-500');
                                setTimeout(() => wrap.classList.remove('border-red-500'), 3000);
                            }
                        });
                    } catch(_) {}
                }

                if (!isValid) {
                    showToast('請填寫所有必填欄位', 'error');
                    return;
                }

                // 顯示載入狀態
                submitBtn.disabled = true;
                submitText.classList.add('hidden');
                loadingText.classList.remove('hidden');

                try {
                    document.getElementById('positioning-result').classList.remove('hidden');
                    document.getElementById('positioning-loading').classList.remove('hidden');
                    await generatePositioningResult();
                } catch (err) {
                    console.warn('定位分析失敗，使用本地預設：', err);
                    try { generatePositioningResultLocal(); } catch(_) {}
                } finally {
                    document.getElementById('positioning-loading').classList.add('hidden');
                    submitBtn.disabled = false;
                    submitText.classList.remove('hidden');
                    loadingText.classList.add('hidden');
                }
            });

            // 快速示例按鈕
            document.querySelectorAll('.quick-example-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const examples = {
                        '科技新創公司': {
                            industry: '科技新創',
                            audience: '25-35歲科技工作者',
                            pains: '工作壓力大、時間管理困難、缺乏工作生活平衡',
                            tone: 'professional'
                        },
                        '線上教育平台': {
                            industry: '線上教育',
                            audience: '在職進修者',
                            pains: '學習時間有限、缺乏系統性學習方法、難以堅持',
                            tone: 'friendly'
                        },
                        '健康食品品牌': {
                            industry: '健康食品',
                            audience: '注重健康的消費者',
                            pains: '市面產品良莠不齊、缺乏專業指導、效果不明顯',
                            tone: 'authoritative'
                        }
                    };
                    
                    const exampleText = this.textContent.replace('快速示例：', '').trim();
                    const data = examples[exampleText];
                    
                    if (data) {
                        document.getElementById('industry').value = data.industry;
                        document.getElementById('audience').value = data.audience;
                        document.getElementById('pains').value = data.pains;
                        document.querySelector(`input[name="tone"][value="${data.tone}"]`).checked = true;
                        updateToneSelection();
                        showToast('已填入快速示例資料', 'success');
                    }
                });
            });

            // 進入頁面時在右側聊天框給開場介紹（只顯示一次）
            const box = document.getElementById('chat-positioning');
            if (box && !box.dataset.intro) {
                const intro = '嗨！我是你的 AI 影音定位顧問。\n我會根據你在左側填寫的資訊結合知識庫，幫你整理品牌定位、語氣守則與執行建議。\n填完表單按「生成定位摘要」，或在下方直接跟我聊天描述你的業務與受眾，我也能一步步引導你完成定位。';
                const wrap = document.createElement('div');
                wrap.className = 'text-left mb-3';
                wrap.innerHTML = `<div class="inline-block px-3 py-2 rounded-lg bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 shadow-sm whitespace-pre-line">${intro}</div>`;
                box.appendChild(wrap); box.dataset.intro = '1';
            }

            const tabChat = document.getElementById('tab-positioning-chat');
            const tabOne = document.getElementById('tab-positioning-oneclick');
            const leftForm = document.getElementById('positioning-form');
            const onePanel = document.getElementById('positioning-oneclick-panel');
            const resultPanel = document.getElementById('positioning-result');
            const title = document.getElementById('positioning-title');
            const description = document.getElementById('positioning-description');
            if (tabChat && tabOne && leftForm && onePanel){
                tabChat.addEventListener('click', ()=>{
                    console.log('切換到 AI 對話模式');
                    tabChat.classList.add('bg-primary','text-white');
                    tabOne.classList.remove('bg-primary','text-white');
                    tabOne.classList.add('border','border-gray-300','dark:border-gray-600');
                    tabChat.classList.remove('border');
                    // 更新標題和說明顏色
                    if (title) title.className = 'text-2xl font-bold text-gray-900 dark:text-white';
                    if (description) description.textContent = '直接與AI對話，描述你的業務與受眾，我會一步步引導你完成定位分析';
                    // 隱藏左側一鍵生成設定模板（只隱藏表單，保留標籤）
                    leftForm.classList.add('hidden');
                    onePanel.classList.add('hidden');
                    // 顯示聊天對話框
                    const chatCard = document.getElementById('positioning-chat-card');
                    if (chatCard) chatCard.classList.remove('hidden');
                    if (resultPanel) resultPanel.classList.add('hidden');
                    // 調整聊天對話框高度
                    setTimeout(adjustPositioningHeights, 100);
                });
                tabOne.addEventListener('click', ()=>{
                    console.log('切換到一鍵生成模式');
                    tabOne.classList.add('bg-primary','text-white');
                    tabChat.classList.remove('bg-primary','text-white');
                    tabChat.classList.add('border','border-gray-300','dark:border-gray-600');
                    tabOne.classList.remove('border');
                    // 更新標題和說明顏色
                    if (title) title.className = 'text-2xl font-bold text-gray-900 dark:text-white';
                    if (description) description.textContent = '填寫必要資訊後，直接送出即可快速產生定位摘要';
                    // 顯示左側一鍵生成設定模板
                    leftForm.classList.remove('hidden');
                    onePanel.classList.remove('hidden');
                    // 隱藏聊天對話框
                    const chatCard = document.getElementById('positioning-chat-card');
                    if (chatCard) chatCard.classList.add('hidden');
                    // 顯示結果面板（一鍵生成模式下顯示結果）
                    if (resultPanel) resultPanel.classList.remove('hidden');
                    // 調整聊天對話框高度
                    setTimeout(adjustPositioningHeights, 100);
                });
                // 預設：AI 對話 → 隱藏左側模板
                console.log('初始化：設定為 AI 對話模式');
                leftForm.classList.add('hidden');
                onePanel.classList.add('hidden');
                if (resultPanel) resultPanel.classList.add('hidden');
            } else {
                console.log('定位頁面元素未找到:', {tabChat, tabOne, leftForm, onePanel});
            }
        }

        // 讓右側聊天對話框高度與左側表單同高（桌面端）
        function adjustPositioningHeights() {
            try {
                const left = document.getElementById('positioning-left');
                const chatCard = document.getElementById('positioning-chat-card');
                if (!left || !chatCard) return;
                if (window.innerWidth >= 1024) { // lg 斷點
                    // 如果左側表單被隱藏，使用預設最小高度
                    if (left.classList.contains('hidden')) {
                        chatCard.style.height = '600px';
                        chatCard.style.minHeight = '600px';
                    } else {
                    // 保留最小高度，避免高度被壓到 0 導致整張卡片消失
                    const target = Math.max(left.offsetHeight, 600);
                    chatCard.style.height = target + 'px';
                        chatCard.style.minHeight = '600px';
                    }
                } else {
                    chatCard.style.height = '';
                    chatCard.style.minHeight = '500px';
                }
            } catch (e) {
                // 忽略
            }
        }

        function updateToneSelection() {
            document.querySelectorAll('.tone-option').forEach(option => {
                const radio = option.parentElement.querySelector('input[type="radio"]');
                if (radio.checked) {
                    option.parentElement.classList.add('border-primary', 'bg-primary', 'text-white');
                    option.parentElement.classList.remove('border-gray-300', 'dark:border-gray-600');
                } else {
                    option.parentElement.classList.remove('border-primary', 'bg-primary', 'text-white');
                    option.parentElement.classList.add('border-gray-300', 'dark:border-gray-600');
                }
            });
        }

        async function generatePositioningResult() {
            // 點數授權檢查
            const authResult = await authorizeUsage('positioning', 'oneclick', 1);
            if (!authResult.authorized) {
                if (authResult.needTopup) {
                    showPurchaseModal();
                } else {
                    showToast(`點數不足，無法執行（需要 ${CREDIT_COSTS['positioning']} 點）`, 'error');
                }
                return;
            }

            const form = document.getElementById('positioning-form');
            const formData = new FormData(form);
            
            const industry = formData.get('industry');
            const audience = formData.get('audience');
            const pains = formData.get('pains');
            const tone = formData.get('tone');
            const competitors = formData.get('competitors');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const userId = user.id || 'web';

            // 後端：知識庫 + AI
            try {
                const res = await fetch(`${API_BASE}/agent/positioning/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        user_input: `產業：${industry}\n目標受眾：${audience}\n痛點：${pains}\n語氣：${tone}\n競品：${competitors || ''}`
                    })
                });
                const data = await res.json();
                if (data && !data.error) {
                    const ps = data.positioning_summary || data.summary || '';
                    const tg = data.tone_guidelines || data.tone || '';
                    let es = data.execution_suggestions || data.action_plan || data.recommendations || data.next_steps || '';
                    // 後備：嘗試從純文字回覆中擷取「執行建議」段落
                    if (!es && typeof data.assistant_message === 'string') {
                        const m = data.assistant_message.match(/執行建議[\s\S]*?$/);
                        es = m ? m[0].replace(/^執行建議\s*[:：]?\s*/,'') : '';
                    }
                    // 再後備：給出基本建議模板
                    if (!es) {
                        es = [
                            `內容節奏：每週 3-4 支短片；開頭 2~3 秒破題，結尾加 CTA。`,
                            `主題安排：以「${pains}」為核心痛點，結合 ${industry} 案例與實作示範。`,
                            `平台策略：${audience} 活躍的平台優先；固定欄位（教學/案例/QA）輪播。`
                        ].join('\n');
                    }
                    // 創建結果卡片
                    const cards = document.getElementById('positioning-cards');
                    if (cards) {
                        cards.innerHTML = `
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 space-y-2">
                                <div class="font-semibold text-gray-900 dark:text-white mb-1">品牌定位</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400 whitespace-pre-line">${ps}</div>
                            </div>
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 space-y-2">
                                <div class="font-semibold text-gray-900 dark:text-white mb-1">語氣守則</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400 whitespace-pre-line">${tg}</div>
                            </div>
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 space-y-2">
                                <div class="font-semibold text-gray-900 dark:text-white mb-1">執行建議</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400 whitespace-pre-line">${es}</div>
                            </div>
                        `;
                    }
                    document.getElementById('positioning-result').classList.remove('hidden');
                    showToast('定位分析完成！請查看右側結果', 'success');
                    // 成功後扣點
                    await consumePoints('positioning', 'oneclick', 1);
                    setTimeout(() => {
                        document.getElementById('positioning-result').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 300);
                    return; // 成功
                }
                throw new Error('API 回傳錯誤');
            } catch (e) {
                throw e; // 讓外層 fallback
            }
        }

        // 本地預設（離線 fallback）
        function generatePositioningResultLocal() {
            const form = document.getElementById('positioning-form');
            const formData = new FormData(form);
            const industry = formData.get('industry');
            const audience = formData.get('audience');
            const pains = formData.get('pains');
            const tone = formData.get('tone');
            
            // 生成假資料結果（舊版）
            const positioningSummary = `基於您的產業「${industry}」和目標受眾「${audience}」，建議定位為專業的解決方案提供者。針對受眾面臨的「${pains}」問題，提供具有差異化的價值主張。`;
            
            const toneGuidelines = {
                professional: '使用專業術語，保持客觀理性，強調數據和事實，避免過於情緒化的表達。',
                friendly: '採用親切友善的語調，使用「我們」、「您」等親近用詞，適當使用問候語和鼓勵性語言。',
                humorous: '適度使用幽默元素，但保持專業性，避免過度玩笑，確保內容有價值且易於理解。',
                authoritative: '展現專業權威，使用確定的語氣，引用專業數據和案例，建立可信度和影響力。'
            };

            const executionSuggestions = `建議採用流量型與轉換型內容 7:3 配比，每週發布 3-5 次，專注於 Instagram Reels 平台。開場使用問句式鉤子，2-3秒換畫面，保持節奏緊湊。`;

            // 顯示結果
            const cards = document.getElementById('positioning-cards');
            if (cards) {
                cards.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 space-y-2">
                        <div class="font-semibold text-gray-900 dark:text-white mb-1">品牌定位</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400 whitespace-pre-line">${positioningSummary}</div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 space-y-2">
                        <div class="font-semibold text-gray-900 dark:text-white mb-1">語氣守則</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400 whitespace-pre-line">${toneGuidelines[tone]}</div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 space-y-2">
                        <div class="font-semibold text-gray-900 dark:text-white mb-1">執行建議</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400 whitespace-pre-line">${executionSuggestions}</div>
                    </div>
                `;
            }
            
            document.getElementById('positioning-result').classList.remove('hidden');
            window.dispatchEvent(new CustomEvent('analyzePositioning', { detail: { industry, audience, pains, tone } }));
            showToast('定位分析完成！（離線預設）', 'success');
            setTimeout(() => {
                document.getElementById('positioning-result').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
        }

        // 選題助手功能
        function initIdeation() {
            const form = document.getElementById('ideation-form');
            const submitBtn = document.getElementById('ideation-submit');
            const submitText = submitBtn.querySelector('.submit-text');
            const loadingText = submitBtn.querySelector('.loading-text');

            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const topic = form.querySelector('[name="topic"]').value.trim();
                const count = parseInt(form.querySelector('[name="count"]').value);
                const dedupe = form.querySelector('[name="dedupe"]').checked;

                if (!topic || !count) {
                    showToast('請填寫主題和選擇產出條數', 'error');
                    return;
                }

                // 顯示載入狀態
                submitBtn.disabled = true;
                submitText.classList.add('hidden');
                loadingText.classList.remove('hidden');
                try{
                    document.getElementById('ideation-result').classList.remove('hidden');
                    document.getElementById('ideation-loading').classList.remove('hidden');
                    await generateIdeasFromAI(topic, count, dedupe);
                }catch(err){
                    console.warn('選題生成失敗，使用本地示例：', err);
                    generateIdeas(topic, count, dedupe);
                }finally{
                    document.getElementById('ideation-loading').classList.add('hidden');
                    submitBtn.disabled = false;
                    submitText.classList.remove('hidden');
                    loadingText.classList.add('hidden');
                }
            });

            // 快速示例按鈕
            document.querySelectorAll('#ideation-empty .quick-example-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const examples = {
                        '減肥方法': '減肥方法',
                        '投資理財': '投資理財', 
                        '職場技能': '職場技能'
                    };
                    
                    const exampleText = this.textContent.replace('快速示例：', '').trim();
                    const topic = examples[exampleText];
                    
                    if (topic) {
                        document.getElementById('topic').value = topic;
                        document.getElementById('count').value = '5';
                        showToast('已填入快速示例資料', 'success');
                    }
                });
            });

            // 腳本生成大師快速示例按鈕（已移除，因為現在有專門的主題輸入框）
            // 讓右側高度與左側等高（桌面端）
            function adjustIdeationHeights(){
                try{
                    const left = document.getElementById('ideation-left');
                    const chat = document.getElementById('ideation-chat-card');
                    if(!left||!chat) return;
                    if (window.innerWidth >= 1024){
                        // 如果左側表單被隱藏，使用預設高度
                        if (left.classList.contains('hidden')) {
                            chat.style.height = '600px';
                        } else {
                        chat.style.height = Math.max(left.offsetHeight, 500) + 'px';
                        }
                    } else {
                        chat.style.height = '';
                    }
                }catch(e){}
            }
            adjustIdeationHeights();
            window.addEventListener('resize', adjustIdeationHeights);

            const tabChat = document.getElementById('tab-ideation-chat');
            const tabOne = document.getElementById('tab-ideation-oneclick');
            const leftForm = document.getElementById('ideation-form');
            const resultPanel = document.getElementById('ideation-result');
            const emptyPanel = document.getElementById('ideation-empty');
            const title = document.getElementById('ideation-title');
            const description = document.getElementById('ideation-description');
            if (tabChat && tabOne && leftForm && emptyPanel){
                tabChat.addEventListener('click', ()=>{
                    console.log('切換到 AI 對話模式（選題）');
                    tabChat.classList.add('bg-primary','text-white');
                    tabOne.classList.remove('bg-primary','text-white');
                    tabOne.classList.add('border','border-gray-300','dark:border-gray-600');
                    tabChat.classList.remove('border');
                    // 更新標題和說明顏色
                    if (title) title.className = 'text-2xl font-bold text-gray-900 dark:text-white';
                    if (description) description.textContent = '直接與AI對話，描述你的主題與需求，我會一步步引導你完成選題分析';
                    // 隱藏左側一鍵生成設定模板（只隱藏表單，保留標籤）
                    leftForm.classList.add('hidden');
                    emptyPanel.classList.add('hidden');
                    // 顯示聊天對話框
                    const chatCard = document.getElementById('ideation-chat-card');
                    if (chatCard) chatCard.classList.remove('hidden');
                    if (resultPanel) resultPanel.classList.add('hidden');
                    if (emptyPanel) emptyPanel.classList.add('hidden');
                    // 調整聊天對話框高度
                    setTimeout(adjustIdeationHeights, 100);
                });
                tabOne.addEventListener('click', ()=>{
                    console.log('切換到一鍵生成模式（選題）');
                    tabOne.classList.add('bg-primary','text-white');
                    tabChat.classList.remove('bg-primary','text-white');
                    tabChat.classList.add('border','border-gray-300','dark:border-gray-600');
                    tabOne.classList.remove('border');
                    // 更新標題和說明顏色
                    if (title) title.className = 'text-2xl font-bold text-gray-900 dark:text-white';
                    if (description) description.textContent = '填寫必要資訊後，直接送出即可快速產生選題建議';
                    // 顯示左側一鍵生成設定模板
                    leftForm.classList.remove('hidden');
                    emptyPanel.classList.remove('hidden');
                    // 隱藏聊天對話框
                    const chatCard = document.getElementById('ideation-chat-card');
                    if (chatCard) chatCard.classList.add('hidden');
                    // 顯示結果面板（一鍵生成模式下顯示結果）
                    if (resultPanel) resultPanel.classList.remove('hidden');
                    if (emptyPanel) emptyPanel.classList.remove('hidden');
                    // 調整聊天對話框高度
                    setTimeout(adjustIdeationHeights, 100);
                });
                // 預設：AI 對話 → 隱藏左側模板
                console.log('初始化：設定為 AI 對話模式（選題）');
                leftForm.classList.add('hidden');
                emptyPanel.classList.add('hidden');
                if (resultPanel) resultPanel.classList.add('hidden');
                if (emptyPanel) emptyPanel.classList.add('hidden');
            }
        }

        // 後端：知識庫 + AI 產生選題
        async function generateIdeasFromAI(topic, count, dedupe){
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const userId = user.id || 'web';
            const res = await fetch(`${API_BASE}/agent/topics/suggest`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId, target_date: null })
            });
            const data = await res.json();
            if (!data || data.error){ throw new Error('topics api error'); }
            const ideasText = data.suggestions || data.reasoning || '';
            const cardsContainer = document.getElementById('ideation-cards');
            cardsContainer.innerHTML = '';
            const card = document.createElement('div');
            card.className = 'bg-white dark:bg-gray-800 rounded-lg shadow p-4 space-y-2';
            card.innerHTML = `<div class="font-semibold text-gray-900 dark:text-white mb-1">AI 生成建議</div><div class="text-sm text-gray-600 dark:text-gray-400 whitespace-pre-line">${ideasText}</div>`;
            cardsContainer.appendChild(card);
            document.getElementById('ideation-result').classList.remove('hidden');
            showToast('已產生 AI 選題建議！', 'success');
            setTimeout(()=>{ document.getElementById('ideation-result').scrollIntoView({behavior:'smooth', block:'start'}); }, 300);
        }

        function generateIdeas(topic, count, dedupe) {
            const ideas = [
                { hook: '你知道嗎？', angle: '數據統計', keyword: '驚人事實', why: '數據具有說服力，容易引起共鳴' },
                { hook: '為什麼會這樣？', angle: '原因分析', keyword: '深度解析', why: '滿足好奇心，提供深度內容' },
                { hook: '這樣做就對了！', angle: '實用技巧', keyword: '操作指南', why: '直接解決問題，實用性強' },
                { hook: '別再犯這個錯誤', angle: '常見誤區', keyword: '避坑指南', why: '警示性強，容易引起注意' },
                { hook: '成功案例分享', angle: '真實故事', keyword: '經驗分享', why: '真實性高，容易產生信任' },
                { hook: '專家都這樣說', angle: '權威觀點', keyword: '專業建議', why: '權威性強，增加可信度' },
                { hook: '最新趨勢來了', angle: '趨勢分析', keyword: '熱點話題', why: '時效性強，容易引起關注' },
                { hook: '對比一下就知道', angle: '對比分析', keyword: '優劣比較', why: '直觀易懂，幫助決策' },
                { hook: '小技巧大效果', angle: '實用技巧', keyword: '簡單方法', why: '操作簡單，效果明顯' },
                { hook: '背後的秘密', angle: '深度挖掘', keyword: '內幕揭秘', why: '神秘感強，滿足好奇心' }
            ];

            let selectedIdeas = ideas.slice(0, count);
            if (dedupe) {
                selectedIdeas = selectedIdeas.filter((idea, index, self) => 
                    index === self.findIndex(i => i.angle !== idea.angle)
                );
            }

            const cardsContainer = document.getElementById('ideation-cards');
            cardsContainer.innerHTML = '';

            selectedIdeas.forEach((idea, index) => {
                const card = document.createElement('div');
                card.className = 'bg-white dark:bg-gray-800 rounded-lg shadow p-4 space-y-2';
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">#${index + 1}</span>
                        <span class="text-xs bg-primary text-white px-2 py-1 rounded">${idea.keyword}</span>
                    </div>
                    <div class="font-semibold text-gray-900 dark:text-white">${idea.hook}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                        <strong>角度：</strong>${idea.angle}
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                        <strong>為什麼可行：</strong>${idea.why}
                    </div>
                `;
                cardsContainer.appendChild(card);
            });

            document.getElementById('ideation-result').classList.remove('hidden');

            // 派發事件
            window.dispatchEvent(new CustomEvent('generateIdeas', {
                detail: { topic, count, dedupe }
            }));

            showToast(`已產生 ${selectedIdeas.length} 個選題建議！請查看下方結果`, 'success');
            
            // 滾動到結果區域
            setTimeout(() => {
                document.getElementById('ideation-result').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }, 500);
        }

        // 腳本生成器功能
        function initScript() {
            // 模式選擇
            document.querySelectorAll('input[name="script_mode"]').forEach(radio => {
                radio.addEventListener('change', updateModeSelection);
            });

            // 模板選擇
            document.querySelectorAll('input[name="script_template"]').forEach(radio => {
                radio.addEventListener('change', updateTemplateSelection);
            });

            // 時長選擇
            document.querySelectorAll('input[name="script_duration"]').forEach(radio => {
                radio.addEventListener('change', updateDurationSelection);
            });

            // 套用設定按鈕（右側主題輸入）
            const oneclickBtn = document.getElementById('oneclick-generate');
            if (oneclickBtn) {
                oneclickBtn.addEventListener('click', function() {
                const mode = document.querySelector('input[name="script_mode"]:checked')?.value || 'educational';
                const template = document.querySelector('input[name="script_template"]:checked')?.value || 'A';
                const duration = document.querySelector('input[name="script_duration"]:checked')?.value || '30';

                // 讀取主題輸入
                const topic = document.getElementById('script-topic-input')?.value?.trim();
                if (!topic) {
                    showToast('請先輸入腳本主題', 'error');
                    return;
                }

                // 顯示載入狀態
                const loadingText = oneclickBtn.querySelector('.loading-text');
                const submitText = oneclickBtn.querySelector('.submit-text');
                if (loadingText) loadingText.classList.remove('hidden');
                if (submitText) submitText.classList.add('hidden');
                oneclickBtn.disabled = true;

                // 顯示結果區域
                const scriptResult = document.getElementById('script-result');
                const scriptContent = document.getElementById('script-content');
                if (scriptResult) scriptResult.classList.remove('hidden');
                if (scriptContent) scriptContent.innerHTML = '<p class="text-gray-500 dark:text-gray-400">生成中...</p>';

                // 生成腳本
                generateScript(topic, mode, template, duration, oneclickBtn, scriptContent);
                });
            }

            // 套用設定並生成腳本按鈕（左側設定區域）
            const applySettingsBtn = document.getElementById('apply-settings-generate');
            if (applySettingsBtn) {
                applySettingsBtn.addEventListener('click', function() {
                    const mode = document.querySelector('input[name="script_mode"]:checked')?.value || 'educational';
                    const template = document.querySelector('input[name="script_template"]:checked')?.value || 'A';
                    const duration = document.querySelector('input[name="script_duration"]:checked')?.value || '30';

                    // 顯示載入狀態
                    const loadingText = applySettingsBtn.querySelector('.apply-loading');
                    const applyText = applySettingsBtn.querySelector('.apply-text');
                    if (loadingText) loadingText.classList.remove('hidden');
                    if (applyText) applyText.classList.add('hidden');
                    applySettingsBtn.disabled = true;

                    // 生成主題和腳本
                    generateScriptWithTopic(mode, template, duration, applySettingsBtn);
                });
            }

            // 生成主題和腳本函數
            async function generateScriptWithTopic(mode, template, duration, button) {
                try {
                    // 先生成主題
                    const topicResponse = await fetch(`${API_BASE}/chat`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            user_id: JSON.parse(localStorage.getItem('user') || '{}').id || 'web',
                            agent_type: 'script',
                            messages: [{
                                role: 'user',
                                content: `請為我生成一個適合${mode}模式、${template}模板、${duration}秒時長的短影音腳本主題。請直接回覆主題，不要其他說明。`
                            }]
                        })
                    });

                    if (!topicResponse.ok) {
                        throw new Error('生成主題失敗');
                    }

                    const topicData = await topicResponse.json();
                    const generatedTopic = topicData.assistant_message || topicData.response || '短影音腳本主題';

                    // 將生成的主題填入右側輸入框
                    const topicInput = document.getElementById('script-topic-input');
                    if (topicInput) {
                        topicInput.value = generatedTopic;
                    }

                    // 顯示結果區域
                    const scriptResult = document.getElementById('script-result');
                    const scriptContent = document.getElementById('script-content');
                    if (scriptResult) scriptResult.classList.remove('hidden');
                    if (scriptContent) scriptContent.innerHTML = '<p class="text-gray-500 dark:text-gray-400">正在生成腳本...</p>';

                    // 生成腳本
                    const scriptResponse = await fetch(`${API_BASE}/chat`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            user_id: JSON.parse(localStorage.getItem('user') || '{}').id || 'web',
                            agent_type: 'script',
                            messages: [{
                                role: 'user',
                                content: `請為我生成一個腳本。主題：${generatedTopic}，模式：${mode}，模板：${template}，時長：${duration}秒`
                            }]
                        })
                    });

                    if (!scriptResponse.ok) {
                        throw new Error('生成腳本失敗');
                    }

                    const scriptData = await scriptResponse.json();
                    if (scriptContent) {
                        scriptContent.innerHTML = marked.parse(scriptData.assistant_message || scriptData.response || '生成失敗');
                    }
                    
                    showToast('腳本生成成功！', 'success');
                } catch (error) {
                    console.error('Error generating script with topic:', error);
                    const scriptContent = document.getElementById('script-content');
                    if (scriptContent) {
                        scriptContent.innerHTML = `<p class="text-red-500">生成失敗: ${error.message}</p>`;
                    }
                    showToast(`生成失敗: ${error.message}`, 'error');
                } finally {
                    // 還原按鈕狀態
                    const loadingText = button.querySelector('.apply-loading');
                    const applyText = button.querySelector('.apply-text');
                    if (loadingText) loadingText.classList.add('hidden');
                    if (applyText) applyText.classList.remove('hidden');
                    button.disabled = false;
                }
            }

            // 生成腳本函數
            async function generateScript(topic, mode, template, duration, button, contentElement) {
                try {
                    // 使用 /chat 端點，因為 /agent/content/generate 可能不存在或需要不同的參數
                    const response = await fetch(`${API_BASE}/chat`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            user_id: JSON.parse(localStorage.getItem('user') || '{}').id || 'web',
                            agent_type: 'script',
                            messages: [{
                                role: 'user',
                                content: `請為我生成一個腳本。主題：${topic}，模式：${mode}，模板：${template}，時長：${duration}秒`
                            }]
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || '生成腳本失敗');
                    }

                    const data = await response.json();
                    contentElement.innerHTML = marked.parse(data.assistant_message || data.response || '生成失敗');
                    showToast('腳本生成成功！', 'success');
                } catch (error) {
                    console.error('Error generating script:', error);
                    contentElement.innerHTML = `<p class="text-red-500">生成腳本失敗: ${error.message}</p>`;
                    showToast(`生成腳本失敗: ${error.message}`, 'error');
                } finally {
                    // 還原按鈕狀態
                    const loadingText = button.querySelector('.loading-text');
                    const submitText = button.querySelector('.submit-text');
                    if (loadingText) loadingText.classList.add('hidden');
                    if (submitText) submitText.classList.remove('hidden');
                    button.disabled = false;
                }
            }

            // 初始化時更新選擇狀態
            updateModeSelection();
            updateTemplateSelection();
            updateDurationSelection();

            // 鍵盤導航
            initKeyboardNavigation();

            // 切換面板事件
            const tabChat = document.getElementById('tab-script-chat');
            const tabOne = document.getElementById('tab-script-oneclick');
            const panelChat = document.getElementById('script-chat-panel');
            const panelOne = document.getElementById('script-oneclick-panel');
            const resultPanel = document.getElementById('script-result');
            // 標題和描述元素已移除，不再需要更新
            
            if (tabChat && tabOne && panelChat && panelOne){
                // 提供全域切換函式（onclick 後援）
                window.switchScriptTab = (mode)=>{
                    console.log('switchScriptTab called with mode:', mode);
                    if (mode === 'one') {
                        console.log('Switching to one-click mode');
                        tabOne.click();
                    } else {
                        console.log('Switching to chat mode');
                        tabChat.click();
                    }
                };
                tabChat.addEventListener('click', ()=>{
                    console.log('切換到 AI 對話模式（腳本）');
                    tabChat.classList.add('bg-primary','text-white');
                    tabOne.classList.remove('bg-primary','text-white');
                    tabOne.classList.add('border','border-gray-300','dark:border-gray-600');
                    tabChat.classList.remove('border');
                    // 標題和描述已移除，不需要更新
                    // 隱藏一鍵生成面板
                    panelOne.classList.add('hidden');
                    // 顯示聊天對話框
                    panelChat.classList.remove('hidden');
                    // 無藍色提示區塊（與其他頁一致）
                    if (resultPanel) resultPanel.classList.add('hidden');
                });
                
                tabOne.addEventListener('click', ()=>{
                    console.log('切換到一鍵生成模式（腳本）');
                    tabOne.classList.add('bg-primary','text-white');
                    tabChat.classList.remove('bg-primary','text-white');
                    tabChat.classList.add('border','border-gray-300','dark:border-gray-600');
                    tabOne.classList.remove('border');
                    // 標題和描述已移除，不需要更新
                    // 顯示一鍵生成面板
                    panelOne.classList.remove('hidden');
                    // 隱藏聊天對話框
                    panelChat.classList.add('hidden');
                    // 顯示結果面板（一鍵生成模式下顯示結果）
                    if (resultPanel) resultPanel.classList.remove('hidden');
                });
                
                // 保障點擊事件（事件委派備援）
                const scriptTabs = document.getElementById('script-tabs');
                scriptTabs?.addEventListener('click', (evt)=>{
                    const btn = evt.target?.closest('button');
                    if (!btn) return;
                    if (btn.id === 'tab-script-oneclick') {
                        tabOne?.click();
                    } else if (btn.id === 'tab-script-chat') {
                        tabChat?.click();
                    }
                });
                
                // 預設：AI 對話 → 隱藏一鍵生成面板
                console.log('初始化：設定為 AI 對話模式（腳本）');
                panelOne.classList.add('hidden');
                if (resultPanel) resultPanel.classList.add('hidden');
            }

        }

        function updateModeSelection() {
            document.querySelectorAll('input[name="script_mode"]').forEach(radio => {
                const label = radio.closest('label');
                if (label) {
                if (radio.checked) {
                        label.classList.add('border-primary', 'bg-primary', 'text-white');
                        label.classList.remove('border-gray-300', 'dark:border-gray-600', 'hover:bg-gray-50', 'dark:hover:bg-gray-700', 'hover:text-gray-900', 'dark:hover:text-gray-100');
                } else {
                        label.classList.remove('border-primary', 'bg-primary', 'text-white');
                        label.classList.add('border-gray-300', 'dark:border-gray-600', 'hover:bg-gray-50', 'dark:hover:bg-gray-700', 'hover:text-gray-900', 'dark:hover:text-gray-100');
                    }
                }
            });
        }

        function updateTemplateSelection() {
            document.querySelectorAll('input[name="script_template"]').forEach(radio => {
                const label = radio.closest('label');
                if (label) {
                if (radio.checked) {
                        label.classList.add('border-primary', 'bg-primary', 'text-white');
                        label.classList.remove('border-gray-300', 'dark:border-gray-600', 'hover:bg-gray-50', 'dark:hover:bg-gray-700', 'hover:text-gray-900', 'dark:hover:text-gray-100');
                } else {
                        label.classList.remove('border-primary', 'bg-primary', 'text-white');
                        label.classList.add('border-gray-300', 'dark:border-gray-600', 'hover:bg-gray-50', 'dark:hover:bg-gray-700', 'hover:text-gray-900', 'dark:hover:text-gray-100');
                    }
                }
            });
        }

        function updateDurationSelection() {
            document.querySelectorAll('input[name="script_duration"]').forEach(radio => {
                const label = radio.closest('label');
                if (label) {
                if (radio.checked) {
                        label.classList.add('border-primary', 'bg-primary', 'text-white');
                        label.classList.remove('border-gray-300', 'dark:border-gray-600', 'hover:bg-gray-50', 'dark:hover:bg-gray-700', 'hover:text-gray-900', 'dark:hover:text-gray-100');
                } else {
                        label.classList.remove('border-primary', 'bg-primary', 'text-white');
                        label.classList.add('border-gray-300', 'dark:border-gray-600', 'hover:bg-gray-50', 'dark:hover:bg-gray-700', 'hover:text-gray-900', 'dark:hover:text-gray-100');
                    }
                }
            });
        }

        function generateScriptPreview(mode, template, duration) {
            const modeText = mode === 'guided' ? '引導模式' : '自由模式';
            const templateText = `模板 ${template}`;
            const durationText = `${duration} 秒`;

            document.getElementById('script-mode').textContent = modeText;
            document.getElementById('script-template').textContent = templateText;
            document.getElementById('script-duration').textContent = durationText;

            // 生成假腳本內容
            document.getElementById('script-loading').classList.remove('hidden');
            const scriptContent = generateScriptContent(template, duration);
            document.getElementById('script-content').textContent = scriptContent;

            document.getElementById('script-empty').classList.add('hidden');
            document.getElementById('script-result').classList.remove('hidden');
            
            showToast('腳本生成完成！請查看下方結果', 'success');
            
            // 滾動到結果區域
            setTimeout(() => {
                document.getElementById('script-result').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }, 500);
            document.getElementById('script-loading').classList.add('hidden');
        }

        function generateScriptContent(template, duration) {
            const templates = {
                A: {
                    title: '三段式腳本',
                    content: `開頭（0-${Math.floor(duration * 0.2)}秒）：
大家好，今天要分享一個重要主題...

主體（${Math.floor(duration * 0.2)}-${Math.floor(duration * 0.8)}秒）：
首先，我們來看看...其次...最後...

結尾（${Math.floor(duration * 0.8)}-${duration}秒）：
總結一下，記住這三個重點...`
                },
                B: {
                    title: '問題解決腳本',
                    content: `問題（0-${Math.floor(duration * 0.3)}秒）：
你是否遇到這樣的困擾...

分析（${Math.floor(duration * 0.3)}-${Math.floor(duration * 0.7)}秒）：
這個問題的根本原因是...

解決（${Math.floor(duration * 0.7)}-${duration}秒）：
解決方案很簡單，只需要...`
                },
                C: {
                    title: 'Before-After 腳本',
                    content: `Before（0-${Math.floor(duration * 0.4)}秒）：
以前的我總是...

After（${Math.floor(duration * 0.4)}-${Math.floor(duration * 0.8)}秒）：
現在的我學會了...

轉變（${Math.floor(duration * 0.8)}-${duration}秒）：
關鍵就在於...`
                },
                D: {
                    title: '教學腳本',
                    content: `介紹（0-${Math.floor(duration * 0.2)}秒）：
今天教大家一個實用技巧...

步驟一（${Math.floor(duration * 0.2)}-${Math.floor(duration * 0.4)}秒）：
第一步...

步驟二（${Math.floor(duration * 0.4)}-${Math.floor(duration * 0.6)}秒）：
第二步...

步驟三（${Math.floor(duration * 0.6)}-${Math.floor(duration * 0.8)}秒）：
第三步...

總結（${Math.floor(duration * 0.8)}-${duration}秒）：
記住這三個步驟...`
                },
                E: {
                    title: '故事腳本',
                    content: `開場（0-${Math.floor(duration * 0.2)}秒）：
讓我分享一個真實故事...

故事（${Math.floor(duration * 0.2)}-${Math.floor(duration * 0.7)}秒）：
有一天...當時我...結果...

啟發（${Math.floor(duration * 0.7)}-${duration}秒）：
這個故事告訴我們...`
                },
                F: {
                    title: '爆點連發腳本',
                    content: `爆點一（0-${Math.floor(duration * 0.25)}秒）：
你知道嗎？驚人事實...

爆點二（${Math.floor(duration * 0.25)}-${Math.floor(duration * 0.5)}秒）：
更驚人的是...

爆點三（${Math.floor(duration * 0.5)}-${Math.floor(duration * 0.75)}秒）：
最關鍵的是...

行動（${Math.floor(duration * 0.75)}-${duration}秒）：
現在就開始...`
                }
            };

            return templates[template].content;
        }

        // 鍵盤導航功能
        function initKeyboardNavigation() {
            // 為所有可選元素添加 tabindex
            document.querySelectorAll('input[type="radio"], button, a').forEach(el => {
                if (!el.hasAttribute('tabindex')) {
                    el.setAttribute('tabindex', '0');
                }
            });

            // 處理鍵盤事件
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    const activeElement = document.activeElement;
                    if (activeElement && activeElement.tagName === 'LABEL') {
                        e.preventDefault();
                        const radio = activeElement.querySelector('input[type="radio"]');
                        if (radio) {
                            radio.checked = true;
                            radio.dispatchEvent(new Event('change'));
                        }
                    }
                }
            });
        }

        // 資料儲存與載入
        function saveFormData() {
            const forms = ['positioning-form', 'ideation-form'];
            forms.forEach(formId => {
                const form = document.getElementById(formId);
                if (form) {
                    const formData = new FormData(form);
                    const data = {};
                    for (let [key, value] of formData.entries()) {
                        data[key] = value;
                    }
                    sessionStorage.setItem(formId, JSON.stringify(data));
                }
            });
        }

        function loadStoredData() {
            const forms = ['positioning-form', 'ideation-form'];
            forms.forEach(formId => {
                const stored = sessionStorage.getItem(formId);
                if (stored) {
                    try {
                        const data = JSON.parse(stored);
                        const form = document.getElementById(formId);
                        if (form) {
                            Object.keys(data).forEach(key => {
                                const input = form.querySelector(`[name="${key}"]`);
                                if (input) {
                                    if (input.type === 'radio') {
                                        if (input.value === data[key]) {
                                            input.checked = true;
                                        }
                                    } else {
                                        input.value = data[key];
                                    }
                                }
                            });
                            
                            // 更新視覺狀態
                            if (formId === 'positioning-form') {
                                updateToneSelection();
                            }
                        }
                    } catch (e) {
                        console.warn('無法載入儲存的表單資料:', e);
                    }
                }
            });
        }

        // 定期儲存表單資料
        setInterval(saveFormData, 2000);

        // 頁面切換時儲存資料
        document.addEventListener('click', function(e) {
            if (e.target.matches('a[href^="#!"]') || e.target.closest('a[href^="#!"]')) {
                setTimeout(saveFormData, 100);
            }
        });
    </script>

    <script>
    // 後端串接事件監聽範例：
    
    // 監聽定位分析事件
    window.addEventListener('analyzePositioning', function(event) {
        const { industry, audience, pains, tone, competitors } = event.detail;
        
        // 發送 API 請求
        fetch('/api/analyze-positioning', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ industry, audience, pains, tone, competitors })
        })
        .then(response => response.json())
        .then(data => {
            // 更新 UI 顯示結果
            const cards = document.getElementById('positioning-cards');
            if (cards) {
                cards.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 space-y-2">
                        <div class="font-semibold text-gray-900 dark:text-white mb-1">品牌定位</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400 whitespace-pre-line">${data.summary}</div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 space-y-2">
                        <div class="font-semibold text-gray-900 dark:text-white mb-1">語氣守則</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400 whitespace-pre-line">${data.guidelines}</div>
                    </div>
                `;
            }
            document.getElementById('positioning-result').classList.remove('hidden');
        })
        .catch(error => {
            console.error('定位分析失敗:', error);
            showToast('分析失敗，請稍後再試', 'error');
        });
    });

    // 監聽選題生成事件
    window.addEventListener('generateIdeas', function(event) {
        const { topic, count, dedupe } = event.detail;
        
        fetch('/api/generate-ideas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ topic, count, dedupe })
        })
        .then(response => response.json())
        .then(data => {
            // 更新選題卡片
            updateIdeationCards(data.ideas);
        })
        .catch(error => {
            console.error('選題生成失敗:', error);
            showToast('生成失敗，請稍後再試', 'error');
        });
    });

    // 監聽腳本設定套用事件
    window.addEventListener('applySettings', function(event) {
        const { mode, template, duration } = event.detail;
        
        fetch('/api/generate-script', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode, template, duration })
        })
        .then(response => response.json())
        .then(data => {
            // 更新腳本預覽
            document.getElementById('script-content').textContent = data.script;
        })
        .catch(error => {
            console.error('腳本生成失敗:', error);
            showToast('生成失敗，請稍後再試', 'error');
        });
    });

    // 訂閱方案功能
    let subscriptionPlans = [];

    // 初始化訂閱方案
    async function initSubscriptionPlans() {
        try {
            const response = await fetch(`${API_BASE}/api/plans`);
            const data = await response.json();
            subscriptionPlans = data.plans || [];
            renderSubscriptionPlans();
        } catch (error) {
            console.error('載入訂閱方案失敗:', error);
            // 如果API失敗，顯示預設方案
            subscriptionPlans = [
                { id: 1, name: '基礎方案', description: '適合個人創作者', price: 99, credits: 100, duration_days: 30 },
                { id: 2, name: '專業方案', description: '適合小型團隊', price: 299, credits: 500, duration_days: 30 },
                { id: 3, name: '企業方案', description: '適合大型企業', price: 999, credits: 2000, duration_days: 30 }
            ];
            renderSubscriptionPlans();
        }
    }

    // 渲染訂閱方案
    function renderSubscriptionPlans() {
        const container = document.getElementById('subscription-plans');
        if (!container) return;

        // 點數包方案
        const pointPacks = [
            { id: 1, name: '小額包', description: '適合輕度使用者', price: 399, credits: 300, duration_days: 180, popular: false },
            { id: 2, name: '標準包', description: '適合一般創作者', price: 1099, credits: 1000, duration_days: 180, popular: true },
            { id: 3, name: '大額包', description: '適合重度使用者', price: 3399, credits: 3000, duration_days: 180, popular: false }
        ];

        container.innerHTML = pointPacks.map(pack => `
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 hover:shadow-xl transition-all duration-300 ${pack.popular ? 'ring-2 ring-primary transform scale-105' : ''} relative">
                ${pack.popular ? '<div class="absolute -top-4 left-1/2 transform -translate-x-1/2"><span class="bg-primary text-white px-4 py-1 rounded-full text-sm font-semibold">🔥 推薦</span></div>' : ''}
                <div class="text-center">
                    <div class="text-4xl mb-4">${pack.name === '小額包' ? '💎' : pack.name === '標準包' ? '💎💎' : '💎💎💎'}</div>
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">${pack.name}</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">${pack.description}</p>
                    <div class="text-4xl font-bold text-primary mb-2">NT$ ${pack.price.toLocaleString()}</div>
                    <div class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">${pack.credits.toLocaleString()} 點數</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400 mb-6">有效期 ${pack.duration_days} 天</div>
                    <button onclick="selectPointPack(${pack.id})" class="w-full bg-gradient-to-r from-primary to-primary-hover text-white py-3 px-6 rounded-xl hover:from-primary-hover hover:to-primary transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 transform hover:-translate-y-1">
                        立即購買
                    </button>
                </div>
            </div>
        `).join('');

        // 訂閱方案
        const subscriptionPlans = [
            { id: 1, name: '基礎方案', description: '適合個人創作者', monthly_points: 100, batch_limit: 10, roles_limit: 1, price: 299 },
            { id: 2, name: '專業方案', description: '適合小型團隊', monthly_points: 500, batch_limit: 50, roles_limit: 3, price: 999 },
            { id: 3, name: '企業方案', description: '適合大型企業', monthly_points: 2000, batch_limit: 200, roles_limit: 10, price: 2999 }
        ];

        const advancedContainer = document.getElementById('subscription-plans-advanced');
        if (advancedContainer) {
            advancedContainer.innerHTML = subscriptionPlans.map(plan => `
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 hover:shadow-xl transition-all duration-300 ${plan.name === '專業方案' ? 'ring-2 ring-primary transform scale-105' : ''} relative">
                    ${plan.name === '專業方案' ? '<div class="absolute -top-4 left-1/2 transform -translate-x-1/2"><span class="bg-primary text-white px-4 py-1 rounded-full text-sm font-semibold">⭐ 熱門</span></div>' : ''}
                    <div class="text-center">
                        <div class="text-4xl mb-4">${plan.name === '基礎方案' ? '🚀' : plan.name === '專業方案' ? '🚀🚀' : '🚀🚀🚀'}</div>
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">${plan.name}</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">${plan.description}</p>
                        <div class="text-4xl font-bold text-primary mb-2">NT$ ${plan.price.toLocaleString()}</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400 mb-6">每月</div>
                        <ul class="text-left space-y-2 mb-6">
                            <li class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                                <svg class="w-4 h-4 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                                每月 ${plan.monthly_points} 點數
                            </li>
                            <li class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                                <svg class="w-4 h-4 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                                批次上限 ${plan.batch_limit} 次
                            </li>
                            <li class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                                <svg class="w-4 h-4 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                                角色上限 ${plan.roles_limit} 個
                            </li>
                        </ul>
                        <button onclick="selectSubscriptionPlan(${plan.id})" class="w-full bg-gradient-to-r from-primary to-primary-hover text-white py-3 px-6 rounded-xl hover:from-primary-hover hover:to-primary transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 transform hover:-translate-y-1">
                            選擇方案
                        </button>
                    </div>
                </div>
            `).join('');
        }
    }

    // 顯示購買彈窗
    function showPurchaseModal() {
        const modal = document.getElementById('purchase-modal');
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.classList.add('modal-open');
        }
    }

    // 關閉購買彈窗
    function closePurchaseModal() {
        const modal = document.getElementById('purchase-modal');
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.classList.remove('modal-open');
        }
    }

    // 選擇方案
    function selectPlan(planId) {
        const plan = subscriptionPlans.find(p => p.id === planId);
        if (!plan) return;

        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if (!user.id) {
            showToast('請先登入', 'error');
            closePurchaseModal();
            return;
        }

        // 確認購買
        if (confirm(`確定要購買「${plan.name}」嗎？\n價格：NT$ ${plan.price}\n點數：${plan.credits} 點`)) {
            purchasePlan(planId);
        }
    }

    // 購買方案
    async function purchasePlan(planId) {
        try {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const response = await fetch(`${API_BASE}/api/purchase`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    user_id: user.id,
                    plan_id: planId,
                    payment_method: 'manual'
                })
            });

            const data = await response.json();
            if (data.ok) {
                showToast(`購買成功！已獲得 ${data.credits_added} 點數`, 'success');
                closePurchaseModal();
                // 更新用戶點數顯示
                updateUserCredits(data.new_balance);
            } else {
                showToast('購買失敗，請稍後再試', 'error');
            }
        } catch (error) {
            console.error('購買失敗:', error);
            showToast('購買失敗，請稍後再試', 'error');
        }
    }

    // 更新用戶點數顯示
    function updateUserCredits(balance) {
        const creditsElement = document.querySelector('#user-credits');
        if (creditsElement) {
            creditsElement.textContent = balance;
        }
    }

    // 選擇點數包
    function selectPointPack(packId) {
        const packs = [
            { id: 1, name: '小額包', price: 399, credits: 300, description: '適合輕度使用者' },
            { id: 2, name: '標準包', price: 1099, credits: 1000, description: '適合一般創作者' },
            { id: 3, name: '大額包', price: 3399, credits: 3000, description: '適合重度使用者' }
        ];
        
        const pack = packs.find(p => p.id === packId);
        if (!pack) return;
        
        // 顯示付款頁面
        showPaymentPage(pack);
    }
    
    // 顯示付款頁面
    function showPaymentPage(plan) {
        // 更新付款頁面內容
        document.getElementById('plan-name').textContent = plan.name;
        document.getElementById('plan-description').textContent = plan.description;
        document.getElementById('plan-price').textContent = `NT$ ${plan.price.toLocaleString()}`;
        document.getElementById('plan-credits').textContent = `${plan.credits.toLocaleString()} 點數`;
        document.getElementById('subtotal').textContent = `NT$ ${plan.price.toLocaleString()}`;
        document.getElementById('total-amount').textContent = `NT$ ${plan.price.toLocaleString()}`;
        
        // 隱藏購買彈窗，顯示付款頁面
        closePurchaseModal();
        document.getElementById('payment-page').classList.remove('hidden');
        document.body.classList.add('modal-open');
    }
    
    // 隱藏付款頁面
    function hidePaymentPage() {
        document.getElementById('payment-page').classList.add('hidden');
        document.body.classList.remove('modal-open');
    }
    
    // 手機版手勢支援
    function setupMobileGestures() {
        const paymentPage = document.getElementById('payment-page');
        if (!paymentPage) return;
        
        let startY = 0;
        let currentY = 0;
        let isDragging = false;
        
        paymentPage.addEventListener('touchstart', function(e) {
            startY = e.touches[0].clientY;
            isDragging = true;
        }, { passive: true });
        
        paymentPage.addEventListener('touchmove', function(e) {
            if (!isDragging) return;
            currentY = e.touches[0].clientY;
            const diff = startY - currentY;
            
            // 向下滑動超過100px時關閉
            if (diff < -100) {
                hidePaymentPage();
                isDragging = false;
            }
        }, { passive: true });
        
        paymentPage.addEventListener('touchend', function() {
            isDragging = false;
        }, { passive: true });
    }
    
    // 選擇訂閱方案
    function selectSubscriptionPlan(planId) {
        const plans = [
            { id: 1, name: '基礎方案', price: 299 },
            { id: 2, name: '專業方案', price: 999 },
            { id: 3, name: '企業方案', price: 2999 }
        ];
        
        const plan = plans.find(p => p.id === planId);
        if (!plan) return;
        
        if (confirm(`確定要選擇「${plan.name}」嗎？\n價格：NT$ ${plan.price.toLocaleString()}/月`)) {
            showToast(`正在處理「${plan.name}」訂閱...`, 'info');
            // 這裡可以跳轉到訂閱付款頁面
        }
    }
    
    // 顯示購買彈窗（全域函數）
    function showPurchaseModal() {
        if (window.aiPoints && window.aiPoints.showModal) {
            window.aiPoints.showModal();
        } else {
            showToast('點數系統載入中，請稍後再試', 'info');
        }
    }
    
    // 初始化訂閱方案
    initSubscriptionPlans();
    
    // 確保頁面載入後執行
    document.addEventListener('DOMContentLoaded', function() {
        initSubscriptionPlans();
        
        // 付款頁面事件監聽器
        setupPaymentPageEvents();
        
        // 手機版手勢支援
        setupMobileGestures();
        
        // 帳戶和設定視窗事件
        setupAccountAndSettingsModals();
    });
    
    // 設置付款頁面事件監聽器
    function setupPaymentPageEvents() {
        // 返回選擇方案按鈕
        const backToPlansBtn = document.getElementById('back-to-plans');
        if (backToPlansBtn) {
            backToPlansBtn.addEventListener('click', function() {
                hidePaymentPage();
                showPurchaseModal();
            });
        }
        
        // 手機版關閉按鈕
        const paymentCloseMobile = document.getElementById('payment-close-mobile');
        if (paymentCloseMobile) {
            paymentCloseMobile.addEventListener('click', function() {
                hidePaymentPage();
            });
        }
        
        // 確認付款按鈕
        const proceedPaymentBtn = document.getElementById('proceed-payment');
        if (proceedPaymentBtn) {
            proceedPaymentBtn.addEventListener('click', function() {
                processPayment();
            });
        }
        
        // 付款方式選擇
        const paymentMethods = document.querySelectorAll('input[name="payment-method"]');
        paymentMethods.forEach(method => {
            method.addEventListener('change', function() {
                updatePaymentMethodUI(this.value);
            });
        });
    }
    
    // 更新付款方式UI
    function updatePaymentMethodUI(method) {
        // 重置所有選項的樣式
        const labels = document.querySelectorAll('label[for*="payment-method"]');
        labels.forEach(label => {
            const radio = label.querySelector('input[type="radio"]');
            const circle = label.querySelector('.w-6.h-6');
            const innerCircle = circle.querySelector('.w-3.h-3');
            
            if (radio.value === method) {
                circle.classList.remove('border-gray-300', 'dark:border-gray-600');
                circle.classList.add('border-primary');
                if (innerCircle) {
                    innerCircle.classList.add('bg-primary');
                }
            } else {
                circle.classList.remove('border-primary');
                circle.classList.add('border-gray-300', 'dark:border-gray-600');
                if (innerCircle) {
                    innerCircle.classList.remove('bg-primary');
                }
            }
        });
    }
    
    // 處理付款
    function processPayment() {
        const selectedMethod = document.querySelector('input[name="payment-method"]:checked');
        if (!selectedMethod) {
            showToast('請選擇付款方式', 'error');
            return;
        }
        
        const method = selectedMethod.value;
        const planName = document.getElementById('plan-name').textContent;
        const totalAmount = document.getElementById('total-amount').textContent;
        
        // 顯示載入狀態
        const proceedBtn = document.getElementById('proceed-payment');
        const originalText = proceedBtn.textContent;
        proceedBtn.textContent = '處理中...';
        proceedBtn.disabled = true;
        
        // 模擬付款處理
        setTimeout(() => {
            // 這裡應該調用實際的金流API
            switch(method) {
                case 'credit-card':
                    showToast('信用卡付款功能開發中，請選擇其他付款方式', 'info');
                    break;
                case 'line-pay':
                    showToast('LINE Pay 付款功能開發中，請選擇其他付款方式', 'info');
                    break;
                case 'jkopay':
                    showToast('街口支付功能開發中，請選擇其他付款方式', 'info');
                    break;
                case 'atm':
                    showToast('ATM轉帳功能開發中，請選擇其他付款方式', 'info');
                    break;
                default:
                    showToast('付款方式不支援', 'error');
            }
            
            // 恢復按鈕狀態
            proceedBtn.textContent = originalText;
            proceedBtn.disabled = false;
        }, 2000);
    }
    
    // 設置帳戶和設定視窗事件
    function setupAccountAndSettingsModals() {
        // 帳戶視窗
        const accountModal = document.getElementById('account-modal');
        const accountModalClose = document.getElementById('account-modal-close');
        const accountLinks = document.querySelectorAll('a[href="#"]:has(span:contains("帳戶"))');
        
        // 設定視窗
        const settingsModal = document.getElementById('settings-modal');
        const settingsModalClose = document.getElementById('settings-modal-close');
        const settingsLinks = document.querySelectorAll('a[href="#"]:has(span:contains("設定"))');
        
        // 開啟帳戶視窗
        function showAccountModal() {
            if (accountModal) {
                accountModal.classList.remove('hidden');
                accountModal.classList.add('flex');
                document.body.classList.add('modal-open');
                loadAccountData();
            }
        }
        
        // 關閉帳戶視窗
        function hideAccountModal() {
            if (accountModal) {
                accountModal.classList.add('hidden');
                accountModal.classList.remove('flex');
                document.body.classList.remove('modal-open');
            }
        }
        
        // 開啟設定視窗
        function showSettingsModal() {
            if (settingsModal) {
                settingsModal.classList.remove('hidden');
                settingsModal.classList.add('flex');
                document.body.classList.add('modal-open');
                loadSettingsData();
            }
        }
        
        // 關閉設定視窗
        function hideSettingsModal() {
            if (settingsModal) {
                settingsModal.classList.add('hidden');
                settingsModal.classList.remove('flex');
                document.body.classList.remove('modal-open');
            }
        }
        
        // 載入帳戶資料
        function loadAccountData() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            // 更新個人資料
            document.getElementById('account-name-input').value = user.name || '';
            document.getElementById('account-email-input').value = user.email || '';
            document.getElementById('account-phone-input').value = user.phone || '';
            document.getElementById('account-avatar-large').textContent = (user.name || 'A').charAt(0).toUpperCase();
            
            // 更新方案資訊
            document.getElementById('account-current-plan').textContent = user.plan || '免費';
            document.getElementById('account-current-credits').textContent = user.credits || '300';
            document.getElementById('account-register-date').textContent = user.registerDate || '2024-01-15';
            document.getElementById('account-last-login').textContent = user.lastLogin || '2024-01-20 14:30';
            
            // 更新使用統計
            document.getElementById('account-monthly-usage').textContent = user.monthlyUsage || '15 次';
            document.getElementById('account-positioning-usage').textContent = user.positioningUsage || '5 次';
            document.getElementById('account-topics-usage').textContent = user.topicsUsage || '6 次';
            document.getElementById('account-script-usage').textContent = user.scriptUsage || '4 次';
        }
        
        // 載入設定資料
        function loadSettingsData() {
            // 載入深色模式設定
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            if (darkModeToggle) {
                darkModeToggle.checked = isDarkMode;
            }
            
            // 載入其他設定
            const settings = JSON.parse(localStorage.getItem('userSettings') || '{}');
            document.getElementById('auto-theme-toggle').checked = settings.autoTheme || false;
            document.getElementById('email-notifications').checked = settings.emailNotifications !== false;
            document.getElementById('credit-alerts').checked = settings.creditAlerts !== false;
            document.getElementById('feature-updates').checked = settings.featureUpdates !== false;
            document.getElementById('data-analytics').checked = settings.dataAnalytics !== false;
            document.getElementById('usage-tracking').checked = settings.usageTracking !== false;
            document.getElementById('language-select').value = settings.language || 'zh-TW';
            document.getElementById('timezone-select').value = settings.timezone || 'Asia/Taipei';
            
            // 更新系統資訊
            updateSystemInfo();
        }
        
        // 更新系統資訊
        function updateSystemInfo() {
            const browserInfo = getBrowserInfo();
            const osInfo = getOSInfo();
            
            document.getElementById('browser-info').textContent = browserInfo;
            document.getElementById('os-info').textContent = osInfo;
        }
        
        // 獲取瀏覽器資訊
        function getBrowserInfo() {
            const ua = navigator.userAgent;
            if (ua.includes('Chrome')) return 'Chrome ' + ua.match(/Chrome\/(\d+)/)?.[1] || 'Unknown';
            if (ua.includes('Firefox')) return 'Firefox ' + ua.match(/Firefox\/(\d+)/)?.[1] || 'Unknown';
            if (ua.includes('Safari')) return 'Safari ' + ua.match(/Version\/(\d+)/)?.[1] || 'Unknown';
            if (ua.includes('Edge')) return 'Edge ' + ua.match(/Edge\/(\d+)/)?.[1] || 'Unknown';
            return 'Unknown Browser';
        }
        
        // 獲取作業系統資訊
        function getOSInfo() {
            const ua = navigator.userAgent;
            if (ua.includes('Windows')) return 'Windows';
            if (ua.includes('Mac')) return 'macOS';
            if (ua.includes('Linux')) return 'Linux';
            if (ua.includes('Android')) return 'Android';
            if (ua.includes('iOS')) return 'iOS';
            return 'Unknown OS';
        }
        
        // 事件監聽器
        if (accountModalClose) {
            accountModalClose.addEventListener('click', hideAccountModal);
        }
        
        if (settingsModalClose) {
            settingsModalClose.addEventListener('click', hideSettingsModal);
        }
        
        // 點擊背景關閉
        if (accountModal) {
            accountModal.addEventListener('click', function(e) {
                if (e.target === accountModal) {
                    hideAccountModal();
                }
            });
        }
        
        if (settingsModal) {
            settingsModal.addEventListener('click', function(e) {
                if (e.target === settingsModal) {
                    hideSettingsModal();
                }
            });
        }
        
        // 帳戶相關按鈕
        document.getElementById('save-profile')?.addEventListener('click', function() {
            const name = document.getElementById('account-name-input').value;
            const phone = document.getElementById('account-phone-input').value;
            
            if (name.trim()) {
                // 更新本地儲存
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                user.name = name;
                user.phone = phone;
                localStorage.setItem('user', JSON.stringify(user));
                
                // 更新UI
                document.getElementById('acc-name').textContent = name;
                document.getElementById('account-avatar-large').textContent = name.charAt(0).toUpperCase();
                
                showToast('個人資料已更新', 'success');
                hideAccountModal();
            } else {
                showToast('請輸入姓名', 'error');
            }
        });
        
        document.getElementById('change-password')?.addEventListener('click', function() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showToast('請填寫所有密碼欄位', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showToast('新密碼與確認密碼不符', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showToast('密碼長度至少6位', 'error');
                return;
            }
            
            // 這裡應該調用後端API
            showToast('密碼變更功能開發中', 'info');
        });
        
        document.getElementById('upgrade-plan-btn')?.addEventListener('click', function() {
            hideAccountModal();
            showPurchaseModal();
        });
        
        document.getElementById('quick-charge-btn')?.addEventListener('click', function() {
            showQuickChargeModal();
        });
        
        document.getElementById('export-data')?.addEventListener('click', function() {
            showToast('資料匯出功能開發中', 'info');
        });
        
        document.getElementById('delete-account')?.addEventListener('click', function() {
            if (confirm('確定要刪除帳戶嗎？此操作無法復原。')) {
                showToast('帳戶刪除功能開發中', 'info');
            }
        });
        
        // 設定相關按鈕
        document.getElementById('save-settings')?.addEventListener('click', function() {
            const settings = {
                autoTheme: document.getElementById('auto-theme-toggle').checked,
                emailNotifications: document.getElementById('email-notifications').checked,
                creditAlerts: document.getElementById('credit-alerts').checked,
                featureUpdates: document.getElementById('feature-updates').checked,
                dataAnalytics: document.getElementById('data-analytics').checked,
                usageTracking: document.getElementById('usage-tracking').checked,
                language: document.getElementById('language-select').value,
                timezone: document.getElementById('timezone-select').value
            };
            
            localStorage.setItem('userSettings', JSON.stringify(settings));
            showToast('設定已儲存', 'success');
            hideSettingsModal();
        });
        
        document.getElementById('reset-settings')?.addEventListener('click', function() {
            if (confirm('確定要重設所有設定嗎？')) {
                localStorage.removeItem('userSettings');
                loadSettingsData();
                showToast('設定已重設', 'success');
            }
        });
        
        // 深色模式切換
        document.getElementById('dark-mode-toggle')?.addEventListener('change', function() {
            isDarkMode = this.checked;
            document.documentElement.classList.toggle('dark', isDarkMode);
            localStorage.setItem('darkMode', isDarkMode);
        });
        
        // 為側邊欄的帳戶和設定連結添加點擊事件
        document.querySelectorAll('a').forEach(link => {
            if (link.textContent.includes('帳戶')) {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    showAccountModal();
                });
            }
            if (link.textContent.includes('設定')) {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    showSettingsModal();
                });
            }
        });
        
        // 快速充值功能
        setupQuickChargeModal();
    }
    
    // 設置快速充值視窗
    function setupQuickChargeModal() {
        const quickChargeModal = document.getElementById('quick-charge-modal');
        const quickChargeClose = document.getElementById('quick-charge-close');
        const chargeOptions = document.querySelectorAll('.charge-option');
        const customChargeBtn = document.getElementById('custom-charge-btn');
        const customCreditsInput = document.getElementById('custom-credits');
        const chargeResult = document.getElementById('charge-result');
        
        // 開啟快速充值視窗
        function showQuickChargeModal() {
            if (quickChargeModal) {
                quickChargeModal.classList.remove('hidden');
                quickChargeModal.classList.add('flex');
                document.body.classList.add('modal-open');
                // 重置選中狀態
                chargeOptions.forEach(btn => btn.classList.remove('border-primary', 'bg-primary/10'));
                chargeResult.classList.add('hidden');
            }
        }
        
        // 關閉快速充值視窗
        function hideQuickChargeModal() {
            if (quickChargeModal) {
                quickChargeModal.classList.add('hidden');
                quickChargeModal.classList.remove('flex');
                document.body.classList.remove('modal-open');
            }
        }
        
        // 執行充值
        async function executeCharge(credits) {
            if (!credits || credits <= 0) {
                showChargeResult('請輸入有效的點數', 'error');
                return;
            }
            
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (!user.email) {
                showChargeResult('請先登入', 'error');
                return;
            }
            
            try {
                showChargeResult('正在處理充值請求...', 'info');
                
                const response = await fetch(`${API_BASE}/admin/user/add_credits`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        identifier: user.email,
                        credits: credits,
                        reason: '用戶快速充值'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showChargeResult(
                        `✅ 充值成功！<br/>
                        💰 充值點數: +${data.credits_added}<br/>
                        📊 新餘額: ${data.new_balance}`, 
                        'success'
                    );
                    
                    // 更新本地用戶資料
                    user.credits = data.new_balance;
                    localStorage.setItem('user', JSON.stringify(user));
                    
                    // 更新UI顯示
                    updateCreditsDisplay(data.new_balance);
                    
                    // 3秒後關閉視窗
                    setTimeout(() => {
                        hideQuickChargeModal();
                    }, 3000);
                } else {
                    showChargeResult(`❌ 充值失敗: ${data.message || data.error || '未知錯誤'}`, 'error');
                }
            } catch (error) {
                showChargeResult(`❌ 請求失敗: ${error.message}`, 'error');
            }
        }
        
        // 顯示充值結果
        function showChargeResult(message, type) {
            chargeResult.classList.remove('hidden');
            chargeResult.innerHTML = message;
            
            // 根據類型設置樣式
            chargeResult.className = `mt-4 p-3 rounded-lg ${
                type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' :
                type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' :
                'bg-blue-100 text-blue-800 border border-blue-200'
            }`;
        }
        
        // 更新點數顯示
        function updateCreditsDisplay(credits) {
            const navCredits = document.getElementById('nav-credits');
            const accCredits = document.getElementById('acc-credits');
            const accountCurrentCredits = document.getElementById('account-current-credits');
            
            if (navCredits) navCredits.textContent = credits;
            if (accCredits) accCredits.textContent = credits;
            if (accountCurrentCredits) accountCurrentCredits.textContent = credits;
        }
        
        // 事件監聽器
        if (quickChargeClose) {
            quickChargeClose.addEventListener('click', hideQuickChargeModal);
        }
        
        // 點擊背景關閉
        if (quickChargeModal) {
            quickChargeModal.addEventListener('click', function(e) {
                if (e.target === quickChargeModal) {
                    hideQuickChargeModal();
                }
            });
        }
        
        // 充值選項按鈕
        chargeOptions.forEach(btn => {
            btn.addEventListener('click', function() {
                // 移除其他選中的樣式
                chargeOptions.forEach(b => b.classList.remove('border-primary', 'bg-primary/10'));
                // 添加選中樣式
                this.classList.add('border-primary', 'bg-primary/10');
                
                const credits = parseInt(this.dataset.credits);
                executeCharge(credits);
            });
        });
        
        // 自定義充值按鈕
        if (customChargeBtn) {
            customChargeBtn.addEventListener('click', function() {
                const credits = parseInt(customCreditsInput.value);
                executeCharge(credits);
            });
        }
        
        // 自定義金額輸入框回車事件
        if (customCreditsInput) {
            customCreditsInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const credits = parseInt(this.value);
                    executeCharge(credits);
                }
            });
        }
        
        // 將函數設為全域，供其他部分調用
        window.showQuickChargeModal = showQuickChargeModal;
    }
    </script>
</body>
</html>
