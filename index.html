<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>AI短影音顧問｜AIJob智能</title>
  <style>
    :root{
      --primary:#2563eb; --primary-600:#1d4ed8;
      --bg:#ffffff; --muted:#f5f7fb; --border:#e6e8ef;
      --text:#0f172a; --text-muted:#64748b;
      --ok:#16a34a; --err:#dc2626; --shadow:0 6px 18px rgba(2,12,27,0.08);
      --radius:14px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC, Helvetica Neue, Arial;
      background:var(--bg); color:var(--text); line-height:1.6; font-size:16px;
      -webkit-text-size-adjust:100%;
      touch-action:manipulation;
    }
    a{ color:var(--primary); text-decoration:none; }
    .container{ max-width:1200px; margin:0 auto; padding:16px; }

    .topbar{ position:sticky; top:0; z-index:50; background:rgba(255,255,255,0.9); backdrop-filter:saturate(180%) blur(8px); border-bottom:1px solid var(--border); }
    .topbar-inner{ display:flex; flex-direction:column; align-items:center; gap:10px; padding:12px 16px; }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:800; font-size:22px; }
    .brand .logo{ width:20px; height:20px; border-radius:4px; object-fit:cover; box-shadow:0 0 0 3px rgba(37,99,235,0.15); }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .tab{ padding:8px 12px; border:1px solid var(--border); border-radius:999px; background:#fff; color:var(--text); cursor:pointer; transition:all .15s; font-weight:600; font-size:14px; }
    .tab.active{ background:var(--primary); border-color:var(--primary); color:#fff; box-shadow:var(--shadow); }

    .hero{ display:grid; grid-template-columns:1fr; gap:16px; padding:20px 16px; }
    .hero-title{ font-size:28px; font-weight:800; letter-spacing:.2px; text-align:left; }
    .hero-sub{ color:var(--text-muted); margin-top:4px; }

    .grid-cards{ display:grid; grid-template-columns:1fr; gap:16px; margin-top:20px; }
    .card{ background:linear-gradient(180deg,#fff,#f9fbff); border:1px solid var(--border); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow); display:flex; flex-direction:column; gap:12px; min-height:160px; }
    .card h3{ margin:0; font-size:20px; }
    .card p{ margin:0; color:var(--text-muted); }
    .card .actions{ margin-top:auto; display:flex; gap:10px; }

    .layout{ display:grid; grid-template-columns:7fr 5fr; gap:16px; padding:16px; }
    .panel{ background:#fff; border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; }
    .panel-head{ padding:12px 14px; border-bottom:1px solid var(--border); display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; }
    .panel-title{ font-weight:800; display:flex; align-items:center; gap:8px; }

    .settings{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .settings .field{ display:flex; align-items:center; gap:6px; background:var(--muted); border:1px solid var(--border); border-radius:10px; padding:6px 8px; }
    .settings input[type="text"], .settings select, .settings input[type="number"]{ border:none; background:transparent; outline:none; padding:4px; min-width:90px; font-size:16px; }
    .settings .check{ display:flex; align-items:center; gap:6px; }
    .settings.collapsed{ display:none; }
    .toggle-settings{ margin-left:auto; border:1px solid var(--border); background:#fff; padding:6px 10px; border-radius:10px; cursor:pointer; font-weight:700; font-size:13px; display:inline-flex; align-items:center; gap:6px; }
    .toggle-settings:hover{ box-shadow:var(--shadow); }
    .chev{ display:inline-block; transition:transform .2s ease; }
    .toggle-settings[aria-expanded="false"] .chev{ transform:rotate(-90deg); }

    .chat-wrap{ display:flex; flex-direction:column; height:62vh; }
    .chat-scroll{ flex:1; overflow-y:auto; overflow-x:hidden; padding:14px; display:flex; flex-direction:column; gap:10px; background:var(--muted); }
    .msg{ max-width:80%; padding:10px 12px; border-radius:14px; border:1px solid var(--border); background:#fff; box-shadow:var(--shadow); }
    .msg.user{ margin-left:auto; background:#eef4ff; border-color:#dbe6ff; }
    .msg .meta{ font-size:12px; color:var(--text-muted); margin-bottom:4px; }
    .inputbar{ display:flex; gap:8px; padding:10px; border-top:1px solid var(--border); background:#fff; }
    .inputbar textarea{ flex:1; resize:none; border:1px solid var(--border); border-radius:12px; padding:10px 12px; min-height:46px; max-height:160px; font-size:16px; line-height:1.5; }
    .inputbar button{ flex-shrink:0; }
    textarea{ flex:1; resize:none; border:1px solid var(--border); border-radius:12px; padding:10px 12px; min-height:46px; max-height:160px; font-size:16px; line-height:1.5; }

    .right-wrap{ display:flex; flex-direction:column; height:62vh; }
    .right-scroll{ flex:1; overflow-y:auto; overflow-x:hidden; padding:14px; display:flex; flex-direction:column; gap:10px; background:var(--muted); }
    .toolbar{ display:flex; gap:8px; padding:10px; border-top:1px solid var(--border); background:#fff; flex-wrap:wrap; }

    .segment-card{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px; box-shadow:var(--shadow); }
    .segment-head{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:6px; }
    .seg-title{ font-weight:700; }
    .seg-meta{ color:var(--text-muted); font-size:13px; }
    .seg-actions{ display:flex; gap:6px; }

    .copy-card{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px; box-shadow:var(--shadow); }
    .copy-card h4{ margin:4px 0 8px; }
    .muted{ color:var(--text-muted); font-size:14px; }

    .chips{ display:flex; gap:8px; flex-wrap:wrap; padding:10px 14px; border-top:1px solid var(--border); background:#fff; }
    .chip{ padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#fff; cursor:pointer; font-size:13px; }
    .chip:hover{ border-color:var(--primary); color:var(--primary); }

    .btn{ padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:#fff; cursor:pointer; font-weight:700; font-size:15px; display:inline-flex; align-items:center; gap:6px; transition:all .15s; min-height:42px; }
    .btn:hover{ transform:translateY(-1px); box-shadow:var(--shadow); }
    .btn.primary{ background:var(--primary); border-color:var(--primary); color:#fff; }
    .btn.primary:disabled{ opacity:.6; cursor:not-allowed; }
    .btn.ghost{ background:transparent; }
    .btn.small{ padding:8px 10px; font-size:14px; min-height:38px; }
    .link-row{ display:flex; gap:8px; flex-wrap:wrap; }

    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:20px; background:#111827; color:#fff; padding:10px 14px; border-radius:10px; font-size:14px; box-shadow:var(--shadow); opacity:0; pointer-events:none; transition:opacity .25s; z-index:100; }
    .toast.show{ opacity:1; }

    /* AI 載入動畫樣式 */
    .loading-msg{ background:#f8fafc; border:1px solid #e2e8f0; }
    .loading-content{ display:flex; align-items:center; gap:12px; }
    .loading-dots{ display:flex; gap:4px; }
    .loading-dots span{ width:8px; height:8px; border-radius:50%; background:#3b82f6; animation:loading-bounce 1.4s ease-in-out infinite both; }
    .loading-dots span:nth-child(1){ animation-delay:-0.32s; }
    .loading-dots span:nth-child(2){ animation-delay:-0.16s; }
    .loading-dots span:nth-child(3){ animation-delay:0s; }
    .loading-text{ color:#64748b; font-style:italic; }
    @keyframes loading-bounce{ 0%, 80%, 100%{ transform:scale(0); } 40%{ transform:scale(1); } }

    /* 格式化內容樣式 */
    .formatted-content{ line-height:1.6; }
    .formatted-content p{ margin:8px 0; }
    .formatted-content strong{ font-weight:600; color:#1e40af; }
    .formatted-content em{ font-style:italic; color:#7c3aed; }
    .formatted-content br{ margin:4px 0; }

    .site-footer{ border-top:1px solid var(--border); margin-top:24px; background:#fff; }
    .copyright{ color:var(--text-muted); font-size:14px; padding:6px 0 14px 0; text-align:center; }

    @media (min-width:880px){ .grid-cards{ grid-template-columns:repeat(2,1fr); } }
    @media (min-width:1200px){ .hero-title{ font-size:32px; } }
    @media (max-width:1199px){ .layout{ grid-template-columns:1fr; } }
    @media (max-width:767px){
      .chat-wrap,.right-wrap{ height:auto; max-height:64vh; }
      .toolbar{ display:none; }
      .settings{ gap:6px; }
      .btn{ min-height:44px; }
      .btn.small{ min-height:40px; }
    }

    /* 新增：模式切換與模板面板 */
    .mode-wrap{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .segctl{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .segctl .group{ display:flex; gap:6px; background:var(--muted); border:1px solid var(--border); border-radius:12px; padding:6px; }
    
    /* 響應式設計 */
    @media (max-width: 768px) {
      .chat-wrap, .right-wrap {
        height: 50vh;
        min-height: 300px;
      }
      
      .panel-head {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      
      .settings {
        width: 100%;
        justify-content: space-between;
      }
      
      .tabs {
        justify-content: center;
      }
      
      .btn {
        min-height: 38px;
        font-size: 14px;
        padding: 8px 12px;
      }
      
      .chips {
        justify-content: center;
      }
    }
    
    @media (max-width: 480px) {
      .left-wrap, .right-wrap {
        height: 45vh;
      }
      
      .btn {
        min-height: 36px;
        font-size: 12px;
        padding: 6px 10px;
      }
      
      .panel-title {
        font-size: 16px;
      }
      
      .brand {
        font-size: 18px;
      }
    }
    .segctl .group label{ 
      padding:8px 16px; 
      border-radius:8px; 
      cursor:pointer; 
      border:1px solid #e0e0e0; 
      background:#fff; 
      transition:all 0.2s ease;
      font-weight:500;
      writing-mode: horizontal-tb;
      text-orientation: mixed;
    }
    .segctl .group label:hover{
      border-color:#2196F3;
      background:#f5f5f5;
    }
    .segctl .group input{ display:none; }
    .segctl .group input:checked + span{ 
      background:var(--primary); 
      border:1px solid var(--primary); 
      color:#fff; 
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* 套用結構按鈕樣式 - 確保字體不垂直 */
    .segctl .group label span {
      writing-mode: horizontal-tb;
      text-orientation: mixed;
      transform: none;
      font-size: 14px;
      line-height: 1.2;
      display: inline-block;
    }
    
    /* 腳本分段樣式 */
    .script-segment {
      margin-bottom: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .segment-content {
      padding: 12px;
      background: #f8f9fa;
    }
    
    .segment-content .dialog,
    .segment-content .visual,
    .segment-content .cta {
      margin-bottom: 8px;
      line-height: 1.5;
    }
    
    .segment-content .dialog {
      color: #333;
    }
    
    .segment-content .visual {
      color: #666;
      font-style: italic;
    }
    
    .segment-content .cta {
      color: #2196F3;
      font-weight: 600;
    }
    
    /* 定位檔案欄位樣式 */
    .profile-field {
      margin-bottom: 8px;
      padding: 6px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .profile-field:last-of-type {
      border-bottom: none;
    }
    
    /* 腳本模式按鈕樣式 - 強制覆蓋 */
    #oneClickScript,
    #guideMode,
    #freeMode {
      background: #2196F3 !important;
      color: white !important;
      border: none !important;
      padding: 8px 16px !important;
      border-radius: 6px !important;
      margin-right: 10px !important;
      cursor: pointer !important;
      font-weight: 600 !important;
      font-size: 14px !important;
      transition: all 0.2s ease !important;
    }
    
    #oneClickScript:hover,
    #guideMode:hover,
    #freeMode:hover {
      background: #1976D2 !important;
      transform: translateY(-1px) !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
    }
    
    /* 選中狀態 */
    #oneClickScript.active,
    #guideMode.active,
    #freeMode.active {
      background: #1976D2 !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner container">
      <div class="brand">
        <img class="logo" alt="AIJob logo" src="https://static.wixstatic.com/media/9705bb_4edf6b22c58f4275bc9bae42891acb49~mv2.png"/>
        AI短影音顧問｜AIJob智能
      </div>
      <div class="tabs">
        <button class="tab active" data-page="home">首頁</button>
        <button class="tab" data-page="positioning">AI影音定位顧問</button>
        <button class="tab" data-page="topics">AI選題小助手</button>
        <button class="tab" data-page="script">AI腳本生成大師</button>
        <button class="tab" data-page="guide">說明/指南</button>
      </div>
    </div>
  </div>

  <!-- 首頁 -->
  <main id="page-home" class="container">
    <section class="hero">
      <div>
        <div class="hero-title">選擇你的任務</div>
        <div class="hero-sub">輸入主題→AI 推理行業爆款要素→與你對話共創。介面簡約、行動友善。</div>
      </div>
      <div class="grid-cards">
        <article class="card">
          <h3>🎯 AI影音定位顧問</h3>
          <p>釐清你的帳號方向、目標受眾、品牌定位。建立完整的內容策略基礎，讓後續創作更有方向。</p>
          <div class="actions">
            <button class="btn primary" data-go="positioning">開始定位分析</button>
            <button class="btn ghost" data-go="guide">看操作說明</button>
          </div>
        </article>
        <article class="card">
          <h3>💡 AI選題小助手</h3>
          <p>基於你的定位檔案，每日提供靈感選題建議。結合熱點、季節性與你的品牌特色。</p>
          <div class="actions">
            <button class="btn primary" data-go="topics">獲取選題靈感</button>
            <button class="btn ghost" data-go="guide">看操作說明</button>
          </div>
        </article>
        <article class="card">
          <h3>📝 AI腳本生成大師</h3>
          <p>整合腳本與文案功能，基於你的定位與記憶生成個性化內容。支援多種模板與時長。</p>
          <div class="actions">
            <button class="btn primary" data-go="script">開始創作</button>
            <button class="btn ghost" data-go="guide">看操作說明</button>
          </div>
        </article>
      </div>

      <!-- 客製化智能體 CTA -->
      <article class="card" style="margin-top:8px;">
        <h3>想要客製化您的短影音 AI 智能體嗎？</h3>
        <p class="muted">需要專屬功能、品牌語氣、整合後端或流程自動化？我們可協助從規劃到上線。</p>
        <div class="actions">
          <a class="btn primary" target="_blank" href="https://AIJobschool.short.gy/E49kA8">與我們聯繫（LINE 官方）</a>
        </div>
      </article>
      <div class="link-row">
        <a class="btn small" target="_blank" href="https://AIJobschool.short.gy/kBmUAL">AIJob YouTube</a>
        <a class="btn small" target="_blank" href="https://AIJobschool.short.gy/ytPY3U">AIJob 官方網站</a>
        <a class="btn small" target="_blank" href="https://AIJobschool.short.gy/KCYu7z">AIJob 行銷自動化課程</a>
        <a class="btn small" target="_blank" href="https://AIJobschool.short.gy/UUwpEG">AIJob Discord社群討論</a>
        <a class="btn small" target="_blank" href="https://AIJobschool.short.gy/E49kA8">AIJob LINE官方帳號</a>
      </div>
    </section>
  </main>

  <!-- 定位智能體頁 -->
  <section id="page-positioning" class="container" style="display:none">
    <div class="layout">
      <div class="panel">
        <div class="panel-head">
          <div class="panel-title">🎯 AI影音定位顧問</div>
          <div class="settings">
            <button class="btn small" id="clearPositioningChat">清空對話</button>
          </div>
        </div>
        <div class="chat-wrap">
          <div id="chatPositioning" class="chat-scroll"></div>
          <div class="chips" id="chipsPositioning">
            <span class="muted">快速問題：</span>
            <button class="chip" data-question="我的帳號是OOO(填寫您的產品或服務或主題)，應該專注在哪個領域？">業務類型定位</button>
            <button class="chip" data-question="我的目標受眾是誰？他們有什麼特徵和痛點？">目標受眾分析</button>
            <button class="chip" data-question="我的品牌應該傳達什麼形象和語氣？">品牌形象定位</button>
            <button class="chip" data-question="我應該在哪些平台經營？為什麼？">平台策略建議</button>
            <button class="chip" data-question="我的內容目標是什麼？想要達成什麼效果？">內容目標設定</button>
            <button class="chip" data-question="我應該多久發一次文？發文頻率如何安排？">發文頻率規劃</button>
            <button class="chip primary" id="oneClickPositioning">🚀 一鍵生成定位</button>
          </div>
          <div class="inputbar">
            <textarea id="inputPositioning" placeholder="告訴我你的業務、產品、目標或困惑..."></textarea>
            <button class="btn primary" id="sendPositioning">分析</button>
            <button class="btn" id="cancelPositioning">停止</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-head">
          <div class="panel-title">📍 定位檔案</div>
          <div class="settings">
            <button class="btn small" id="saveProfile">儲存檔案</button>
          </div>
        </div>
        <div class="right-wrap">
          <div id="profileWrap" class="right-scroll">
            <div class="copy-card">
              <h4>用戶定位檔案</h4>
              <div id="profileContent" class="muted">尚未建立定位檔案，請先與AI影音定位顧問對話。</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- 選題智能體頁 -->
  <section id="page-topics" class="container" style="display:none">
    <div class="layout">
      <div class="panel">
        <div class="panel-head">
          <div class="panel-title">💡 AI選題小助手</div>
          <div class="settings">
            <button class="btn small" id="refreshTopics">重新生成</button>
            <button class="btn small" id="viewTopicHistory">歷史記錄</button>
          </div>
        </div>
        <div class="chat-wrap">
          <div id="chatTopics" class="chat-scroll"></div>
          <div class="chips" id="chipsTopics">
            <span class="muted">選題類型：</span>
            <button class="chip" data-topic-type="trending">熱門趨勢</button>
            <button class="chip" data-topic-type="educational">教育分享</button>
            <button class="chip" data-topic-type="personal">個人故事</button>
            <button class="chip" data-topic-type="product">產品介紹</button>
          </div>
          <div class="inputbar">
            <textarea id="inputTopics" placeholder="告訴我你想要什麼類型的選題靈感..."></textarea>
            <button class="btn primary" id="getTopics">獲取靈感</button>
            <button class="btn" id="cancelTopics">停止</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-head">
          <div class="panel-title">📅 今日選題建議</div>
          <div class="settings">
            <button class="btn small" id="copyAllTopics">複製全部</button>
          </div>
        </div>
        <div class="right-wrap">
          <div id="topicsWrap" class="right-scroll">
            <div class="copy-card">
              <h4>選題建議</h4>
              <div id="topicsContent" class="muted">點擊「獲取靈感」開始生成選題建議。</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- 腳本頁 -->
  <section id="page-script" class="container" style="display:none">
    <div class="layout">
      <div class="panel">
        <div class="panel-head">
          <div class="panel-title">📝 AI腳本生成大師</div>
          <div class="mode-wrap">
            <!-- 模式切換 -->
            <div class="segctl">
              <div class="group" id="modeGroup">
                <button class="mode-btn" id="oneClickScript">🚀 一鍵生成腳本</button>
                <button class="mode-btn" id="guideMode">✍️ 引導模式</button>
                <button class="mode-btn" id="freeMode">💬 自由模式</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 引導模式：模板與時長（僅 guide 顯示） -->
        <div class="panel-head" id="guideBar" style="border-top:0; border-bottom:1px solid var(--border);">
          <div class="segctl">
            <div class="group" id="tplGroup" aria-label="模板結構">
              <label><input type="radio" name="tpl" value="A" checked><span>A 三段式</span></label>
              <label><input type="radio" name="tpl" value="B"><span>B 問題解決</span></label>
              <label><input type="radio" name="tpl" value="C"><span>C Before-After</span></label>
              <label><input type="radio" name="tpl" value="D"><span>D 教學</span></label>
              <label><input type="radio" name="tpl" value="E"><span>E 敘事</span></label>
              <label><input type="radio" name="tpl" value="F"><span>F 爆點連發</span></label>
            </div>
            <div class="group" id="durGroup" aria-label="時長">
              <label><input type="radio" name="dur" value="30" checked><span>30 秒</span></label>
              <label><input type="radio" name="dur" value="60"><span>60 秒</span></label>
            </div>
            <button class="btn small" id="btnStartGuide">套用設定並開始</button>
          </div>
        </div>


        <div class="chat-wrap">
          <div id="chatScript" class="chat-scroll"></div>

          <!-- 快速模板/快速問題 -->
          <div class="chips" id="chipsScript">
            <!-- 內容由 JS 根據模式切換 -->
          </div>

          <div class="inputbar">
            <textarea id="inputScript" placeholder="輸入主題/目標/受眾/平台/時長/語氣…（按鈕送出；Shift+Enter 換行）"></textarea>
            <button class="btn primary" id="sendScript">送出</button>
            <button class="btn" id="cancelScript">停止</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-head">
          <div class="panel-title">腳本分段 / 時間軸</div>
          <div class="settings" style="gap:8px">
            <button class="btn small" id="copyAllScript">複製全部</button>
            <button class="btn small" id="clearScript">清空</button>
          </div>
        </div>
        <div class="right-wrap">
          <div id="segmentsWrap" class="right-scroll"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- 文案頁（原樣保留） -->
  <section id="page-copy" class="container" style="display:none">
    <!-- ……（此處保持你上傳版本的文案區塊不變）…… -->
    <!-- 為節省篇幅，此段略；若需要我可以再貼完整相同內容 -->
  </section>

  <!-- 說明/指南（新版） -->
  <section id="page-guide" class="container" style="display:none; padding-top:16px">
    <article class="card" style="margin-bottom:12px">
      <h3>🎯 AI影音定位顧問</h3>
      <h4 style="margin:6px 0 8px">功能說明</h4>
      <p>• <strong>帳號定位分析</strong>：幫助釐清你的業務類型、目標受眾、品牌形象<br/>
         • <strong>平台策略建議</strong>：根據你的定位推薦最適合的平台<br/>
         • <strong>內容方向規劃</strong>：建立完整的內容策略基礎<br/>
         • <strong>定位檔案管理</strong>：自動記錄和更新你的定位資訊</p>
      <h4 style="margin:6px 0 8px">使用方式</h4>
      <p>1️⃣ 點擊「快速問題」按鈕開始定位分析<br/>
         2️⃣ 回答AI的問題，建立你的定位檔案<br/>
         3️⃣ 使用「🚀 一鍵生成定位」快速建立完整定位<br/>
         4️⃣ 定位檔案會自動儲存並同步到其他功能</p>
    </article>

    <article class="card" style="margin-bottom:12px">
      <h3>💡 AI選題小助手</h3>
      <h4 style="margin:6px 0 8px">功能說明</h4>
      <p>• <strong>個性化選題</strong>：基於你的定位檔案生成相關選題<br/>
         • <strong>熱點結合</strong>：結合當前熱門話題與你的品牌特色<br/>
         • <strong>季節性內容</strong>：考慮時節與節日提供適時建議<br/>
         • <strong>選題類型篩選</strong>：熱門趨勢、教育分享、個人故事、產品介紹</p>
      <h4 style="margin:6px 0 8px">使用方式</h4>
      <p>1️⃣ 先完成定位分析，建立你的定位檔案<br/>
         2️⃣ 選擇選題類型（熱門趨勢、教育分享等）<br/>
         3️⃣ 點擊「獲取靈感」獲得個性化選題建議<br/>
         4️⃣ 查看「今日選題建議」和「歷史記錄」</p>
    </article>

    <article class="card" style="margin-bottom:12px">
      <h3>📝 AI腳本生成大師</h3>
      <h4 style="margin:6px 0 8px">功能說明</h4>
      <p>• <strong>一鍵生成腳本</strong>：根據主題快速生成完整腳本<br/>
         • <strong>引導模式</strong>：選擇結構模板和時長，AI逐步引導<br/>
         • <strong>自由模式</strong>：自由討論需求，AI提供創意建議<br/>
         • <strong>多種模板</strong>：支援 A-F 六種腳本結構模板<br/>
         • <strong>時長靈活</strong>：支援 30 秒與 60 秒腳本</p>
      <h4 style="margin:6px 0 8px">使用方式</h4>
      <p>1️⃣ <strong>一鍵生成</strong>：點擊「🚀 一鍵生成腳本」，輸入主題即可<br/>
         2️⃣ <strong>引導模式</strong>：選擇結構模板和時長，輸入主題開始<br/>
         3️⃣ <strong>自由模式</strong>：直接輸入需求，與AI自由討論<br/>
         4️⃣ 查看「腳本分段/時間軸」和「腳本筆記」</p>
    </article>

    <article class="card" style="margin-bottom:12px">
      <h3>💾 資料儲存與管理</h3>
      <h4 style="margin:6px 0 8px">儲存位置</h4>
      <p>• <strong>定位檔案</strong>：自動儲存在資料庫中，點擊「儲存檔案」確認<br/>
         • <strong>選題建議</strong>：儲存在「今日選題建議」和「歷史記錄」中<br/>
         • <strong>腳本筆記</strong>：儲存在「腳本分段/時間軸」中<br/>
         • <strong>定位筆記</strong>：儲存在「定位檔案」側邊欄中</p>
      <h4 style="margin:6px 0 8px">資料同步</h4>
      <p>所有資料會自動同步到其他功能，讓AI能夠根據你的歷史記錄提供更精準的建議。</p>
      <h4 style="margin:6px 0 8px">記憶作用</h4>
      <p>智能體會根據你的記憶提供更個性化的建議。例如：<br/>
         • 定位智能體記住你的業務類型後，選題智能體會推薦相關領域的選題<br/>
         • 腳本文案智能體會根據你的品牌語氣與受眾偏好生成內容<br/>
         • 系統會持續學習你的偏好，提供越來越精準的建議</p>
    </article>

    <article class="card" style="margin-bottom:12px">
      <h3>🚀 使用建議</h3>
      <h4 style="margin:6px 0 8px">最佳流程</h4>
      <p>1. <strong>先使用定位智能體</strong>：建立你的基本定位檔案<br/>
         2. <strong>再使用選題智能體</strong>：獲取個性化的選題建議<br/>
         3. <strong>最後使用腳本文案智能體</strong>：基於定位與選題創作具體內容</p>
      <h4 style="margin:6px 0 8px">進階技巧</h4>
      <p>• 定期更新定位檔案，讓系統更了解你的變化<br/>
         • 使用快速問題 chips 快速開始對話<br/>
         • 查看歷史記錄了解過去的建議<br/>
         • 利用複製功能保存有用的內容</p>
    </article>
  </section>

  <footer class="site-footer">
    <div class="container">
      <div class="copyright">© 2025 AIJobSchool 版權所有</div>
    </div>
  </footer>

  <div id="toast" class="toast">已複製</div>

  <script>
  // 根據部署環境自動選擇 API 基礎 URL
  const API_BASE = window.location.hostname === 'localhost' 
    ? 'http://localhost:8080'  // 本地開發
    : 'https://aijobvideobackend.zeabur.app';  // 你的實際 Zeabur 後端 URL
  const DEFAULT_USER_ID = `web-${Math.random().toString(36).slice(2,8)}`;

  // 全域狀態
  const state = { 
    userId: DEFAULT_USER_ID,
    scriptMode: 'guide',                 // guide | free
    templateType: 'A',                   // 引導模式使用
    duration: 30,                        // 30 | 60，引導模式使用
    sessionIdScript: `web-${Math.random().toString(36).slice(2,8)}`,
    messagesScript: [],
    lastAssistantScript: '',
    segments: [],
    
    // 新增：三智能體狀態
    sessionIdPositioning: `web-${Math.random().toString(36).slice(2,8)}`,
    messagesPositioning: [],
    userProfile: null,
    userNotes: [],
    
    sessionIdTopics: `web-${Math.random().toString(36).slice(2,8)}`,
    messagesTopics: [],
    currentTopics: null,
    topicsNotes: [],
    
    sessionIdScript: `web-${Math.random().toString(36).slice(2,8)}`,
    scriptNotes: []
  };

  // 簡便工具
  function fmtTS(d=new Date()){ const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`; }
  function escapeHTML(s){ return (s||'').replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }
  function showToast(m){ const t=document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1500); }
  function copyText(s,msg='已複製囉！'){ navigator.clipboard.writeText(s).then(()=>showToast(msg)); }
  function appendMsg(el, role, content, isFormatted = false){
    const div=document.createElement('div');
    div.className='msg ' + (role==='user'?'user':'');
    
    // 如果是 AI 回應且需要格式化
    if(role === 'assistant' && isFormatted){
      div.innerHTML=`<div class="meta">${role} · ${fmtTS()}</div><div class="formatted-content">${formatAIResponse(content)}</div>`;
    } else {
      div.innerHTML=`<div class="meta">${role} · ${fmtTS()}</div><div>${escapeHTML(content)}</div>`;
    }
    
    el.appendChild(div); el.scrollTop=el.scrollHeight;
  }

  // 添加 AI 處理中的載入狀態
  function showLoadingMsg(el, message = 'AI 正在思考中...'){
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'msg loading-msg';
    loadingDiv.id = 'loading-msg';
    loadingDiv.innerHTML = `
      <div class="meta">assistant · ${fmtTS()}</div>
      <div class="loading-content">
        <div class="loading-dots">
          <span></span><span></span><span></span>
        </div>
        <span class="loading-text">${message}</span>
      </div>
    `;
    el.appendChild(loadingDiv);
    el.scrollTop = el.scrollHeight;
    return loadingDiv;
  }

  function hideLoadingMsg(el){
    const loadingMsg = el.querySelector('#loading-msg');
    if(loadingMsg){
      loadingMsg.remove();
    }
  }

  // 串流聊天：逐步渲染 assistant 回覆
  let currentStream = { controller: null };
  async function streamChat(targetEl, payload, { onComplete } = {}){
    const div = document.createElement('div');
    div.className = 'msg';
    div.innerHTML = `<div class="meta">assistant · ${fmtTS()}</div><div class="stream-content"></div>`;
    const contentEl = div.querySelector('.stream-content');
    targetEl.appendChild(div);
    targetEl.scrollTop = targetEl.scrollHeight;

    // 初始顯示打字指示
    contentEl.textContent = 'AI 正在回覆中…';

    let buffer = '';
    try{
      const controller = new AbortController();
      currentStream.controller = controller;
      const resp = await fetch(`${API_BASE}/chat_stream`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        signal: controller.signal,
        body: JSON.stringify(payload)
      });
      if(!resp.ok || !resp.body) throw new Error(`HTTP ${resp.status}`);
      const reader = resp.body.getReader();
      const decoder = new TextDecoder();
      while(true){
        const {done, value} = await reader.read();
        if(done) break;
        buffer += decoder.decode(value, {stream:true});
        contentEl.textContent = buffer;
        targetEl.scrollTop = targetEl.scrollHeight;
      }
      contentEl.innerHTML = formatAIResponse(buffer);
      if(typeof onComplete === 'function') onComplete(buffer);
    }catch(e){
      contentEl.textContent = `❌ 錯誤：${e.message}`;
    } finally { currentStream.controller = null; }
  }

  function cancelStream(){ try{ currentStream.controller && currentStream.controller.abort(); }catch(_){ } }

  // 格式化 AI 回應，改善顯示效果
  function formatAIResponse(content){
    if(!content) return '';
    
    // 移除多個星號，改為適當的格式
    let formatted = content
      .replace(/\*\*\*(.*?)\*\*\*/g, '<strong>$1</strong>')  // 三個星號轉為粗體
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')      // 兩個星號轉為粗體
      .replace(/\*(.*?)\*/g, '<em>$1</em>')                  // 一個星號轉為斜體
      .replace(/\n\n+/g, '</p><p>')                          // 多個換行轉為段落
      .replace(/\n/g, '<br>');                               // 單個換行轉為換行標籤
    
    // 添加段落標籤
    if(!formatted.startsWith('<p>')) formatted = '<p>' + formatted;
    if(!formatted.endsWith('</p>')) formatted = formatted + '</p>';
    
    // 處理標題（數字開頭的行）
    formatted = formatted.replace(/(<p>)?(\d+[\.\)]\s*.*?)(<\/p>)?/g, '<p><strong>$2</strong></p>');
    
    // 處理列表項（• 或 - 開頭）
    formatted = formatted.replace(/(<p>)?([•\-]\s*.*?)(<\/p>)?/g, '<p>• $2</p>');
    
    // 添加適當的 emoji
    formatted = formatted
      .replace(/業務類型/g, '🏢 業務類型')
      .replace(/目標受眾/g, '👥 目標受眾')
      .replace(/品牌語氣/g, '🎨 品牌語氣')
      .replace(/平台策略/g, '📱 平台策略')
      .replace(/內容方向/g, '📝 內容方向')
      .replace(/建議/g, '💡 建議')
      .replace(/分析/g, '🔍 分析')
      .replace(/重點/g, '⭐ 重點')
      .replace(/關鍵/g, '🔑 關鍵');
    
    return formatted;
  }

  // 分頁切換
  const pages = ['home','positioning','topics','script','copy','guide'];
  document.querySelectorAll('.tab').forEach(b=>b.onclick=()=>goPage(b.dataset.page));
  document.querySelectorAll('[data-go]').forEach(b=>b.onclick=()=>goPage(b.dataset.go));
  function goPage(name){
    pages.forEach(p=>{
      const elPage = document.getElementById(`page-${p}`);
      if(elPage) elPage.style.display = (p===name)?'block':'none';
      const tab = document.querySelector(`.tab[data-page="${p}"]`);
      if(tab) tab.classList.toggle('active', p===name);
    });
    
    if(name==='script' && state.messagesScript.length===0){
      showScriptWelcome();
      // 不自動進入 Q1，僅顯示歡迎
      renderChips();          // 初始化 chips
    } else if(name==='positioning' && state.messagesPositioning.length===0){
      showPositioningWelcome();
      checkPositioningProfile();
    } else if(name==='topics' && state.messagesTopics.length===0){
      showTopicsWelcome();
      refreshTopicsNotes();
    } else if(name==='script' && state.messagesScript.length===0){
      showScriptWelcome();
      refreshScriptNotes();
    }
  }

  // 腳本模式：歡迎說明
  function showScriptWelcome(){
    const chat=document.getElementById('chatScript');
    const msg = '👋 歡迎使用腳本模式！\n— 如果你用【引導模式】：請先輸入你的主題，我會一步步引導你生成屬於你的腳本（先選結構＋時長）。\n— 已有想法 → 切到【自由模式】直接聊，你說想做什麼，我來補齊腳本與畫面建議。';
    appendMsg(chat,'assistant',msg);
    state.messagesScript.push({ role:'assistant', content:msg });
    state.lastAssistantScript = msg;
    
    // 確保輸入框可見
    setTimeout(() => {
      const inputScript = document.getElementById('inputScript');
      const inputbar = document.querySelector('#page-script .inputbar');
      if(inputScript) {
        inputScript.style.display = 'block';
        inputScript.style.visibility = 'visible';
        inputScript.style.opacity = '1';
        console.log('腳本輸入框已顯示');
      }
      if(inputbar) {
        inputbar.style.display = 'flex';
        inputbar.style.visibility = 'visible';
        inputbar.style.opacity = '1';
        console.log('輸入框區域已顯示');
      }
    }, 100);
  }

  // 快速模板 / 快速問題（依模式更換）
  function renderChips(){
    const wrap=document.getElementById('chipsScript');
    wrap.innerHTML='';
    if(state.scriptMode==='guide'){
      const hint = document.createElement('span'); hint.className='muted'; hint.textContent='已選擇模板與時長 → 直接輸入主題或需求開始生成';
      wrap.appendChild(hint);
    }else{
      const hint = document.createElement('span'); hint.className='muted'; hint.textContent='快速提問：';
      wrap.appendChild(hint);
      [
        '幫我把這個想法拆成 60 秒腳本，Hook 要很強：',
        '請先用簡短方式介紹 A~F 六種結構的差異與適用情境，然後依我這個主題挑一種並給第一版：',
        '請用 6 段 60 秒，對白口語＋畫面具體，最後給 CTA：'
      ].forEach(q=>{
        const b=document.createElement('button'); b.className='chip'; b.textContent=q;
        b.onclick=()=>{ const t=document.getElementById('inputScript'); t.value=q; t.focus(); };
        wrap.appendChild(b);
      });
    }
  }

  // 引導模式：Q/A API
  async function apiChatQA(message){
    const r = await fetch(`${API_BASE}/chat_qa`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ session_id: state.sessionIdScript, message })
    });
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.json();
  }

  // 取得第一題
  async function startQaFirstQuestion(){
    if(state.guideApplied) return; // 已套用設定，不自動進入 Q1
    const resp=await apiChatQA('');
    if(resp.assistant_message){
      appendMsg(document.getElementById('chatScript'),'assistant',resp.assistant_message);
      state.messagesScript.push({ role:'assistant', content:resp.assistant_message });
      state.lastAssistantScript = resp.assistant_message;
    }
  }

  // 引導模式：把上方的模板/時長直接先回答 Q1/Q2（省兩步）
  document.getElementById('btnStartGuide').onclick = async ()=>{
    if(state.scriptMode!=='guide') return;
    const tpl = document.querySelector('input[name="tpl"]:checked').value;
    const dur = document.querySelector('input[name="dur"]:checked').value;
    state.templateType = tpl;
    state.duration = parseInt(dur,10);
    state.guideApplied = true;
    showToast('已套用模板與時長設定');
  };

  // 模式切換
  document.getElementById('modeGroup').addEventListener('change', e=>{
    if(e.target.name!=='scriptMode') return;
    state.scriptMode = e.target.value;       // guide | free
    document.getElementById('guideBar').style.display = (state.scriptMode==='guide')?'block':'none';
    renderChips();
  });

  // 送出：改走增強版 API，能回傳分段 → 右側顯示
  const chatScript = document.getElementById('chatScript');
  document.getElementById('sendScript').onclick = async ()=>{ await sendScriptMessage(); };

  // 片段渲染
  const segmentsWrap = document.getElementById('segmentsWrap');
  function segmentToText(s){ 
    return `(${s.start_sec}s–${s.end_sec}s) [${s.type||'-'}] camera:${s.camera||'-'}\n台詞:${s.dialog||''}\n畫面:${s.visual||''}\nCTA:${s.cta||''}`;
  }
  function renderSegments(){
    segmentsWrap.innerHTML='';
    if(!state.segments?.length){ 
      const empty=document.createElement('div'); 
      empty.className='segment-card muted'; 
      empty.textContent='尚無片段。請輸入更具體的秒數/場景/目標。'; 
      segmentsWrap.appendChild(empty); 
      return; 
    }
    state.segments.forEach((s,i)=>{
      if(s.start_sec==null||s.end_sec==null){ s.start_sec=i*6; s.end_sec=i*6+6; }
      const card=document.createElement('div'); card.className='segment-card';
      card.innerHTML=`
        <div class="segment-head">
          <div class="seg-title">#${i+1} ${s.type||'segment'} <span class="seg-meta">${s.start_sec}s–${s.end_sec}s · 鏡位 ${s.camera||'-'}</span></div>
          <div class="seg-actions">
            <button class="btn small" data-act="copy" data-idx="${i}">複製</button>
            <button class="btn small" data-act="tweak" data-idx="${i}">微調</button>
            <button class="btn small" data-act="del" data-idx="${i}">刪除</button>
          </div>
        </div>
        <div class="muted">對白</div><div>${escapeHTML(s.dialog||'')}</div>
        <div class="muted" style="margin-top:6px">畫面感</div><div>${escapeHTML(s.visual||'')}</div>
        <div class="muted" style="margin-top:6px">CTA</div><div>${escapeHTML(s.cta||'')}</div>`;
      segmentsWrap.appendChild(card);
    });
  }
  segmentsWrap.onclick = e=>{
    const b=e.target.closest('button'); if(!b) return;
    const idx=+b.dataset.idx, seg=state.segments[idx];
    if(b.dataset.act==='copy') copyText(segmentToText(seg));
    if(b.dataset.act==='del'){ state.segments.splice(idx,1); renderSegments(); }
    if(b.dataset.act==='tweak'){
      const nd=prompt('微調對白（留空略過）',seg.dialog||''); if(nd!=null && nd!=='') seg.dialog=nd;
      const nv=prompt('微調畫面（留空略過）',seg.visual||''); if(nv!=null && nv!=='') seg.visual=nv;
      const nc=prompt('微調 CTA（留空略過）',seg.cta||''); if(nc!=null && nc!=='') seg.cta=nc;
      renderSegments();
    }
  };

  // 複製/清空
  document.getElementById('copyAllScript').onclick=()=>{ 
    if(!state.segments?.length) return showToast('無可複製內容'); 
    copyText(state.segments.map(s=>segmentToText(s)).join('\n\n'),'已複製囉！');
  };
  document.getElementById('clearScript').onclick =()=>{ state.segments=[]; renderSegments(); };



  // 模板/時長選取 → 存到 state（供自由模式也可帶）
  document.getElementById('tplGroup').addEventListener('change', e=>{
    if(e.target.name==='tpl') state.templateType = e.target.value;
  });
  document.getElementById('durGroup').addEventListener('change', e=>{
    if(e.target.name==='dur') state.duration = parseInt(e.target.value,10);
  });

  // ========= 三智能體功能 =========

  // 定位智能體
  function showPositioningWelcome(){
    const chat = document.getElementById('chatPositioning');
    const msg = '🎯 歡迎使用AI影音定位顧問！\n\n我會幫你建立完整的定位檔案，包含：\n• 業務類型：你主要做什麼？\n• 目標受眾：你的觀眾是誰？\n• 品牌語氣：你想傳達什麼形象？\n• 主要平台：在哪裡經營？\n• 內容目標：想要達成什麼？\n• 發文頻率：多久更新一次？\n\n💡 你可以：\n1. 直接告訴我你的業務和想法\n2. 點擊下方快速問題按鈕\n3. 我會根據你的回答逐步幫你完善定位檔案！';
    appendMsg(chat, 'assistant', msg, true);
    state.messagesPositioning.push({ role:'assistant', content:msg });
  }

  async function sendPositioningMessage(){
    const textarea = document.getElementById('inputPositioning');
    const text = (textarea.value || '').trim();
    if(!text){ showToast('請先輸入內容'); return; }
    
    const chat = document.getElementById('chatPositioning');
    appendMsg(chat, 'user', text);
    textarea.value = '';
    
    // 串流方式
    streamChat(chat, {
      user_id: state.userId,
      agent_type: 'positioning',
      session_id: state.sessionIdPositioning,
      messages: [{ role: 'user', content: text }]
    }, {
      onComplete: async ()=>{
        try{ await refreshPositioningProfile(); }catch(_){ }
      }
    });
  }

  function updateProfileDisplay(){
    const profileContent = document.getElementById('profileContent');
    if(state.userProfile){
      const profile = state.userProfile;
      // 清理欄位（去除 ** 等 Markdown 殘留；空值顯示為未設定）
      const cleanField = (v)=>{
        if(v==null) return '未設定';
        let s = String(v)
          .replace(/^\*+\s*/g,'')
          .replace(/\s*\*+$/g,'')
          .replace(/^【.*?】/,'')
          .trim();
        if(!s || s === '—' || s === '-') return '未設定';
        return s;
      };

      const notes = (state.userNotes||[]).map(n=>{
        // 清理內容，移除開場白
        let cleanContent = n.content
          .replace(/哈囉!.*?定位顧問.*?台灣市場特性.*?短影音腳本。/g, '')
          .replace(/沒問題!.*?選題顧問.*?影片燒起來。/g, '')
          .trim();
        
        // 格式化段落
        cleanContent = cleanContent
          .replace(/\n/g, '<br>')
          .replace(/(\d+\.)/g, '<br><strong>$1</strong>')
          .replace(/(Hook|Value|CTA)/g, '<br><strong>$1</strong>')
          .replace(/(\d+-\d+秒)/g, '<br><em>$1</em>');
        
        return `<li style="margin-bottom: 8px; line-height: 1.5;">${cleanContent}</li>`;
      }).join('') || '<li class="muted">尚無筆記</li>';
      
      // 檢查哪些欄位已填寫
      const filledFields = [];
      const emptyFields = [];
      
      if(profile.business_type && profile.business_type !== '未設定') filledFields.push('業務類型');
      else emptyFields.push('業務類型');
      
      if(profile.target_audience && profile.target_audience !== '未設定') filledFields.push('目標受眾');
      else emptyFields.push('目標受眾');
      
      if(profile.brand_voice && profile.brand_voice !== '未設定') filledFields.push('品牌語氣');
      else emptyFields.push('品牌語氣');
      
      if(profile.primary_platform && profile.primary_platform !== '未設定') filledFields.push('主要平台');
      else emptyFields.push('主要平台');
      
      if(profile.content_goals && profile.content_goals !== '未設定') filledFields.push('內容目標');
      else emptyFields.push('內容目標');
      
      if(profile.posting_frequency && profile.posting_frequency !== '未設定') filledFields.push('發文頻率');
      else emptyFields.push('發文頻率');
      
      let statusText = '';
      if(emptyFields.length === 0) {
        statusText = '<div style="color:var(--ok); font-weight:600; margin-bottom:8px;">✅ 定位檔案完整</div>';
      } else {
        statusText = `<div style="color:var(--err); font-weight:600; margin-bottom:8px;">⚠️ 還需填寫：${emptyFields.join('、')}</div>`;
      }
      
      profileContent.innerHTML = `
        ${statusText}
        <div class="profile-field"><strong>業務類型：</strong>${cleanField(profile.business_type)}</div>
        <div class="profile-field"><strong>目標受眾：</strong>${cleanField(profile.target_audience)}</div>
        <div class="profile-field"><strong>品牌語氣：</strong>${cleanField(profile.brand_voice)}</div>
        <div class="profile-field"><strong>主要平台：</strong>${cleanField(profile.primary_platform)}</div>
        <div class="profile-field"><strong>內容目標：</strong>${cleanField(profile.content_goals)}</div>
        <div class="profile-field"><strong>發文頻率：</strong>${cleanField(profile.posting_frequency)}</div>
        <div style="margin-top:12px; padding-top:8px; border-top:1px solid #eee;"><strong>📝 定位筆記：</strong></div>
        <ul style="padding-left:18px; margin:6px 0 0">${notes}</ul>
      `;
    } else {
      profileContent.innerHTML = '<div class="muted">尚未建立定位檔案，請先與AI影音定位顧問對話。</div>';
    }
  }

  async function refreshPositioningProfile(){
    const resp = await fetch(`${API_BASE}/agent/positioning/profile?user_id=${state.userId}&notes_limit=8`);
    const data = await resp.json();
    if(data && !data.error){
      state.userProfile = data.profile || {};
      state.userNotes = data.notes || [];
      updateProfileDisplay();
    }
  }

  // 選題智能體
  function showTopicsWelcome(){
    const chat = document.getElementById('chatTopics');
    const msg = '💡 歡迎使用AI選題小助手！\n\n我會根據你的定位檔案，提供：\n• 每日選題靈感\n• 熱門話題建議\n• 季節性內容\n• 平台特色選題\n\n點擊「獲取靈感」開始生成今日選題建議！';
    appendMsg(chat, 'assistant', msg, true);
    state.messagesTopics.push({ role:'assistant', content:msg });
  }

  // 選題筆記顯示
  function updateTopicsNotesDisplay(){
    const topicsContent = document.getElementById('topicsContent');
    if(state.topicsNotes && state.topicsNotes.length > 0){
      const notes = state.topicsNotes.map(n=>{
        // 清理內容，移除開場白
        let cleanContent = n.content
          .replace(/沒問題!.*?選題顧問.*?影片燒起來。/g, '')
          .replace(/哈囉!.*?選題小助手.*?歡迎使用。/g, '')
          .trim();
        
        // 確保內容完整，修復截斷問題
        if(cleanContent.includes('2. 別') && !cleanContent.includes('你out了!')) {
          cleanContent = cleanContent.replace(/2\. 別.*$/, '2. 以為我們不懂人情世故?其實只是用「新型社交通關密語」溝通，你out了!');
        }
        
        // 格式化段落
        cleanContent = cleanContent
          .replace(/^/,'🔥 ')
          .replace(/\n/g, '<br>')
          .replace(/(\d+\.)/g, '<br><strong>$1</strong>')
          .replace(/(選題方向|爆點切入|內容發展|為什麼會爆)/g, '<br><strong>$1</strong>')
          .replace(/(Hook|Value|CTA)/g, '<br><strong>$1</strong>');
        
        return `<li style="margin-bottom: 12px; line-height: 1.6; padding: 8px; background: #f8f9fa; border-radius: 6px;">${cleanContent}</li>`;
      }).join('');
      
      // 重新設計為歷史紀錄格式
      const historyItems = state.topicsNotes.map((n, index) => {
        // 清理內容，移除開場白
        let cleanContent = n.content
          .replace(/沒問題!.*?選題顧問.*?影片燒起來。/g, '')
          .replace(/哈囉!.*?選題小助手.*?歡迎使用。/g, '')
          .trim();
        
        // 確保內容完整，修復截斷問題
        if(cleanContent.includes('2. 別') && !cleanContent.includes('你out了!')) {
          cleanContent = cleanContent.replace(/2\. 別.*$/, '2. 以為我們不懂人情世故?其實只是用「新型社交通關密語」溝通，你out了!');
        }
        
        // 提取時間
        const time = n.created_at ? new Date(n.created_at).toLocaleString('zh-TW') : `記錄 ${index + 1}`;
        
        // 提取主題標題（從內容中找第一個標題）
        const titleMatch = cleanContent.match(/(蹭「[^」]+」熱點|選題方向[：:]\s*([^\n]+)|爆款\s*Hook[：:]\s*([^\n]+))/);
        const title = titleMatch ? (titleMatch[1] || titleMatch[2] || titleMatch[3] || '選題建議').trim() : '選題建議';
        
        // 格式化內容為結構化顯示
        const formattedContent = cleanContent
          .replace(/\n/g, '<br>')
          .replace(/(選題方向[：:])/g, '<br><strong>🎯 $1</strong>')
          .replace(/(爆款\s*Hook[：:])/g, '<br><strong>🔥 $1</strong>')
          .replace(/(主體內容切入點[：:])/g, '<br><strong>💡 $1</strong>')
          .replace(/(建議\s*Hashtag[：:])/g, '<br><strong># $1</strong>')
          .replace(/(\d+\.)/g, '<br><strong>$1</strong>');
        
        return `
          <div class="history-item" style="margin-bottom: 16px; padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #2196F3;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <span style="font-size: 12px; color: #666;">${time}</span>
              <span style="font-size: 11px; color: #2196F3; background: #e3f2fd; padding: 2px 6px; border-radius: 4px;">選題建議</span>
            </div>
            <div style="font-weight: 600; color: #333; margin-bottom: 8px;">✨ ${title}</div>
            <div style="line-height: 1.6; color: #555;">${formattedContent}</div>
          </div>
        `;
      }).join('');
      
      topicsContent.innerHTML = `
        <div style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
          <strong>📚 歷史紀錄</strong>
          <button onclick="clearTopicsHistory()" style="font-size: 12px; color: #666; background: none; border: none; cursor: pointer;">清空</button>
        </div>
        <div style="max-height: 400px; overflow-y: auto;">${historyItems}</div>
      `;
    } else {
      topicsContent.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">點擊「獲取靈感」開始生成選題建議。</div>';
    }
  }
  
  // 清空選題歷史
  function clearTopicsHistory() {
    if(confirm('確定要清空所有選題歷史嗎？')) {
      state.topicsNotes = [];
      updateTopicsNotesDisplay();
    }
  }

  async function refreshTopicsNotes(){
    try{
      const resp = await fetch(`${API_BASE}/agent/notes?user_id=${state.userId}&agent_type=topic_selection&memory_type=note&limit=8`);
      const data = await resp.json();
      if(data && !data.error){
        state.topicsNotes = data.notes || [];
        updateTopicsNotesDisplay();
      }
    }catch(e){}
  }

  async function loadUserProfile(){
    // 保留但不再在選題頁顯示提示
    try{ await fetch(`${API_BASE}/memory/user/${state.userId}?agent_type=positioning&limit=1`); }catch(e){}
  }

  async function checkPositioningProfile(){
    try{
      await refreshPositioningProfile();
      const chat = document.getElementById('chatPositioning');
      if(state.userProfile && Object.keys(state.userProfile).length){
        appendMsg(chat, 'assistant', '✅ 我已讀取到你的定位檔案，之後的建議會更貼近你的方向。', true);
      } else {
        appendMsg(chat, 'assistant', '💡 目前沒有定位檔案，先跟我聊聊你的業務與受眾，我會幫你建立。', true);
      }
    }catch(e){ }
  }

  async function getTopics(){
    const textarea = document.getElementById('inputTopics');
    const text = (textarea.value || '').trim();
    
    const chat = document.getElementById('chatTopics');
    if(text){
      appendMsg(chat, 'user', text);
    }
    
    // 串流方式
    streamChat(chat, {
      user_id: state.userId,
      agent_type: 'topics',
      session_id: state.sessionIdTopics,
      messages: [{ role:'user', content: text || '請提供今日的選題靈感' }]
    }, {
      onComplete: async (finalText)=>{ 
        updateTopicsDisplay(finalText);
        await refreshTopicsNotes(); // 更新筆記
      }
    });
  }

  function updateTopicsDisplay(suggestions){
    const topicsContent = document.getElementById('topicsContent');
    if(state.topicsNotes && state.topicsNotes.length > 0){
      const notes = state.topicsNotes.map(n=>`<li>${escapeHTML(n.content||'')}</li>`).join('');
      topicsContent.innerHTML = `
        <div><strong>選題建議</strong></div>
        <div style="margin:8px 0">${suggestions.replace(/\n/g, '<br>')}</div>
        <div style="margin-top:8px"><strong>選題筆記：</strong></div>
        <ul style="padding-left:18px; margin:6px 0 0">${notes}</ul>
      `;
    } else {
      topicsContent.innerHTML = `<div>${suggestions.replace(/\n/g, '<br>')}</div>`;
    }
  }

  // 腳本文案智能體（增強版）
  async function sendScriptMessage(){
    const textarea = document.getElementById('inputScript');
    const text = (textarea.value || '').trim();
    if(!text){ showToast('請先輸入內容'); return; }
    
    const chat = document.getElementById('chatScript');
    appendMsg(chat, 'user', text);
    textarea.value = '';
    
    // 顯示載入狀態
    showLoadingMsg(chat, 'AI腳本生成大師正在創作中...');
    
    try{
      const payload = {
        user_id: state.userId,
        user_input: text,
        mode: 'script',
        template_type: state.templateType || null,
        duration: state.duration || null
      };
      
      const r = await fetch(`${API_BASE}/agent/content/generate`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      
      const j = await r.json();
      
      // 隱藏載入狀態
      hideLoadingMsg(chat);
      
      if(!r.ok) throw new Error(j?.assistant_message || j?.error || `HTTP ${r.status}`);
      
      if(j.assistant_message) {
        // 使用格式化顯示 AI 回應
        appendMsg(chat, 'assistant', j.assistant_message, true);
      }
      
      // 處理腳本分段 - 確保正確顯示
      if(j.generated_content?.segments) {
        state.segments = j.generated_content.segments;
        renderSegments();
      } else if(j.segments) {
        state.segments = j.segments;
        renderSegments();
      }
      
      // 更新腳本筆記
      await refreshScriptNotes();
    }catch(e){
      // 隱藏載入狀態
      hideLoadingMsg(chat);
      appendMsg(chat, 'assistant', `❌ 錯誤：${e.message}`);
    }
  }

  // 腳本筆記功能
  async function refreshScriptNotes(){
    try{
      const resp = await fetch(`${API_BASE}/agent/notes?user_id=${state.userId}&agent_type=script_copy&memory_type=note&limit=8`);
      const data = await resp.json();
      if(data && !data.error){
        state.scriptNotes = data.notes || [];
        updateScriptNotesDisplay();
      }
    }catch(e){}
  }

  function updateScriptSegmentsDisplay(segments) {
    const segmentsWrap = document.getElementById('segmentsWrap');
    if (!segmentsWrap) return;
    
    // 清除現有的腳本分段
    const existingSegments = segmentsWrap.querySelectorAll('.script-segment');
    existingSegments.forEach(el => el.remove());
    
    if (!segments || segments.length === 0) {
      return;
    }
    
    segments.forEach((segment, index) => {
      const segmentDiv = document.createElement('div');
      segmentDiv.className = 'script-segment segment-card';
      
      let typeText = '';
      switch(segment.type) {
        case 'hook': typeText = '🎯 開場鉤子'; break;
        case 'value': typeText = '💡 內容價值'; break;
        case 'cta': typeText = '📢 行動呼籲'; break;
        default: typeText = '📝 腳本段落';
      }
      
      segmentDiv.innerHTML = `
        <div class="segment-head">
          <div class="seg-title">${typeText} (${segment.start_sec}-${segment.end_sec}秒)</div>
        </div>
        <div class="segment-content">
          <div class="dialog"><strong>台詞：</strong>${segment.dialog || ''}</div>
          <div class="visual"><strong>畫面：</strong>${segment.visual || ''}</div>
          ${segment.cta ? `<div class="cta"><strong>CTA：</strong>${segment.cta}</div>` : ''}
        </div>
      `;
      
      segmentsWrap.appendChild(segmentDiv);
    });
  }

  function updateScriptNotesDisplay(){
    const segmentsWrap = document.getElementById('segmentsWrap');
    if(state.scriptNotes && state.scriptNotes.length > 0){
      const notes = state.scriptNotes.map(n=>{
        // 清理內容，移除程式碼和開場白
        let cleanContent = n.content
          .replace(/哈囉!.*?腳本顧問.*?台灣市場特性.*?短影音腳本。/g, '')
          .replace(/```json[\s\S]*?```/g, '')
          .replace(/\{[\s\S]*?\}/g, '')
          .replace(/---.*?---/g, '')
          .replace(/\*\*.*?\*\*/g, '')
          .trim();
        
        // 格式化段落
        cleanContent = cleanContent
          .replace(/\n/g, '<br>')
          .replace(/(\d+\.)/g, '<br><strong>$1</strong>')
          .replace(/(Hook|Value|CTA)/g, '<br><strong>$1</strong>')
          .replace(/(\d+-\d+秒)/g, '<br><em>$1</em>');
        
        return `<li style="margin-bottom: 12px; line-height: 1.6;">${cleanContent}</li>`;
      }).join('');
      
      const notesDiv = document.createElement('div');
      notesDiv.className = 'segment-card';
      notesDiv.innerHTML = `
        <div class="segment-head">
          <div class="seg-title">📝 腳本筆記</div>
        </div>
        <ul style="padding-left:18px; margin:6px 0 0">${notes}</ul>
      `;
      segmentsWrap.insertBefore(notesDiv, segmentsWrap.firstChild);
    }
  }

  // 事件綁定
  document.getElementById('sendPositioning').onclick = sendPositioningMessage;
  document.getElementById('getTopics').onclick = getTopics;
  document.getElementById('cancelPositioning').onclick = cancelStream;
  document.getElementById('cancelTopics').onclick = cancelStream;
  document.getElementById('cancelScript').onclick = cancelStream;
  
  // 快速問題 chips
  document.querySelectorAll('#chipsPositioning .chip').forEach(chip => {
    chip.onclick = () => {
      const question = chip.dataset.question;
      document.getElementById('inputPositioning').value = question;
    };
  });
  
  document.querySelectorAll('#chipsTopics .chip').forEach(chip => {
    chip.onclick = () => {
      const topicType = chip.dataset.topicType;
      document.getElementById('inputTopics').value = `我想要${chip.textContent}類型的選題建議`;
    };
  });

  // 複製功能
  document.getElementById('copyAllTopics').onclick = () => {
    const content = document.getElementById('topicsContent').textContent;
    if(content && content !== '點擊「獲取靈感」開始生成選題建議。'){
      copyText(content, '選題建議已複製！');
    } else {
      showToast('暫無可複製內容');
    }
  };

  // 清空對話
  document.getElementById('clearPositioningChat').onclick = () => {
    document.getElementById('chatPositioning').innerHTML = '';
    state.messagesPositioning = [];
    showPositioningWelcome();
  };

  // 重新生成選題
  document.getElementById('refreshTopics').onclick = getTopics;

  // 歷史記錄
  document.getElementById('viewTopicHistory').onclick = async () => {
    try{
      const resp = await fetch(`${API_BASE}/agent/topics/history?user_id=${state.userId}&limit=5`);
      const data = await resp.json();
      if(data.suggestions && data.suggestions.length > 0){
        let history = '📅 選題歷史記錄：\n\n';
        data.suggestions.forEach((s, i) => {
          history += `${i+1}. ${s.suggested_date}\n${JSON.parse(s.topics || '{}').suggestions || s.reasoning}\n\n`;
        });
        showToast('歷史記錄已顯示在對話中');
        appendMsg(document.getElementById('chatTopics'), 'assistant', history);
      } else {
        showToast('暫無歷史記錄');
      }
    }catch(e){
      showToast('載入歷史記錄失敗');
    }
  };

  // 儲存檔案
  document.getElementById('saveProfile').onclick = async () => {
    if(!state.userProfile){
      showToast('暫無檔案可儲存');
      return;
    }
    
    try{
      const resp = await fetch(`${API_BASE}/agent/positioning/profile`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          user_id: state.userId,
          profile_data: state.userProfile
        })
      });
      
      const data = await resp.json();
      if(data.success){
        showToast('檔案儲存成功！');
      } else {
        showToast('檔案儲存失敗');
      }
    }catch(e){
      showToast('儲存失敗：' + e.message);
    }
  };

  // 一鍵生成定位
  document.getElementById('oneClickPositioning').onclick = async () => {
    const theme = prompt('請輸入你的產品、服務或主題：', '');
    if (!theme || !theme.trim()) {
      showToast('請輸入主題');
      return;
    }
    
    const chat = document.getElementById('chatPositioning');
    const input = document.getElementById('inputPositioning');
    
    // 顯示載入狀態
    showLoadingMsg(chat, 'AI正在分析你的主題並生成定位...');
    
    try {
      const payload = {
        user_id: state.userId,
        theme: theme.trim()
      };
      
      const resp = await fetch(`${API_BASE}/agent/positioning/generate`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      
      const data = await resp.json();
      
      // 隱藏載入狀態
      hideLoadingMsg(chat);
      
      if (!resp.ok) {
        throw new Error(data?.error || `HTTP ${resp.status}`);
      }
      
      if (data.response) {
        // 顯示 AI 回應
        appendMsg(chat, 'assistant', data.response, true);
        
        // 更新定位檔案
        if (data.user_profile) {
          state.userProfile = data.user_profile;
          updateProfileDisplay();
        }
        
        // 刷新定位筆記
        await refreshPositioningProfile();
        
        showToast('定位生成完成！');
      }
      
    } catch (e) {
      // 隱藏載入狀態
      hideLoadingMsg(chat);
      appendMsg(chat, 'assistant', `❌ 錯誤：${e.message}`);
      showToast('生成失敗：' + e.message);
    }
  };

  // 模式切換功能
  document.getElementById('guideMode').onclick = () => {
    // 切換到引導模式
    document.getElementById('guideBar').style.display = 'block';
    // 更新按鈕狀態
    document.getElementById('guideMode').classList.add('active');
    document.getElementById('freeMode').classList.remove('active');
    document.getElementById('oneClickScript').classList.remove('active');
    // 更新全局狀態
    state.scriptMode = 'guide';
  };

  document.getElementById('freeMode').onclick = () => {
    // 切換到自由模式
    document.getElementById('guideBar').style.display = 'none';
    // 更新按鈕狀態
    document.getElementById('freeMode').classList.add('active');
    document.getElementById('guideMode').classList.remove('active');
    document.getElementById('oneClickScript').classList.remove('active');
    // 更新全局狀態
    state.scriptMode = 'free';
  };

  // 一鍵生成腳本功能
  document.getElementById('oneClickScript').onclick = async () => {
    // 更新按鈕狀態
    document.getElementById('oneClickScript').classList.add('active');
    document.getElementById('guideMode').classList.remove('active');
    document.getElementById('freeMode').classList.remove('active');
    
    const theme = prompt('請輸入您的主題或腳本內容：', '');
    if (!theme || !theme.trim()) {
      showToast('請輸入主題');
      return;
    }
    
    const chat = document.getElementById('chatScript');
    
    // 顯示載入狀態
    showLoadingMsg(chat, 'AI正在生成腳本...');
    
    try {
      const payload = {
        user_id: state.userId,
        theme: theme.trim(),
        template_type: state.templateType,
        duration: state.duration
      };
      
      const resp = await fetch(`${API_BASE}/agent/script/generate`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      
      const data = await resp.json();
      
      // 隱藏載入狀態
      hideLoadingMsg(chat);
      
      if (!resp.ok) {
        throw new Error(data?.error || `HTTP ${resp.status}`);
      }
      
      if (data.assistant_message) {
        // 顯示 AI 回應
        appendMsg(chat, 'assistant', data.assistant_message, true);
        
        // 更新腳本分段顯示（寫入狀態並渲染到「腳本分段 / 時間軸」）
        if (data.segments && data.segments.length > 0) {
          try {
            state.segments = data.segments;
            if (typeof renderSegments === 'function') {
              renderSegments();
            } else {
              // 若舊版函數不存在，退而使用新渲染方式
              updateScriptSegmentsDisplay(data.segments);
            }
          } catch(e) {
            updateScriptSegmentsDisplay(data.segments);
          }
        } else if (data.generated_content?.segments) {
          // 處理不同的回應格式
          state.segments = data.generated_content.segments;
          if (typeof renderSegments === 'function') {
            renderSegments();
          } else {
            updateScriptSegmentsDisplay(data.generated_content.segments);
          }
        }
        
        // 刷新腳本筆記
        await refreshScriptNotes();
        
        // 確保腳本分段區域可見
        const segmentsWrap = document.getElementById('segmentsWrap');
        if (segmentsWrap) {
          segmentsWrap.scrollTop = 0;
        }
        
        showToast('腳本生成完成！');
      }
      
    } catch (e) {
      // 隱藏載入狀態
      hideLoadingMsg(chat);
      appendMsg(chat, 'assistant', `❌ 錯誤：${e.message}`);
      showToast('生成失敗：' + e.message);
    }
  };

  // 初始化腳本模式按鈕狀態
  function initScriptModeButtons() {
    // 設置初始狀態：引導模式為選中
    document.getElementById('guideMode').classList.add('active');
    document.getElementById('freeMode').classList.remove('active');
    document.getElementById('oneClickScript').classList.remove('active');
    state.scriptMode = 'guide';
  }

  // 初始化
  goPage('home');
  initScriptModeButtons();
  
  // 確保腳本頁面輸入框可見
  setTimeout(() => {
    const inputScript = document.getElementById('inputScript');
    const inputbar = document.querySelector('#page-script .inputbar');
    if(inputScript) {
      console.log('腳本輸入框找到:', inputScript);
      inputScript.style.display = 'block';
      inputScript.style.visibility = 'visible';
      inputScript.style.opacity = '1';
    } else {
      console.error('腳本輸入框未找到!');
    }
    if(inputbar) {
      inputbar.style.display = 'flex';
      inputbar.style.visibility = 'visible';
      inputbar.style.opacity = '1';
      console.log('輸入框區域已確保可見');
    }
  }, 100);
  </script>
</body>
</html>
