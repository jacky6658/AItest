<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AIJobçŸ­å½±éŸ³ç‡ŸéŠ·æ™ºèƒ½</title>
  <style>
    /* =========================
       äº®è‰²ä¸»é¡Œï¼ˆå¯èª¿è‰²ç”¨è®Šæ•¸ï¼‰
       ========================= */
    :root{
      --bg:#f6f8fc;
      --panel:#ffffff;
      --panel-2:#f3f5f9;
      --text:#1b2430;
      --muted:#5f6b7a;
      --primary:#0b66ff;
      --primary-2:#4a8cff;
      --ok:#17b26a;
      --warn:#ff9f00;
      --danger:#ff3366;
      --border:rgba(16,24,40,.10);
      --shadow:0 10px 30px rgba(16,24,40,.08);
      --radius:14px;

      /* åˆ†æ®µé¡å‹é¡è‰² */
      --tag-intro:#0b66ff;   /* ç‰‡é ­ */
      --tag-scene:#64748b;   /* å ´æ™¯ */
      --tag-outro:#ff7a45;   /* ç‰‡å°¾ */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(180deg,#f9fbff 0%, #eef2f8 100%);
      color:var(--text);
      font:16px/1.55 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
    }
    .container{max-width:1200px; margin:26px auto; padding:0 16px}

    /* é é ­ï¼‹æ­¥é©Ÿåˆ— */
    header{display:flex; align-items:center; gap:12px; margin-bottom:12px}
    .logo{
      width:40px;height:40px;border-radius:12px;
      background:
        radial-gradient(120% 120% at 10% 10%, var(--primary), transparent 60%),
        radial-gradient(120% 120% at 90% 30%, #7b3fff, transparent 60%),
        radial-gradient(120% 120% at 50% 90%, #00c2c2, transparent 60%);
      box-shadow:0 6px 18px rgba(11,102,255,.25), inset 0 0 20px rgba(255,255,255,.6);
    }
    h1{font-size:22px; margin:0}
    .sub{color:var(--muted); font-size:13px}

    .stepper{
      display:flex; gap:8px; align-items:center; margin:14px 0 18px;
      font-size:13px; color:#334155;
    }
    .step{
      background:#fff; border:1px solid var(--border); border-radius:999px;
      padding:6px 10px; box-shadow:0 2px 8px rgba(16,24,40,.05);
    }
    .step.is-primary{background:linear-gradient(180deg,var(--primary),var(--primary-2)); color:#fff; border:none}
    .sep{opacity:.35}

    /* ä¸»å€å¡Š */
    .grid{display:grid; grid-template-columns: 1.05fr 1.1fr; gap:18px}
    @media (max-width:980px){ .grid{ grid-template-columns:1fr } }

    .panel{
      background:linear-gradient(180deg,var(--panel) 0%, var(--panel-2) 100%);
      border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:16px;
    }
    .panel h2{margin:4px 0 12px; font-size:16px}

    label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
    textarea{
      width:100%; min-height:110px; resize:vertical;
      background:#fff; color:var(--text);
      border:1px solid var(--border); border-radius:12px; padding:12px;
      transition:border-color .2s, box-shadow .2s;
    }
    textarea:focus{border-color:var(--primary); box-shadow:0 0 0 4px rgba(11,102,255,.14)}

    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px}
    .hint{font-size:12px; color:var(--muted); margin-top:6px}

    .btn{
      appearance:none; cursor:pointer;
      border:1px solid var(--border); background:#f7f9fc; color:#111827;
      padding:10px 14px; border-radius:12px;
      transition:transform .05s, box-shadow .2s, border-color .2s, background .2s;
    }
    .btn:hover{border-color:#cdd6e5; background:#eef2f8}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:linear-gradient(180deg,var(--primary),var(--primary-2)); color:#fff; border:none; font-weight:700; box-shadow:0 6px 16px rgba(11,102,255,.25)}
    .btn-ok{background:linear-gradient(180deg,#47e0a3,var(--ok)); color:#0a1312; border:none; font-weight:700}
    .btn-danger{background:linear-gradient(180deg,#ff7b94,var(--danger)); color:#fff; border:none}
    .btn-ghost{background:#fff}
    .btn-small{padding:7px 10px; border-radius:10px; font-size:12px}

    .toolbar{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}

    /* å³å´å¡ç‰‡åˆ—è¡¨ */
    .cards{display:grid; grid-template-columns:1fr; gap:12px}
    .card{
      position:relative; background:#fff; border:1px solid var(--border); border-radius:14px; padding:12px;
    }
    .tag{
      position:absolute; top:10px; right:10px; color:#fff; font-size:11px; font-weight:700; padding:4px 8px; border-radius:999px;
    }
    .tag.intro{background:var(--tag-intro)}
    .tag.scene{background:var(--tag-scene)}
    .tag.outro{background:var(--tag-outro)}

    .kv{display:grid; grid-template-columns: 92px 1fr; gap:10px}
    .kv strong{color:#334155; font-size:13px}
    .kv div{background:#f7f9fc; border:1px solid var(--border); border-radius:10px; min-height:40px; padding:8px 10px; white-space:pre-wrap}
    .actions{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap}
    .copy-icon{border:1px solid var(--border); background:#fff; border-radius:10px; font-size:12px; padding:6px 8px}

    /* Timeline */
    .timeline{margin-top:12px; padding-left:4px; border-left:2px dashed #d7deea}
    .tl-item{position:relative; background:#fff; border:1px solid var(--border); border-radius:12px; padding:10px 10px 10px 16px; margin:4px 0 8px}
    .tl-item::before{content:""; position:absolute; left:-7px; top:14px; width:10px; height:10px; border-radius:50%; background:var(--primary-2); box-shadow:0 0 0 4px rgba(74,140,255,.18)}
    .tl-head{display:flex; align-items:center; gap:8px; margin-bottom:6px}
    .tl-no{font-size:12px; color:#fff; background:#3b82f6; border-radius:999px; padding:2px 8px}
    .pill{font-size:11px; color:#0b1020; background:linear-gradient(180deg,#ffd480,#ffb100); border-radius:999px; padding:2px 8px; font-weight:700}
    .tl-editable{background:#f1f5ff}

    /* ç‹€æ…‹æç¤º & Toast */
    .status{display:flex; align-items:center; gap:8px; font-size:13px; color:var(--muted); margin-top:8px}
    .dot{width:10px; height:10px; border-radius:50%; background:linear-gradient(180deg,#9fd1ff,#0b66ff); box-shadow:0 0 0 6px rgba(74,140,255,.15); animation:pulse 1s infinite alternate}
    @keyframes pulse{to{transform:scale(1.1); box-shadow:0 0 0 10px rgba(74,140,255,.08)}}

    .toast{position:fixed; left:50%; bottom:20px; transform:translateX(-50%); background:#111827; color:#fff; border:1px solid rgba(255,255,255,.12); padding:10px 14px; border-radius:12px; box-shadow:var(--shadow); font-size:14px; display:none; z-index:9999}
    .toast.show{display:block; animation:fade .2s}
    @keyframes fade{from{opacity:0; transform:translate(-50%,6px)} to{opacity:1; transform:translate(-50%,0)}}

    details{background:#fff; border:1px dashed var(--border); border-radius:12px; padding:10px; margin-top:10px}
    summary{cursor:pointer; color:#0b66ff; font-weight:700}

    @media (max-width:560px){
      .kv{grid-template-columns:1fr}
      .kv strong{margin-top:6px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>AIJobçŸ­å½±éŸ³ç‡ŸéŠ·æ™ºèƒ½ </h1>
        <div class="sub">ä»¥ä½¿ç”¨è€…æµç¨‹ç‚ºä¸»ï¼šè¼¸å…¥ â†’ é€å‡º â†’ æŸ¥çœ‹ â†’ å¾®èª¿ â†’ ä¸‹ä¸€æ®µã€‚API å¥‘ç´„ä¸è®Šã€‚</div>
      </div>
    </header>

    <!-- æ­¥é©Ÿå°è¦½ï¼ˆç´”è¦–è¦ºï¼Œä¸å½±éŸ¿ APIï¼‰ -->
    <div class="stepper" aria-hidden="true">
      <div class="step is-primary">æ­¥é©Ÿ 1ï¼šè¼¸å…¥éœ€æ±‚</div>
      <div class="sep">â†’</div>
      <div class="step">æ­¥é©Ÿ 2ï¼šç”Ÿæˆåˆ†æ®µ</div>
      <div class="sep">â†’</div>
      <div class="step">æ­¥é©Ÿ 3ï¼šåŠ å…¥æ™‚é–“è»¸/å¾®èª¿</div>
    </div>

    <div class="grid">
      <!-- å·¦ï¼šè¼¸å…¥èˆ‡æ§åˆ¶ -->
      <section class="panel" aria-labelledby="input-title">
        <h2 id="input-title">è¼¸å…¥èˆ‡æ§åˆ¶</h2>

        <label for="userInput">è«‹æè¿°å½±ç‰‡ä¸»é¡Œæˆ–ä¿®æ”¹å»ºè­°ï¼ˆè¶Šå…·é«”è¶Šå¥½ï¼‰</label>
        <textarea id="userInput" placeholder="ä¾‹ï¼šçµ¦ä¸Šç­æ—çš„ 30 ç§’ Reelsï¼Œä¸»é¡Œã€åŠ ç­ä¹Ÿèƒ½å¥èº«ã€ï¼Œå¹½é»˜å£èªé¢¨æ ¼ï¼›è‹¥ä¸Šä¸€æ®µå¤ªé•·ï¼Œè«‹ç¸®çŸ­å°è©ã€‚"></textarea>

        <div class="row">
          <button id="btnSend" class="btn btn-primary">é€å‡ºçµ¦ /generate_script</button>
          <button id="btnNext" class="btn btn-ok" title="åŸºæ–¼ä¸Šä¸€æ®µå»¶çºŒåŠ‡æƒ…">ç”Ÿæˆä¸‹ä¸€æ®µ</button>
          <button id="btnClear" class="btn btn-danger" title="æ¸…é™¤æœ¬é çš„æš«å­˜è³‡æ–™">æ¸…ç©ºï¼ˆä¸å½±éŸ¿ä¼ºæœå™¨ï¼‰</button>
        </div>

        <div class="toolbar">
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer">
            <input id="mockToggle" type="checkbox"> ä½¿ç”¨ Mock APIï¼ˆæœ¬åœ°æ¸¬è©¦ï¼Œä¸å‘¼å«å¾Œç«¯ï¼‰
          </label>
          <button id="btnExport" class="btn btn-ghost btn-small">åŒ¯å‡º previous_segments.json</button>
          <button id="btnCopyAll" class="btn btn-ghost btn-small">è¤‡è£½æ‰€æœ‰æ®µè½æ–‡å­—</button>
        </div>

        <!-- æŠ€è¡“æ ¼å¼ï¼šé è¨­å¯æ”¶åˆï¼Œé¿å…åš‡åˆ°å®¢æˆ¶ -->
        <details>
          <summary>æŸ¥çœ‹æŠ€è¡“æ ¼å¼ï¼ˆå·¥ç¨‹ç”¨ï¼‰</summary>
<pre class="mono" style="white-space:pre-wrap; margin:8px 0 0">
Request:
{"user_input":"...", "previous_segments":[ ... ]}

Response:
{"segments":[{"type":"ç‰‡é ­|å ´æ™¯|ç‰‡å°¾","camera":"...","dialog":"...","visual":"..."}],
 "error": null}
</pre>
        </details>

        <hr style="border:none; border-top:1px solid var(--border); margin:16px 0" />

        <h2 style="display:flex; align-items:center; gap:8px">å·²æ¥å—æ®µè½ï¼ˆæ™‚é–“è»¸ï¼‰ <span class="pill">previous_segments</span></h2>
        <div id="timeline" class="timeline" aria-live="polite"></div>

        <div class="status">
          <div class="dot" aria-hidden="true"></div>
          <div>ç‹€æ…‹ï¼š<span id="statusText">é–’ç½®</span></div>
        </div>
      </section>

      <!-- å³ï¼šAI ç”Ÿæˆçµæœ -->
      <section class="panel" aria-labelledby="output-title">
        <h2 id="output-title">AI ç”Ÿæˆçš„åˆ†æ®µè…³æœ¬</h2>
        <div id="cards" class="cards" aria-live="polite"></div>
        <div class="hint">æ¯å¼µå¡ç‰‡éƒ½å¯ä»¥ã€ŒåŠ å…¥æ™‚é–“è»¸ã€æˆ–ã€Œå¾®èª¿å¾ŒåŠ å…¥ã€ã€‚æ²’æœ‰å…§å®¹æ™‚æœƒé¡¯ç¤ºç©ºç‹€æ…‹ã€‚</div>
      </section>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    /**
     * =========================================================
     * å‰ç«¯æ§åˆ¶ï¼ˆç´”åŸç”Ÿ JSï¼‰
     * ï¼API å¥‘ç´„ä¸è®Šã€URL ä¸è®Šã€æ–¹æ³•ä¸è®Šï¼
     *   POST /generate_script
     *   Request:  { "user_input": string, "previous_segments": Array<object> }
     *   Response: { "segments": Array<{type,camera,dialog,visual}>, "error": string|null }
     * =========================================================
     */

    /* âœ… æ–°å¢ï¼šå¾Œç«¯åŸºåº• URLï¼ˆé¿å… 405ï¼‰ */
    const API_BASE = 'https://aijobvideobackend.zeabur.app';

    // DOM å¿«å–
    const dom = {
      userInput: document.getElementById('userInput'),
      btnSend: document.getElementById('btnSend'),
      btnNext: document.getElementById('btnNext'),
      btnClear: document.getElementById('btnClear'),
      btnExport: document.getElementById('btnExport'),
      btnCopyAll: document.getElementById('btnCopyAll'),
      mockToggle: document.getElementById('mockToggle'),
      cards: document.getElementById('cards'),
      timeline: document.getElementById('timeline'),
      statusText: document.getElementById('statusText'),
      toast: document.getElementById('toast'),
    };

    // ç‹€æ…‹
    /** @type {Array<{type:string,camera?:string,dialog?:string,visual?:string}>} */
    let previousSegments = [];

    // å·¥å…·
    const toast = (msg, ms=1600)=>{ dom.toast.textContent = msg; dom.toast.classList.add('show'); setTimeout(()=> dom.toast.classList.remove('show'), ms); };
    const setStatus = (t)=> dom.statusText.textContent = t;
    const esc = (s='') => String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

    // å³å´ï¼šæ¸²æŸ“ segments
    function renderCards(segments){
      if(!Array.isArray(segments) || !segments.length){
        dom.cards.innerHTML = `
          <div class="card">
            <div class="kv">
              <div style="grid-column:1/-1; background:#f7f9fc; border:1px dashed var(--border); border-radius:10px; padding:16px; color:#64748b">
                ç›®å‰æ²’æœ‰å¯é¡¯ç¤ºçš„ segmentsã€‚è«‹åœ¨å·¦å´è¼¸å…¥éœ€æ±‚ä¸¦æŒ‰ã€Œé€å‡ºã€ã€‚
              </div>
            </div>
          </div>`;
        return;
      }
      dom.cards.innerHTML = segments.map((seg, idx)=>{
        const type = (seg.type||'').includes('é ­') ? 'intro' : ((seg.type||'').includes('å°¾') ? 'outro' : 'scene');
        const label = seg.type || (type==='intro'?'ç‰‡é ­':(type==='outro'?'ç‰‡å°¾':'å ´æ™¯'));
        return `
        <article class="card">
          <span class="tag ${type}">${esc(label)}</span>
          <button class="copy-icon" data-act="copy" data-idx="${idx}" title="è¤‡è£½é€™å¼µå¡ç‰‡å…§å®¹" style="position:absolute; top:10px; left:10px">ğŸ“‹ è¤‡è£½</button>
          <div class="kv" style="margin-top:8px">
            <strong>é¡ä½ camera</strong><div>${esc(seg.camera||'â€”')}</div>
            <strong>å°è© dialog</strong><div>${esc(seg.dialog||'â€”')}</div>
            <strong>è¦–è¦º visual</strong><div>${esc(seg.visual||'â€”')}</div>
          </div>
          <div class="actions">
            <button class="btn btn-primary btn-small" data-act="add"  data-idx="${idx}">åŠ å…¥æ™‚é–“è»¸</button>
            <button class="btn btn-ok btn-small"       data-act="fine" data-idx="${idx}">å¾®èª¿å¾ŒåŠ å…¥</button>
          </div>
        </article>`;
      }).join('');
    }

    // å·¦å´ï¼šæ¸²æŸ“ timeline
    function renderTimeline(){
      if(!previousSegments.length){
        dom.timeline.innerHTML = `<div class="tl-item"><div>å°šæœªåŠ å…¥ä»»ä½•æ®µè½ã€‚å…ˆåˆ°å³å´å¡ç‰‡æŒ‰ã€ŒåŠ å…¥æ™‚é–“è»¸ã€ã€‚</div></div>`;
        return;
      }
      dom.timeline.innerHTML = previousSegments.map((seg, i)=>{
        const editable = i === previousSegments.length-1;
        return `
        <div class="tl-item" data-i="${i}">
          <div class="tl-head">
            <span class="tl-no">#${i+1}</span>
            <strong style="margin-left:4px">${esc(seg.type || `æ®µè½ ${i+1}`)}</strong>
            ${editable ? `<span class="pill" title="ä¸Šä¸€æ®µå¯ç›´æ¥ä¿®æ”¹">LAST å¯ç·¨è¼¯</span>` : ``}
          </div>
          <div class="kv" style="margin-top:6px">
            <strong>camera</strong>
            <div ${editable?'contenteditable="true" class="tl-editable"':''} data-field="camera">${esc(seg.camera||'')}</div>
            <strong>dialog</strong>
            <div ${editable?'contenteditable="true" class="tl-editable"':''} data-field="dialog">${esc(seg.dialog||'')}</div>
            <strong>visual</strong>
            <div ${editable?'contenteditable="true" class="tl-editable"':''} data-field="visual">${esc(seg.visual||'')}</div>
          </div>
          <div class="actions">
            <button class="btn btn-ghost btn-small" data-tl="copy"   data-i="${i}">è¤‡è£½</button>
            <button class="btn btn-ghost btn-small" data-tl="remove" data-i="${i}">ç§»é™¤</button>
            ${editable ? `<button class="btn btn-primary btn-small" data-tl="save" data-i="${i}">ä¿å­˜æ­¤æ®µä¿®æ”¹</button>`:''}
          </div>
        </div>`;
      }).join('');
    }

    // å³å´å¡ç‰‡äº‹ä»¶
    dom.cards.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-act]');
      if(!btn) return;
      const idx = +btn.dataset.idx;
      const card = dom.cards.querySelectorAll('.card')[idx];
      const seg = extractSegmentFromCard(card);
      if(!seg) return;

      const act = btn.dataset.act;
      if(act==='add'){
        previousSegments.push(seg); renderTimeline(); toast('å·²åŠ å…¥æ™‚é–“è»¸');
      }else if(act==='copy'){
        navigator.clipboard.writeText(segmentToText(seg)).then(()=> toast('å·²è¤‡è£½æ®µè½'));
      }else if(act==='fine'){
        openFineTune(seg).then(result=>{
          if(result){ previousSegments.push(result); renderTimeline(); toast('å·²åŠ å…¥ï¼ˆå¾®èª¿å¾Œï¼‰'); }
        });
      }
    });

    // Timeline æŒ‰éˆ•
    dom.timeline.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-tl]');
      if(!btn) return;
      const i = +btn.dataset.i; if(Number.isNaN(i) || !previousSegments[i]) return;

      const act = btn.dataset.tl;
      if(act==='copy'){
        navigator.clipboard.writeText(segmentToText(previousSegments[i])).then(()=> toast('å·²è¤‡è£½æ™‚é–“è»¸æ®µè½'));
      }else if(act==='remove'){
        previousSegments.splice(i,1); renderTimeline(); toast('å·²ç§»é™¤æ®µè½');
      }else if(act==='save'){
        const item = dom.timeline.querySelector(`.tl-item[data-i="${i}"]`);
        const camera = item.querySelector('[data-field="camera"]')?.textContent ?? '';
        const dialog = item.querySelector('[data-field="dialog"]')?.textContent ?? '';
        const visual = item.querySelector('[data-field="visual"]')?.textContent ?? '';
        previousSegments[i] = {...previousSegments[i], camera, dialog, visual};
        toast('å·²ä¿å­˜æ­¤æ®µä¿®æ”¹');
      }
    });

    // é¡å¤–æ“ä½œ
    dom.btnClear.addEventListener('click', ()=>{
      dom.userInput.value=''; previousSegments=[]; renderTimeline(); dom.cards.innerHTML=''; setStatus('å·²æ¸…ç©º'); toast('å·²æ¸…ç©ºï¼ˆåƒ…å‰ç«¯ï¼‰');
    });
    dom.btnExport.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(previousSegments,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='previous_segments.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
    dom.btnCopyAll.addEventListener('click', ()=>{
      const text = previousSegments.map(segmentToText).join('\n\n');
      navigator.clipboard.writeText(text || 'ï¼ˆå°šç„¡æ®µè½ï¼‰').then(()=> toast('å·²è¤‡è£½æ‰€æœ‰æ®µè½'));
    });

    // é€å‡ºï¼ˆä¸»æµç¨‹ï¼‰
    dom.btnSend.addEventListener('click', async ()=>{ await callGenerate(dom.userInput.value.trim()); });
    dom.btnNext.addEventListener('click', async ()=>{
      const prompt = dom.userInput.value.trim() || 'è«‹åŸºæ–¼ä¸Šä¸€æ®µï¼Œå»¶çºŒåŒä¸€ä¸»é¡Œç”Ÿæˆä¸‹ä¸€æ®µã€‚';
      await callGenerate(prompt);
    });

    // è½‰æ–‡å­—
    function extractSegmentFromCard(card){
      try{
        const label = card.querySelector('.tag')?.textContent?.trim() || 'SEG';
        const kv = card.querySelectorAll('.kv div');
        return { type: label, camera: kv[0]?.textContent??'', dialog: kv[1]?.textContent??'', visual: kv[2]?.textContent??'' };
      }catch(e){ console.error(e); toast('è§£æå¡ç‰‡å¤±æ•—'); return null; }
    }
    function segmentToText(seg){
      return `ã€${seg.type||'æ®µè½'}ã€‘
é¡ä½ï¼š${seg.camera||''}
å°è©ï¼š${seg.dialog||''}
è¦–è¦ºï¼š${seg.visual||''}`;
    }

    // =============== API å‘¼å«å€å¡Šï¼ˆè«‹å‹¿ä¿®æ”¹ï¼‰ ===============
    async function callGenerate(user_input){
      setStatus('è™•ç†ä¸­â€¦');
      try{
        const payload = { user_input, previous_segments: previousSegments };
        let data;

        if(dom.mockToggle.checked){
          await sleep(420);
          data = await mockGenerate(payload);              // æœ¬åœ° Mockï¼ˆçµæ§‹ç›¸åŒï¼‰
        }else{
          /* âœ… å”¯ä¸€æ›¿æ›ï¼šæŒ‡å®šå¾Œç«¯å®Œæ•´ URL */
          data = await callApiWithRetry(`${API_BASE}/generate_script`, payload, 8000, 2);
        }

        if(!data || typeof data !== 'object') throw new Error('Invalid JSON');
        if(data.error) throw new Error(data.error);

        const segments = Array.isArray(data.segments) ? data.segments : [];
        if(!segments.length) toast('API å·²å›æ‡‰ï¼Œä½†æ²’æœ‰ segmentsã€‚');
        renderCards(segments);
        setStatus('å®Œæˆ');
      }catch(err){
        console.error(err);
        toast('å‘¼å«å¤±æ•—ï¼š' + (err?.message || 'æœªçŸ¥éŒ¯èª¤'));
        setStatus('éŒ¯èª¤');
      }
    }

    async function callApiWithRetry(url, body, timeoutMs=8000, retry=2){
      let lastErr;
      for(let i=0;i<=retry;i++){
        try{
          const res = await fetchWithTimeout(url, {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify(body),
          }, timeoutMs + i*2000);
          if(!res.ok) throw new Error('HTTP '+res.status);
          return await res.json();
        }catch(e){ lastErr=e; await sleep(300*(i+1)); }
      }
      throw lastErr;
    }
    function fetchWithTimeout(resource, options={}, timeout=8000){
      return new Promise((resolve,reject)=>{
        const id=setTimeout(()=>reject(new Error('Timeout')), timeout);
        fetch(resource, options).then(r=>{clearTimeout(id); resolve(r)}, e=>{clearTimeout(id); reject(e)});
      });
    }
    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
    // ================== API å€å¡ŠçµæŸï¼ˆè«‹å‹¿ä¿®æ”¹ï¼‰ ==================

    // æœ¬åœ° Mockï¼ˆæ–¹ä¾¿åœ¨ GitHub Pages ä¹Ÿèƒ½æ¸¬ UIï¼‰
    async function mockGenerate(req){
      const { user_input='', previous_segments=[] } = req||{};
      const step = previous_segments.length;
      const pickType = step===0 ? 'ç‰‡é ­' : (step>=2 ? 'ç‰‡å°¾' : 'å ´æ™¯');
      const short = (user_input||'').slice(0,30);
      return {
        segments: [{
          type: pickType,
          camera: step===0 ? 'ç‰¹å¯«ä¸»è§’è‡‰éƒ¨ï¼Œç‡ˆå…‰å¾å³å´æ‰“å…¥ï¼Œèšç„¦çœ¼ç¥ã€‚'
                           : step===1 ? 'åŠèº«è·Ÿæ‹ï¼Œç§»è‡³æ¡Œé¢ï¼Œå¿«é€Ÿæ¨è¿‘ç”¢å“ã€‚'
                           : 'é æ™¯æ”¶å°¾ï¼Œä¸»è§’èƒŒå°å¤œæ™¯ï¼Œé¡é ­ç·©æ…¢æ‹‰é ã€‚',
          dialog: step===0 ? `ä½ æ˜¯å¦ä¹Ÿæ›¾é€™æ¨£æƒ³éï¼Ÿ${short} â€”â€” ç”¨ 30 ç§’æ”¹è®Šä½ çš„çœ‹æ³•ã€‚`
                           : step===1 ? `æŠŠé›£çš„è®Šç°¡å–®ã€‚${short}ï¼Œç¾åœ¨å°±é–‹å§‹ã€‚`
                           : `è¡Œå‹•æ°¸é æ¯”ç­‰å¾…é‡è¦ã€‚ç¾åœ¨ï¼Œè¼ªåˆ°ä½ äº†ã€‚`,
          visual: step===0 ? 'å­—å¹•å½ˆå…¥ï¼š#åŠ ç­ä¹Ÿèƒ½å¥èº«ï¼›LOGO æ·¡å…¥ã€‚'
                           : step===1 ? 'å¿«åˆ‡ B-rollï¼šéµç›¤ã€å®šæ™‚å™¨ã€æ¯ä¸­å†°å¡Šï¼›ç¯€å¥å°é½Šæ‹é»ã€‚'
                           : 'LOGO æ”¶åˆã€CTA å¡ç‰‡æ»‘å…¥ï¼ˆå·¦ä¸‹ï¼‰ã€‚'
        }],
        error: null
      };
    }

    // åˆå§‹æ¸²æŸ“
    renderTimeline();
    renderCards([]);
  </script>
</body>
</html>

