<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI æ–‡æ¡ˆï¼è…³æœ¬åŠ©æ‰‹ Â· ä¿®æ­£ç‰ˆ</title>
  <style>
    :root{
      --bg:#ffffff;--surface:#ffffff;--surface-2:#fafafa;--border:#e6e6ea;
      --text:#1f2328;--muted:#666a70;--primary:#f6c744;--primary-600:#e7b000;
      --primary-100:#fff7d6;--accent:#111827;--radius:16px;--shadow:0 6px 18px rgba(0,0,0,.06);
      --focus:0 0 0 3px rgba(246,199,68,.35);
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
      font-family:"Noto Sans TC",system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";}
    *{box-sizing:border-box} img,video{max-width:100%;height:auto}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:40px;height:40px;border-radius:12px;background:radial-gradient(circle at 30% 30%, #fff6d3, #f6c744 40%, #b48600 100%);box-shadow:inset 0 0 10px rgba(255,255,255,.6),0 1px 0 rgba(0,0,0,.05)}
    h1{font-size:20px;margin:0}.muted{color:var(--muted);font-size:13px}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{background:linear-gradient(180deg,#ffe08b 0%,var(--primary) 60%,var(--primary-600) 100%);color:#2b2100;border:none;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:700;box-shadow:0 6px 16px rgba(246,199,68,.28);transition:transform .06s ease;min-height:44px}
    .btn:hover{transform:translateY(-1px)} .btn:focus{outline:none;box-shadow:var(--focus)}
    .btn.btn-block{width:100%} .btn-outline{background:#fff;border:1px solid var(--border);color:#151515;box-shadow:none}
    input[type="text"],textarea,select{width:100%;background:#fff;border:1px solid var(--border);color:var(--text);border-radius:12px;padding:12px;font-size:16px;outline:none;min-height:44px}
    input:focus,textarea:focus,select:focus{box-shadow:var(--focus)}
    textarea{min-height:100px;resize:vertical}
    .chat{min-height:380px;max-height:60vh;overflow:auto;background:#fff;border:1px solid var(--border);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:8px}
    .bubble{max-width:80%;padding:12px 14px;border-radius:14px;line-height:1.7;box-shadow:0 1px 6px rgba(0,0,0,.06);white-space:pre-wrap;word-break:break-word;border:1px solid var(--border)}
    .ai{align-self:flex-start;background:#fff}
    .me{align-self:flex-end;background:#fff7c6}
    .loading{display:none;gap:8px;align-items:center;color:#6b4d00;margin-top:8px}
    .loading.on{display:flex}
    .dot{width:6px;height:6px;border-radius:50%;background:#e2b100;animation:blink 1s infinite ease-in-out}
    .dot:nth-child(2){animation-delay:.15s}.dot:nth-child(3){animation-delay:.3s}
    @keyframes blink{0%,80%,100%{opacity:.25}40%{opacity:1}}
    @media (max-width:960px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>AI æ–‡æ¡ˆ / è…³æœ¬åŠ©æ‰‹ Â· ä¿®æ­£ç‰ˆ</h1>
          <div class="muted">RWDã€é€¾æ™‚/é‡è©¦ã€éŒ¯èª¤æç¤ºçš†å·²ä¿®æ­£</div>
        </div>
      </div>
      <div class="row" role="group" aria-label="ä½¿ç”¨è€…ç­‰ç´š">
        <label class="muted" for="userLevel">ä½¿ç”¨è€…ç­‰ç´š</label>
        <select id="userLevel" aria-label="ä½¿ç”¨è€…ç­‰ç´šé¸å–®">
          <option value="beginner">åˆå­¸è€…</option>
          <option value="intermediate">ä¸­ç´šç”¨æˆ¶</option>
          <option value="advanced">é€²éšç”¨æˆ¶</option>
        </select>
      </div>
    </header>

    <div class="grid">
      <section class="card" aria-label="å‰µä½œé¢æ¿">
        <h2 style="margin:4px 0 12px">å‰µä½œé¢æ¿</h2>
        <div class="row">
          <input id="topic" type="text" placeholder="è¼¸å…¥ä¸»é¡Œï¼ˆä¾‹ï¼šæ–°å“ä¸Šå¸‚å»£å‘Šã€å“ç‰Œæ•…äº‹ã€30ç§’çŸ­å½±ç‰‡æ¨å»£ï¼‰" aria-label="ä¸»é¡Œè¼¸å…¥"/>
        </div>
        <div class="row">
          <textarea id="notes" placeholder="ï¼ˆé¸å¡«ï¼‰è£œå……é‡é»ã€ç”¢å“ç‰¹é»ã€ç›®æ¨™æ—ç¾¤ã€èªæ°£åå¥½â‹¯â‹¯" aria-label="å‚™è¨»è¼¸å…¥"></textarea>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="sendBtn">é€å‡º</button>
          <button class="btn btn-outline" id="exportBtn">ğŸ’¾ å°å‡ºæ–‡æ¡ˆ</button>
        </div>
      </section>

      <section class="card" aria-label="äº’å‹•å€">
        <h2 style="margin:4px 0 12px">äº’å‹•å°è©±</h2>
        <div id="chat" class="chat" aria-live="polite">
          <div class="bubble ai">å—¨ğŸ‘‹ æ­¡è¿ä¾†åˆ°ä½ çš„çŸ­å½±ç‰‡å‰µä½œåŠ©æ‰‹ï½ èªªå€‹æ–¹å‘æˆ–æƒ³å‚³é”çš„æƒ…ç·’ï¼Œæˆ‘å°±å¹«ä½ æ§‹å‡ºå®Œæ•´ç¯€å¥ã€‚</div>
        </div>
        <div class="row" style="margin-top:8px">
          <input id="chatInput" type="text" placeholder="è¼¸å…¥ä½ çš„æƒ³æ³•æˆ–å›è¦†ï¼ŒæŒ‰ Enter é€å‡º"/>
        </div>
        <div class="loading" id="loading"><span class="dot"></span><span class="dot"></span><span class="dot"></span> æ­£åœ¨æ€è€ƒâ€¦</div>
      </section>
    </div>
  </div>

<script>
// ====== ä½ å¯ä»¥æ”¹æˆè‡ªå·±çš„å¾Œç«¯ç«¯é» ======
const apiEndpoint = "https://aijobvideobackend.zeabur.app/generate";

// ====== å°å·¥å…·èˆ‡å…¨åŸŸç‹€æ…‹ ======
const $ = (sel)=>document.querySelector(sel);
const byId = (id)=>document.getElementById(id);
const userId = (()=>{ const key="aijob_user_id"; let v=localStorage.getItem(key); if(!v){ v='u_'+Math.random().toString(36).slice(2); localStorage.setItem(key,v);} return v; })();
let messages = [];
let lastAiDraft = "";
let chatLock = false;

function appendAi(text){ const el=document.createElement("div"); el.className="bubble ai"; el.textContent=text; byId("chat").appendChild(el); byId("chat").scrollTop=byId("chat").scrollHeight; }
function appendMe(text){ const el=document.createElement("div"); el.className="bubble me"; el.textContent=text; byId("chat").appendChild(el); byId("chat").scrollTop=byId("chat").scrollHeight; }
function showLoading(on){ byId("loading").classList.toggle("on", !!on); }

// ====== é€¾æ™‚èˆ‡é‡è©¦ï¼ˆå®Œæ•´ä¿®æ­£ç‰ˆæœ¬ï¼‰ ======
async function fetchWithTimeout(url, opt={}, timeoutMs=30000){
  if (window.AbortSignal && AbortSignal.timeout) {
    opt.signal = AbortSignal.timeout(timeoutMs);
    return fetch(url, opt);
  }
  const ctrl = new AbortController();
  const to = setTimeout(()=>ctrl.abort(), timeoutMs);
  opt.signal = ctrl.signal;
  try { return await fetch(url, opt); } finally { clearTimeout(to); }
}

// ä¾ç­‰ç´šæ±ºå®šé€¾æ™‚ï¼ˆbeginner 30s / intermediate 45s / advanced 60sï¼‰
function levelTimeoutMs(level){
  if (level === "advanced") return 60000;
  if (level === "intermediate") return 45000;
  return 30000;
}

// å…·é€€é¿é‡è©¦çš„å‘¼å«ï¼ˆæœ€å¤š 3 æ¬¡ï¼›1.0s, 2.0s é€€é¿ï¼‰
async function callApiWithRetry(payload, baseTimeoutMs){
  let lastErr;
  for (let attempt=1; attempt<=3; attempt++){
    const timeout = baseTimeoutMs + (attempt-1)*3000; // ç¬¬2/3æ¬¡å†å„+3ç§’ä¿éšª
    try{
      const res = await fetchWithTimeout(apiEndpoint, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload),
        mode: "cors",
        credentials: "omit"
      }, timeout);

      const raw = await res.text();
      let data = null;
      try{ data = JSON.parse(raw); }catch{}
      if (!res.ok){
        const msg = (data && (data.error || data.message || data.msg)) || raw || `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return data || { message:{ content: raw } };
    }catch(err){
      lastErr = err;
      const isAbortOrTimeout = err?.name === "AbortError" || /aborted|timeout/i.test(String(err));
      if (attempt < 3 && isAbortOrTimeout){
        // æŒ‡æ•¸é€€é¿ï¼š1s -> 2s
        await new Promise(r=>setTimeout(r, 1000 * Math.pow(2, attempt-1)));
        continue;
      }
      throw err;
    }
  }
  throw lastErr;
}

// ====== ç™¼é€é‚è¼¯ï¼ˆå¥—ç”¨ç­‰ç´šé€¾æ™‚ï¼‹é‡è©¦ï¼‰ ======
async function sendMessage(){
  if(chatLock) return;
  const input=byId("chatInput");
  const text=(input.value||"").trim();
  if(!text) return;
  if(text.length>300){ alert("è¼¸å…¥å…§å®¹éé•·ï¼Œè«‹ç°¡åŒ–å¾Œå†è©¦ã€‚"); return; }

  input.value="";
  appendMe(text);
  chatLock=true;
  showLoading(true);

  const level = byId("userLevel").value;
  const payload = {
    user_id: userId,
    user_level: level,
    topic: byId("topic").value.trim() || "ä¸€èˆ¬ä¸»é¡Œ",
    action: "copywriting",
    notes: byId("notes") ? byId("notes").value.trim() : "",
    messages
  };

  try{
    const data = await callApiWithRetry(payload, levelTimeoutMs(level));
    const ai = data?.message?.content ?? data?.message?.text ?? data?.reply ?? "ï¼ˆç„¡å›æ‡‰å…§å®¹ï¼‰";
    messages.push({ role:"assistant", content: ai });
    appendAi(ai);
    if(ai && ai.length>10) lastAiDraft = ai;
  }catch(err){
    let msg = String(err?.message || err);
    if (err?.name === "AbortError" || /aborted|timeout/i.test(msg)){
      msg = "é€£ç·šé€¾æ™‚æˆ–è¢«ä¸­æ–·ï¼ˆå¯èƒ½æ˜¯å†·å•Ÿå‹•ï¼å›æ‡‰è¼ƒé•·ï¼‰ã€‚";
    }
    appendAi("âš ï¸ æœå‹™å»¶é²æˆ–é€£ç·šè¢«ä¸­æ–·ï¼š" + msg);
    console.error(err);
  }finally{
    showLoading(false);
    chatLock=false;
  }
}

// ====== åŒ¯å‡ºç‚º RTFï¼ˆå¯ç›´æ¥é–‹å•Ÿæˆ Wordï¼‰ ======
function exportWord(){
  let content=(lastAiDraft || messages.filter(m=>m.role==="assistant").map(m=>m.content).join("\\n\\n") || "").trim();
  if(!content){ alert("ç›®å‰æ²’æœ‰å¯å°å‡ºçš„AIç”Ÿæˆå…§å®¹"); return; }
  const esc=s=>String(s).replace(/\\/g,'\\\\').replace(/{/g,'\\{').replace(/}/g,'\\}').replace(/\\n/g,'\\par ');
  const title="çŸ­å½±ç‰‡æ–‡æ¡ˆè‰ç¨¿"; const topic=(byId("topic").value.trim()||"æœªå‘½å").replace(/[\\/:*?\"<>|]+/g,"_");
  const rtf=`{\\rtf1\\ansi\\deff0
{\\fonttbl{\\f0 Arial;}{\\f1 Microsoft JhengHei;}}
\\fs44 \\b ${esc(title)} \\b0\\par
\\fs24 \\b ä¸»é¡Œï¼š\\b0 ${esc(topic)}\\par
\\par
${esc(content)}
}`;
  const blob=new Blob([rtf],{type:"application/rtf"});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`çŸ­å½±ç‰‡æ–‡æ¡ˆ_${topic}.doc`; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 800);
}

// ====== ç¶å®šäº‹ä»¶ ======
byId("sendBtn").addEventListener("click", sendMessage);
byId("chatInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); }});
byId("exportBtn").addEventListener("click", exportWord);
</script>
</body>
</html>
