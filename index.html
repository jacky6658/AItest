<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI 文案／腳本助手 · 修正版</title>
  <style>
    :root{
      --bg:#ffffff;--surface:#ffffff;--surface-2:#fafafa;--border:#e6e6ea;
      --text:#1f2328;--muted:#666a70;--primary:#f6c744;--primary-600:#e7b000;
      --primary-100:#fff7d6;--accent:#111827;--radius:16px;--shadow:0 6px 18px rgba(0,0,0,.06);
      --focus:0 0 0 3px rgba(246,199,68,.35);
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
      font-family:"Noto Sans TC",system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";}
    *{box-sizing:border-box} img,video{max-width:100%;height:auto}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:40px;height:40px;border-radius:12px;background:radial-gradient(circle at 30% 30%, #fff6d3, #f6c744 40%, #b48600 100%);box-shadow:inset 0 0 10px rgba(255,255,255,.6),0 1px 0 rgba(0,0,0,.05)}
    h1{font-size:20px;margin:0}.muted{color:var(--muted);font-size:13px}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{background:linear-gradient(180deg,#ffe08b 0%,var(--primary) 60%,var(--primary-600) 100%);color:#2b2100;border:none;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:700;box-shadow:0 6px 16px rgba(246,199,68,.28);transition:transform .06s ease;min-height:44px}
    .btn:hover{transform:translateY(-1px)} .btn:focus{outline:none;box-shadow:var(--focus)}
    .btn.btn-block{width:100%} .btn-outline{background:#fff;border:1px solid var(--border);color:#151515;box-shadow:none}
    input[type="text"],textarea,select{width:100%;background:#fff;border:1px solid var(--border);color:var(--text);border-radius:12px;padding:12px;font-size:16px;outline:none;min-height:44px}
    input:focus,textarea:focus,select:focus{box-shadow:var(--focus)}
    textarea{min-height:100px;resize:vertical}
    .chat{min-height:380px;max-height:60vh;overflow:auto;background:#fff;border:1px solid var(--border);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:8px}
    .bubble{max-width:80%;padding:12px 14px;border-radius:14px;line-height:1.7;box-shadow:0 1px 6px rgba(0,0,0,.06);white-space:pre-wrap;word-break:break-word;border:1px solid var(--border)}
    .ai{align-self:flex-start;background:#fff}
    .me{align-self:flex-end;background:#fff7c6}
    .loading{display:none;gap:8px;align-items:center;color:#6b4d00;margin-top:8px}
    .loading.on{display:flex}
    .dot{width:6px;height:6px;border-radius:50%;background:#e2b100;animation:blink 1s infinite ease-in-out}
    .dot:nth-child(2){animation-delay:.15s}.dot:nth-child(3){animation-delay:.3s}
    @keyframes blink{0%,80%,100%{opacity:.25}40%{opacity:1}}
    @media (max-width:960px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>AI 文案 / 腳本助手 · 修正版</h1>
          <div class="muted">RWD、逾時/重試、錯誤提示皆已修正</div>
        </div>
      </div>
      <div class="row" role="group" aria-label="使用者等級">
        <label class="muted" for="userLevel">使用者等級</label>
        <select id="userLevel" aria-label="使用者等級選單">
          <option value="beginner">初學者</option>
          <option value="intermediate">中級用戶</option>
          <option value="advanced">進階用戶</option>
        </select>
      </div>
    </header>

    <div class="grid">
      <section class="card" aria-label="創作面板">
        <h2 style="margin:4px 0 12px">創作面板</h2>
        <div class="row">
          <input id="topic" type="text" placeholder="輸入主題（例：新品上市廣告、品牌故事、30秒短影片推廣）" aria-label="主題輸入"/>
        </div>
        <div class="row">
          <textarea id="notes" placeholder="（選填）補充重點、產品特點、目標族群、語氣偏好⋯⋯" aria-label="備註輸入"></textarea>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="sendBtn">送出</button>
          <button class="btn btn-outline" id="exportBtn">💾 導出文案</button>
        </div>
      </section>

      <section class="card" aria-label="互動區">
        <h2 style="margin:4px 0 12px">互動對話</h2>
        <div id="chat" class="chat" aria-live="polite">
          <div class="bubble ai">嗨👋 歡迎來到你的短影片創作助手～ 說個方向或想傳達的情緒，我就幫你構出完整節奏。</div>
        </div>
        <div class="row" style="margin-top:8px">
          <input id="chatInput" type="text" placeholder="輸入你的想法或回覆，按 Enter 送出"/>
        </div>
        <div class="loading" id="loading"><span class="dot"></span><span class="dot"></span><span class="dot"></span> 正在思考…</div>
      </section>
    </div>
  </div>

<script>
// ====== 你可以改成自己的後端端點 ======
const apiEndpoint = "https://aijobvideobackend.zeabur.app/generate";

// ====== 小工具與全域狀態 ======
const $ = (sel)=>document.querySelector(sel);
const byId = (id)=>document.getElementById(id);
const userId = (()=>{ const key="aijob_user_id"; let v=localStorage.getItem(key); if(!v){ v='u_'+Math.random().toString(36).slice(2); localStorage.setItem(key,v);} return v; })();
let messages = [];
let lastAiDraft = "";
let chatLock = false;

function appendAi(text){ const el=document.createElement("div"); el.className="bubble ai"; el.textContent=text; byId("chat").appendChild(el); byId("chat").scrollTop=byId("chat").scrollHeight; }
function appendMe(text){ const el=document.createElement("div"); el.className="bubble me"; el.textContent=text; byId("chat").appendChild(el); byId("chat").scrollTop=byId("chat").scrollHeight; }
function showLoading(on){ byId("loading").classList.toggle("on", !!on); }

// ====== 逾時與重試（完整修正版本） ======
async function fetchWithTimeout(url, opt={}, timeoutMs=30000){
  if (window.AbortSignal && AbortSignal.timeout) {
    opt.signal = AbortSignal.timeout(timeoutMs);
    return fetch(url, opt);
  }
  const ctrl = new AbortController();
  const to = setTimeout(()=>ctrl.abort(), timeoutMs);
  opt.signal = ctrl.signal;
  try { return await fetch(url, opt); } finally { clearTimeout(to); }
}

// 依等級決定逾時（beginner 30s / intermediate 45s / advanced 60s）
function levelTimeoutMs(level){
  if (level === "advanced") return 60000;
  if (level === "intermediate") return 45000;
  return 30000;
}

// 具退避重試的呼叫（最多 3 次；1.0s, 2.0s 退避）
async function callApiWithRetry(payload, baseTimeoutMs){
  let lastErr;
  for (let attempt=1; attempt<=3; attempt++){
    const timeout = baseTimeoutMs + (attempt-1)*3000; // 第2/3次再各+3秒保險
    try{
      const res = await fetchWithTimeout(apiEndpoint, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload),
        mode: "cors",
        credentials: "omit"
      }, timeout);

      const raw = await res.text();
      let data = null;
      try{ data = JSON.parse(raw); }catch{}
      if (!res.ok){
        const msg = (data && (data.error || data.message || data.msg)) || raw || `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return data || { message:{ content: raw } };
    }catch(err){
      lastErr = err;
      const isAbortOrTimeout = err?.name === "AbortError" || /aborted|timeout/i.test(String(err));
      if (attempt < 3 && isAbortOrTimeout){
        // 指數退避：1s -> 2s
        await new Promise(r=>setTimeout(r, 1000 * Math.pow(2, attempt-1)));
        continue;
      }
      throw err;
    }
  }
  throw lastErr;
}

// ====== 發送邏輯（套用等級逾時＋重試） ======
async function sendMessage(){
  if(chatLock) return;
  const input=byId("chatInput");
  const text=(input.value||"").trim();
  if(!text) return;
  if(text.length>300){ alert("輸入內容過長，請簡化後再試。"); return; }

  input.value="";
  appendMe(text);
  chatLock=true;
  showLoading(true);

  const level = byId("userLevel").value;
  const payload = {
    user_id: userId,
    user_level: level,
    topic: byId("topic").value.trim() || "一般主題",
    action: "copywriting",
    notes: byId("notes") ? byId("notes").value.trim() : "",
    messages
  };

  try{
    const data = await callApiWithRetry(payload, levelTimeoutMs(level));
    const ai = data?.message?.content ?? data?.message?.text ?? data?.reply ?? "（無回應內容）";
    messages.push({ role:"assistant", content: ai });
    appendAi(ai);
    if(ai && ai.length>10) lastAiDraft = ai;
  }catch(err){
    let msg = String(err?.message || err);
    if (err?.name === "AbortError" || /aborted|timeout/i.test(msg)){
      msg = "連線逾時或被中斷（可能是冷啟動／回應較長）。";
    }
    appendAi("⚠️ 服務延遲或連線被中斷：" + msg);
    console.error(err);
  }finally{
    showLoading(false);
    chatLock=false;
  }
}

// ====== 匯出為 RTF（可直接開啟成 Word） ======
function exportWord(){
  let content=(lastAiDraft || messages.filter(m=>m.role==="assistant").map(m=>m.content).join("\\n\\n") || "").trim();
  if(!content){ alert("目前沒有可導出的AI生成內容"); return; }
  const esc=s=>String(s).replace(/\\/g,'\\\\').replace(/{/g,'\\{').replace(/}/g,'\\}').replace(/\\n/g,'\\par ');
  const title="短影片文案草稿"; const topic=(byId("topic").value.trim()||"未命名").replace(/[\\/:*?\"<>|]+/g,"_");
  const rtf=`{\\rtf1\\ansi\\deff0
{\\fonttbl{\\f0 Arial;}{\\f1 Microsoft JhengHei;}}
\\fs44 \\b ${esc(title)} \\b0\\par
\\fs24 \\b 主題：\\b0 ${esc(topic)}\\par
\\par
${esc(content)}
}`;
  const blob=new Blob([rtf],{type:"application/rtf"});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`短影片文案_${topic}.doc`; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 800);
}

// ====== 綁定事件 ======
byId("sendBtn").addEventListener("click", sendMessage);
byId("chatInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); }});
byId("exportBtn").addEventListener("click", exportWord);
</script>
</body>
</html>
