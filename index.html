<!DOCTYPE html>
<html lang="zh-TW" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>AIJob短影音顧問智能</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Noto Sans TC', 'sans-serif'],
                    },
                    colors: {
                        primary: '#2563EB',
                        'primary-hover': '#1D4ED8',
                        secondary: '#16A34A',
                    }
                }
            }
        }
    </script>
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        /* iOS Safari 字體縮放與輸入框自動放大修正 */
        html { -webkit-text-size-adjust: 100%; }
        @media (max-width: 480px) {
          input, textarea, select { font-size: 16px !important; }
        }
        .btn-chip {
            padding: 6px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 9999px;
            background: #fff;
            color: #374151;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 13px;
            font-weight: 500;
        }
        .btn-chip:hover {
            border-color: #3b82f6;
            color: #3b82f6;
            background: #f8fafc;
        }
        .dark .btn-chip {
            background: #374151;
            color: #d1d5db;
            border-color: #4b5563;
        }
        .dark .btn-chip:hover {
            border-color: #3b82f6;
            color: #3b82f6;
            background: #1f2937;
        }
    </style>
</head>
<body class="font-sans bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-150">
    <!-- Toast 容器 -->
    <div id="toast-container" class="fixed inset-0 z-50 flex flex-col items-center justify-center gap-3 pointer-events-none"></div>

    <!-- 頂部導覽列 -->
    <nav class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16 relative">
                <!-- Logo -->
                <div class="flex items-center">
                    <a href="#!home" class="focus:outline-none" data-page="home">
                        <h1 class="font-bold text-primary dark:text-white text-lg sm:text-xl md:text-2xl leading-tight">AIJob短影音顧問智能</h1>
                    </a>
                </div>
                
                <!-- 導覽連結 -->
                <div class="hidden md:flex space-x-8" id="nav-links">
                    <a href="#!home" class="nav-link text-gray-700 dark:text-gray-300 hover:text-primary transition-colors duration-150" data-page="home">首頁</a>
                    <a href="#!positioning" class="nav-link text-gray-700 dark:text-gray-300 hover:text-primary transition-colors duration-150" data-page="positioning">AI短影音定位顧問</a>
                    <a href="#!ideation" class="nav-link text-gray-700 dark:text-gray-300 hover:text-primary transition-colors duration-150" data-page="ideation">AI選題小助手</a>
                    <a href="#!script" class="nav-link text-gray-700 dark:text-gray-300 hover:text-primary transition-colors duration-150" data-page="script">AI腳本生成大師</a>
                    <a href="#!guide" class="nav-link text-gray-700 dark:text-gray-300 hover:text-primary transition-colors duration-150" data-page="guide">說明/指南</a>
                </div>

                <!-- 右側按鈕群 -->
                <div class="flex items-center space-x-2 md:space-x-4">
                    <!-- 手機選單 -->
                    <button id="mobile-menu-btn" class="md:hidden p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary" aria-label="開啟選單">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                    </button>
                    <!-- 暗色模式切換 -->
                    <button id="theme-toggle" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-gray-800" aria-label="切換暗色模式">
                        <svg id="theme-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path id="sun-icon" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                            <path id="moon-icon" class="hidden" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                        </svg>
                    </button>
                    
                    <!-- Credits 顯示（登入後才顯示） -->
                    <div id="nav-credits-wrap" class="hidden items-center text-sm text-gray-500 dark:text-gray-400">
                        <span>Credits: <span id="nav-credits">0</span></span>
                    </div>
                    
                    <!-- 登入按鈕（最右側） -->
                    <div class="relative">
                        <button id="login-btn" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                            登入
                        </button>
                        <!-- 登入後的下拉選單 -->
                        <div id="user-dropdown" class="absolute right-0 top-full mt-2 w-64 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg hidden z-50">
                            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-orange-500 rounded-full flex items-center justify-center text-white font-semibold">
                                        <span id="user-avatar">G</span>
                                    </div>
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900 dark:text-white" id="user-name">Google 用戶</div>
                                        <div class="text-sm text-gray-500 dark:text-gray-400" id="user-email">user@gmail.com</div>
                                    </div>
                                    <button class="text-gray-400 hover:text-gray-600">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="p-2">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">免費</span>
                                    <button class="bg-black text-white text-xs px-3 py-1 rounded">升級</button>
                                </div>
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center space-x-2">
                                        <svg class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                        </svg>
                                        <span class="text-sm text-gray-600 dark:text-gray-400">點數</span>
                                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <div class="flex items-center space-x-1">
                                        <span class="text-sm font-semibold">300</span>
                                        <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div class="space-y-1">
                                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                        </svg>
                                        <span>知識</span>
                                    </a>
                                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                        <span>帳戶</span>
                                    </a>
                                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                        <span>設定</span>
                                    </a>
                                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                                        </svg>
                                        <span>首頁</span>
                                        <svg class="w-3 h-3 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                        </svg>
                                    </a>
                                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span>獲取幫助</span>
                                        <svg class="w-3 h-3 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                        </svg>
                                    </a>
                                </div>
                                <div class="border-t border-gray-200 dark:border-gray-700 mt-2 pt-2">
                                    <button id="logout-btn" class="flex items-center space-x-3 px-3 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-gray-700 rounded w-full">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                        </svg>
                                        <span>登出</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 手機下拉選單 -->
            <div id="mobile-menu" class="md:hidden hidden border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
                <div class="px-4 py-3 space-y-2">
                    <a href="#!home" class="block nav-link text-gray-700 dark:text-gray-300 hover:text-primary transition-colors duration-150" data-page="home">首頁</a>
                    <a href="#!positioning" class="block nav-link text-gray-700 dark:text-gray-300 hover:text-primary transition-colors duration-150" data-page="positioning">AI短影音定位顧問</a>
                    <a href="#!ideation" class="block nav-link text-gray-700 dark:text-gray-300 hover:text-primary transition-colors duration-150" data-page="ideation">AI選題小助手</a>
                    <a href="#!script" class="block nav-link text-gray-700 dark:text-gray-300 hover:text-primary transition-colors duration-150" data-page="script">AI腳本生成大師</a>
                    <a href="#!guide" class="block nav-link text-gray-700 dark:text-gray-300 hover:text-primary transition-colors duration-150" data-page="guide">說明/指南</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- 帳號側邊抽屜（登入後） -->
    <div id="drawer-overlay" class="fixed inset-0 bg-black/40 hidden z-40"></div>
    <aside id="account-drawer" class="fixed right-0 top-0 h-full w-80 bg-white dark:bg-gray-800 border-l border-gray-200 dark:border-gray-700 transform translate-x-full transition-transform duration-200 z-50">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div id="acc-avatar" class="w-10 h-10 rounded-full bg-orange-500 text-white flex items-center justify-center font-semibold">A</div>
                <div>
                    <div id="acc-name" class="font-semibold text-gray-900 dark:text-white">使用者</div>
                    <div id="acc-email" class="text-sm text-gray-500 dark:text-gray-400">user@email.com</div>
                </div>
            </div>
            <button id="drawer-close" class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700" aria-label="關閉">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>
        <div class="p-4 space-y-4">
            <div class="flex items-center justify-between">
                <span id="acc-plan" class="text-sm px-2 py-1 rounded bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">免費</span>
                <button id="acc-upgrade" class="px-3 py-1 text-xs bg-black text-white rounded">升級</button>
            </div>
            <div class="flex items-center justify-between text-sm text-gray-600 dark:text-gray-400">
                <span>點數</span>
                <span id="acc-credits" class="font-semibold">300</span>
            </div>
            <nav class="pt-2 space-y-1 text-gray-700 dark:text-gray-300">
                <a href="#" class="flex items-center justify-between px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700">
                    <span>知識</span>
                </a>
                <a href="#" class="flex items-center justify-between px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700">
                    <span>帳戶</span>
                </a>
                <a href="#" class="flex items-center justify-between px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700">
                    <span>設定</span>
                </a>
                <a href="#!home" class="flex items-center justify-between px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700">
                    <span>首頁</span>
                </a>
                <a href="#" class="flex items-center justify-between px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700">
                    <span>獲取幫助</span>
                </a>
            </nav>
        </div>
        <div class="mt-auto p-4 border-t border-gray-200 dark:border-gray-700">
            <button id="drawer-logout-btn" class="w-full flex items-center justify-center gap-2 px-4 py-2 rounded bg-red-50 text-red-600 hover:bg-red-100 dark:bg-gray-700 dark:text-red-400">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                登出
            </button>
        </div>
    </aside>


    <!-- Email 登入/註冊 全畫面頁（新） -->
    <div id="email-auth-page" class="fixed inset-0 hidden z-50">
        <div class="absolute inset-0 bg-gray-900/60"></div>
        <div class="absolute inset-0 flex items-center justify-center p-3 sm:p-4">
            <div class="w-full max-w-2xl bg-white dark:bg-gray-800 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                <div class="flex items-center justify-between px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center gap-3">
                        <h3 class="text-lg font-semibold">Email 登入 / 註冊</h3>
                        <span class="text-xs px-2 py-1 rounded bg-primary text-white">Beta</span>
                    </div>
                    <button id="email-auth-close" class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700" aria-label="關閉">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2">
                    <!-- 左：登入 -->
                    <div class="p-4 sm:p-6 border-b md:border-b-0 md:border-r border-gray-200 dark:border-gray-700">
                        <div class="mb-4">
                            <h4 class="font-semibold mb-1">已有帳號？登入</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">輸入 Email 或 帳號 與密碼登入。</p>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm mb-1">Email 或 帳號</label>
                                <input id="login-identifier" type="text" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700" placeholder="you@example.com 或 yourname"/>
                            </div>
                            <div>
                                <label class="block text-sm mb-1">密碼</label>
                                <div class="flex items-center gap-2">
                                    <input id="login-password" type="password" class="flex-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700" placeholder="********"/>
                                    <button id="toggle-login-pw" type="button" class="px-2 py-2 rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700" aria-label="顯示/隱藏密碼">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8Z"/><circle cx="12" cy="12" r="3"/></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="pt-2 flex flex-wrap items-center justify-end gap-2">
                                <button id="btn-email-login" class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-primary-hover w-full sm:w-auto">登入</button>
                            </div>
                            <div class="flex items-center gap-3 pt-3">
                                <div class="h-px bg-gray-200 dark:bg-gray-700 flex-1"></div>
                                <span class="text-xs text-gray-500">或</span>
                                <div class="h-px bg-gray-200 dark:bg-gray-700 flex-1"></div>
                            </div>
                            <button id="btn-google-login" class="mt-2 w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center justify-center gap-2">
                                <span>使用 Google 登入</span>
                            </button>
                        </div>
                    </div>
                    <!-- 右：註冊 -->
                    <div class="p-4 sm:p-6">
                        <div class="mb-4">
                            <h4 class="font-semibold mb-1">沒有帳號？註冊</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">建立帳號需填寫電話、Email、帳號與密碼。</p>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm mb-1">電話</label>
                                <input id="signup-phone" type="tel" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700" placeholder="09xx-xxx-xxx"/>
                            </div>
                            <div>
                                <label class="block text-sm mb-1">Email</label>
                                <input id="signup-email" type="email" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700" placeholder="you@example.com"/>
                            </div>
                            <div>
                                <label class="block text-sm mb-1">帳號</label>
                                <input id="signup-username" type="text" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700" placeholder="yourname"/>
                            </div>
                            <div>
                                <label class="block text-sm mb-1">密碼</label>
                                <div class="flex items-center gap-2">
                                    <input id="signup-password" type="password" class="flex-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700" placeholder="********"/>
                                    <button id="toggle-signup-pw" type="button" class="px-2 py-2 rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700" aria-label="顯示/隱藏密碼">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8Z"/><circle cx="12" cy="12" r="3"/></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="pt-2 flex flex-wrap items-center justify-end gap-2">
                                <button id="btn-email-signup" class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 w-full sm:w-auto">建立帳號</button>
                            </div>
                            <div class="flex items-center gap-3 pt-3">
                                <div class="h-px bg-gray-200 dark:bg-gray-700 flex-1"></div>
                                <span class="text-xs text-gray-500">或</span>
                                <div class="h-px bg-gray-200 dark:bg-gray-700 flex-1"></div>
                            </div>
                            <button id="btn-google-signup" class="mt-2 w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center justify-center gap-2">
                                <span>使用 Google 註冊</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 主要內容區域 -->
    <main class="min-h-screen bg-gray-50 dark:bg-gray-900">
        <!-- 首頁 -->
        <div id="page-home" class="page hidden">
            <!-- Hero 區 -->
            <section class="bg-gradient-to-br from-primary to-primary-hover text-white py-20">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                    <h2 class="text-4xl md:text-6xl font-bold mb-6">內容創作，從此簡單</h2>
                    <p class="text-xl md:text-2xl mb-8 opacity-90">三款專業工具，助您打造優質內容</p>
                </div>
            </section>

            <!-- 工具卡片區 -->
            <section class="py-16">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="grid md:grid-cols-3 gap-8">
                        <!-- 定位助手卡片 -->
                        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 hover:shadow-xl transition-all duration-150 active:scale-95">
                            <div class="text-4xl mb-4">🎯</div>
                            <h3 class="text-2xl font-bold mb-4">AI短影音定位顧問</h3>
                            <p class="text-gray-600 dark:text-gray-400 mb-6">透過引導式問答，幫您找到最適合的品牌定位與語氣風格</p>
                            <a href="#!positioning" class="block w-full bg-primary text-white text-center py-3 px-6 rounded-lg hover:bg-primary-hover transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                                開始使用
                            </a>
                        </div>

                        <!-- 選題助手卡片 -->
                        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 hover:shadow-xl transition-all duration-150 active:scale-95">
                            <div class="text-4xl mb-4">💡</div>
                            <h3 class="text-2xl font-bold mb-4">AI選題小助手</h3>
                            <p class="text-gray-600 dark:text-gray-400 mb-6">輸入主題關鍵字，自動產生多個吸睛的內容角度與切入點</p>
                            <a href="#!ideation" class="block w-full bg-primary text-white text-center py-3 px-6 rounded-lg hover:bg-primary-hover transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                                開始使用
                            </a>
                        </div>

                        <!-- 腳本生成器卡片 -->
                        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 hover:shadow-xl transition-all duration-150 active:scale-95">
                            <div class="text-4xl mb-4">📝</div>
                            <h3 class="text-2xl font-bold mb-4">AI腳本生成大師</h3>
                            <p class="text-gray-600 dark:text-gray-400 mb-6">多種模板與時長選擇，快速生成專業的內容腳本</p>
                            <a href="#!script" class="block w-full bg-primary text-white text-center py-3 px-6 rounded-lg hover:bg-primary-hover transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                                開始使用
                            </a>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- 客製化智能體 CTA -->
            <section class="pt-0 pb-8">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8">
                        <h3 class="text-2xl font-bold mb-2">想要客製化您的短影音 AI 智能體嗎？</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">需要專屬功能、品牌語氣、整合後端或流程自動化？我們可協助從規劃到上線。</p>
                        <a class="inline-block bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary-hover" target="_blank" href="https://AIJobschool.short.gy/E49kA8">與我們聯繫（LINE 官方）</a>
                    </div>
                </div>
            </section>
        </div>

        <!-- 定位助手頁面 -->
        <div id="page-positioning" class="page hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="grid lg:grid-cols-12 gap-8">
                    <!-- 左側表單 -->
                    <div id="positioning-left" class="space-y-6 lg:col-span-4">
                        <!-- Tabs: AI 對話 / 一鍵生成 -->
                        <div id="positioning-tabs" class="flex flex-wrap md:flex-nowrap gap-2 mb-3 overflow-x-auto whitespace-nowrap">
                            <button id="tab-positioning-chat" class="shrink-0 px-3 py-1.5 rounded-lg bg-primary text-white hover:bg-primary-hover">AI 對話</button>
                            <button id="tab-positioning-oneclick" class="shrink-0 px-3 py-1.5 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700">一鍵生成</button>
                        </div>
                        <form id="positioning-form" class="space-y-6">
                            <!-- 產業 -->
                            <div>
                                <label for="industry" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">產業類型 *</label>
                                <input type="text" id="industry" name="industry" required
                                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white transition-all duration-150"
                                    placeholder="例如：科技、教育、餐飲、金融...">
                            </div>

                            <!-- 目標受眾 -->
                            <div>
                                <label for="audience" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">目標受眾 *</label>
                                <input type="text" id="audience" name="audience" required
                                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white transition-all duration-150"
                                    placeholder="例如：25-35歲上班族、學生家長、小企業主...">
                            </div>

                            <!-- 主要痛點 -->
                            <div>
                                <label for="pains" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">主要痛點 *</label>
                                <textarea id="pains" name="pains" rows="4" required
                                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white transition-all duration-150"
                                    placeholder="描述您的目標受眾面臨的主要問題或挑戰..."></textarea>
                            </div>

                            <!-- 品牌語氣 -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">品牌語氣 *</label>
                                <div class="grid grid-cols-2 gap-3" role="radiogroup" aria-label="品牌語氣選擇">
                                    <label class="flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
                                        <input type="radio" name="tone" value="professional" class="sr-only" required>
                                        <div class="tone-option w-full text-center py-2">專業</div>
                                    </label>
                                    <label class="flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
                                        <input type="radio" name="tone" value="friendly" class="sr-only" required>
                                        <div class="tone-option w-full text-center py-2">親切</div>
                                    </label>
                                    <label class="flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
                                        <input type="radio" name="tone" value="humorous" class="sr-only" required>
                                        <div class="tone-option w-full text-center py-2">幽默</div>
                                    </label>
                                    <label class="flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
                                        <input type="radio" name="tone" value="authoritative" class="sr-only" required>
                                        <div class="tone-option w-full text-center py-2">權威</div>
                                    </label>
                                </div>
                            </div>

                            <!-- 競品分析 -->
                            <div>
                                <label for="competitors" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">競品分析（選填）</label>
                                <input type="text" id="competitors" name="competitors"
                                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white transition-all duration-150"
                                    placeholder="列出主要競爭對手...">
                            </div>

                            <button type="submit" id="positioning-submit"
                                class="w-full bg-primary text-white py-3 px-6 rounded-lg hover:bg-primary-hover transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed">
                                <span class="submit-text">生成定位摘要</span>
                                <span class="loading-text hidden">
                                    <svg class="loading-spinner w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    生成中...
                                </span>
                            </button>
                        </form>
                        
                        <!-- 準備開始定位分析區塊 -->
                        <div class="mt-6 text-center py-8">
                            <div class="text-6xl mb-4">🎯</div>
                            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">準備開始定位分析</h3>
                            <p class="text-gray-600 dark:text-gray-400 mb-6">填寫左側表單，我們將為您生成專業的定位摘要</p>
                            <div class="space-y-2">
                                <button class="quick-example-btn block w-full text-sm text-primary hover:text-primary-hover transition-colors duration-150">
                                    快速示例：科技新創公司
                                </button>
                                <button class="quick-example-btn block w-full text-sm text-primary hover:text-primary-hover transition-colors duration-150">
                                    快速示例：線上教育平台
                                </button>
                                <button class="quick-example-btn block w-full text-sm text-primary hover:text-primary-hover transition-colors duration-150">
                                    快速示例：健康食品品牌
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 右側結果 -->
                    <div class="lg:col-span-8">
                        <!-- 定位 顧問聊天室（強化版） -->
                        <div class="mb-6">
                            <div id="positioning-chat-card" class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden flex flex-col min-h-[420px] md:min-h-[600px]">
                                <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 dark:border-gray-700">
                                    <h3 class="text-lg font-semibold">🎯 AI影音定位顧問</h3>
                                    <button id="chat-clear-positioning" class="text-sm px-3 py-1 rounded-md border border-gray-300 hover:bg-gray-50 dark:border-gray-600">清空對話</button>
                                </div>
                                <div id="chat-positioning" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50 dark:bg-gray-900"></div>
                                <div class="px-4 py-3 border-t border-gray-200 dark:border-gray-700">
                                    <div class="flex flex-wrap gap-2 mb-3 text-sm">
                                        <button class="chip-p btn-chip">業務類型定位</button>
                                        <button class="chip-p btn-chip">目標受眾分析</button>
                                        <button class="chip-p btn-chip">品牌形象定位</button>
                                        <button class="chip-p btn-chip">平台策略建議</button>
                                        <button class="chip-p btn-chip">內容目標設定</button>
                                        <button class="chip-p btn-chip">發文頻率規劃</button>
                                    </div>
                                    <div class="flex gap-2">
                                        <textarea id="chat-input-positioning" rows="2" class="flex-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700 resize-y" placeholder="告訴我你的業務、產品、目標或困惑...（Enter 送出；Shift+Enter 換行）"></textarea>
                                        <button id="chat-send-positioning" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-hover">分析</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="positioning-result" class="hidden">
                            <h3 class="text-xl font-bold mb-4">定位摘要</h3>
                            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 space-y-4">
                                <div id="positioning-loading" class="hidden text-center py-6 text-gray-500 dark:text-gray-400">
                                    <svg class="loading-spinner w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    AI 回覆中...
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900 dark:text-white mb-2">品牌定位</h4>
                                    <p class="text-gray-600 dark:text-gray-400 whitespace-pre-line" id="positioning-summary"></p>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900 dark:text-white mb-2">語氣守則</h4>
                                    <p class="text-gray-600 dark:text-gray-400 whitespace-pre-line" id="tone-guidelines"></p>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900 dark:text-white mb-2">執行建議</h4>
                                    <p class="text-gray-600 dark:text-gray-400 whitespace-pre-line" id="execution-suggestions"></p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 一鍵生成面板（沿用既有表單區塊作為一鍵生成輸入）-->
                        <div id="positioning-oneclick-panel" class="hidden">
                            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow p-4 text-sm text-gray-600 dark:text-gray-400">
                                <p>輸入必要資訊後，直接送出即可快速產生定位摘要。</p>
                                <!-- 使用同一份 form 的提交邏輯，維持 API 不變 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 選題助手頁面 -->
        <div id="page-ideation" class="page hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="grid lg:grid-cols-12 gap-8">
                    <!-- 左側表單 -->
                    <div id="ideation-left" class="space-y-6 lg:col-span-4">
                        <!-- Tabs: AI 對話 / 一鍵生成 -->
                        <div id="ideation-tabs" class="flex flex-wrap md:flex-nowrap gap-2 mb-3 overflow-x-auto whitespace-nowrap">
                            <button id="tab-ideation-chat" class="shrink-0 px-3 py-1.5 rounded-lg bg-primary text-white hover:bg-primary-hover">AI 對話</button>
                            <button id="tab-ideation-oneclick" class="shrink-0 px-3 py-1.5 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700">一鍵生成</button>
                        </div>
                        <form id="ideation-form" class="space-y-6">
                            <!-- 主題/關鍵字 -->
                            <div>
                                <label for="topic" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">主題/關鍵字 *</label>
                                <input type="text" id="topic" name="topic" required
                                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white transition-all duration-150"
                                    placeholder="例如：減肥、理財、職場技能、親子教育...">
                            </div>

                            <!-- 產出條數 -->
                            <div>
                                <label for="count" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">欲產出條數 *</label>
                                <select id="count" name="count" required
                                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white transition-all duration-150">
                                    <option value="">請選擇</option>
                                    <option value="1">1 條</option>
                                    <option value="2">2 條</option>
                                    <option value="3">3 條</option>
                                    <option value="4">4 條</option>
                                    <option value="5">5 條</option>
                                    <option value="6">6 條</option>
                                    <option value="7">7 條</option>
                                    <option value="8">8 條</option>
                                    <option value="9">9 條</option>
                                    <option value="10">10 條</option>
                                </select>
                            </div>

                            <!-- 避免重複 -->
                            <div class="flex items-center">
                                <input type="checkbox" id="dedupe" name="dedupe" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 dark:border-gray-600 rounded">
                                <label for="dedupe" class="ml-2 text-sm text-gray-700 dark:text-gray-300">避免重複角度</label>
                            </div>

                            <button type="submit" id="ideation-submit"
                                class="w-full bg-primary text-white py-3 px-6 rounded-lg hover:bg-primary-hover transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed">
                                <span class="submit-text">產生選題</span>
                                <span class="loading-text hidden">
                                    <svg class="loading-spinner w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    產生中...
                                </span>
                            </button>
                        </form>
                    </div>

                    <!-- 右側結果 -->
                    <div class="lg:col-span-8">
                        <!-- 選題 聊天室（強化版） -->
                        <div class="mb-6">
                            <div id="ideation-chat-card" class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden min-h-[380px] md:min-h-[500px] flex flex-col">
                                <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 dark:border-gray-700">
                                    <h3 class="text-lg font-semibold">💡 AI選題小助手</h3>
                                    <button id="chat-clear-ideation" class="text-sm px-3 py-1 rounded-md border border-gray-300 hover:bg-gray-50 dark:border-gray-600">清空對話</button>
                                </div>
                                <div id="chat-ideation" class="h-80 sm:h-96 overflow-y-auto p-4 space-y-3 bg-gray-50 dark:bg-gray-900"></div>
                                <div class="px-4 py-3 border-t border-gray-200 dark:border-gray-700">
                                    <div class="flex flex-wrap gap-2 mb-3 text-sm">
                                        <button class="chip-i btn-chip">熱門趨勢</button>
                                        <button class="chip-i btn-chip">教育分享</button>
                                        <button class="chip-i btn-chip">個人故事</button>
                                        <button class="chip-i btn-chip">產品介紹</button>
                                    </div>
                                    <div class="flex gap-2">
                                        <textarea id="chat-input-ideation" rows="2" class="flex-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700 resize-y" placeholder="告訴我你想要什麼類型的選題靈感...（Enter 送出；Shift+Enter 換行）"></textarea>
                                        <button id="chat-send-ideation" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-hover">獲取靈感</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="ideation-result" class="hidden">
                            <h3 class="text-xl font-bold mb-4">選題建議</h3>
                            <div class="space-y-4">
                                <div id="ideation-loading" class="hidden text-center py-6 text-gray-500 dark:text-gray-400">
                                    <svg class="loading-spinner w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    AI 回覆中...
                                </div>
                                <div id="ideation-cards" class="space-y-4"></div>
                            </div>
                        </div>
                        
                        <div id="ideation-empty" class="text-center py-12">
                            <div class="text-6xl mb-4">💡</div>
                            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">準備產生創意選題</h3>
                            <p class="text-gray-600 dark:text-gray-400 mb-6">輸入主題關鍵字，我們將為您產生多個吸睛的角度</p>
                            <div class="space-y-2">
                                <button class="quick-example-btn block w-full text-sm text-primary hover:text-primary-hover transition-colors duration-150">
                                    快速示例：減肥方法
                                </button>
                                <button class="quick-example-btn block w-full text-sm text-primary hover:text-primary-hover transition-colors duration-150">
                                    快速示例：投資理財
                                </button>
                                <button class="quick-example-btn block w-full text-sm text-primary hover:text-primary-hover transition-colors duration-150">
                                    快速示例：職場技能
                                </button>
                            </div>
                        </div>
                        <div id="ideation-oneclick-panel" class="hidden">
                            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow p-4 text-sm text-gray-600 dark:text-gray-400">
                                <p>輸入主題或條件後，將直接產生精簡選題摘要。</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 腳本生成器頁面 -->
        <div id="page-script" class="page hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="grid lg:grid-cols-12 gap-8">
                    <!-- 左側控制區 -->
                    <div class="space-y-8 lg:col-span-4">
                        <div>
                            <h2 class="text-3xl font-bold mb-2">AI腳本生成大師</h2>
                            <p class="text-gray-600 dark:text-gray-400">選擇模式、模板與時長，快速生成專業腳本</p>
                        </div>

                        <!-- 模式選擇 -->
                        <div>
                            <h3 class="text-lg font-semibold mb-4">模式選擇</h3>
                            <div class="flex space-x-2" role="radiogroup" aria-label="模式選擇">
                                <label class="flex-1">
                                    <input type="radio" name="mode" value="guided" class="sr-only" checked>
                                    <div class="mode-option w-full text-center py-3 px-4 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white transition-colors duration-150">
                                        引導模式
                                    </div>
                                </label>
                                <label class="flex-1">
                                    <input type="radio" name="mode" value="free" class="sr-only">
                                    <div class="mode-option w-full text-center py-3 px-4 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white transition-colors duration-150">
                                        自由模式
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- 模板選擇 -->
                        <div>
                            <h3 class="text-lg font-semibold mb-4">選擇模板</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3" role="radiogroup" aria-label="模板選擇">
                                <label class="template-option">
                                    <input type="radio" name="template" value="A" class="sr-only" checked>
                                    <div class="template-card p-4 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
                                        <div class="font-semibold mb-1">A 三段式</div>
                                        <div class="text-sm text-gray-600 dark:text-gray-400">開頭-主體-結尾</div>
                                    </div>
                                </label>
                                <label class="template-option">
                                    <input type="radio" name="template" value="B" class="sr-only">
                                    <div class="template-card p-4 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
                                        <div class="font-semibold mb-1">B 問題解決</div>
                                        <div class="text-sm text-gray-600 dark:text-gray-400">問題-分析-解決</div>
                                    </div>
                                </label>
                                <label class="template-option">
                                    <input type="radio" name="template" value="C" class="sr-only">
                                    <div class="template-card p-4 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
                                        <div class="font-semibold mb-1">C Before-After</div>
                                        <div class="text-sm text-gray-600 dark:text-gray-400">對比呈現</div>
                                    </div>
                                </label>
                                <label class="template-option">
                                    <input type="radio" name="template" value="D" class="sr-only">
                                    <div class="template-card p-4 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
                                        <div class="font-semibold mb-1">D 教學</div>
                                        <div class="text-sm text-gray-600 dark:text-gray-400">步驟式教學</div>
                                    </div>
                                </label>
                                <label class="template-option">
                                    <input type="radio" name="template" value="E" class="sr-only">
                                    <div class="template-card p-4 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
                                        <div class="font-semibold mb-1">E 故事</div>
                                        <div class="text-sm text-gray-600 dark:text-gray-400">故事化敘述</div>
                                    </div>
                                </label>
                                <label class="template-option">
                                    <input type="radio" name="template" value="F" class="sr-only">
                                    <div class="template-card p-4 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
                                        <div class="font-semibold mb-1">F 爆點連發</div>
                                        <div class="text-sm text-gray-600 dark:text-gray-400">多個亮點</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- 時長選擇 -->
                        <div>
                            <h3 class="text-lg font-semibold mb-4">時長選擇</h3>
                            <div class="flex space-x-2" role="radiogroup" aria-label="時長選擇">
                                <label class="flex-1">
                                    <input type="radio" name="duration" value="30" class="sr-only" checked>
                                    <div class="duration-option w-full text-center py-3 px-4 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
                                        30 秒
                                    </div>
                                </label>
                                <label class="flex-1">
                                    <input type="radio" name="duration" value="60" class="sr-only">
                                    <div class="duration-option w-full text-center py-3 px-4 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
                                        60 秒
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- 主要 CTA -->
                        <button id="apply-settings" 
                            class="w-full bg-primary text-white py-4 px-6 rounded-lg hover:bg-primary-hover transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-gray-800 active:scale-95">
                            套用設定並開始
                        </button>
                    </div>

                    <!-- 右側預覽區 -->
                    <div class="lg:col-span-8">
                        <h3 class="text-xl font-bold mb-4">預覽結果</h3>
                        <!-- 切換：AI 對話 / 一鍵生成 -->
                        <div id="script-tabs" class="flex gap-2 mb-3">
                            <button id="tab-script-chat" class="px-3 py-1.5 rounded-lg bg-primary text-white hover:bg-primary-hover">AI 對話</button>
                            <button id="tab-script-oneclick" class="px-3 py-1.5 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700">一鍵生成</button>
                        </div>
                        <!-- 腳本 聊天室（強化版） -->
                        <div id="script-chat-panel" class="mb-6">
                            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden">
                                <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 dark:border-gray-700">
                                    <h3 class="text-lg font-semibold">📝 AI腳本生成大師</h3>
                                    <button id="chat-clear-script" class="text-sm px-3 py-1 rounded-md border border-gray-300 hover:bg-gray-50 dark:border-gray-600">清空對話</button>
                                </div>
                                <div id="chat-script" class="h-80 sm:h-96 overflow-y-auto p-4 space-y-3 bg-gray-50 dark:bg-gray-900"></div>
                                <div class="px-4 py-3 border-t border-gray-200 dark:border-gray-700">
                                    <div class="flex flex-wrap gap-2 mb-3 text-sm">
                                        <button class="chip-s btn-chip">A 三段式</button>
                                        <button class="chip-s btn-chip">B 問題解決</button>
                                        <button class="chip-s btn-chip">C Before-After</button>
                                        <button class="chip-s btn-chip">D 教學</button>
                                        <button class="chip-s btn-chip">E 敘事</button>
                                        <button class="chip-s btn-chip">F 爆點連發</button>
                                    </div>
                                    <div class="flex gap-2">
                                        <textarea id="chat-input-script" rows="2" class="flex-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700 resize-y" placeholder="輸入主題/目標/受眾/平台/時長/語氣…（Enter 送出；Shift+Enter 換行）"></textarea>
                                        <button id="chat-send-script" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-hover">送出</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- 一鍵生成 面板 -->
                        <div id="script-oneclick-panel" class="hidden mb-6">
                            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden p-4 border border-gray-200 dark:border-gray-700">
                                <div class="mb-3 text-sm text-gray-600 dark:text-gray-400">輸入主題與重點，將依照左側的模板/時長設定一鍵生成腳本。</div>
                                <div class="flex gap-2 mb-3">
                                    <input id="oneclick-topic" type="text" class="flex-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700" placeholder="例如：AI認證落地智能體的60秒短影音腳本">
                                    <button id="oneclick-generate" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-hover">生成腳本</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="script-preview" class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 min-h-96">
                            <div id="script-empty" class="text-center py-12">
                                <div class="text-6xl mb-4">📝</div>
                                <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">準備生成腳本</h4>
                                <p class="text-gray-600 dark:text-gray-400">選擇左側設定，點擊「套用設定並開始」開始生成</p>
                            </div>
                            <div id="script-loading" class="hidden text-center py-6 text-gray-500 dark:text-gray-400">
                                <svg class="loading-spinner w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                AI 生成中...
                            </div>
                            <div id="script-result" class="hidden">
                                <div class="space-y-4">
                                    <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
                                        <h4 class="font-semibold text-gray-900 dark:text-white mb-2">腳本設定</h4>
                                        <div class="text-sm text-gray-600 dark:text-gray-400">
                                            <span id="script-mode"></span> • <span id="script-template"></span> • <span id="script-duration"></span>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-gray-900 dark:text-white mb-2">腳本內容</h4>
                                        <div id="script-content" class="text-gray-600 dark:text-gray-400 whitespace-pre-line"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 說明/指南頁面 -->
        <div id="page-guide" class="page hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-6">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                    <h3 class="text-2xl font-bold mb-2">🎯 AI短影音定位顧問</h3>
                    <h4 class="font-semibold mb-2">功能說明</h4>
                    <p class="text-gray-600 dark:text-gray-400">• <strong>帳號定位分析</strong>：幫助釐清你的業務類型、目標受眾、品牌形象<br/>• <strong>平台策略建議</strong>：根據你的定位推薦最適合的平台<br/>• <strong>內容方向規劃</strong>：建立完整的內容策略基礎<br/>• <strong>定位檔案管理</strong>：自動記錄和更新你的定位資訊</p>
                    <h4 class="font-semibold mt-4 mb-2">使用方式</h4>
                    <p class="text-gray-600 dark:text-gray-400">1️⃣ 點擊「快速問題」開始定位分析<br/>2️⃣ 回答AI的問題，建立你的定位檔案<br/>3️⃣ 使用「🚀 一鍵生成定位」快速建立完整定位<br/>4️⃣ 定位檔案會自動儲存並同步到其他功能</p>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                    <h3 class="text-2xl font-bold mb-2">💡 AI選題小助手</h3>
                    <h4 class="font-semibold mb-2">功能說明</h4>
                    <p class="text-gray-600 dark:text-gray-400">• <strong>個性化選題</strong>：基於你的定位檔案生成相關選題<br/>• <strong>熱點結合</strong>：結合當前熱門話題與你的品牌特色<br/>• <strong>季節性內容</strong>：考慮時節與節日提供適時建議<br/>• <strong>選題類型篩選</strong>：熱門趨勢、教育分享、個人故事、產品介紹</p>
                    <h4 class="font-semibold mt-4 mb-2">使用方式</h4>
                    <p class="text-gray-600 dark:text-gray-400">1️⃣ 先完成定位分析，建立你的定位檔案<br/>2️⃣ 選擇選題類型（熱門趨勢、教育分享等）<br/>3️⃣ 點擊「獲取靈感」獲得個性化選題建議<br/>4️⃣ 查看「今日選題建議」和「歷史記錄」</p>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                    <h3 class="text-2xl font-bold mb-2">📝 AI腳本生成大師</h3>
                    <h4 class="font-semibold mb-2">功能說明</h4>
                    <p class="text-gray-600 dark:text-gray-400">• <strong>一鍵生成腳本</strong>：根據主題快速生成完整腳本<br/>• <strong>引導模式</strong>：選擇結構模板和時長，AI逐步引導<br/>• <strong>自由模式</strong>：自由討論需求，AI提供創意建議<br/>• <strong>多種模板</strong>：支援 A-F 六種腳本結構模板<br/>• <strong>時長靈活</strong>：支援 30 秒與 60 秒腳本</p>
                    <h4 class="font-semibold mt-4 mb-2">使用方式</h4>
                    <p class="text-gray-600 dark:text-gray-400">1️⃣ 一鍵生成：套用設定後輸入主題即可<br/>2️⃣ 引導模式：選擇結構模板與時長，輸入主題開始<br/>3️⃣ 自由模式：直接輸入需求，與 AI 自由討論<br/>4️⃣ 查看「腳本分段/時間軸」</p>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                    <h3 class="text-2xl font-bold mb-2">💾 資料儲存與管理</h3>
                    <p class="text-gray-600 dark:text-gray-400">• <strong>定位檔案</strong>：自動儲存在資料庫中<br/>• <strong>選題建議</strong>：儲存在「今日選題建議」與「歷史記錄」<br/>• <strong>腳本筆記</strong>：儲存在「腳本分段/時間軸」</p>
                    <p class="text-gray-600 dark:text-gray-400 mt-2">所有資料會自動同步到其他功能，讓 AI 能夠根據你的歷史記錄提供更精準的建議。</p>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                    <h3 class="text-2xl font-bold mb-2">🚀 使用建議</h3>
                    <p class="text-gray-600 dark:text-gray-400">1. 先使用定位智能體建立基本定位<br/>2. 再使用選題智能體獲取個性化建議<br/>3. 最後使用腳本生成大師創作具體內容</p>
                </div>
            </div>
        </div>
    </main>

    <!-- 全站頁尾：外部連結 + 版權 -->
    <footer class="border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 mt-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex flex-wrap gap-3 mb-4">
                <a class="px-4 py-2 rounded-full border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300" target="_blank" href="https://AIJobschool.short.gy/kBmUAL">AIJob YouTube</a>
                <a class="px-4 py-2 rounded-full border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300" target="_blank" href="https://AIJobschool.short.gy/ytPY3U">AIJob 官方網站</a>
                <a class="px-4 py-2 rounded-full border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300" target="_blank" href="https://AIJobschool.short.gy/KCYu7z">AIJob 行銷自動化課程</a>
                <a class="px-4 py-2 rounded-full border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300" target="_blank" href="https://AIJobschool.short.gy/UUwpEG">AIJob Discord社群討論</a>
                <a class="px-4 py-2 rounded-full border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300" target="_blank" href="https://AIJobschool.short.gy/E49kA8">AIJob LINE官方帳號</a>
            </div>
            <div class="text-center text-gray-500 dark:text-gray-400">© 2025 AIJobSchool 版權所有</div>
        </div>
    </footer>

    <script>
        // API Base（自動偵測本機或雲端）
        const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:8080' : 'https://aijobvideobackend.zeabur.app';
        // 會員 API base（可與主 API 相同）
        const ACCOUNT_API = API_BASE;
        // 功能扣點設定（可依實際調整）
        const CREDIT_COSTS = { positioning: 5, topics: 3, script: 8 };

        // 全域變數
        let currentPage = 'home';
        let isDarkMode = localStorage.getItem('darkMode') === 'true';

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initTheme();
            initRouter();
            initMobileMenu();
            initPositioning();
            initIdeation();
            initScript();
            initAuth();
            // 與後端 Session 對齊，避免 localStorage 殘留導致誤顯示已登入
            (async function syncSession(){
                try{
                    const me = await fetch(`${API_BASE}/me`, { credentials:'include' }).then(r=> r.ok ? r.json() : null);
                    if (me && me.id){
                        localStorage.setItem('isLoggedIn','true');
                        localStorage.setItem('user', JSON.stringify(me));
                    } else {
                        localStorage.setItem('isLoggedIn','false');
                        localStorage.removeItem('user');
                    }
                }catch(_){ /* 忽略網路錯誤 */ }
            })();
            initChats();
            loadStoredData();
            adjustPositioningHeights();
            window.addEventListener('resize', adjustPositioningHeights);
        });

        // 主題切換功能
        function initTheme() {
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = document.getElementById('theme-icon');
            const sunIcon = document.getElementById('sun-icon');
            const moonIcon = document.getElementById('moon-icon');

            // 設定初始主題
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
                console.log('初始化夜間模式'); // 調試信息
            } else {
                document.documentElement.classList.remove('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
                console.log('初始化日間模式'); // 調試信息
            }

            themeToggle.addEventListener('click', function() {
                isDarkMode = !isDarkMode;
                localStorage.setItem('darkMode', isDarkMode);
                
                console.log('切換夜間模式:', isDarkMode); // 調試信息
                
                if (isDarkMode) {
                    document.documentElement.classList.add('dark');
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                    showToast('已切換到夜間模式', 'success');
                } else {
                    document.documentElement.classList.remove('dark');
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                    showToast('已切換到日間模式', 'success');
                }
                
                // 強制重新渲染
                document.body.offsetHeight;
            });
        }

        // 路由系統
        function initRouter() {
            // 處理導覽連結點擊
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.dataset.page;
                    navigateToPage(page);
                });
            });

            // 處理首頁卡片點擊
            document.querySelectorAll('a[href^="#!"]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('href').replace('#!', '');
                    navigateToPage(page);
                });
            });

            // 監聽瀏覽器前進/後退
            window.addEventListener('hashchange', function() {
                const hash = window.location.hash.replace('#!', '') || 'home';
                navigateToPage(hash);
            });

            // 初始化頁面
            const hash = window.location.hash.replace('#!', '') || 'home';
            navigateToPage(hash);
        }

        function navigateToPage(page) {
            // 隱藏所有頁面
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            
            // 顯示目標頁面
            const targetPage = document.getElementById(`page-${page}`);
            if (targetPage) {
                targetPage.classList.remove('hidden');
                targetPage.classList.add('fade-in');
                currentPage = page;
                
                // 更新 URL
                window.location.hash = `#!${page}`;
                
                // 更新導覽狀態
                updateNavigation(page);
            }
        }

        function updateNavigation(activePage) {
            document.querySelectorAll('.nav-link').forEach(link => {
                if (link.dataset.page === activePage) {
                    link.classList.add('text-primary', 'font-semibold');
                    link.classList.remove('text-gray-700', 'dark:text-gray-300');
                } else {
                    link.classList.remove('text-primary', 'font-semibold');
                    link.classList.add('text-gray-700', 'dark:text-gray-300');
                }
            });
        }

        function initMobileMenu() {
            const btn = document.getElementById('mobile-menu-btn');
            const menu = document.getElementById('mobile-menu');
            if (!btn || !menu) return;
    btn.addEventListener('click', () => menu.classList.toggle('hidden'));
    // 點擊導覽連結自動收合
    menu.querySelectorAll('a').forEach(a => a.addEventListener('click', () => menu.classList.add('hidden')));
    // 點擊外部收合
    document.addEventListener('click', (e) => {
        const within = menu.contains(e.target) || btn.contains(e.target);
        if (!within) menu.classList.add('hidden');
    });
            // 點品牌返回首頁
            const brand = document.querySelector('nav a[data-page="home"]');
            if (brand) brand.addEventListener('click', (e)=>{ e.preventDefault(); navigateToPage('home'); });
        }

        // 簡易登入系統（參考 login.html）
        function initAuth() {
            const loginBtn = document.getElementById('login-btn');
            const dropdown = document.getElementById('user-dropdown');
            const logoutBtn = document.getElementById('logout-btn');
            const drawer = document.getElementById('account-drawer');
            const overlay = document.getElementById('drawer-overlay');
            const drawerClose = document.getElementById('drawer-close');
            const drawerLogout = document.getElementById('drawer-logout-btn');
            const emailOpen = document.getElementById('email-login-open');
            const emailModal = document.getElementById('email-modal');
            const emailClose = document.getElementById('email-modal-close');
            const emailCancel = document.getElementById('email-modal-cancel');
            const emailSubmit = document.getElementById('email-login-submit');
            const emailInput = document.getElementById('email-login-input');
            const emailOverlay = document.getElementById('email-modal-overlay');
            const emailPage = document.getElementById('email-auth-page');
            const emailPageClose = document.getElementById('email-auth-close');
            const btnEmailLogin = document.getElementById('btn-email-login');
            const btnEmailSignup = document.getElementById('btn-email-signup');
            if (!loginBtn) return;

            function refreshUserUI() {
                const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                const userRaw = localStorage.getItem('user');
                const creditsWrap = document.getElementById('nav-credits-wrap');
                
                if (isLoggedIn && userRaw) {
                    const u = JSON.parse(userRaw);
                    loginBtn.textContent = u.name || 'Google 用戶';
                    loginBtn.classList.add('bg-orange-100', 'text-orange-800', 'border-orange-200');
                    loginBtn.classList.remove('bg-gray-100', 'text-gray-700');
                    // 顯示 Credits 區塊
                    if (creditsWrap) creditsWrap.classList.remove('hidden');
                    
                    // 更新下拉選單內容
                    document.getElementById('user-name').textContent = u.name || 'Google 用戶';
                    document.getElementById('user-email').textContent = u.email || 'user@gmail.com';
                    document.getElementById('user-avatar').textContent = u.name ? u.name.charAt(0).toUpperCase() : 'G';
                    // 更新抽屜內容
                    document.getElementById('acc-name').textContent = u.name || 'Google 用戶';
                    document.getElementById('acc-email').textContent = u.email || 'user@gmail.com';
                    document.getElementById('acc-avatar').textContent = u.name ? u.name.charAt(0).toUpperCase() : 'G';
                    // 同步後端點數/方案
                    fetchAccountSummary(u).catch(()=>{});
                    // 若本地已有點數，先行顯示（後端回來會覆蓋）
                    if (typeof u.credits === 'number') {
                        const navC = document.getElementById('nav-credits'); if (navC) navC.textContent = u.credits;
                        const accC = document.getElementById('acc-credits'); if (accC) accC.textContent = u.credits;
                    }
                } else {
                    loginBtn.textContent = '登入';
                    loginBtn.classList.remove('bg-orange-100', 'text-orange-800', 'border-orange-200');
                    loginBtn.classList.add('bg-gray-100', 'text-gray-700');
                    // 未登入隱藏 Credits 區塊
                    if (creditsWrap) creditsWrap.classList.add('hidden');
                    // 顯示 Email 登入按鈕（未登入時）
                    if (emailOpen) emailOpen.classList.remove('hidden');
                }
            }

            loginBtn.addEventListener('click', () => {
                const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                if (!isLoggedIn) {
                    // 顯示 Email 全畫面頁（使用者可改點右上角 Google 登入）
                    if (emailPage) emailPage.classList.remove('hidden');
                } else {
                    // 開啟帳號抽屜
                    drawer.classList.remove('translate-x-full');
                    overlay.classList.remove('hidden');
                }
            });

            // Email 登入 Modal 控制（舊，暫保留）
            function openEmailModal(){ if (emailModal) emailModal.classList.remove('hidden'); emailInput?.focus(); }
            function closeEmailModal(){ if (emailModal) emailModal.classList.add('hidden'); emailInput.value=''; }
            emailOpen?.addEventListener('click', openEmailModal);
            emailClose?.addEventListener('click', closeEmailModal);
            emailCancel?.addEventListener('click', closeEmailModal);
            emailOverlay?.addEventListener('click', closeEmailModal);

            emailSubmit?.addEventListener('click', async () => {
                const email = (emailInput?.value || '').trim();
                if (!email) { showToast('請輸入 Email', 'error'); return; }
                try{
                    const res = await fetch(`${API_BASE}/auth/email/start`, {
                        method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });
                    if (!res.ok) throw new Error('send failed');
                    showToast('已寄出登入連結，請至信箱查收', 'success');
                    closeEmailModal();
                }catch(e){
                    showToast('寄送失敗，請稍後再試', 'error');
                }
            });

            // Email 全畫面頁：關閉
            emailPageClose?.addEventListener('click', ()=> emailPage.classList.add('hidden'));

            // Email 登入：POST /auth/login
            btnEmailLogin?.addEventListener('click', async ()=>{
                const identifier = (document.getElementById('login-identifier')?.value||'').trim();
                const password = (document.getElementById('login-password')?.value||'').trim();
                if (!identifier || !password){ showToast('請輸入帳號與密碼', 'error'); return; }
                try{
                    const res = await fetch(`${API_BASE}/auth/login`, { method:'POST', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ identifier, password }) });
                    if (!res.ok) throw new Error('login failed');
                    const me = await fetch(`${API_BASE}/me`, { credentials:'include' }).then(r=>r.ok?r.json():null);
                    if (me){ localStorage.setItem('isLoggedIn','true'); localStorage.setItem('user', JSON.stringify(me)); emailPage.classList.add('hidden'); showToast('登入成功', 'success'); location.reload(); }
                }catch(e){ showToast('登入失敗，請檢查帳密或稍後再試', 'error'); }
            });

            // Email 註冊：POST /auth/signup
            btnEmailSignup?.addEventListener('click', async ()=>{
                const phone = (document.getElementById('signup-phone')?.value||'').trim();
                const email = (document.getElementById('signup-email')?.value||'').trim();
                const username = (document.getElementById('signup-username')?.value||'').trim();
                const password = (document.getElementById('signup-password')?.value||'').trim();
                if (!phone || !email || !username || !password){ showToast('請完整填寫電話/Email/帳號/密碼', 'error'); return; }
                try{
                    const res = await fetch(`${API_BASE}/auth/signup`, { method:'POST', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ phone, email, username, password }) });
                    if (!res.ok) throw new Error('signup failed');
                    showToast('帳號建立成功，請以帳密登入', 'success');
                }catch(e){ showToast('建立帳號失敗，請稍後再試', 'error'); }
            });

            // Google 登入/註冊（皆導向同一 OAuth 起始端點，後端處理不存在帳號時自動建帳）
            async function startGoogle(nextUrl){
                // 先清除現有 session，避免因為已登入而被誤認為成功
                try{ await fetch(`${API_BASE}/logout`, {method:'POST', credentials:'include'}); }catch(_){ }
                const url = `${API_BASE}/auth/google/start?next=${encodeURIComponent(nextUrl||location.href)}`;
                const features = 'width=520,height=640,menubar=no,toolbar=no,location=no,status=no,resizable=yes,scrollbars=yes';
                const popup = window.open(url, 'google_auth', features);
                // 輕量輪詢：等待後端設定好 session cookie 後，自動關閉視窗並刷新父頁
                const timer = setInterval(async ()=>{
                    try{
                        const me = await fetch(`${API_BASE}/me`, { credentials:'include' }).then(r=> r.ok ? r.json() : null);
                        if (me && me.id){
                            localStorage.setItem('isLoggedIn','true');
                            localStorage.setItem('user', JSON.stringify(me));
                            clearInterval(timer);
                            try{ popup && popup.close(); }catch(_){ }
                            location.reload();
                        }
                    }catch(_){ /* 忽略暫時錯誤 */ }
                }, 1000);
                showToast('請在彈窗完成 Google 登入', 'info');
            }
            document.getElementById('btn-google-login')?.addEventListener('click', ()=> startGoogle(location.href));
            document.getElementById('btn-google-signup')?.addEventListener('click', ()=> startGoogle(location.href));

            // 顯示/隱藏密碼
            function bindToggle(btnId, inputId){
                const btn = document.getElementById(btnId);
                const inp = document.getElementById(inputId);
                if (!btn || !inp) return;
                btn.addEventListener('click', ()=>{
                    inp.type = (inp.type === 'password') ? 'text' : 'password';
                });
            }
            bindToggle('toggle-login-pw','login-password');
            bindToggle('toggle-signup-pw','signup-password');

            // 登出功能
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    localStorage.removeItem('user');
                    localStorage.setItem('isLoggedIn', 'false');
                    showToast('已登出', 'success');
                    refreshUserUI();
                    dropdown.classList.add('hidden');
                });
            }

            if (drawerLogout) {
                drawerLogout.addEventListener('click', () => {
                    localStorage.removeItem('user');
                    localStorage.setItem('isLoggedIn', 'false');
                    showToast('已登出', 'success');
                    refreshUserUI();
                    drawer.classList.add('translate-x-full');
                    overlay.classList.add('hidden');
                });
            }

            // 點擊外部關閉下拉選單
            document.addEventListener('click', (e) => {
                if (!loginBtn.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });

            // 抽屜關閉控制
            if (drawerClose) drawerClose.addEventListener('click', () => { drawer.classList.add('translate-x-full'); overlay.classList.add('hidden'); });
            if (overlay) overlay.addEventListener('click', () => { drawer.classList.add('translate-x-full'); overlay.classList.add('hidden'); });

            refreshUserUI();
        }

        // 從後端讀取使用者點數與方案
        async function fetchAccountSummary(user){
            if (!user || !user.id) return;
            try {
                const res = await fetch(`${ACCOUNT_API}/account/summary?user_id=${encodeURIComponent(user.id)}`, { credentials: 'include' });
                const data = await res.json();
                if (!data || data.error) return;
                const credits = typeof data.credits === 'number' ? data.credits : (data.credits?.balance ?? undefined);
                const plan = data.plan || data.subscription || '免費';
                if (credits !== undefined) {
                    const navC = document.getElementById('nav-credits');
                    if (navC) navC.textContent = credits;
                    const accC = document.getElementById('acc-credits');
                    if (accC) accC.textContent = credits;
                    // 也同步到 localStorage 方便模擬扣點
                    const userRaw = localStorage.getItem('user');
                    if (userRaw) {
                        const u = JSON.parse(userRaw); u.credits = credits; localStorage.setItem('user', JSON.stringify(u));
                    }
                }
                const accPlan = document.getElementById('acc-plan');
                if (accPlan) accPlan.textContent = plan;
            } catch(e) { /* 忽略錯誤，保持原樣 */ }
        }

        // 扣點（前端模擬）
        function tryConsumeCredits(agent){
            const userRaw = localStorage.getItem('user');
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            if (!isLoggedIn || !userRaw) return true; // 未登入就不扣，直接通過
            const u = JSON.parse(userRaw);
            const cost = CREDIT_COSTS[agent] || 0;
            if ((u.credits ?? 0) < cost) {
                showToast(`點數不足，無法執行（需要 ${cost} 點）`, 'error');
                return false;
            }
            u.credits = (u.credits ?? 0) - cost;
            localStorage.setItem('user', JSON.stringify(u));
            const navC = document.getElementById('nav-credits'); if (navC) navC.textContent = u.credits;
            const accC = document.getElementById('acc-credits'); if (accC) accC.textContent = u.credits;
            showToast(`已扣點 ${cost}，剩餘 ${u.credits}`, 'success');
            return true;
        }

        // 測試輔助：在瀏覽器 Console 可呼叫下列方法模擬
        window.setCredits = function(n){
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const userRaw = localStorage.getItem('user');
            if (!isLoggedIn || !userRaw) { showToast('請先登入再設定點數', 'error'); return; }
            const u = JSON.parse(userRaw); u.credits = Number(n)||0; localStorage.setItem('user', JSON.stringify(u));
            const navC = document.getElementById('nav-credits'); if (navC) navC.textContent = u.credits;
            const accC = document.getElementById('acc-credits'); if (accC) accC.textContent = u.credits;
            showToast(`已設定點數為 ${u.credits}`, 'success');
        };
        window.getCredits = function(){
            const userRaw = localStorage.getItem('user');
            const u = userRaw ? JSON.parse(userRaw) : null;
            return u?.credits ?? null;
        };
        window.mockConsume = function(agent){
            if (!tryConsumeCredits(agent||'topics')) return false; return window.getCredits();
        };

        // 共用聊天邏輯（前端模擬）
        function initChats() {
            async function callBackend(agent, content) {
                try {
                    const user = JSON.parse(localStorage.getItem('user') || '{}');
                    const userId = user.id || 'web';
                    const res = await fetch(`${API_BASE}/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: userId,
                            agent_type: agent,
                            messages: [{ role: 'user', content }]
                        })
                    });
                    const data = await res.json();
                    const msg = data.assistant_message || '（後端已回覆，但無內容）';
                    // 將 AI 回覆同步到對應結果區塊（段落分明）
                    try {
                        if (agent === 'script') {
                            const preview = document.getElementById('script-preview');
                            if (preview) {
                                document.getElementById('script-empty').classList.add('hidden');
                                document.getElementById('script-result').classList.remove('hidden');
                                const ctn = document.getElementById('script-content');
                                if (ctn) ctn.textContent = msg; // whitespace-pre-line 已在樣式
                                preview.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        } else if (agent === 'positioning') {
                            const area = document.getElementById('positioning-result');
                            if (area) {
                                area.classList.remove('hidden');
                                // 解析回覆中的三個區塊（品牌定位 / 語氣守則 / 執行建議）
                                let summary = msg;
                                let toneTxt = '';
                                let execTxt = '';
                                const toneIdx = msg.indexOf('語氣守則');
                                const execIdx = msg.indexOf('執行建議');
                                if (toneIdx !== -1) {
                                    summary = msg.slice(0, toneIdx).trim();
                                    if (execIdx !== -1) {
                                        toneTxt = msg.slice(toneIdx).replace(/^語氣守則\s*[:：]?\s*/,'');
                                        toneTxt = toneTxt.slice(0, Math.max(0, toneTxt.indexOf('執行建議'))).trim();
                                    } else {
                                        toneTxt = msg.slice(toneIdx).replace(/^語氣守則\s*[:：]?\s*/,'').trim();
                                    }
                                }
                                if (execIdx !== -1) {
                                    execTxt = msg.slice(execIdx).replace(/^執行建議\s*[:：]?\s*/,'').trim();
                                }

                                // 若仍無執行建議，提供前端 fallback（避免空白）
                                if (!execTxt) {
                                    const industry = (document.getElementById('industry')?.value || '').trim();
                                    const audience = (document.getElementById('audience')?.value || '').trim();
                                    const pains = (document.getElementById('pains')?.value || '').trim();
                                    const lines = [
                                        `內容節奏：每週 3-4 支短片；開頭 2~3 秒破題，結尾加 CTA。`,
                                        `主題安排：以「${pains || '用戶痛點'}」為核心，結合 ${industry || '你的產業'} 案例與實作示範。`,
                                        `平台策略：優先經營 ${audience || '目標受眾'} 常用的平台，固定欄位（教學/案例/QA）輪播。`
                                    ];
                                    execTxt = lines.join('\n');
                                }

                                // 去除重複行（例如重複的「發文頻率」）
                                const dedup = [];
                                const seen = new Set();
                                execTxt.split(/\r?\n/).forEach(l => {
                                    const t = l.trim();
                                    if (!t) return;
                                    const key = t.replace(/^[📌•\-\d\s]+/, '').replace(/：|:/, ':');
                                    if (!seen.has(key)) { seen.add(key); dedup.push(t); }
                                });
                                execTxt = dedup.join('\n');

                                const s = document.getElementById('positioning-summary');
                                if (s) s.textContent = summary || msg;
                                const t = document.getElementById('tone-guidelines');
                                if (t && toneTxt) t.textContent = toneTxt;
                                const e = document.getElementById('execution-suggestions');
                                if (e) e.textContent = execTxt;
                                document.getElementById('positioning-loading')?.classList.add('hidden');
                            }
                        } else if (agent === 'topics') {
                            const area = document.getElementById('ideation-result');
                            const cards = document.getElementById('ideation-cards');
                            if (area && cards) {
                                area.classList.remove('hidden');
                                const card = document.createElement('div');
                                card.className = 'bg-white dark:bg-gray-800 rounded-lg shadow p-4 space-y-2';
                                card.innerHTML = `<div class="font-semibold text-gray-900 dark:text-white mb-1">AI 生成建議</div><div class="text-sm text-gray-600 dark:text-gray-400 whitespace-pre-line">${msg}</div>`;
                                cards.prepend(card);
                                area.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        }
                    } catch (_) {}
                    return msg;
                } catch (e) {
                    return '（後端不可用，這是前端示範回覆）';
                }
            }

            function bindChat(sendId, inputId, boxId, agent) {
                const send = document.getElementById(sendId);
                const input = document.getElementById(inputId);
                const box = document.getElementById(boxId);
                if (!send || !input || !box) return;
                
                function formatAIResponse(text) {
                    // 將AI回覆格式化為段落分明，使用emoji做段落分配
                    let formatted = text;
                    
                    // 常見的段落分隔符號
                    const separators = [
                        { pattern: /\n\n/g, emoji: '📝' },
                        { pattern: /\n/g, emoji: '💡' },
                        { pattern: /。/g, emoji: '✨' },
                        { pattern: /！/g, emoji: '🎯' },
                        { pattern: /？/g, emoji: '🤔' }
                    ];
                    
                    // 先處理雙換行（段落分隔）
                    formatted = formatted.replace(/\n\n+/g, '\n\n📝 ');
                    
                    // 處理單換行
                    formatted = formatted.replace(/\n(?!\n)/g, '\n💡 ');
                    
                    // 處理句號後的段落
                    formatted = formatted.replace(/。([^。！？\n])/g, '。\n✨ $1');
                    
                    // 處理驚嘆號後的段落
                    formatted = formatted.replace(/！([^。！？\n])/g, '！\n🎯 $1');
                    
                    // 處理問號後的段落
                    formatted = formatted.replace(/？([^。！？\n])/g, '？\n🤔 $1');
                    
                    // 確保每個段落都有適當的間距
                    formatted = formatted.replace(/([📝💡✨🎯🤔]) /g, '$1 ');
                    
                    return formatted;
                }
                
                function append(role, text) {
                    const item = document.createElement('div');
                    item.className = role === 'user' ? 'text-right mb-3' : 'text-left mb-3';
                    const bubble = document.createElement('div');
                    bubble.className = `inline-block px-4 py-3 rounded-lg max-w-[85%] ${role==='user'?'bg-blue-50 text-blue-900':'bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600'} shadow-sm`;
                    
                    if (role === 'ai') {
                        // AI回覆使用格式化的內容
                        const formattedText = formatAIResponse(text);
                        bubble.innerHTML = `<div class="whitespace-pre-line text-sm leading-relaxed">${formattedText}</div>`;
                    } else {
                        // 用戶訊息保持原樣
                        bubble.textContent = text;
                    }
                    
                    item.appendChild(bubble);
                    box.appendChild(item);
                    box.scrollTop = box.scrollHeight;
                }
                
                function appendPending() {
                    const item = document.createElement('div');
                    item.className = 'text-left mb-3';
                    const bubble = document.createElement('div');
                    bubble.className = 'inline-block px-4 py-3 rounded-lg max-w-[85%] bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 shadow-sm flex items-center gap-2';
                    bubble.innerHTML = `<svg class="loading-spinner w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v2m0 12v2m8-8h-2M6 12H4m13.657 6.343l-1.414-1.414M7.757 7.757L6.343 6.343m12.728 0l-1.414 1.414M7.757 16.243l-1.414 1.414"></path></svg><span class="text-sm">AI 回覆中...</span>`;
                    item.appendChild(bubble);
                    box.appendChild(item);
                    box.scrollTop = box.scrollHeight;
                    return item;
                }
                
                send.addEventListener('click', () => {
                    const v = input.value.trim();
                    if (!v) return;
                    // 扣點（若不足則阻擋）
                    if (!tryConsumeCredits(agent)) return;
                    append('user', v);
                    input.value = '';
                    const pending = appendPending();
                    callBackend(agent, v)
                        .then(msg => {
                            if (pending && pending.parentNode) pending.parentNode.removeChild(pending);
                            append('ai', msg);
                        })
                        .catch(() => {
                            if (pending && pending.parentNode) pending.parentNode.removeChild(pending);
                            append('ai', '抱歉，目前系統較繁忙，請稍後再試。');
                        });
                });
                // Enter 送出（Shift+Enter 不送出）
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        const v = input.value.trim();
                        if (v) {
                            send.click();
                        }
                    }
                });
            }
            bindChat('chat-send-positioning','chat-input-positioning','chat-positioning','positioning');
            bindChat('chat-send-ideation','chat-input-ideation','chat-ideation','topics');
            bindChat('chat-send-script','chat-input-script','chat-script','script');

            // 清空對話功能
            const clearBtns = [
                {btn: 'chat-clear-positioning', box: 'chat-positioning'},
                {btn: 'chat-clear-ideation', box: 'chat-ideation'},
                {btn: 'chat-clear-script', box: 'chat-script'}
            ];
            clearBtns.forEach(({btn, box}) => {
                const clearBtn = document.getElementById(btn);
                const chatBox = document.getElementById(box);
                if (clearBtn && chatBox) {
                    clearBtn.addEventListener('click', () => chatBox.innerHTML = '');
                }
            });

            // 快速按鈕功能
            document.querySelectorAll('.chip-p').forEach(btn => {
                btn.addEventListener('click', () => {
                    const input = document.getElementById('chat-input-positioning');
                    const send = document.getElementById('chat-send-positioning');
                    const box = document.getElementById('chat-positioning');
                    if (input && send && box) {
                        // 如果是第一次使用，先顯示歡迎訊息
                        if (box.children.length === 0) {
                            const welcomeMsg = `🎯 歡迎使用AI短影音定位顧問！

📝 我是您的專業定位顧問，可以幫助您：
💡 分析業務類型與目標受眾
✨ 建立品牌定位與內容策略
🎯 規劃平台經營方向

🤔 請告訴我您的業務、產品或想法，我會逐步引導您建立完整的定位檔案！`;
                            
                            const item = document.createElement('div');
                            item.className = 'text-left mb-3';
                            const bubble = document.createElement('div');
                            bubble.className = 'inline-block px-4 py-3 rounded-lg max-w-[85%] bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 shadow-sm';
                            const safe = document.createElement('div');
                            safe.className = 'whitespace-pre-line text-sm leading-relaxed';
                            safe.textContent = welcomeMsg;
                            bubble.appendChild(safe);
                            item.appendChild(bubble);
                            box.appendChild(item);
                        }
                        
                        input.value = btn.textContent;
                        send.click();
                    }
                });
            });

            document.querySelectorAll('.chip-i').forEach(btn => {
                btn.addEventListener('click', () => {
                    const input = document.getElementById('chat-input-ideation');
                    const send = document.getElementById('chat-send-ideation');
                    const box = document.getElementById('chat-ideation');
                    if (input && send && box) {
                        // 如果是第一次使用，先顯示歡迎訊息
                        if (box.children.length === 0) {
                            const welcomeMsg = `💡 歡迎使用AI選題小助手！

📝 我可以為您提供：
✨ 個性化選題建議
🎯 熱點結合創意
💡 季節性內容規劃
🤔 多種選題類型篩選

📝 請告訴我您想要什麼類型的選題靈感，我會為您量身打造！`;
                            
                            const item = document.createElement('div');
                            item.className = 'text-left mb-3';
                            const bubble = document.createElement('div');
                            bubble.className = 'inline-block px-4 py-3 rounded-lg max-w-[85%] bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 shadow-sm';
                            const safe2 = document.createElement('div');
                            safe2.className = 'whitespace-pre-line text-sm leading-relaxed';
                            safe2.textContent = welcomeMsg;
                            bubble.appendChild(safe2);
                            item.appendChild(bubble);
                            box.appendChild(item);
                        }
                        
                        input.value = btn.textContent;
                        send.click();
                    }
                });
            });

            document.querySelectorAll('.chip-s').forEach(btn => {
                btn.addEventListener('click', () => {
                    const input = document.getElementById('chat-input-script');
                    const send = document.getElementById('chat-send-script');
                    const box = document.getElementById('chat-script');
                    if (input && send && box) {
                        // 如果是第一次使用，先顯示歡迎訊息
                        if (box.children.length === 0) {
                            const welcomeMsg = `📝 歡迎使用AI腳本生成大師！

🎯 我可以為您提供：
✨ 一鍵生成完整腳本
💡 引導模式逐步創作
📝 自由模式創意討論
🎯 多種模板結構選擇
🤔 30秒與60秒時長支援

📝 請告訴我您的主題、目標、受眾或平台，我會為您量身打造專業腳本！`;
                            
                            const item = document.createElement('div');
                            item.className = 'text-left mb-3';
                            const bubble = document.createElement('div');
                            bubble.className = 'inline-block px-4 py-3 rounded-lg max-w-[85%] bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 shadow-sm';
                            const safe3 = document.createElement('div');
                            safe3.className = 'whitespace-pre-line text-sm leading-relaxed';
                            safe3.textContent = welcomeMsg;
                            bubble.appendChild(safe3);
                            item.appendChild(bubble);
                            box.appendChild(item);
                        }
                        
                        input.value = btn.textContent;
                        send.click();
                    }
                });
            });
            // 進入頁面時在右側聊天框給開場介紹（只顯示一次）
            const ibox = document.getElementById('chat-ideation');
            if (ibox && !ibox.dataset.intro){
                const intro = '嗨！我是 AI 選題小助手。\n我會根據你的定位與需求，提供多元的內容角度與切入點。\n請在左側輸入主題和條數，或直接在下方跟我說你想討論的方向（例如熱門趨勢、教育分享…），我會即時回覆建議。';
                const wrap = document.createElement('div');
                wrap.className = 'text-left mb-3';
                wrap.innerHTML = `<div class=\"inline-block px-3 py-2 rounded-lg bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 shadow-sm whitespace-pre-line\">${intro}</div>`;
                ibox.appendChild(wrap); ibox.dataset.intro = '1';
            }
        }


        // Toast 通知系統
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-600';
            toast.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-2xl fade-in pointer-events-auto`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 2200);
        }

        // 定位助手功能
        function initPositioning() {
            const form = document.getElementById('positioning-form');
            const submitBtn = document.getElementById('positioning-submit');
            const submitText = submitBtn.querySelector('.submit-text');
            const loadingText = submitBtn.querySelector('.loading-text');

            // 語氣選項點擊處理
            document.querySelectorAll('input[name="tone"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    updateToneSelection();
                });
            });

            // 表單提交
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // 驗證必填欄位（tone 以 checked 驗證）
                const requiredFields = ['industry', 'audience', 'pains'];
                let isValid = true;
                
                requiredFields.forEach(field => {
                    const input = form.querySelector(`[name="${field}"]`);
                    if (!input || !input.value.trim()) {
                        isValid = false;
                        if (input) {
                            input.classList.add('border-red-500');
                            setTimeout(() => input.classList.remove('border-red-500'), 3000);
                        }
                    }
                });
                // tone（radio group）需至少選取一個
                const toneChecked = form.querySelector('input[name="tone"]:checked');
                if (!toneChecked) {
                    isValid = false;
                    try {
                        document.querySelectorAll('.tone-option').forEach(opt => {
                            const wrap = opt.parentElement;
                            if (wrap) {
                                wrap.classList.add('border-red-500');
                                setTimeout(() => wrap.classList.remove('border-red-500'), 3000);
                            }
                        });
                    } catch(_) {}
                }

                if (!isValid) {
                    showToast('請填寫所有必填欄位', 'error');
                    return;
                }

                // 顯示載入狀態
                submitBtn.disabled = true;
                submitText.classList.add('hidden');
                loadingText.classList.remove('hidden');

                try {
                    document.getElementById('positioning-result').classList.remove('hidden');
                    document.getElementById('positioning-loading').classList.remove('hidden');
                    await generatePositioningResult();
                } catch (err) {
                    console.warn('定位分析失敗，使用本地預設：', err);
                    try { generatePositioningResultLocal(); } catch(_) {}
                } finally {
                    document.getElementById('positioning-loading').classList.add('hidden');
                    submitBtn.disabled = false;
                    submitText.classList.remove('hidden');
                    loadingText.classList.add('hidden');
                }
            });

            // 快速示例按鈕
            document.querySelectorAll('.quick-example-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const examples = {
                        '科技新創公司': {
                            industry: '科技新創',
                            audience: '25-35歲科技工作者',
                            pains: '工作壓力大、時間管理困難、缺乏工作生活平衡',
                            tone: 'professional'
                        },
                        '線上教育平台': {
                            industry: '線上教育',
                            audience: '在職進修者',
                            pains: '學習時間有限、缺乏系統性學習方法、難以堅持',
                            tone: 'friendly'
                        },
                        '健康食品品牌': {
                            industry: '健康食品',
                            audience: '注重健康的消費者',
                            pains: '市面產品良莠不齊、缺乏專業指導、效果不明顯',
                            tone: 'authoritative'
                        }
                    };
                    
                    const exampleText = this.textContent.replace('快速示例：', '').trim();
                    const data = examples[exampleText];
                    
                    if (data) {
                        document.getElementById('industry').value = data.industry;
                        document.getElementById('audience').value = data.audience;
                        document.getElementById('pains').value = data.pains;
                        document.querySelector(`input[name="tone"][value="${data.tone}"]`).checked = true;
                        updateToneSelection();
                        showToast('已填入快速示例資料', 'success');
                    }
                });
            });

            // 進入頁面時在右側聊天框給開場介紹（只顯示一次）
            const box = document.getElementById('chat-positioning');
            if (box && !box.dataset.intro) {
                const intro = '嗨！我是你的 AI 影音定位顧問。\n我會根據你在左側填寫的資訊結合知識庫，幫你整理品牌定位、語氣守則與執行建議。\n填完表單按「生成定位摘要」，或在下方直接跟我聊天描述你的業務與受眾，我也能一步步引導你完成定位。';
                const wrap = document.createElement('div');
                wrap.className = 'text-left mb-3';
                wrap.innerHTML = `<div class="inline-block px-3 py-2 rounded-lg bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 shadow-sm whitespace-pre-line">${intro}</div>`;
                box.appendChild(wrap); box.dataset.intro = '1';
            }

            const tabChat = document.getElementById('tab-positioning-chat');
            const tabOne = document.getElementById('tab-positioning-oneclick');
            const chatCard = document.getElementById('positioning-chat-card');
            const onePanel = document.getElementById('positioning-oneclick-panel');
            if (tabChat && tabOne && chatCard && onePanel){
                tabChat.addEventListener('click', ()=>{
                    tabChat.classList.add('bg-primary','text-white');
                    tabOne.classList.remove('bg-primary','text-white');
                    chatCard.classList.remove('hidden');
                    onePanel.classList.add('hidden');
                });
                tabOne.addEventListener('click', ()=>{
                    tabOne.classList.add('bg-primary','text-white');
                    tabChat.classList.remove('bg-primary','text-white');
                    chatCard.classList.add('hidden');
                    onePanel.classList.remove('hidden');
                });
            }
        }

        // 讓右側聊天對話框高度與左側表單同高（桌面端）
        function adjustPositioningHeights() {
            try {
                const left = document.getElementById('positioning-left');
                const chatCard = document.getElementById('positioning-chat-card');
                if (!left || !chatCard) return;
                if (window.innerWidth >= 1024) { // lg 斷點
                    // 保留最小高度，避免高度被壓到 0 導致整張卡片消失
                    const target = Math.max(left.offsetHeight, 600);
                    chatCard.style.height = target + 'px';
                } else {
                    chatCard.style.height = '';
                }
            } catch (e) {
                // 忽略
            }
        }

        function updateToneSelection() {
            document.querySelectorAll('.tone-option').forEach(option => {
                const radio = option.parentElement.querySelector('input[type="radio"]');
                if (radio.checked) {
                    option.parentElement.classList.add('border-primary', 'bg-primary', 'text-white');
                    option.parentElement.classList.remove('border-gray-300', 'dark:border-gray-600');
                } else {
                    option.parentElement.classList.remove('border-primary', 'bg-primary', 'text-white');
                    option.parentElement.classList.add('border-gray-300', 'dark:border-gray-600');
                }
            });
        }

        async function generatePositioningResult() {
            const form = document.getElementById('positioning-form');
            const formData = new FormData(form);
            
            const industry = formData.get('industry');
            const audience = formData.get('audience');
            const pains = formData.get('pains');
            const tone = formData.get('tone');
            const competitors = formData.get('competitors');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const userId = user.id || 'web';

            // 後端：知識庫 + AI
            try {
                const res = await fetch(`${API_BASE}/agent/positioning/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        user_input: `產業：${industry}\n目標受眾：${audience}\n痛點：${pains}\n語氣：${tone}\n競品：${competitors || ''}`
                    })
                });
                const data = await res.json();
                if (data && !data.error) {
                    const ps = data.positioning_summary || data.summary || '';
                    const tg = data.tone_guidelines || data.tone || '';
                    let es = data.execution_suggestions || data.action_plan || data.recommendations || data.next_steps || '';
                    // 後備：嘗試從純文字回覆中擷取「執行建議」段落
                    if (!es && typeof data.assistant_message === 'string') {
                        const m = data.assistant_message.match(/執行建議[\s\S]*?$/);
                        es = m ? m[0].replace(/^執行建議\s*[:：]?\s*/,'') : '';
                    }
                    // 再後備：給出基本建議模板
                    if (!es) {
                        es = [
                            `內容節奏：每週 3-4 支短片；開頭 2~3 秒破題，結尾加 CTA。`,
                            `主題安排：以「${pains}」為核心痛點，結合 ${industry} 案例與實作示範。`,
                            `平台策略：${audience} 活躍的平台優先；固定欄位（教學/案例/QA）輪播。`
                        ].join('\n');
                    }
                    document.getElementById('positioning-summary').textContent = ps;
                    document.getElementById('tone-guidelines').textContent = tg;
                    document.getElementById('execution-suggestions').textContent = es;
                    document.getElementById('positioning-result').classList.remove('hidden');
                    showToast('定位分析完成！請查看右側結果', 'success');
                    setTimeout(() => {
                        document.getElementById('positioning-result').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 300);
                    return; // 成功
                }
                throw new Error('API 回傳錯誤');
            } catch (e) {
                throw e; // 讓外層 fallback
            }
        }

        // 本地預設（離線 fallback）
        function generatePositioningResultLocal() {
            const form = document.getElementById('positioning-form');
            const formData = new FormData(form);
            const industry = formData.get('industry');
            const audience = formData.get('audience');
            const pains = formData.get('pains');
            const tone = formData.get('tone');
            
            // 生成假資料結果（舊版）
            const positioningSummary = `基於您的產業「${industry}」和目標受眾「${audience}」，建議定位為專業的解決方案提供者。針對受眾面臨的「${pains}」問題，提供具有差異化的價值主張。`;
            
            const toneGuidelines = {
                professional: '使用專業術語，保持客觀理性，強調數據和事實，避免過於情緒化的表達。',
                friendly: '採用親切友善的語調，使用「我們」、「您」等親近用詞，適當使用問候語和鼓勵性語言。',
                humorous: '適度使用幽默元素，但保持專業性，避免過度玩笑，確保內容有價值且易於理解。',
                authoritative: '展現專業權威，使用確定的語氣，引用專業數據和案例，建立可信度和影響力。'
            };

            const executionSuggestions = `建議採用流量型與轉換型內容 7:3 配比，每週發布 3-5 次，專注於 Instagram Reels 平台。開場使用問句式鉤子，2-3秒換畫面，保持節奏緊湊。`;

            // 顯示結果
            document.getElementById('positioning-summary').textContent = positioningSummary;
            document.getElementById('tone-guidelines').textContent = toneGuidelines[tone];
            document.getElementById('execution-suggestions').textContent = executionSuggestions;
            
            document.getElementById('positioning-result').classList.remove('hidden');
            window.dispatchEvent(new CustomEvent('analyzePositioning', { detail: { industry, audience, pains, tone } }));
            showToast('定位分析完成！（離線預設）', 'success');
            setTimeout(() => {
                document.getElementById('positioning-result').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
        }

        // 選題助手功能
        function initIdeation() {
            const form = document.getElementById('ideation-form');
            const submitBtn = document.getElementById('ideation-submit');
            const submitText = submitBtn.querySelector('.submit-text');
            const loadingText = submitBtn.querySelector('.loading-text');

            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const topic = form.querySelector('[name="topic"]').value.trim();
                const count = parseInt(form.querySelector('[name="count"]').value);
                const dedupe = form.querySelector('[name="dedupe"]').checked;

                if (!topic || !count) {
                    showToast('請填寫主題和選擇產出條數', 'error');
                    return;
                }

                // 顯示載入狀態
                submitBtn.disabled = true;
                submitText.classList.add('hidden');
                loadingText.classList.remove('hidden');
                try{
                    document.getElementById('ideation-result').classList.remove('hidden');
                    document.getElementById('ideation-loading').classList.remove('hidden');
                    await generateIdeasFromAI(topic, count, dedupe);
                }catch(err){
                    console.warn('選題生成失敗，使用本地示例：', err);
                    generateIdeas(topic, count, dedupe);
                }finally{
                    document.getElementById('ideation-loading').classList.add('hidden');
                    submitBtn.disabled = false;
                    submitText.classList.remove('hidden');
                    loadingText.classList.add('hidden');
                }
            });

            // 快速示例按鈕
            document.querySelectorAll('#ideation-empty .quick-example-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const examples = {
                        '減肥方法': '減肥方法',
                        '投資理財': '投資理財', 
                        '職場技能': '職場技能'
                    };
                    
                    const exampleText = this.textContent.replace('快速示例：', '').trim();
                    const topic = examples[exampleText];
                    
                    if (topic) {
                        document.getElementById('topic').value = topic;
                        document.getElementById('count').value = '5';
                        showToast('已填入快速示例資料', 'success');
                    }
                });
            });
            // 讓右側高度與左側等高（桌面端）
            function adjustIdeationHeights(){
                try{
                    const left = document.getElementById('ideation-left');
                    const chat = document.getElementById('ideation-chat-card');
                    if(!left||!chat) return;
                    if (window.innerWidth >= 1024){
                        chat.style.height = Math.max(left.offsetHeight, 500) + 'px';
                    } else {
                        chat.style.height = '';
                    }
                }catch(e){}
            }
            adjustIdeationHeights();
            window.addEventListener('resize', adjustIdeationHeights);

            const tabChat = document.getElementById('tab-ideation-chat');
            const tabOne = document.getElementById('tab-ideation-oneclick');
            const chatCard = document.getElementById('ideation-chat-card');
            const onePanel = document.getElementById('ideation-oneclick-panel');
            if (tabChat && tabOne && chatCard && onePanel){
                tabChat.addEventListener('click', ()=>{
                    tabChat.classList.add('bg-primary','text-white');
                    tabOne.classList.remove('bg-primary','text-white');
                    chatCard.classList.remove('hidden');
                    onePanel.classList.add('hidden');
                });
                tabOne.addEventListener('click', ()=>{
                    tabOne.classList.add('bg-primary','text-white');
                    tabChat.classList.remove('bg-primary','text-white');
                    chatCard.classList.add('hidden');
                    onePanel.classList.remove('hidden');
                });
            }
        }

        // 後端：知識庫 + AI 產生選題
        async function generateIdeasFromAI(topic, count, dedupe){
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const userId = user.id || 'web';
            const res = await fetch(`${API_BASE}/agent/topics/suggest`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId, target_date: null })
            });
            const data = await res.json();
            if (!data || data.error){ throw new Error('topics api error'); }
            const ideasText = data.suggestions || data.reasoning || '';
            const cardsContainer = document.getElementById('ideation-cards');
            cardsContainer.innerHTML = '';
            const card = document.createElement('div');
            card.className = 'bg-white dark:bg-gray-800 rounded-lg shadow p-4 space-y-2';
            card.innerHTML = `<div class="font-semibold text-gray-900 dark:text-white mb-1">AI 生成建議</div><div class="text-sm text-gray-600 dark:text-gray-400 whitespace-pre-line">${ideasText}</div>`;
            cardsContainer.appendChild(card);
            document.getElementById('ideation-result').classList.remove('hidden');
            showToast('已產生 AI 選題建議！', 'success');
            setTimeout(()=>{ document.getElementById('ideation-result').scrollIntoView({behavior:'smooth', block:'start'}); }, 300);
        }

        function generateIdeas(topic, count, dedupe) {
            const ideas = [
                { hook: '你知道嗎？', angle: '數據統計', keyword: '驚人事實', why: '數據具有說服力，容易引起共鳴' },
                { hook: '為什麼會這樣？', angle: '原因分析', keyword: '深度解析', why: '滿足好奇心，提供深度內容' },
                { hook: '這樣做就對了！', angle: '實用技巧', keyword: '操作指南', why: '直接解決問題，實用性強' },
                { hook: '別再犯這個錯誤', angle: '常見誤區', keyword: '避坑指南', why: '警示性強，容易引起注意' },
                { hook: '成功案例分享', angle: '真實故事', keyword: '經驗分享', why: '真實性高，容易產生信任' },
                { hook: '專家都這樣說', angle: '權威觀點', keyword: '專業建議', why: '權威性強，增加可信度' },
                { hook: '最新趨勢來了', angle: '趨勢分析', keyword: '熱點話題', why: '時效性強，容易引起關注' },
                { hook: '對比一下就知道', angle: '對比分析', keyword: '優劣比較', why: '直觀易懂，幫助決策' },
                { hook: '小技巧大效果', angle: '實用技巧', keyword: '簡單方法', why: '操作簡單，效果明顯' },
                { hook: '背後的秘密', angle: '深度挖掘', keyword: '內幕揭秘', why: '神秘感強，滿足好奇心' }
            ];

            let selectedIdeas = ideas.slice(0, count);
            if (dedupe) {
                selectedIdeas = selectedIdeas.filter((idea, index, self) => 
                    index === self.findIndex(i => i.angle !== idea.angle)
                );
            }

            const cardsContainer = document.getElementById('ideation-cards');
            cardsContainer.innerHTML = '';

            selectedIdeas.forEach((idea, index) => {
                const card = document.createElement('div');
                card.className = 'bg-white dark:bg-gray-800 rounded-lg shadow p-4 space-y-2';
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">#${index + 1}</span>
                        <span class="text-xs bg-primary text-white px-2 py-1 rounded">${idea.keyword}</span>
                    </div>
                    <div class="font-semibold text-gray-900 dark:text-white">${idea.hook}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                        <strong>角度：</strong>${idea.angle}
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                        <strong>為什麼可行：</strong>${idea.why}
                    </div>
                `;
                cardsContainer.appendChild(card);
            });

            document.getElementById('ideation-result').classList.remove('hidden');

            // 派發事件
            window.dispatchEvent(new CustomEvent('generateIdeas', {
                detail: { topic, count, dedupe }
            }));

            showToast(`已產生 ${selectedIdeas.length} 個選題建議！請查看下方結果`, 'success');
            
            // 滾動到結果區域
            setTimeout(() => {
                document.getElementById('ideation-result').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }, 500);
        }

        // 腳本生成器功能
        function initScript() {
            // 模式選擇
            document.querySelectorAll('input[name="mode"]').forEach(radio => {
                radio.addEventListener('change', updateModeSelection);
            });

            // 模板選擇
            document.querySelectorAll('input[name="template"]').forEach(radio => {
                radio.addEventListener('change', updateTemplateSelection);
            });

            // 時長選擇
            document.querySelectorAll('input[name="duration"]').forEach(radio => {
                radio.addEventListener('change', updateDurationSelection);
            });

            // 套用設定按鈕
            document.getElementById('apply-settings').addEventListener('click', function() {
                const mode = document.querySelector('input[name="mode"]:checked').value;
                const template = document.querySelector('input[name="template"]:checked').value;
                const duration = document.querySelector('input[name="duration"]:checked').value;

                const modeText = mode === 'guided' ? '引導模式' : '自由模式';
                const templateText = `模板 ${template}`;
                const durationText = `${duration} 秒`;

                showToast(`已套用：${modeText}/${templateText}/${durationText}`, 'success');

                // 派發事件：先讓右側聊天框說明操作方式與下一步
                const intro = `已套用設定：${modeText}／${templateText}／${durationText}\n\n可在「AI 對話」與「一鍵生成」兩種方式間切換。\n- AI 對話：在下方輸入主題與條件，我會根據左側設定生成並優化腳本。\n- 一鍵生成：切到「一鍵生成」頁，直接輸入主題快速產出腳本。`;
                const box = document.getElementById('chat-script');
                if (box){
                    const wrap = document.createElement('div');
                    wrap.className = 'text-left mb-3';
                    wrap.innerHTML = `<div class="inline-block px-3 py-2 rounded-lg bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 shadow-sm whitespace-pre-line">${intro}</div>`;
                    box.appendChild(wrap); box.scrollTop = box.scrollHeight;
                }
                window.dispatchEvent(new CustomEvent('applySettings', { detail: { mode, template, duration: parseInt(duration) } }));
            });

            // 鍵盤導航
            initKeyboardNavigation();

            // 切換面板事件
            const tabChat = document.getElementById('tab-script-chat');
            const tabOne = document.getElementById('tab-script-oneclick');
            const panelChat = document.getElementById('script-chat-panel');
            const panelOne = document.getElementById('script-oneclick-panel');
            function activate(tab){
                if (tab === 'chat') {
                    panelChat.classList.remove('hidden');
                    panelOne.classList.add('hidden');
                    tabChat.classList.add('bg-primary','text-white');
                    tabOne.classList.remove('bg-primary','text-white');
                    tabOne.classList.add('border','border-gray-300','dark:border-gray-600');
                } else {
                    panelChat.classList.add('hidden');
                    panelOne.classList.remove('hidden');
                    tabOne.classList.remove('border','border-gray-300','dark:border-gray-600');
                    tabOne.classList.add('bg-primary','text-white');
                    tabChat.classList.remove('bg-primary','text-white');
                }
            }
            tabChat?.addEventListener('click', ()=>activate('chat'));
            tabOne?.addEventListener('click', ()=>activate('one'));
            activate('chat');

            // 一鍵生成：按鈕行為（顯示按鈕內轉圈圈與預覽結果）
            const oneBtn = document.getElementById('oneclick-generate');
            const oneTopic = document.getElementById('oneclick-topic');
            oneBtn?.addEventListener('click', async ()=>{
                const topic = (oneTopic?.value||'').trim();
                if (!topic){ showToast('請先輸入主題', 'error'); return; }

                // 讀取左側設定
                const mode = document.querySelector('input[name="mode"]:checked')?.value || 'guided';
                const template = document.querySelector('input[name="template"]:checked')?.value || 'A';
                const duration = parseInt(document.querySelector('input[name="duration"]:checked')?.value || '30');

                // 切換到一鍵生成頁，顯示下方預覽 loading
                activate('one');
                const preview = document.getElementById('script-preview');
                if (preview){
                    document.getElementById('script-empty')?.classList.add('hidden');
                    document.getElementById('script-result')?.classList.add('hidden');
                    document.getElementById('script-loading')?.classList.remove('hidden');
                }

                // 按鈕顯示轉圈圈
                const original = oneBtn.innerHTML;
                oneBtn.disabled = true;
                oneBtn.innerHTML = `<svg class="loading-spinner w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg> 生成中...`;

                try{
                    // 嘗試呼叫後端 /chat（agent: script），失敗則本地生成
                    const user = JSON.parse(localStorage.getItem('user') || '{}');
                    const userId = user.id || 'web';
                    const prompt = `主題：${topic}\n模板：${template}\n時長：${duration}秒\n模式：${mode}`;
                    let scriptText = '';
                    try{
                        const res = await fetch(`${API_BASE}/chat`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_id: userId, agent_type: 'script', messages: [{ role:'user', content: prompt }] }) });
                        const data = await res.json();
                        scriptText = (data && data.assistant_message) ? data.assistant_message : '';
                    }catch(_){ /* 後端不可用時走本地 */ }

                    if (!scriptText){
                        // 本地生成
                        scriptText = generateScriptContent(template, duration);
                    }

                    // 更新預覽
                    document.getElementById('script-loading')?.classList.add('hidden');
                    const modeText = mode === 'guided' ? '引導模式' : '自由模式';
                    const templateText = `模板 ${template}`;
                    const durationText = `${duration} 秒`;
                    const m = document.getElementById('script-mode'); if (m) m.textContent = modeText;
                    const t = document.getElementById('script-template'); if (t) t.textContent = templateText;
                    const d = document.getElementById('script-duration'); if (d) d.textContent = durationText;
                    const c = document.getElementById('script-content'); if (c) c.textContent = scriptText;
                    document.getElementById('script-result')?.classList.remove('hidden');
                    showToast('腳本已生成，請查看預覽', 'success');
                    setTimeout(()=>{ document.getElementById('script-result')?.scrollIntoView({behavior:'smooth', block:'start'}); }, 200);
                } finally {
                    // 還原按鈕
                    oneBtn.disabled = false;
                    oneBtn.innerHTML = original;
                }
            });
        }

        function updateModeSelection() {
            document.querySelectorAll('.mode-option').forEach(option => {
                const radio = option.parentElement.querySelector('input[type="radio"]');
                if (radio.checked) {
                    option.classList.add('border-primary', 'bg-primary', 'text-white');
                    option.classList.remove('border-gray-300', 'dark:border-gray-600');
                } else {
                    option.classList.remove('border-primary', 'bg-primary', 'text-white');
                    option.classList.add('border-gray-300', 'dark:border-gray-600');
                }
            });
        }

        function updateTemplateSelection() {
            document.querySelectorAll('.template-card').forEach(card => {
                const radio = card.parentElement.querySelector('input[type="radio"]');
                if (radio.checked) {
                    card.classList.add('border-primary', 'bg-primary', 'text-white');
                    card.classList.remove('border-gray-300', 'dark:border-gray-600');
                } else {
                    card.classList.remove('border-primary', 'bg-primary', 'text-white');
                    card.classList.add('border-gray-300', 'dark:border-gray-600');
                }
            });
        }

        function updateDurationSelection() {
            document.querySelectorAll('.duration-option').forEach(option => {
                const radio = option.parentElement.querySelector('input[type="radio"]');
                if (radio.checked) {
                    option.classList.add('border-primary', 'bg-primary', 'text-white');
                    option.classList.remove('border-gray-300', 'dark:border-gray-600');
                } else {
                    option.classList.remove('border-primary', 'bg-primary', 'text-white');
                    option.classList.add('border-gray-300', 'dark:border-gray-600');
                }
            });
        }

        function generateScriptPreview(mode, template, duration) {
            const modeText = mode === 'guided' ? '引導模式' : '自由模式';
            const templateText = `模板 ${template}`;
            const durationText = `${duration} 秒`;

            document.getElementById('script-mode').textContent = modeText;
            document.getElementById('script-template').textContent = templateText;
            document.getElementById('script-duration').textContent = durationText;

            // 生成假腳本內容
            document.getElementById('script-loading').classList.remove('hidden');
            const scriptContent = generateScriptContent(template, duration);
            document.getElementById('script-content').textContent = scriptContent;

            document.getElementById('script-empty').classList.add('hidden');
            document.getElementById('script-result').classList.remove('hidden');
            
            showToast('腳本生成完成！請查看下方結果', 'success');
            
            // 滾動到結果區域
            setTimeout(() => {
                document.getElementById('script-result').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }, 500);
            document.getElementById('script-loading').classList.add('hidden');
        }

        function generateScriptContent(template, duration) {
            const templates = {
                A: {
                    title: '三段式腳本',
                    content: `開頭（0-${Math.floor(duration * 0.2)}秒）：
大家好，今天要分享一個重要主題...

主體（${Math.floor(duration * 0.2)}-${Math.floor(duration * 0.8)}秒）：
首先，我們來看看...其次...最後...

結尾（${Math.floor(duration * 0.8)}-${duration}秒）：
總結一下，記住這三個重點...`
                },
                B: {
                    title: '問題解決腳本',
                    content: `問題（0-${Math.floor(duration * 0.3)}秒）：
你是否遇到這樣的困擾...

分析（${Math.floor(duration * 0.3)}-${Math.floor(duration * 0.7)}秒）：
這個問題的根本原因是...

解決（${Math.floor(duration * 0.7)}-${duration}秒）：
解決方案很簡單，只需要...`
                },
                C: {
                    title: 'Before-After 腳本',
                    content: `Before（0-${Math.floor(duration * 0.4)}秒）：
以前的我總是...

After（${Math.floor(duration * 0.4)}-${Math.floor(duration * 0.8)}秒）：
現在的我學會了...

轉變（${Math.floor(duration * 0.8)}-${duration}秒）：
關鍵就在於...`
                },
                D: {
                    title: '教學腳本',
                    content: `介紹（0-${Math.floor(duration * 0.2)}秒）：
今天教大家一個實用技巧...

步驟一（${Math.floor(duration * 0.2)}-${Math.floor(duration * 0.4)}秒）：
第一步...

步驟二（${Math.floor(duration * 0.4)}-${Math.floor(duration * 0.6)}秒）：
第二步...

步驟三（${Math.floor(duration * 0.6)}-${Math.floor(duration * 0.8)}秒）：
第三步...

總結（${Math.floor(duration * 0.8)}-${duration}秒）：
記住這三個步驟...`
                },
                E: {
                    title: '故事腳本',
                    content: `開場（0-${Math.floor(duration * 0.2)}秒）：
讓我分享一個真實故事...

故事（${Math.floor(duration * 0.2)}-${Math.floor(duration * 0.7)}秒）：
有一天...當時我...結果...

啟發（${Math.floor(duration * 0.7)}-${duration}秒）：
這個故事告訴我們...`
                },
                F: {
                    title: '爆點連發腳本',
                    content: `爆點一（0-${Math.floor(duration * 0.25)}秒）：
你知道嗎？驚人事實...

爆點二（${Math.floor(duration * 0.25)}-${Math.floor(duration * 0.5)}秒）：
更驚人的是...

爆點三（${Math.floor(duration * 0.5)}-${Math.floor(duration * 0.75)}秒）：
最關鍵的是...

行動（${Math.floor(duration * 0.75)}-${duration}秒）：
現在就開始...`
                }
            };

            return templates[template].content;
        }

        // 鍵盤導航功能
        function initKeyboardNavigation() {
            // 為所有可選元素添加 tabindex
            document.querySelectorAll('input[type="radio"], button, a').forEach(el => {
                if (!el.hasAttribute('tabindex')) {
                    el.setAttribute('tabindex', '0');
                }
            });

            // 處理鍵盤事件
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    const activeElement = document.activeElement;
                    if (activeElement && activeElement.tagName === 'LABEL') {
                        e.preventDefault();
                        const radio = activeElement.querySelector('input[type="radio"]');
                        if (radio) {
                            radio.checked = true;
                            radio.dispatchEvent(new Event('change'));
                        }
                    }
                }
            });
        }

        // 資料儲存與載入
        function saveFormData() {
            const forms = ['positioning-form', 'ideation-form'];
            forms.forEach(formId => {
                const form = document.getElementById(formId);
                if (form) {
                    const formData = new FormData(form);
                    const data = {};
                    for (let [key, value] of formData.entries()) {
                        data[key] = value;
                    }
                    sessionStorage.setItem(formId, JSON.stringify(data));
                }
            });
        }

        function loadStoredData() {
            const forms = ['positioning-form', 'ideation-form'];
            forms.forEach(formId => {
                const stored = sessionStorage.getItem(formId);
                if (stored) {
                    try {
                        const data = JSON.parse(stored);
                        const form = document.getElementById(formId);
                        if (form) {
                            Object.keys(data).forEach(key => {
                                const input = form.querySelector(`[name="${key}"]`);
                                if (input) {
                                    if (input.type === 'radio') {
                                        if (input.value === data[key]) {
                                            input.checked = true;
                                        }
                                    } else {
                                        input.value = data[key];
                                    }
                                }
                            });
                            
                            // 更新視覺狀態
                            if (formId === 'positioning-form') {
                                updateToneSelection();
                            }
                        }
                    } catch (e) {
                        console.warn('無法載入儲存的表單資料:', e);
                    }
                }
            });
        }

        // 定期儲存表單資料
        setInterval(saveFormData, 2000);

        // 頁面切換時儲存資料
        document.addEventListener('click', function(e) {
            if (e.target.matches('a[href^="#!"]') || e.target.closest('a[href^="#!"]')) {
                setTimeout(saveFormData, 100);
            }
        });
    </script>

    <!-- 
    後端串接事件監聽範例：
    
    // 監聽定位分析事件
    window.addEventListener('analyzePositioning', function(event) {
        const { industry, audience, pains, tone, competitors } = event.detail;
        
        // 發送 API 請求
        fetch('/api/analyze-positioning', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ industry, audience, pains, tone, competitors })
        })
        .then(response => response.json())
        .then(data => {
            // 更新 UI 顯示結果
            document.getElementById('positioning-summary').textContent = data.summary;
            document.getElementById('tone-guidelines').textContent = data.guidelines;
        })
        .catch(error => {
            console.error('定位分析失敗:', error);
            showToast('分析失敗，請稍後再試', 'error');
        });
    });

    // 監聽選題生成事件
    window.addEventListener('generateIdeas', function(event) {
        const { topic, count, dedupe } = event.detail;
        
        fetch('/api/generate-ideas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ topic, count, dedupe })
        })
        .then(response => response.json())
        .then(data => {
            // 更新選題卡片
            updateIdeationCards(data.ideas);
        })
        .catch(error => {
            console.error('選題生成失敗:', error);
            showToast('生成失敗，請稍後再試', 'error');
        });
    });

    // 監聽腳本設定套用事件
    window.addEventListener('applySettings', function(event) {
        const { mode, template, duration } = event.detail;
        
        fetch('/api/generate-script', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode, template, duration })
        })
        .then(response => response.json())
        .then(data => {
            // 更新腳本預覽
            document.getElementById('script-content').textContent = data.script;
        })
        .catch(error => {
            console.error('腳本生成失敗:', error);
            showToast('生成失敗，請稍後再試', 'error');
        });
    });
    -->
</body>
</html>
