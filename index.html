<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>AIçŸ­å½±éŸ³é¡§å•ï½œAIJobæ™ºèƒ½</title>
  <style>
    :root{
      --primary:#2563eb; --primary-600:#1d4ed8;
      --bg:#ffffff; --muted:#f5f7fb; --border:#e6e8ef;
      --text:#0f172a; --text-muted:#64748b;
      --ok:#16a34a; --err:#dc2626; --shadow:0 6px 18px rgba(2,12,27,0.08);
      --radius:14px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC, Helvetica Neue, Arial;
      background:var(--bg); color:var(--text); line-height:1.6; font-size:16px;
      -webkit-text-size-adjust:100%;
      touch-action:manipulation;
    }
    a{ color:var(--primary); text-decoration:none; }
    .container{ max-width:1200px; margin:0 auto; padding:16px; }

    .topbar{ position:sticky; top:0; z-index:50; background:rgba(255,255,255,0.9); backdrop-filter:saturate(180%) blur(8px); border-bottom:1px solid var(--border); }
    .topbar-inner{ display:flex; flex-direction:column; align-items:center; gap:10px; padding:12px 16px; }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:800; font-size:22px; }
    .brand .logo{ width:20px; height:20px; border-radius:4px; object-fit:cover; box-shadow:0 0 0 3px rgba(37,99,235,0.15); }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .tab{ padding:8px 12px; border:1px solid var(--border); border-radius:999px; background:#fff; color:var(--text); cursor:pointer; transition:all .15s; font-weight:600; font-size:14px; }
    .tab.active{ background:var(--primary); border-color:var(--primary); color:#fff; box-shadow:var(--shadow); }

    .hero{ display:grid; grid-template-columns:1fr; gap:16px; padding:20px 16px; }
    .hero-title{ font-size:28px; font-weight:800; letter-spacing:.2px; text-align:left; }
    .hero-sub{ color:var(--text-muted); margin-top:4px; }

    .grid-cards{ display:grid; grid-template-columns:1fr; gap:16px; margin-top:20px; }
    .card{ background:linear-gradient(180deg,#fff,#f9fbff); border:1px solid var(--border); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow); display:flex; flex-direction:column; gap:12px; min-height:160px; }
    .card h3{ margin:0; font-size:20px; }
    .card p{ margin:0; color:var(--text-muted); }
    .card .actions{ margin-top:auto; display:flex; gap:10px; }

    .layout{ display:grid; grid-template-columns:7fr 5fr; gap:16px; padding:16px; }
    .panel{ background:#fff; border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; }
    .panel-head{ padding:12px 14px; border-bottom:1px solid var(--border); display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; }
    .panel-title{ font-weight:800; display:flex; align-items:center; gap:8px; }

    .settings{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .settings .field{ display:flex; align-items:center; gap:6px; background:var(--muted); border:1px solid var(--border); border-radius:10px; padding:6px 8px; }
    .settings input[type="text"], .settings select, .settings input[type="number"]{ border:none; background:transparent; outline:none; padding:4px; min-width:90px; font-size:16px; }
    .settings .check{ display:flex; align-items:center; gap:6px; }
    .settings.collapsed{ display:none; }
    .toggle-settings{ margin-left:auto; border:1px solid var(--border); background:#fff; padding:6px 10px; border-radius:10px; cursor:pointer; font-weight:700; font-size:13px; display:inline-flex; align-items:center; gap:6px; }
    .toggle-settings:hover{ box-shadow:var(--shadow); }
    .chev{ display:inline-block; transition:transform .2s ease; }
    .toggle-settings[aria-expanded="false"] .chev{ transform:rotate(-90deg); }

    .chat-wrap{ display:flex; flex-direction:column; height:62vh; }
    .chat-scroll{ flex:1; overflow-y:auto; overflow-x:hidden; padding:14px; display:flex; flex-direction:column; gap:10px; background:var(--muted); }
    .msg{ max-width:80%; padding:10px 12px; border-radius:14px; border:1px solid var(--border); background:#fff; box-shadow:var(--shadow); }
    .msg.user{ margin-left:auto; background:#eef4ff; border-color:#dbe6ff; }
    .msg .meta{ font-size:12px; color:var(--text-muted); margin-bottom:4px; }
    .inputbar{ display:flex; gap:8px; padding:10px; border-top:1px solid var(--border); background:#fff; }
    .inputbar textarea{ flex:1; resize:none; border:1px solid var(--border); border-radius:12px; padding:10px 12px; min-height:46px; max-height:160px; font-size:16px; line-height:1.5; }
    .inputbar button{ flex-shrink:0; }
    textarea{ flex:1; resize:none; border:1px solid var(--border); border-radius:12px; padding:10px 12px; min-height:46px; max-height:160px; font-size:16px; line-height:1.5; }

    .right-wrap{ display:flex; flex-direction:column; height:62vh; }
    .right-scroll{ flex:1; overflow-y:auto; overflow-x:hidden; padding:14px; display:flex; flex-direction:column; gap:10px; background:var(--muted); }
    .toolbar{ display:flex; gap:8px; padding:10px; border-top:1px solid var(--border); background:#fff; flex-wrap:wrap; }

    .segment-card{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px; box-shadow:var(--shadow); }
    .segment-head{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:6px; }
    .seg-title{ font-weight:700; }
    .seg-meta{ color:var(--text-muted); font-size:13px; }
    .seg-actions{ display:flex; gap:6px; }

    .copy-card{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px; box-shadow:var(--shadow); }
    .copy-card h4{ margin:4px 0 8px; }
    .muted{ color:var(--text-muted); font-size:14px; }

    .chips{ display:flex; gap:8px; flex-wrap:wrap; padding:10px 14px; border-top:1px solid var(--border); background:#fff; }
    .chip{ padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#fff; cursor:pointer; font-size:13px; }
    .chip:hover{ border-color:var(--primary); color:var(--primary); }

    .btn{ padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:#fff; cursor:pointer; font-weight:700; font-size:15px; display:inline-flex; align-items:center; gap:6px; transition:all .15s; min-height:42px; }
    .btn:hover{ transform:translateY(-1px); box-shadow:var(--shadow); }
    .btn.primary{ background:var(--primary); border-color:var(--primary); color:#fff; }
    .btn.primary:disabled{ opacity:.6; cursor:not-allowed; }
    .btn.ghost{ background:transparent; }
    .btn.small{ padding:8px 10px; font-size:14px; min-height:38px; }
    .link-row{ display:flex; gap:8px; flex-wrap:wrap; }

    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:20px; background:#111827; color:#fff; padding:10px 14px; border-radius:10px; font-size:14px; box-shadow:var(--shadow); opacity:0; pointer-events:none; transition:opacity .25s; z-index:100; }
    .toast.show{ opacity:1; }

    /* AI è¼‰å…¥å‹•ç•«æ¨£å¼ */
    .loading-msg{ background:#f8fafc; border:1px solid #e2e8f0; }
    .loading-content{ display:flex; align-items:center; gap:12px; }
    .loading-dots{ display:flex; gap:4px; }
    .loading-dots span{ width:8px; height:8px; border-radius:50%; background:#3b82f6; animation:loading-bounce 1.4s ease-in-out infinite both; }
    .loading-dots span:nth-child(1){ animation-delay:-0.32s; }
    .loading-dots span:nth-child(2){ animation-delay:-0.16s; }
    .loading-dots span:nth-child(3){ animation-delay:0s; }
    .loading-text{ color:#64748b; font-style:italic; }
    @keyframes loading-bounce{ 0%, 80%, 100%{ transform:scale(0); } 40%{ transform:scale(1); } }

    /* æ ¼å¼åŒ–å…§å®¹æ¨£å¼ */
    .formatted-content{ line-height:1.6; }
    .formatted-content p{ margin:8px 0; }
    .formatted-content strong{ font-weight:600; color:#1e40af; }
    .formatted-content em{ font-style:italic; color:#7c3aed; }
    .formatted-content br{ margin:4px 0; }

    .site-footer{ border-top:1px solid var(--border); margin-top:24px; background:#fff; }
    .copyright{ color:var(--text-muted); font-size:14px; padding:6px 0 14px 0; text-align:center; }

    @media (min-width:880px){ .grid-cards{ grid-template-columns:repeat(2,1fr); } }
    @media (min-width:1200px){ .hero-title{ font-size:32px; } }
    @media (max-width:1199px){ .layout{ grid-template-columns:1fr; } }
    @media (max-width:767px){
      .chat-wrap,.right-wrap{ height:auto; max-height:64vh; }
      .toolbar{ display:none; }
      .settings{ gap:6px; }
      .btn{ min-height:44px; }
      .btn.small{ min-height:40px; }
    }

    /* æ–°å¢ï¼šæ¨¡å¼åˆ‡æ›èˆ‡æ¨¡æ¿é¢æ¿ */
    .mode-wrap{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .segctl{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .segctl .group{ display:flex; gap:6px; background:var(--muted); border:1px solid var(--border); border-radius:12px; padding:6px; }
    
    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 768px) {
      .chat-wrap, .right-wrap {
        height: 50vh;
        min-height: 300px;
      }
      
      .panel-head {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      
      .settings {
        width: 100%;
        justify-content: space-between;
      }
      
      .tabs {
        justify-content: center;
      }
      
      .btn {
        min-height: 38px;
        font-size: 14px;
        padding: 8px 12px;
      }
      
      .chips {
        justify-content: center;
      }
    }
    
    @media (max-width: 480px) {
      .left-wrap, .right-wrap {
        height: 45vh;
      }
      
      .btn {
        min-height: 36px;
        font-size: 12px;
        padding: 6px 10px;
      }
      
      .panel-title {
        font-size: 16px;
      }
      
      .brand {
        font-size: 18px;
      }
    }
    .segctl .group label{ 
      padding:8px 16px; 
      border-radius:8px; 
      cursor:pointer; 
      border:1px solid #e0e0e0; 
      background:#fff; 
      transition:all 0.2s ease;
      font-weight:500;
      writing-mode: horizontal-tb;
      text-orientation: mixed;
    }
    .segctl .group label:hover{
      border-color:#2196F3;
      background:#f5f5f5;
    }
    .segctl .group input{ display:none; }
    .segctl .group input:checked + span{ 
      background:var(--primary); 
      border:1px solid var(--primary); 
      color:#fff; 
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* å¥—ç”¨çµæ§‹æŒ‰éˆ•æ¨£å¼ - ç¢ºä¿å­—é«”ä¸å‚ç›´ */
    .segctl .group label span {
      writing-mode: horizontal-tb;
      text-orientation: mixed;
      transform: none;
      font-size: 14px;
      line-height: 1.2;
      display: inline-block;
    }
    
    /* è…³æœ¬åˆ†æ®µæ¨£å¼ */
    .script-segment {
      margin-bottom: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .segment-content {
      padding: 12px;
      background: #f8f9fa;
    }
    
    .segment-content .dialog,
    .segment-content .visual,
    .segment-content .cta {
      margin-bottom: 8px;
      line-height: 1.5;
    }
    
    .segment-content .dialog {
      color: #333;
    }
    
    .segment-content .visual {
      color: #666;
      font-style: italic;
    }
    
    .segment-content .cta {
      color: #2196F3;
      font-weight: 600;
    }
    
    /* å®šä½æª”æ¡ˆæ¬„ä½æ¨£å¼ */
    .profile-field {
      margin-bottom: 8px;
      padding: 6px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .profile-field:last-of-type {
      border-bottom: none;
    }
    
    /* è…³æœ¬æ¨¡å¼æŒ‰éˆ•æ¨£å¼ - å¼·åˆ¶è¦†è“‹ */
    #oneClickScript,
    #guideMode,
    #freeMode {
      background: #2196F3 !important;
      color: white !important;
      border: none !important;
      padding: 8px 16px !important;
      border-radius: 6px !important;
      margin-right: 10px !important;
      cursor: pointer !important;
      font-weight: 600 !important;
      font-size: 14px !important;
      transition: all 0.2s ease !important;
    }
    
    #oneClickScript:hover,
    #guideMode:hover,
    #freeMode:hover {
      background: #1976D2 !important;
      transform: translateY(-1px) !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
    }
    
    /* é¸ä¸­ç‹€æ…‹ */
    #oneClickScript.active,
    #guideMode.active,
    #freeMode.active {
      background: #1976D2 !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner container">
      <div class="brand">
        <img class="logo" alt="AIJob logo" src="https://static.wixstatic.com/media/9705bb_4edf6b22c58f4275bc9bae42891acb49~mv2.png"/>
        AIçŸ­å½±éŸ³é¡§å•ï½œAIJobæ™ºèƒ½
      </div>
      <div class="tabs">
        <button class="tab active" data-page="home">é¦–é </button>
        <button class="tab" data-page="positioning">AIå½±éŸ³å®šä½é¡§å•</button>
        <button class="tab" data-page="topics">AIé¸é¡Œå°åŠ©æ‰‹</button>
        <button class="tab" data-page="script">AIè…³æœ¬ç”Ÿæˆå¤§å¸«</button>
        <button class="tab" data-page="guide">èªªæ˜/æŒ‡å—</button>
      </div>
    </div>
  </div>

  <!-- é¦–é  -->
  <main id="page-home" class="container">
    <section class="hero">
      <div>
        <div class="hero-title">é¸æ“‡ä½ çš„ä»»å‹™</div>
        <div class="hero-sub">è¼¸å…¥ä¸»é¡Œâ†’AI æ¨ç†è¡Œæ¥­çˆ†æ¬¾è¦ç´ â†’èˆ‡ä½ å°è©±å…±å‰µã€‚ä»‹é¢ç°¡ç´„ã€è¡Œå‹•å‹å–„ã€‚</div>
      </div>
      <div class="grid-cards">
        <article class="card">
          <h3>ğŸ¯ AIå½±éŸ³å®šä½é¡§å•</h3>
          <p>é‡æ¸…ä½ çš„å¸³è™Ÿæ–¹å‘ã€ç›®æ¨™å—çœ¾ã€å“ç‰Œå®šä½ã€‚å»ºç«‹å®Œæ•´çš„å…§å®¹ç­–ç•¥åŸºç¤ï¼Œè®“å¾ŒçºŒå‰µä½œæ›´æœ‰æ–¹å‘ã€‚</p>
          <div class="actions">
            <button class="btn primary" data-go="positioning">é–‹å§‹å®šä½åˆ†æ</button>
            <button class="btn ghost" data-go="guide">çœ‹æ“ä½œèªªæ˜</button>
          </div>
        </article>
        <article class="card">
          <h3>ğŸ’¡ AIé¸é¡Œå°åŠ©æ‰‹</h3>
          <p>åŸºæ–¼ä½ çš„å®šä½æª”æ¡ˆï¼Œæ¯æ—¥æä¾›éˆæ„Ÿé¸é¡Œå»ºè­°ã€‚çµåˆç†±é»ã€å­£ç¯€æ€§èˆ‡ä½ çš„å“ç‰Œç‰¹è‰²ã€‚</p>
          <div class="actions">
            <button class="btn primary" data-go="topics">ç²å–é¸é¡Œéˆæ„Ÿ</button>
            <button class="btn ghost" data-go="guide">çœ‹æ“ä½œèªªæ˜</button>
          </div>
        </article>
        <article class="card">
          <h3>ğŸ“ AIè…³æœ¬ç”Ÿæˆå¤§å¸«</h3>
          <p>æ•´åˆè…³æœ¬èˆ‡æ–‡æ¡ˆåŠŸèƒ½ï¼ŒåŸºæ–¼ä½ çš„å®šä½èˆ‡è¨˜æ†¶ç”Ÿæˆå€‹æ€§åŒ–å…§å®¹ã€‚æ”¯æ´å¤šç¨®æ¨¡æ¿èˆ‡æ™‚é•·ã€‚</p>
          <div class="actions">
            <button class="btn primary" data-go="script">é–‹å§‹å‰µä½œ</button>
            <button class="btn ghost" data-go="guide">çœ‹æ“ä½œèªªæ˜</button>
          </div>
        </article>
      </div>

      <!-- å®¢è£½åŒ–æ™ºèƒ½é«” CTA -->
      <article class="card" style="margin-top:8px;">
        <h3>æƒ³è¦å®¢è£½åŒ–æ‚¨çš„çŸ­å½±éŸ³ AI æ™ºèƒ½é«”å—ï¼Ÿ</h3>
        <p class="muted">éœ€è¦å°ˆå±¬åŠŸèƒ½ã€å“ç‰Œèªæ°£ã€æ•´åˆå¾Œç«¯æˆ–æµç¨‹è‡ªå‹•åŒ–ï¼Ÿæˆ‘å€‘å¯å”åŠ©å¾è¦åŠƒåˆ°ä¸Šç·šã€‚</p>
        <div class="actions">
          <a class="btn primary" target="_blank" href="https://AIJobschool.short.gy/E49kA8">èˆ‡æˆ‘å€‘è¯ç¹«ï¼ˆLINE å®˜æ–¹ï¼‰</a>
        </div>
      </article>
      <div class="link-row">
        <a class="btn small" target="_blank" href="https://AIJobschool.short.gy/kBmUAL">AIJob YouTube</a>
        <a class="btn small" target="_blank" href="https://AIJobschool.short.gy/ytPY3U">AIJob å®˜æ–¹ç¶²ç«™</a>
        <a class="btn small" target="_blank" href="https://AIJobschool.short.gy/KCYu7z">AIJob è¡ŒéŠ·è‡ªå‹•åŒ–èª²ç¨‹</a>
        <a class="btn small" target="_blank" href="https://AIJobschool.short.gy/UUwpEG">AIJob Discordç¤¾ç¾¤è¨è«–</a>
        <a class="btn small" target="_blank" href="https://AIJobschool.short.gy/E49kA8">AIJob LINEå®˜æ–¹å¸³è™Ÿ</a>
      </div>
    </section>
  </main>

  <!-- å®šä½æ™ºèƒ½é«”é  -->
  <section id="page-positioning" class="container" style="display:none">
    <div class="layout">
      <div class="panel">
        <div class="panel-head">
          <div class="panel-title">ğŸ¯ AIå½±éŸ³å®šä½é¡§å•</div>
          <div class="settings">
            <button class="btn small" id="clearPositioningChat">æ¸…ç©ºå°è©±</button>
          </div>
        </div>
        <div class="chat-wrap">
          <div id="chatPositioning" class="chat-scroll"></div>
          <div class="chips" id="chipsPositioning">
            <span class="muted">å¿«é€Ÿå•é¡Œï¼š</span>
            <button class="chip" data-question="æˆ‘çš„å¸³è™Ÿæ˜¯OOO(å¡«å¯«æ‚¨çš„ç”¢å“æˆ–æœå‹™æˆ–ä¸»é¡Œ)ï¼Œæ‡‰è©²å°ˆæ³¨åœ¨å“ªå€‹é ˜åŸŸï¼Ÿ">æ¥­å‹™é¡å‹å®šä½</button>
            <button class="chip" data-question="æˆ‘çš„ç›®æ¨™å—çœ¾æ˜¯èª°ï¼Ÿä»–å€‘æœ‰ä»€éº¼ç‰¹å¾µå’Œç—›é»ï¼Ÿ">ç›®æ¨™å—çœ¾åˆ†æ</button>
            <button class="chip" data-question="æˆ‘çš„å“ç‰Œæ‡‰è©²å‚³é”ä»€éº¼å½¢è±¡å’Œèªæ°£ï¼Ÿ">å“ç‰Œå½¢è±¡å®šä½</button>
            <button class="chip" data-question="æˆ‘æ‡‰è©²åœ¨å“ªäº›å¹³å°ç¶“ç‡Ÿï¼Ÿç‚ºä»€éº¼ï¼Ÿ">å¹³å°ç­–ç•¥å»ºè­°</button>
            <button class="chip" data-question="æˆ‘çš„å…§å®¹ç›®æ¨™æ˜¯ä»€éº¼ï¼Ÿæƒ³è¦é”æˆä»€éº¼æ•ˆæœï¼Ÿ">å…§å®¹ç›®æ¨™è¨­å®š</button>
            <button class="chip" data-question="æˆ‘æ‡‰è©²å¤šä¹…ç™¼ä¸€æ¬¡æ–‡ï¼Ÿç™¼æ–‡é »ç‡å¦‚ä½•å®‰æ’ï¼Ÿ">ç™¼æ–‡é »ç‡è¦åŠƒ</button>
            <button class="chip primary" id="oneClickPositioning">ğŸš€ ä¸€éµç”Ÿæˆå®šä½</button>
          </div>
          <div class="inputbar">
            <textarea id="inputPositioning" placeholder="å‘Šè¨´æˆ‘ä½ çš„æ¥­å‹™ã€ç”¢å“ã€ç›®æ¨™æˆ–å›°æƒ‘..."></textarea>
            <button class="btn primary" id="sendPositioning">åˆ†æ</button>
            <button class="btn" id="cancelPositioning">åœæ­¢</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-head">
          <div class="panel-title">ğŸ“ å®šä½æª”æ¡ˆ</div>
          <div class="settings">
            <button class="btn small" id="saveProfile">å„²å­˜æª”æ¡ˆ</button>
          </div>
        </div>
        <div class="right-wrap">
          <div id="profileWrap" class="right-scroll">
            <div class="copy-card">
              <h4>ç”¨æˆ¶å®šä½æª”æ¡ˆ</h4>
              <div id="profileContent" class="muted">å°šæœªå»ºç«‹å®šä½æª”æ¡ˆï¼Œè«‹å…ˆèˆ‡AIå½±éŸ³å®šä½é¡§å•å°è©±ã€‚</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- é¸é¡Œæ™ºèƒ½é«”é  -->
  <section id="page-topics" class="container" style="display:none">
    <div class="layout">
      <div class="panel">
        <div class="panel-head">
          <div class="panel-title">ğŸ’¡ AIé¸é¡Œå°åŠ©æ‰‹</div>
          <div class="settings">
            <button class="btn small" id="refreshTopics">é‡æ–°ç”Ÿæˆ</button>
            <button class="btn small" id="viewTopicHistory">æ­·å²è¨˜éŒ„</button>
          </div>
        </div>
        <div class="chat-wrap">
          <div id="chatTopics" class="chat-scroll"></div>
          <div class="chips" id="chipsTopics">
            <span class="muted">é¸é¡Œé¡å‹ï¼š</span>
            <button class="chip" data-topic-type="trending">ç†±é–€è¶¨å‹¢</button>
            <button class="chip" data-topic-type="educational">æ•™è‚²åˆ†äº«</button>
            <button class="chip" data-topic-type="personal">å€‹äººæ•…äº‹</button>
            <button class="chip" data-topic-type="product">ç”¢å“ä»‹ç´¹</button>
          </div>
          <div class="inputbar">
            <textarea id="inputTopics" placeholder="å‘Šè¨´æˆ‘ä½ æƒ³è¦ä»€éº¼é¡å‹çš„é¸é¡Œéˆæ„Ÿ..."></textarea>
            <button class="btn primary" id="getTopics">ç²å–éˆæ„Ÿ</button>
            <button class="btn" id="cancelTopics">åœæ­¢</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-head">
          <div class="panel-title">ğŸ“… ä»Šæ—¥é¸é¡Œå»ºè­°</div>
          <div class="settings">
            <button class="btn small" id="copyAllTopics">è¤‡è£½å…¨éƒ¨</button>
          </div>
        </div>
        <div class="right-wrap">
          <div id="topicsWrap" class="right-scroll">
            <div class="copy-card">
              <h4>é¸é¡Œå»ºè­°</h4>
              <div id="topicsContent" class="muted">é»æ“Šã€Œç²å–éˆæ„Ÿã€é–‹å§‹ç”Ÿæˆé¸é¡Œå»ºè­°ã€‚</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- è…³æœ¬é  -->
  <section id="page-script" class="container" style="display:none">
    <div class="layout">
      <div class="panel">
        <div class="panel-head">
          <div class="panel-title">ğŸ“ AIè…³æœ¬ç”Ÿæˆå¤§å¸«</div>
          <div class="mode-wrap">
            <!-- æ¨¡å¼åˆ‡æ› -->
            <div class="segctl">
              <div class="group" id="modeGroup">
                <button class="mode-btn" id="oneClickScript">ğŸš€ ä¸€éµç”Ÿæˆè…³æœ¬</button>
                <button class="mode-btn" id="guideMode">âœï¸ å¼•å°æ¨¡å¼</button>
                <button class="mode-btn" id="freeMode">ğŸ’¬ è‡ªç”±æ¨¡å¼</button>
              </div>
            </div>
          </div>
        </div>

        <!-- å¼•å°æ¨¡å¼ï¼šæ¨¡æ¿èˆ‡æ™‚é•·ï¼ˆåƒ… guide é¡¯ç¤ºï¼‰ -->
        <div class="panel-head" id="guideBar" style="border-top:0; border-bottom:1px solid var(--border);">
          <div class="segctl">
            <div class="group" id="tplGroup" aria-label="æ¨¡æ¿çµæ§‹">
              <label><input type="radio" name="tpl" value="A" checked><span>A ä¸‰æ®µå¼</span></label>
              <label><input type="radio" name="tpl" value="B"><span>B å•é¡Œè§£æ±º</span></label>
              <label><input type="radio" name="tpl" value="C"><span>C Before-After</span></label>
              <label><input type="radio" name="tpl" value="D"><span>D æ•™å­¸</span></label>
              <label><input type="radio" name="tpl" value="E"><span>E æ•˜äº‹</span></label>
              <label><input type="radio" name="tpl" value="F"><span>F çˆ†é»é€£ç™¼</span></label>
            </div>
            <div class="group" id="durGroup" aria-label="æ™‚é•·">
              <label><input type="radio" name="dur" value="30" checked><span>30 ç§’</span></label>
              <label><input type="radio" name="dur" value="60"><span>60 ç§’</span></label>
            </div>
            <button class="btn small" id="btnStartGuide">å¥—ç”¨è¨­å®šä¸¦é–‹å§‹</button>
          </div>
        </div>


        <div class="chat-wrap">
          <div id="chatScript" class="chat-scroll"></div>

          <!-- å¿«é€Ÿæ¨¡æ¿/å¿«é€Ÿå•é¡Œ -->
          <div class="chips" id="chipsScript">
            <!-- å…§å®¹ç”± JS æ ¹æ“šæ¨¡å¼åˆ‡æ› -->
          </div>

          <div class="inputbar">
            <textarea id="inputScript" placeholder="è¼¸å…¥ä¸»é¡Œ/ç›®æ¨™/å—çœ¾/å¹³å°/æ™‚é•·/èªæ°£â€¦ï¼ˆæŒ‰éˆ•é€å‡ºï¼›Shift+Enter æ›è¡Œï¼‰"></textarea>
            <button class="btn primary" id="sendScript">é€å‡º</button>
            <button class="btn" id="cancelScript">åœæ­¢</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-head">
          <div class="panel-title">è…³æœ¬åˆ†æ®µ / æ™‚é–“è»¸</div>
          <div class="settings" style="gap:8px">
            <button class="btn small" id="copyAllScript">è¤‡è£½å…¨éƒ¨</button>
            <button class="btn small" id="clearScript">æ¸…ç©º</button>
          </div>
        </div>
        <div class="right-wrap">
          <div id="segmentsWrap" class="right-scroll"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- æ–‡æ¡ˆé ï¼ˆåŸæ¨£ä¿ç•™ï¼‰ -->
  <section id="page-copy" class="container" style="display:none">
    <!-- â€¦â€¦ï¼ˆæ­¤è™•ä¿æŒä½ ä¸Šå‚³ç‰ˆæœ¬çš„æ–‡æ¡ˆå€å¡Šä¸è®Šï¼‰â€¦â€¦ -->
    <!-- ç‚ºç¯€çœç¯‡å¹…ï¼Œæ­¤æ®µç•¥ï¼›è‹¥éœ€è¦æˆ‘å¯ä»¥å†è²¼å®Œæ•´ç›¸åŒå…§å®¹ -->
  </section>

  <!-- èªªæ˜/æŒ‡å—ï¼ˆæ–°ç‰ˆï¼‰ -->
  <section id="page-guide" class="container" style="display:none; padding-top:16px">
    <article class="card" style="margin-bottom:12px">
      <h3>ğŸ¯ AIå½±éŸ³å®šä½é¡§å•</h3>
      <h4 style="margin:6px 0 8px">åŠŸèƒ½èªªæ˜</h4>
      <p>â€¢ <strong>å¸³è™Ÿå®šä½åˆ†æ</strong>ï¼šå¹«åŠ©é‡æ¸…ä½ çš„æ¥­å‹™é¡å‹ã€ç›®æ¨™å—çœ¾ã€å“ç‰Œå½¢è±¡<br/>
         â€¢ <strong>å¹³å°ç­–ç•¥å»ºè­°</strong>ï¼šæ ¹æ“šä½ çš„å®šä½æ¨è–¦æœ€é©åˆçš„å¹³å°<br/>
         â€¢ <strong>å…§å®¹æ–¹å‘è¦åŠƒ</strong>ï¼šå»ºç«‹å®Œæ•´çš„å…§å®¹ç­–ç•¥åŸºç¤<br/>
         â€¢ <strong>å®šä½æª”æ¡ˆç®¡ç†</strong>ï¼šè‡ªå‹•è¨˜éŒ„å’Œæ›´æ–°ä½ çš„å®šä½è³‡è¨Š</p>
      <h4 style="margin:6px 0 8px">ä½¿ç”¨æ–¹å¼</h4>
      <p>1ï¸âƒ£ é»æ“Šã€Œå¿«é€Ÿå•é¡Œã€æŒ‰éˆ•é–‹å§‹å®šä½åˆ†æ<br/>
         2ï¸âƒ£ å›ç­”AIçš„å•é¡Œï¼Œå»ºç«‹ä½ çš„å®šä½æª”æ¡ˆ<br/>
         3ï¸âƒ£ ä½¿ç”¨ã€ŒğŸš€ ä¸€éµç”Ÿæˆå®šä½ã€å¿«é€Ÿå»ºç«‹å®Œæ•´å®šä½<br/>
         4ï¸âƒ£ å®šä½æª”æ¡ˆæœƒè‡ªå‹•å„²å­˜ä¸¦åŒæ­¥åˆ°å…¶ä»–åŠŸèƒ½</p>
    </article>

    <article class="card" style="margin-bottom:12px">
      <h3>ğŸ’¡ AIé¸é¡Œå°åŠ©æ‰‹</h3>
      <h4 style="margin:6px 0 8px">åŠŸèƒ½èªªæ˜</h4>
      <p>â€¢ <strong>å€‹æ€§åŒ–é¸é¡Œ</strong>ï¼šåŸºæ–¼ä½ çš„å®šä½æª”æ¡ˆç”Ÿæˆç›¸é—œé¸é¡Œ<br/>
         â€¢ <strong>ç†±é»çµåˆ</strong>ï¼šçµåˆç•¶å‰ç†±é–€è©±é¡Œèˆ‡ä½ çš„å“ç‰Œç‰¹è‰²<br/>
         â€¢ <strong>å­£ç¯€æ€§å…§å®¹</strong>ï¼šè€ƒæ…®æ™‚ç¯€èˆ‡ç¯€æ—¥æä¾›é©æ™‚å»ºè­°<br/>
         â€¢ <strong>é¸é¡Œé¡å‹ç¯©é¸</strong>ï¼šç†±é–€è¶¨å‹¢ã€æ•™è‚²åˆ†äº«ã€å€‹äººæ•…äº‹ã€ç”¢å“ä»‹ç´¹</p>
      <h4 style="margin:6px 0 8px">ä½¿ç”¨æ–¹å¼</h4>
      <p>1ï¸âƒ£ å…ˆå®Œæˆå®šä½åˆ†æï¼Œå»ºç«‹ä½ çš„å®šä½æª”æ¡ˆ<br/>
         2ï¸âƒ£ é¸æ“‡é¸é¡Œé¡å‹ï¼ˆç†±é–€è¶¨å‹¢ã€æ•™è‚²åˆ†äº«ç­‰ï¼‰<br/>
         3ï¸âƒ£ é»æ“Šã€Œç²å–éˆæ„Ÿã€ç²å¾—å€‹æ€§åŒ–é¸é¡Œå»ºè­°<br/>
         4ï¸âƒ£ æŸ¥çœ‹ã€Œä»Šæ—¥é¸é¡Œå»ºè­°ã€å’Œã€Œæ­·å²è¨˜éŒ„ã€</p>
    </article>

    <article class="card" style="margin-bottom:12px">
      <h3>ğŸ“ AIè…³æœ¬ç”Ÿæˆå¤§å¸«</h3>
      <h4 style="margin:6px 0 8px">åŠŸèƒ½èªªæ˜</h4>
      <p>â€¢ <strong>ä¸€éµç”Ÿæˆè…³æœ¬</strong>ï¼šæ ¹æ“šä¸»é¡Œå¿«é€Ÿç”Ÿæˆå®Œæ•´è…³æœ¬<br/>
         â€¢ <strong>å¼•å°æ¨¡å¼</strong>ï¼šé¸æ“‡çµæ§‹æ¨¡æ¿å’Œæ™‚é•·ï¼ŒAIé€æ­¥å¼•å°<br/>
         â€¢ <strong>è‡ªç”±æ¨¡å¼</strong>ï¼šè‡ªç”±è¨è«–éœ€æ±‚ï¼ŒAIæä¾›å‰µæ„å»ºè­°<br/>
         â€¢ <strong>å¤šç¨®æ¨¡æ¿</strong>ï¼šæ”¯æ´ A-F å…­ç¨®è…³æœ¬çµæ§‹æ¨¡æ¿<br/>
         â€¢ <strong>æ™‚é•·éˆæ´»</strong>ï¼šæ”¯æ´ 30 ç§’èˆ‡ 60 ç§’è…³æœ¬</p>
      <h4 style="margin:6px 0 8px">ä½¿ç”¨æ–¹å¼</h4>
      <p>1ï¸âƒ£ <strong>ä¸€éµç”Ÿæˆ</strong>ï¼šé»æ“Šã€ŒğŸš€ ä¸€éµç”Ÿæˆè…³æœ¬ã€ï¼Œè¼¸å…¥ä¸»é¡Œå³å¯<br/>
         2ï¸âƒ£ <strong>å¼•å°æ¨¡å¼</strong>ï¼šé¸æ“‡çµæ§‹æ¨¡æ¿å’Œæ™‚é•·ï¼Œè¼¸å…¥ä¸»é¡Œé–‹å§‹<br/>
         3ï¸âƒ£ <strong>è‡ªç”±æ¨¡å¼</strong>ï¼šç›´æ¥è¼¸å…¥éœ€æ±‚ï¼Œèˆ‡AIè‡ªç”±è¨è«–<br/>
         4ï¸âƒ£ æŸ¥çœ‹ã€Œè…³æœ¬åˆ†æ®µ/æ™‚é–“è»¸ã€å’Œã€Œè…³æœ¬ç­†è¨˜ã€</p>
    </article>

    <article class="card" style="margin-bottom:12px">
      <h3>ğŸ’¾ è³‡æ–™å„²å­˜èˆ‡ç®¡ç†</h3>
      <h4 style="margin:6px 0 8px">å„²å­˜ä½ç½®</h4>
      <p>â€¢ <strong>å®šä½æª”æ¡ˆ</strong>ï¼šè‡ªå‹•å„²å­˜åœ¨è³‡æ–™åº«ä¸­ï¼Œé»æ“Šã€Œå„²å­˜æª”æ¡ˆã€ç¢ºèª<br/>
         â€¢ <strong>é¸é¡Œå»ºè­°</strong>ï¼šå„²å­˜åœ¨ã€Œä»Šæ—¥é¸é¡Œå»ºè­°ã€å’Œã€Œæ­·å²è¨˜éŒ„ã€ä¸­<br/>
         â€¢ <strong>è…³æœ¬ç­†è¨˜</strong>ï¼šå„²å­˜åœ¨ã€Œè…³æœ¬åˆ†æ®µ/æ™‚é–“è»¸ã€ä¸­<br/>
         â€¢ <strong>å®šä½ç­†è¨˜</strong>ï¼šå„²å­˜åœ¨ã€Œå®šä½æª”æ¡ˆã€å´é‚Šæ¬„ä¸­</p>
      <h4 style="margin:6px 0 8px">è³‡æ–™åŒæ­¥</h4>
      <p>æ‰€æœ‰è³‡æ–™æœƒè‡ªå‹•åŒæ­¥åˆ°å…¶ä»–åŠŸèƒ½ï¼Œè®“AIèƒ½å¤ æ ¹æ“šä½ çš„æ­·å²è¨˜éŒ„æä¾›æ›´ç²¾æº–çš„å»ºè­°ã€‚</p>
      <h4 style="margin:6px 0 8px">è¨˜æ†¶ä½œç”¨</h4>
      <p>æ™ºèƒ½é«”æœƒæ ¹æ“šä½ çš„è¨˜æ†¶æä¾›æ›´å€‹æ€§åŒ–çš„å»ºè­°ã€‚ä¾‹å¦‚ï¼š<br/>
         â€¢ å®šä½æ™ºèƒ½é«”è¨˜ä½ä½ çš„æ¥­å‹™é¡å‹å¾Œï¼Œé¸é¡Œæ™ºèƒ½é«”æœƒæ¨è–¦ç›¸é—œé ˜åŸŸçš„é¸é¡Œ<br/>
         â€¢ è…³æœ¬æ–‡æ¡ˆæ™ºèƒ½é«”æœƒæ ¹æ“šä½ çš„å“ç‰Œèªæ°£èˆ‡å—çœ¾åå¥½ç”Ÿæˆå…§å®¹<br/>
         â€¢ ç³»çµ±æœƒæŒçºŒå­¸ç¿’ä½ çš„åå¥½ï¼Œæä¾›è¶Šä¾†è¶Šç²¾æº–çš„å»ºè­°</p>
    </article>

    <article class="card" style="margin-bottom:12px">
      <h3>ğŸš€ ä½¿ç”¨å»ºè­°</h3>
      <h4 style="margin:6px 0 8px">æœ€ä½³æµç¨‹</h4>
      <p>1. <strong>å…ˆä½¿ç”¨å®šä½æ™ºèƒ½é«”</strong>ï¼šå»ºç«‹ä½ çš„åŸºæœ¬å®šä½æª”æ¡ˆ<br/>
         2. <strong>å†ä½¿ç”¨é¸é¡Œæ™ºèƒ½é«”</strong>ï¼šç²å–å€‹æ€§åŒ–çš„é¸é¡Œå»ºè­°<br/>
         3. <strong>æœ€å¾Œä½¿ç”¨è…³æœ¬æ–‡æ¡ˆæ™ºèƒ½é«”</strong>ï¼šåŸºæ–¼å®šä½èˆ‡é¸é¡Œå‰µä½œå…·é«”å…§å®¹</p>
      <h4 style="margin:6px 0 8px">é€²éšæŠ€å·§</h4>
      <p>â€¢ å®šæœŸæ›´æ–°å®šä½æª”æ¡ˆï¼Œè®“ç³»çµ±æ›´äº†è§£ä½ çš„è®ŠåŒ–<br/>
         â€¢ ä½¿ç”¨å¿«é€Ÿå•é¡Œ chips å¿«é€Ÿé–‹å§‹å°è©±<br/>
         â€¢ æŸ¥çœ‹æ­·å²è¨˜éŒ„äº†è§£éå»çš„å»ºè­°<br/>
         â€¢ åˆ©ç”¨è¤‡è£½åŠŸèƒ½ä¿å­˜æœ‰ç”¨çš„å…§å®¹</p>
    </article>
  </section>

  <footer class="site-footer">
    <div class="container">
      <div class="copyright">Â© 2025 AIJobSchool ç‰ˆæ¬Šæ‰€æœ‰</div>
    </div>
  </footer>

  <div id="toast" class="toast">å·²è¤‡è£½</div>

  <script>
  // æ ¹æ“šéƒ¨ç½²ç’°å¢ƒè‡ªå‹•é¸æ“‡ API åŸºç¤ URL
  const API_BASE = window.location.hostname === 'localhost' 
    ? 'http://localhost:8080'  // æœ¬åœ°é–‹ç™¼
    : 'https://aijobvideobackend.zeabur.app';  // ä½ çš„å¯¦éš› Zeabur å¾Œç«¯ URL
  const DEFAULT_USER_ID = `web-${Math.random().toString(36).slice(2,8)}`;

  // å…¨åŸŸç‹€æ…‹
  const state = { 
    userId: DEFAULT_USER_ID,
    scriptMode: 'guide',                 // guide | free
    templateType: 'A',                   // å¼•å°æ¨¡å¼ä½¿ç”¨
    duration: 30,                        // 30 | 60ï¼Œå¼•å°æ¨¡å¼ä½¿ç”¨
    sessionIdScript: `web-${Math.random().toString(36).slice(2,8)}`,
    messagesScript: [],
    lastAssistantScript: '',
    segments: [],
    
    // æ–°å¢ï¼šä¸‰æ™ºèƒ½é«”ç‹€æ…‹
    sessionIdPositioning: `web-${Math.random().toString(36).slice(2,8)}`,
    messagesPositioning: [],
    userProfile: null,
    userNotes: [],
    
    sessionIdTopics: `web-${Math.random().toString(36).slice(2,8)}`,
    messagesTopics: [],
    currentTopics: null,
    topicsNotes: [],
    
    sessionIdScript: `web-${Math.random().toString(36).slice(2,8)}`,
    scriptNotes: []
  };

  // ç°¡ä¾¿å·¥å…·
  function fmtTS(d=new Date()){ const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`; }
  function escapeHTML(s){ return (s||'').replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }
  function showToast(m){ const t=document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1500); }
  function copyText(s,msg='å·²è¤‡è£½å›‰ï¼'){ navigator.clipboard.writeText(s).then(()=>showToast(msg)); }
  function appendMsg(el, role, content, isFormatted = false){
    const div=document.createElement('div');
    div.className='msg ' + (role==='user'?'user':'');
    
    // å¦‚æœæ˜¯ AI å›æ‡‰ä¸”éœ€è¦æ ¼å¼åŒ–
    if(role === 'assistant' && isFormatted){
      div.innerHTML=`<div class="meta">${role} Â· ${fmtTS()}</div><div class="formatted-content">${formatAIResponse(content)}</div>`;
    } else {
      div.innerHTML=`<div class="meta">${role} Â· ${fmtTS()}</div><div>${escapeHTML(content)}</div>`;
    }
    
    el.appendChild(div); el.scrollTop=el.scrollHeight;
  }

  // æ·»åŠ  AI è™•ç†ä¸­çš„è¼‰å…¥ç‹€æ…‹
  function showLoadingMsg(el, message = 'AI æ­£åœ¨æ€è€ƒä¸­...'){
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'msg loading-msg';
    loadingDiv.id = 'loading-msg';
    loadingDiv.innerHTML = `
      <div class="meta">assistant Â· ${fmtTS()}</div>
      <div class="loading-content">
        <div class="loading-dots">
          <span></span><span></span><span></span>
        </div>
        <span class="loading-text">${message}</span>
      </div>
    `;
    el.appendChild(loadingDiv);
    el.scrollTop = el.scrollHeight;
    return loadingDiv;
  }

  function hideLoadingMsg(el){
    const loadingMsg = el.querySelector('#loading-msg');
    if(loadingMsg){
      loadingMsg.remove();
    }
  }

  // ä¸²æµèŠå¤©ï¼šé€æ­¥æ¸²æŸ“ assistant å›è¦†
  let currentStream = { controller: null };
  async function streamChat(targetEl, payload, { onComplete } = {}){
    const div = document.createElement('div');
    div.className = 'msg';
    div.innerHTML = `<div class="meta">assistant Â· ${fmtTS()}</div><div class="stream-content"></div>`;
    const contentEl = div.querySelector('.stream-content');
    targetEl.appendChild(div);
    targetEl.scrollTop = targetEl.scrollHeight;

    // åˆå§‹é¡¯ç¤ºæ‰“å­—æŒ‡ç¤º
    contentEl.textContent = 'AI æ­£åœ¨å›è¦†ä¸­â€¦';

    let buffer = '';
    try{
      const controller = new AbortController();
      currentStream.controller = controller;
      const resp = await fetch(`${API_BASE}/chat_stream`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        signal: controller.signal,
        body: JSON.stringify(payload)
      });
      if(!resp.ok || !resp.body) throw new Error(`HTTP ${resp.status}`);
      const reader = resp.body.getReader();
      const decoder = new TextDecoder();
      while(true){
        const {done, value} = await reader.read();
        if(done) break;
        buffer += decoder.decode(value, {stream:true});
        contentEl.textContent = buffer;
        targetEl.scrollTop = targetEl.scrollHeight;
      }
      contentEl.innerHTML = formatAIResponse(buffer);
      if(typeof onComplete === 'function') onComplete(buffer);
    }catch(e){
      contentEl.textContent = `âŒ éŒ¯èª¤ï¼š${e.message}`;
    } finally { currentStream.controller = null; }
  }

  function cancelStream(){ try{ currentStream.controller && currentStream.controller.abort(); }catch(_){ } }

  // æ ¼å¼åŒ– AI å›æ‡‰ï¼Œæ”¹å–„é¡¯ç¤ºæ•ˆæœ
  function formatAIResponse(content){
    if(!content) return '';
    
    // ç§»é™¤å¤šå€‹æ˜Ÿè™Ÿï¼Œæ”¹ç‚ºé©ç•¶çš„æ ¼å¼
    let formatted = content
      .replace(/\*\*\*(.*?)\*\*\*/g, '<strong>$1</strong>')  // ä¸‰å€‹æ˜Ÿè™Ÿè½‰ç‚ºç²—é«”
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')      // å…©å€‹æ˜Ÿè™Ÿè½‰ç‚ºç²—é«”
      .replace(/\*(.*?)\*/g, '<em>$1</em>')                  // ä¸€å€‹æ˜Ÿè™Ÿè½‰ç‚ºæ–œé«”
      .replace(/\n\n+/g, '</p><p>')                          // å¤šå€‹æ›è¡Œè½‰ç‚ºæ®µè½
      .replace(/\n/g, '<br>');                               // å–®å€‹æ›è¡Œè½‰ç‚ºæ›è¡Œæ¨™ç±¤
    
    // æ·»åŠ æ®µè½æ¨™ç±¤
    if(!formatted.startsWith('<p>')) formatted = '<p>' + formatted;
    if(!formatted.endsWith('</p>')) formatted = formatted + '</p>';
    
    // è™•ç†æ¨™é¡Œï¼ˆæ•¸å­—é–‹é ­çš„è¡Œï¼‰
    formatted = formatted.replace(/(<p>)?(\d+[\.\)]\s*.*?)(<\/p>)?/g, '<p><strong>$2</strong></p>');
    
    // è™•ç†åˆ—è¡¨é …ï¼ˆâ€¢ æˆ– - é–‹é ­ï¼‰
    formatted = formatted.replace(/(<p>)?([â€¢\-]\s*.*?)(<\/p>)?/g, '<p>â€¢ $2</p>');
    
    // æ·»åŠ é©ç•¶çš„ emoji
    formatted = formatted
      .replace(/æ¥­å‹™é¡å‹/g, 'ğŸ¢ æ¥­å‹™é¡å‹')
      .replace(/ç›®æ¨™å—çœ¾/g, 'ğŸ‘¥ ç›®æ¨™å—çœ¾')
      .replace(/å“ç‰Œèªæ°£/g, 'ğŸ¨ å“ç‰Œèªæ°£')
      .replace(/å¹³å°ç­–ç•¥/g, 'ğŸ“± å¹³å°ç­–ç•¥')
      .replace(/å…§å®¹æ–¹å‘/g, 'ğŸ“ å…§å®¹æ–¹å‘')
      .replace(/å»ºè­°/g, 'ğŸ’¡ å»ºè­°')
      .replace(/åˆ†æ/g, 'ğŸ” åˆ†æ')
      .replace(/é‡é»/g, 'â­ é‡é»')
      .replace(/é—œéµ/g, 'ğŸ”‘ é—œéµ');
    
    return formatted;
  }

  // åˆ†é åˆ‡æ›
  const pages = ['home','positioning','topics','script','copy','guide'];
  document.querySelectorAll('.tab').forEach(b=>b.onclick=()=>goPage(b.dataset.page));
  document.querySelectorAll('[data-go]').forEach(b=>b.onclick=()=>goPage(b.dataset.go));
  function goPage(name){
    pages.forEach(p=>{
      const elPage = document.getElementById(`page-${p}`);
      if(elPage) elPage.style.display = (p===name)?'block':'none';
      const tab = document.querySelector(`.tab[data-page="${p}"]`);
      if(tab) tab.classList.toggle('active', p===name);
    });
    
    if(name==='script' && state.messagesScript.length===0){
      showScriptWelcome();
      // ä¸è‡ªå‹•é€²å…¥ Q1ï¼Œåƒ…é¡¯ç¤ºæ­¡è¿
      renderChips();          // åˆå§‹åŒ– chips
    } else if(name==='positioning' && state.messagesPositioning.length===0){
      showPositioningWelcome();
      checkPositioningProfile();
    } else if(name==='topics' && state.messagesTopics.length===0){
      showTopicsWelcome();
      refreshTopicsNotes();
    } else if(name==='script' && state.messagesScript.length===0){
      showScriptWelcome();
      refreshScriptNotes();
    }
  }

  // è…³æœ¬æ¨¡å¼ï¼šæ­¡è¿èªªæ˜
  function showScriptWelcome(){
    const chat=document.getElementById('chatScript');
    const msg = 'ğŸ‘‹ æ­¡è¿ä½¿ç”¨è…³æœ¬æ¨¡å¼ï¼\nâ€” å¦‚æœä½ ç”¨ã€å¼•å°æ¨¡å¼ã€‘ï¼šè«‹å…ˆè¼¸å…¥ä½ çš„ä¸»é¡Œï¼Œæˆ‘æœƒä¸€æ­¥æ­¥å¼•å°ä½ ç”Ÿæˆå±¬æ–¼ä½ çš„è…³æœ¬ï¼ˆå…ˆé¸çµæ§‹ï¼‹æ™‚é•·ï¼‰ã€‚\nâ€” å·²æœ‰æƒ³æ³• â†’ åˆ‡åˆ°ã€è‡ªç”±æ¨¡å¼ã€‘ç›´æ¥èŠï¼Œä½ èªªæƒ³åšä»€éº¼ï¼Œæˆ‘ä¾†è£œé½Šè…³æœ¬èˆ‡ç•«é¢å»ºè­°ã€‚';
    appendMsg(chat,'assistant',msg);
    state.messagesScript.push({ role:'assistant', content:msg });
    state.lastAssistantScript = msg;
    
    // ç¢ºä¿è¼¸å…¥æ¡†å¯è¦‹
    setTimeout(() => {
      const inputScript = document.getElementById('inputScript');
      const inputbar = document.querySelector('#page-script .inputbar');
      if(inputScript) {
        inputScript.style.display = 'block';
        inputScript.style.visibility = 'visible';
        inputScript.style.opacity = '1';
        console.log('è…³æœ¬è¼¸å…¥æ¡†å·²é¡¯ç¤º');
      }
      if(inputbar) {
        inputbar.style.display = 'flex';
        inputbar.style.visibility = 'visible';
        inputbar.style.opacity = '1';
        console.log('è¼¸å…¥æ¡†å€åŸŸå·²é¡¯ç¤º');
      }
    }, 100);
  }

  // å¿«é€Ÿæ¨¡æ¿ / å¿«é€Ÿå•é¡Œï¼ˆä¾æ¨¡å¼æ›´æ›ï¼‰
  function renderChips(){
    const wrap=document.getElementById('chipsScript');
    wrap.innerHTML='';
    if(state.scriptMode==='guide'){
      const hint = document.createElement('span'); hint.className='muted'; hint.textContent='å·²é¸æ“‡æ¨¡æ¿èˆ‡æ™‚é•· â†’ ç›´æ¥è¼¸å…¥ä¸»é¡Œæˆ–éœ€æ±‚é–‹å§‹ç”Ÿæˆ';
      wrap.appendChild(hint);
    }else{
      const hint = document.createElement('span'); hint.className='muted'; hint.textContent='å¿«é€Ÿæå•ï¼š';
      wrap.appendChild(hint);
      [
        'å¹«æˆ‘æŠŠé€™å€‹æƒ³æ³•æ‹†æˆ 60 ç§’è…³æœ¬ï¼ŒHook è¦å¾ˆå¼·ï¼š',
        'è«‹å…ˆç”¨ç°¡çŸ­æ–¹å¼ä»‹ç´¹ A~F å…­ç¨®çµæ§‹çš„å·®ç•°èˆ‡é©ç”¨æƒ…å¢ƒï¼Œç„¶å¾Œä¾æˆ‘é€™å€‹ä¸»é¡ŒæŒ‘ä¸€ç¨®ä¸¦çµ¦ç¬¬ä¸€ç‰ˆï¼š',
        'è«‹ç”¨ 6 æ®µ 60 ç§’ï¼Œå°ç™½å£èªï¼‹ç•«é¢å…·é«”ï¼Œæœ€å¾Œçµ¦ CTAï¼š'
      ].forEach(q=>{
        const b=document.createElement('button'); b.className='chip'; b.textContent=q;
        b.onclick=()=>{ const t=document.getElementById('inputScript'); t.value=q; t.focus(); };
        wrap.appendChild(b);
      });
    }
  }

  // å¼•å°æ¨¡å¼ï¼šQ/A API
  async function apiChatQA(message){
    const r = await fetch(`${API_BASE}/chat_qa`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ session_id: state.sessionIdScript, message })
    });
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.json();
  }

  // å–å¾—ç¬¬ä¸€é¡Œ
  async function startQaFirstQuestion(){
    if(state.guideApplied) return; // å·²å¥—ç”¨è¨­å®šï¼Œä¸è‡ªå‹•é€²å…¥ Q1
    const resp=await apiChatQA('');
    if(resp.assistant_message){
      appendMsg(document.getElementById('chatScript'),'assistant',resp.assistant_message);
      state.messagesScript.push({ role:'assistant', content:resp.assistant_message });
      state.lastAssistantScript = resp.assistant_message;
    }
  }

  // å¼•å°æ¨¡å¼ï¼šæŠŠä¸Šæ–¹çš„æ¨¡æ¿/æ™‚é•·ç›´æ¥å…ˆå›ç­” Q1/Q2ï¼ˆçœå…©æ­¥ï¼‰
  document.getElementById('btnStartGuide').onclick = async ()=>{
    if(state.scriptMode!=='guide') return;
    const tpl = document.querySelector('input[name="tpl"]:checked').value;
    const dur = document.querySelector('input[name="dur"]:checked').value;
    state.templateType = tpl;
    state.duration = parseInt(dur,10);
    state.guideApplied = true;
    showToast('å·²å¥—ç”¨æ¨¡æ¿èˆ‡æ™‚é•·è¨­å®š');
  };

  // æ¨¡å¼åˆ‡æ›
  document.getElementById('modeGroup').addEventListener('change', e=>{
    if(e.target.name!=='scriptMode') return;
    state.scriptMode = e.target.value;       // guide | free
    document.getElementById('guideBar').style.display = (state.scriptMode==='guide')?'block':'none';
    renderChips();
  });

  // é€å‡ºï¼šæ”¹èµ°å¢å¼·ç‰ˆ APIï¼Œèƒ½å›å‚³åˆ†æ®µ â†’ å³å´é¡¯ç¤º
  const chatScript = document.getElementById('chatScript');
  document.getElementById('sendScript').onclick = async ()=>{ await sendScriptMessage(); };

  // ç‰‡æ®µæ¸²æŸ“
  const segmentsWrap = document.getElementById('segmentsWrap');
  function segmentToText(s){ 
    return `(${s.start_sec}sâ€“${s.end_sec}s) [${s.type||'-'}] camera:${s.camera||'-'}\nå°è©:${s.dialog||''}\nç•«é¢:${s.visual||''}\nCTA:${s.cta||''}`;
  }
  function renderSegments(){
    segmentsWrap.innerHTML='';
    if(!state.segments?.length){ 
      const empty=document.createElement('div'); 
      empty.className='segment-card muted'; 
      empty.textContent='å°šç„¡ç‰‡æ®µã€‚è«‹è¼¸å…¥æ›´å…·é«”çš„ç§’æ•¸/å ´æ™¯/ç›®æ¨™ã€‚'; 
      segmentsWrap.appendChild(empty); 
      return; 
    }
    state.segments.forEach((s,i)=>{
      if(s.start_sec==null||s.end_sec==null){ s.start_sec=i*6; s.end_sec=i*6+6; }
      const card=document.createElement('div'); card.className='segment-card';
      card.innerHTML=`
        <div class="segment-head">
          <div class="seg-title">#${i+1} ${s.type||'segment'} <span class="seg-meta">${s.start_sec}sâ€“${s.end_sec}s Â· é¡ä½ ${s.camera||'-'}</span></div>
          <div class="seg-actions">
            <button class="btn small" data-act="copy" data-idx="${i}">è¤‡è£½</button>
            <button class="btn small" data-act="tweak" data-idx="${i}">å¾®èª¿</button>
            <button class="btn small" data-act="del" data-idx="${i}">åˆªé™¤</button>
          </div>
        </div>
        <div class="muted">å°ç™½</div><div>${escapeHTML(s.dialog||'')}</div>
        <div class="muted" style="margin-top:6px">ç•«é¢æ„Ÿ</div><div>${escapeHTML(s.visual||'')}</div>
        <div class="muted" style="margin-top:6px">CTA</div><div>${escapeHTML(s.cta||'')}</div>`;
      segmentsWrap.appendChild(card);
    });
  }
  segmentsWrap.onclick = e=>{
    const b=e.target.closest('button'); if(!b) return;
    const idx=+b.dataset.idx, seg=state.segments[idx];
    if(b.dataset.act==='copy') copyText(segmentToText(seg));
    if(b.dataset.act==='del'){ state.segments.splice(idx,1); renderSegments(); }
    if(b.dataset.act==='tweak'){
      const nd=prompt('å¾®èª¿å°ç™½ï¼ˆç•™ç©ºç•¥éï¼‰',seg.dialog||''); if(nd!=null && nd!=='') seg.dialog=nd;
      const nv=prompt('å¾®èª¿ç•«é¢ï¼ˆç•™ç©ºç•¥éï¼‰',seg.visual||''); if(nv!=null && nv!=='') seg.visual=nv;
      const nc=prompt('å¾®èª¿ CTAï¼ˆç•™ç©ºç•¥éï¼‰',seg.cta||''); if(nc!=null && nc!=='') seg.cta=nc;
      renderSegments();
    }
  };

  // è¤‡è£½/æ¸…ç©º
  document.getElementById('copyAllScript').onclick=()=>{ 
    if(!state.segments?.length) return showToast('ç„¡å¯è¤‡è£½å…§å®¹'); 
    copyText(state.segments.map(s=>segmentToText(s)).join('\n\n'),'å·²è¤‡è£½å›‰ï¼');
  };
  document.getElementById('clearScript').onclick =()=>{ state.segments=[]; renderSegments(); };



  // æ¨¡æ¿/æ™‚é•·é¸å– â†’ å­˜åˆ° stateï¼ˆä¾›è‡ªç”±æ¨¡å¼ä¹Ÿå¯å¸¶ï¼‰
  document.getElementById('tplGroup').addEventListener('change', e=>{
    if(e.target.name==='tpl') state.templateType = e.target.value;
  });
  document.getElementById('durGroup').addEventListener('change', e=>{
    if(e.target.name==='dur') state.duration = parseInt(e.target.value,10);
  });

  // ========= ä¸‰æ™ºèƒ½é«”åŠŸèƒ½ =========

  // å®šä½æ™ºèƒ½é«”
  function showPositioningWelcome(){
    const chat = document.getElementById('chatPositioning');
    const msg = 'ğŸ¯ æ­¡è¿ä½¿ç”¨AIå½±éŸ³å®šä½é¡§å•ï¼\n\næˆ‘æœƒå¹«ä½ å»ºç«‹å®Œæ•´çš„å®šä½æª”æ¡ˆï¼ŒåŒ…å«ï¼š\nâ€¢ æ¥­å‹™é¡å‹ï¼šä½ ä¸»è¦åšä»€éº¼ï¼Ÿ\nâ€¢ ç›®æ¨™å—çœ¾ï¼šä½ çš„è§€çœ¾æ˜¯èª°ï¼Ÿ\nâ€¢ å“ç‰Œèªæ°£ï¼šä½ æƒ³å‚³é”ä»€éº¼å½¢è±¡ï¼Ÿ\nâ€¢ ä¸»è¦å¹³å°ï¼šåœ¨å“ªè£¡ç¶“ç‡Ÿï¼Ÿ\nâ€¢ å…§å®¹ç›®æ¨™ï¼šæƒ³è¦é”æˆä»€éº¼ï¼Ÿ\nâ€¢ ç™¼æ–‡é »ç‡ï¼šå¤šä¹…æ›´æ–°ä¸€æ¬¡ï¼Ÿ\n\nğŸ’¡ ä½ å¯ä»¥ï¼š\n1. ç›´æ¥å‘Šè¨´æˆ‘ä½ çš„æ¥­å‹™å’Œæƒ³æ³•\n2. é»æ“Šä¸‹æ–¹å¿«é€Ÿå•é¡ŒæŒ‰éˆ•\n3. æˆ‘æœƒæ ¹æ“šä½ çš„å›ç­”é€æ­¥å¹«ä½ å®Œå–„å®šä½æª”æ¡ˆï¼';
    appendMsg(chat, 'assistant', msg, true);
    state.messagesPositioning.push({ role:'assistant', content:msg });
  }

  async function sendPositioningMessage(){
    const textarea = document.getElementById('inputPositioning');
    const text = (textarea.value || '').trim();
    if(!text){ showToast('è«‹å…ˆè¼¸å…¥å…§å®¹'); return; }
    
    const chat = document.getElementById('chatPositioning');
    appendMsg(chat, 'user', text);
    textarea.value = '';
    
    // ä¸²æµæ–¹å¼
    streamChat(chat, {
      user_id: state.userId,
      agent_type: 'positioning',
      session_id: state.sessionIdPositioning,
      messages: [{ role: 'user', content: text }]
    }, {
      onComplete: async ()=>{
        try{ await refreshPositioningProfile(); }catch(_){ }
      }
    });
  }

  function updateProfileDisplay(){
    const profileContent = document.getElementById('profileContent');
    if(state.userProfile){
      const profile = state.userProfile;
      // æ¸…ç†æ¬„ä½ï¼ˆå»é™¤ ** ç­‰ Markdown æ®˜ç•™ï¼›ç©ºå€¼é¡¯ç¤ºç‚ºæœªè¨­å®šï¼‰
      const cleanField = (v)=>{
        if(v==null) return 'æœªè¨­å®š';
        let s = String(v)
          .replace(/^\*+\s*/g,'')
          .replace(/\s*\*+$/g,'')
          .replace(/^ã€.*?ã€‘/,'')
          .trim();
        if(!s || s === 'â€”' || s === '-') return 'æœªè¨­å®š';
        return s;
      };

      const notes = (state.userNotes||[]).map(n=>{
        // æ¸…ç†å…§å®¹ï¼Œç§»é™¤é–‹å ´ç™½
        let cleanContent = n.content
          .replace(/å“ˆå›‰!.*?å®šä½é¡§å•.*?å°ç£å¸‚å ´ç‰¹æ€§.*?çŸ­å½±éŸ³è…³æœ¬ã€‚/g, '')
          .replace(/æ²’å•é¡Œ!.*?é¸é¡Œé¡§å•.*?å½±ç‰‡ç‡’èµ·ä¾†ã€‚/g, '')
          .trim();
        
        // æ ¼å¼åŒ–æ®µè½
        cleanContent = cleanContent
          .replace(/\n/g, '<br>')
          .replace(/(\d+\.)/g, '<br><strong>$1</strong>')
          .replace(/(Hook|Value|CTA)/g, '<br><strong>$1</strong>')
          .replace(/(\d+-\d+ç§’)/g, '<br><em>$1</em>');
        
        return `<li style="margin-bottom: 8px; line-height: 1.5;">${cleanContent}</li>`;
      }).join('') || '<li class="muted">å°šç„¡ç­†è¨˜</li>';
      
      // æª¢æŸ¥å“ªäº›æ¬„ä½å·²å¡«å¯«
      const filledFields = [];
      const emptyFields = [];
      
      if(profile.business_type && profile.business_type !== 'æœªè¨­å®š') filledFields.push('æ¥­å‹™é¡å‹');
      else emptyFields.push('æ¥­å‹™é¡å‹');
      
      if(profile.target_audience && profile.target_audience !== 'æœªè¨­å®š') filledFields.push('ç›®æ¨™å—çœ¾');
      else emptyFields.push('ç›®æ¨™å—çœ¾');
      
      if(profile.brand_voice && profile.brand_voice !== 'æœªè¨­å®š') filledFields.push('å“ç‰Œèªæ°£');
      else emptyFields.push('å“ç‰Œèªæ°£');
      
      if(profile.primary_platform && profile.primary_platform !== 'æœªè¨­å®š') filledFields.push('ä¸»è¦å¹³å°');
      else emptyFields.push('ä¸»è¦å¹³å°');
      
      if(profile.content_goals && profile.content_goals !== 'æœªè¨­å®š') filledFields.push('å…§å®¹ç›®æ¨™');
      else emptyFields.push('å…§å®¹ç›®æ¨™');
      
      if(profile.posting_frequency && profile.posting_frequency !== 'æœªè¨­å®š') filledFields.push('ç™¼æ–‡é »ç‡');
      else emptyFields.push('ç™¼æ–‡é »ç‡');
      
      let statusText = '';
      if(emptyFields.length === 0) {
        statusText = '<div style="color:var(--ok); font-weight:600; margin-bottom:8px;">âœ… å®šä½æª”æ¡ˆå®Œæ•´</div>';
      } else {
        statusText = `<div style="color:var(--err); font-weight:600; margin-bottom:8px;">âš ï¸ é‚„éœ€å¡«å¯«ï¼š${emptyFields.join('ã€')}</div>`;
      }
      
      profileContent.innerHTML = `
        ${statusText}
        <div class="profile-field"><strong>æ¥­å‹™é¡å‹ï¼š</strong>${cleanField(profile.business_type)}</div>
        <div class="profile-field"><strong>ç›®æ¨™å—çœ¾ï¼š</strong>${cleanField(profile.target_audience)}</div>
        <div class="profile-field"><strong>å“ç‰Œèªæ°£ï¼š</strong>${cleanField(profile.brand_voice)}</div>
        <div class="profile-field"><strong>ä¸»è¦å¹³å°ï¼š</strong>${cleanField(profile.primary_platform)}</div>
        <div class="profile-field"><strong>å…§å®¹ç›®æ¨™ï¼š</strong>${cleanField(profile.content_goals)}</div>
        <div class="profile-field"><strong>ç™¼æ–‡é »ç‡ï¼š</strong>${cleanField(profile.posting_frequency)}</div>
        <div style="margin-top:12px; padding-top:8px; border-top:1px solid #eee;"><strong>ğŸ“ å®šä½ç­†è¨˜ï¼š</strong></div>
        <ul style="padding-left:18px; margin:6px 0 0">${notes}</ul>
      `;
    } else {
      profileContent.innerHTML = '<div class="muted">å°šæœªå»ºç«‹å®šä½æª”æ¡ˆï¼Œè«‹å…ˆèˆ‡AIå½±éŸ³å®šä½é¡§å•å°è©±ã€‚</div>';
    }
  }

  async function refreshPositioningProfile(){
    const resp = await fetch(`${API_BASE}/agent/positioning/profile?user_id=${state.userId}&notes_limit=8`);
    const data = await resp.json();
    if(data && !data.error){
      state.userProfile = data.profile || {};
      state.userNotes = data.notes || [];
      updateProfileDisplay();
    }
  }

  // é¸é¡Œæ™ºèƒ½é«”
  function showTopicsWelcome(){
    const chat = document.getElementById('chatTopics');
    const msg = 'ğŸ’¡ æ­¡è¿ä½¿ç”¨AIé¸é¡Œå°åŠ©æ‰‹ï¼\n\næˆ‘æœƒæ ¹æ“šä½ çš„å®šä½æª”æ¡ˆï¼Œæä¾›ï¼š\nâ€¢ æ¯æ—¥é¸é¡Œéˆæ„Ÿ\nâ€¢ ç†±é–€è©±é¡Œå»ºè­°\nâ€¢ å­£ç¯€æ€§å…§å®¹\nâ€¢ å¹³å°ç‰¹è‰²é¸é¡Œ\n\né»æ“Šã€Œç²å–éˆæ„Ÿã€é–‹å§‹ç”Ÿæˆä»Šæ—¥é¸é¡Œå»ºè­°ï¼';
    appendMsg(chat, 'assistant', msg, true);
    state.messagesTopics.push({ role:'assistant', content:msg });
  }

  // é¸é¡Œç­†è¨˜é¡¯ç¤º
  function updateTopicsNotesDisplay(){
    const topicsContent = document.getElementById('topicsContent');
    if(state.topicsNotes && state.topicsNotes.length > 0){
      const notes = state.topicsNotes.map(n=>{
        // æ¸…ç†å…§å®¹ï¼Œç§»é™¤é–‹å ´ç™½
        let cleanContent = n.content
          .replace(/æ²’å•é¡Œ!.*?é¸é¡Œé¡§å•.*?å½±ç‰‡ç‡’èµ·ä¾†ã€‚/g, '')
          .replace(/å“ˆå›‰!.*?é¸é¡Œå°åŠ©æ‰‹.*?æ­¡è¿ä½¿ç”¨ã€‚/g, '')
          .trim();
        
        // ç¢ºä¿å…§å®¹å®Œæ•´ï¼Œä¿®å¾©æˆªæ–·å•é¡Œ
        if(cleanContent.includes('2. åˆ¥') && !cleanContent.includes('ä½ outäº†!')) {
          cleanContent = cleanContent.replace(/2\. åˆ¥.*$/, '2. ä»¥ç‚ºæˆ‘å€‘ä¸æ‡‚äººæƒ…ä¸–æ•…?å…¶å¯¦åªæ˜¯ç”¨ã€Œæ–°å‹ç¤¾äº¤é€šé—œå¯†èªã€æºé€šï¼Œä½ outäº†!');
        }
        
        // æ ¼å¼åŒ–æ®µè½
        cleanContent = cleanContent
          .replace(/^/,'ğŸ”¥ ')
          .replace(/\n/g, '<br>')
          .replace(/(\d+\.)/g, '<br><strong>$1</strong>')
          .replace(/(é¸é¡Œæ–¹å‘|çˆ†é»åˆ‡å…¥|å…§å®¹ç™¼å±•|ç‚ºä»€éº¼æœƒçˆ†)/g, '<br><strong>$1</strong>')
          .replace(/(Hook|Value|CTA)/g, '<br><strong>$1</strong>');
        
        return `<li style="margin-bottom: 12px; line-height: 1.6; padding: 8px; background: #f8f9fa; border-radius: 6px;">${cleanContent}</li>`;
      }).join('');
      
      // é‡æ–°è¨­è¨ˆç‚ºæ­·å²ç´€éŒ„æ ¼å¼
      const historyItems = state.topicsNotes.map((n, index) => {
        // æ¸…ç†å…§å®¹ï¼Œç§»é™¤é–‹å ´ç™½
        let cleanContent = n.content
          .replace(/æ²’å•é¡Œ!.*?é¸é¡Œé¡§å•.*?å½±ç‰‡ç‡’èµ·ä¾†ã€‚/g, '')
          .replace(/å“ˆå›‰!.*?é¸é¡Œå°åŠ©æ‰‹.*?æ­¡è¿ä½¿ç”¨ã€‚/g, '')
          .trim();
        
        // ç¢ºä¿å…§å®¹å®Œæ•´ï¼Œä¿®å¾©æˆªæ–·å•é¡Œ
        if(cleanContent.includes('2. åˆ¥') && !cleanContent.includes('ä½ outäº†!')) {
          cleanContent = cleanContent.replace(/2\. åˆ¥.*$/, '2. ä»¥ç‚ºæˆ‘å€‘ä¸æ‡‚äººæƒ…ä¸–æ•…?å…¶å¯¦åªæ˜¯ç”¨ã€Œæ–°å‹ç¤¾äº¤é€šé—œå¯†èªã€æºé€šï¼Œä½ outäº†!');
        }
        
        // æå–æ™‚é–“
        const time = n.created_at ? new Date(n.created_at).toLocaleString('zh-TW') : `è¨˜éŒ„ ${index + 1}`;
        
        // æå–ä¸»é¡Œæ¨™é¡Œï¼ˆå¾å…§å®¹ä¸­æ‰¾ç¬¬ä¸€å€‹æ¨™é¡Œï¼‰
        const titleMatch = cleanContent.match(/(è¹­ã€Œ[^ã€]+ã€ç†±é»|é¸é¡Œæ–¹å‘[ï¼š:]\s*([^\n]+)|çˆ†æ¬¾\s*Hook[ï¼š:]\s*([^\n]+))/);
        const title = titleMatch ? (titleMatch[1] || titleMatch[2] || titleMatch[3] || 'é¸é¡Œå»ºè­°').trim() : 'é¸é¡Œå»ºè­°';
        
        // æ ¼å¼åŒ–å…§å®¹ç‚ºçµæ§‹åŒ–é¡¯ç¤º
        const formattedContent = cleanContent
          .replace(/\n/g, '<br>')
          .replace(/(é¸é¡Œæ–¹å‘[ï¼š:])/g, '<br><strong>ğŸ¯ $1</strong>')
          .replace(/(çˆ†æ¬¾\s*Hook[ï¼š:])/g, '<br><strong>ğŸ”¥ $1</strong>')
          .replace(/(ä¸»é«”å…§å®¹åˆ‡å…¥é»[ï¼š:])/g, '<br><strong>ğŸ’¡ $1</strong>')
          .replace(/(å»ºè­°\s*Hashtag[ï¼š:])/g, '<br><strong># $1</strong>')
          .replace(/(\d+\.)/g, '<br><strong>$1</strong>');
        
        return `
          <div class="history-item" style="margin-bottom: 16px; padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #2196F3;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <span style="font-size: 12px; color: #666;">${time}</span>
              <span style="font-size: 11px; color: #2196F3; background: #e3f2fd; padding: 2px 6px; border-radius: 4px;">é¸é¡Œå»ºè­°</span>
            </div>
            <div style="font-weight: 600; color: #333; margin-bottom: 8px;">âœ¨ ${title}</div>
            <div style="line-height: 1.6; color: #555;">${formattedContent}</div>
          </div>
        `;
      }).join('');
      
      topicsContent.innerHTML = `
        <div style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
          <strong>ğŸ“š æ­·å²ç´€éŒ„</strong>
          <button onclick="clearTopicsHistory()" style="font-size: 12px; color: #666; background: none; border: none; cursor: pointer;">æ¸…ç©º</button>
        </div>
        <div style="max-height: 400px; overflow-y: auto;">${historyItems}</div>
      `;
    } else {
      topicsContent.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">é»æ“Šã€Œç²å–éˆæ„Ÿã€é–‹å§‹ç”Ÿæˆé¸é¡Œå»ºè­°ã€‚</div>';
    }
  }
  
  // æ¸…ç©ºé¸é¡Œæ­·å²
  function clearTopicsHistory() {
    if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰é¸é¡Œæ­·å²å—ï¼Ÿ')) {
      state.topicsNotes = [];
      updateTopicsNotesDisplay();
    }
  }

  async function refreshTopicsNotes(){
    try{
      const resp = await fetch(`${API_BASE}/agent/notes?user_id=${state.userId}&agent_type=topic_selection&memory_type=note&limit=8`);
      const data = await resp.json();
      if(data && !data.error){
        state.topicsNotes = data.notes || [];
        updateTopicsNotesDisplay();
      }
    }catch(e){}
  }

  async function loadUserProfile(){
    // ä¿ç•™ä½†ä¸å†åœ¨é¸é¡Œé é¡¯ç¤ºæç¤º
    try{ await fetch(`${API_BASE}/memory/user/${state.userId}?agent_type=positioning&limit=1`); }catch(e){}
  }

  async function checkPositioningProfile(){
    try{
      await refreshPositioningProfile();
      const chat = document.getElementById('chatPositioning');
      if(state.userProfile && Object.keys(state.userProfile).length){
        appendMsg(chat, 'assistant', 'âœ… æˆ‘å·²è®€å–åˆ°ä½ çš„å®šä½æª”æ¡ˆï¼Œä¹‹å¾Œçš„å»ºè­°æœƒæ›´è²¼è¿‘ä½ çš„æ–¹å‘ã€‚', true);
      } else {
        appendMsg(chat, 'assistant', 'ğŸ’¡ ç›®å‰æ²’æœ‰å®šä½æª”æ¡ˆï¼Œå…ˆè·Ÿæˆ‘èŠèŠä½ çš„æ¥­å‹™èˆ‡å—çœ¾ï¼Œæˆ‘æœƒå¹«ä½ å»ºç«‹ã€‚', true);
      }
    }catch(e){ }
  }

  async function getTopics(){
    const textarea = document.getElementById('inputTopics');
    const text = (textarea.value || '').trim();
    
    const chat = document.getElementById('chatTopics');
    if(text){
      appendMsg(chat, 'user', text);
    }
    
    // ä¸²æµæ–¹å¼
    streamChat(chat, {
      user_id: state.userId,
      agent_type: 'topics',
      session_id: state.sessionIdTopics,
      messages: [{ role:'user', content: text || 'è«‹æä¾›ä»Šæ—¥çš„é¸é¡Œéˆæ„Ÿ' }]
    }, {
      onComplete: async (finalText)=>{ 
        updateTopicsDisplay(finalText);
        await refreshTopicsNotes(); // æ›´æ–°ç­†è¨˜
      }
    });
  }

  function updateTopicsDisplay(suggestions){
    const topicsContent = document.getElementById('topicsContent');
    if(state.topicsNotes && state.topicsNotes.length > 0){
      const notes = state.topicsNotes.map(n=>`<li>${escapeHTML(n.content||'')}</li>`).join('');
      topicsContent.innerHTML = `
        <div><strong>é¸é¡Œå»ºè­°</strong></div>
        <div style="margin:8px 0">${suggestions.replace(/\n/g, '<br>')}</div>
        <div style="margin-top:8px"><strong>é¸é¡Œç­†è¨˜ï¼š</strong></div>
        <ul style="padding-left:18px; margin:6px 0 0">${notes}</ul>
      `;
    } else {
      topicsContent.innerHTML = `<div>${suggestions.replace(/\n/g, '<br>')}</div>`;
    }
  }

  // è…³æœ¬æ–‡æ¡ˆæ™ºèƒ½é«”ï¼ˆå¢å¼·ç‰ˆï¼‰
  async function sendScriptMessage(){
    const textarea = document.getElementById('inputScript');
    const text = (textarea.value || '').trim();
    if(!text){ showToast('è«‹å…ˆè¼¸å…¥å…§å®¹'); return; }
    
    const chat = document.getElementById('chatScript');
    appendMsg(chat, 'user', text);
    textarea.value = '';
    
    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    showLoadingMsg(chat, 'AIè…³æœ¬ç”Ÿæˆå¤§å¸«æ­£åœ¨å‰µä½œä¸­...');
    
    try{
      const payload = {
        user_id: state.userId,
        user_input: text,
        mode: 'script',
        template_type: state.templateType || null,
        duration: state.duration || null
      };
      
      const r = await fetch(`${API_BASE}/agent/content/generate`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      
      const j = await r.json();
      
      // éš±è—è¼‰å…¥ç‹€æ…‹
      hideLoadingMsg(chat);
      
      if(!r.ok) throw new Error(j?.assistant_message || j?.error || `HTTP ${r.status}`);
      
      if(j.assistant_message) {
        // ä½¿ç”¨æ ¼å¼åŒ–é¡¯ç¤º AI å›æ‡‰
        appendMsg(chat, 'assistant', j.assistant_message, true);
      }
      
      // è™•ç†è…³æœ¬åˆ†æ®µ - ç¢ºä¿æ­£ç¢ºé¡¯ç¤º
      if(j.generated_content?.segments) {
        state.segments = j.generated_content.segments;
        renderSegments();
      } else if(j.segments) {
        state.segments = j.segments;
        renderSegments();
      }
      
      // æ›´æ–°è…³æœ¬ç­†è¨˜
      await refreshScriptNotes();
    }catch(e){
      // éš±è—è¼‰å…¥ç‹€æ…‹
      hideLoadingMsg(chat);
      appendMsg(chat, 'assistant', `âŒ éŒ¯èª¤ï¼š${e.message}`);
    }
  }

  // è…³æœ¬ç­†è¨˜åŠŸèƒ½
  async function refreshScriptNotes(){
    try{
      const resp = await fetch(`${API_BASE}/agent/notes?user_id=${state.userId}&agent_type=script_copy&memory_type=note&limit=8`);
      const data = await resp.json();
      if(data && !data.error){
        state.scriptNotes = data.notes || [];
        updateScriptNotesDisplay();
      }
    }catch(e){}
  }

  function updateScriptSegmentsDisplay(segments) {
    const segmentsWrap = document.getElementById('segmentsWrap');
    if (!segmentsWrap) return;
    
    // æ¸…é™¤ç¾æœ‰çš„è…³æœ¬åˆ†æ®µ
    const existingSegments = segmentsWrap.querySelectorAll('.script-segment');
    existingSegments.forEach(el => el.remove());
    
    if (!segments || segments.length === 0) {
      return;
    }
    
    segments.forEach((segment, index) => {
      const segmentDiv = document.createElement('div');
      segmentDiv.className = 'script-segment segment-card';
      
      let typeText = '';
      switch(segment.type) {
        case 'hook': typeText = 'ğŸ¯ é–‹å ´é‰¤å­'; break;
        case 'value': typeText = 'ğŸ’¡ å…§å®¹åƒ¹å€¼'; break;
        case 'cta': typeText = 'ğŸ“¢ è¡Œå‹•å‘¼ç±²'; break;
        default: typeText = 'ğŸ“ è…³æœ¬æ®µè½';
      }
      
      segmentDiv.innerHTML = `
        <div class="segment-head">
          <div class="seg-title">${typeText} (${segment.start_sec}-${segment.end_sec}ç§’)</div>
        </div>
        <div class="segment-content">
          <div class="dialog"><strong>å°è©ï¼š</strong>${segment.dialog || ''}</div>
          <div class="visual"><strong>ç•«é¢ï¼š</strong>${segment.visual || ''}</div>
          ${segment.cta ? `<div class="cta"><strong>CTAï¼š</strong>${segment.cta}</div>` : ''}
        </div>
      `;
      
      segmentsWrap.appendChild(segmentDiv);
    });
  }

  function updateScriptNotesDisplay(){
    const segmentsWrap = document.getElementById('segmentsWrap');
    if(state.scriptNotes && state.scriptNotes.length > 0){
      const notes = state.scriptNotes.map(n=>{
        // æ¸…ç†å…§å®¹ï¼Œç§»é™¤ç¨‹å¼ç¢¼å’Œé–‹å ´ç™½
        let cleanContent = n.content
          .replace(/å“ˆå›‰!.*?è…³æœ¬é¡§å•.*?å°ç£å¸‚å ´ç‰¹æ€§.*?çŸ­å½±éŸ³è…³æœ¬ã€‚/g, '')
          .replace(/```json[\s\S]*?```/g, '')
          .replace(/\{[\s\S]*?\}/g, '')
          .replace(/---.*?---/g, '')
          .replace(/\*\*.*?\*\*/g, '')
          .trim();
        
        // æ ¼å¼åŒ–æ®µè½
        cleanContent = cleanContent
          .replace(/\n/g, '<br>')
          .replace(/(\d+\.)/g, '<br><strong>$1</strong>')
          .replace(/(Hook|Value|CTA)/g, '<br><strong>$1</strong>')
          .replace(/(\d+-\d+ç§’)/g, '<br><em>$1</em>');
        
        return `<li style="margin-bottom: 12px; line-height: 1.6;">${cleanContent}</li>`;
      }).join('');
      
      const notesDiv = document.createElement('div');
      notesDiv.className = 'segment-card';
      notesDiv.innerHTML = `
        <div class="segment-head">
          <div class="seg-title">ğŸ“ è…³æœ¬ç­†è¨˜</div>
        </div>
        <ul style="padding-left:18px; margin:6px 0 0">${notes}</ul>
      `;
      segmentsWrap.insertBefore(notesDiv, segmentsWrap.firstChild);
    }
  }

  // äº‹ä»¶ç¶å®š
  document.getElementById('sendPositioning').onclick = sendPositioningMessage;
  document.getElementById('getTopics').onclick = getTopics;
  document.getElementById('cancelPositioning').onclick = cancelStream;
  document.getElementById('cancelTopics').onclick = cancelStream;
  document.getElementById('cancelScript').onclick = cancelStream;
  
  // å¿«é€Ÿå•é¡Œ chips
  document.querySelectorAll('#chipsPositioning .chip').forEach(chip => {
    chip.onclick = () => {
      const question = chip.dataset.question;
      document.getElementById('inputPositioning').value = question;
    };
  });
  
  document.querySelectorAll('#chipsTopics .chip').forEach(chip => {
    chip.onclick = () => {
      const topicType = chip.dataset.topicType;
      document.getElementById('inputTopics').value = `æˆ‘æƒ³è¦${chip.textContent}é¡å‹çš„é¸é¡Œå»ºè­°`;
    };
  });

  // è¤‡è£½åŠŸèƒ½
  document.getElementById('copyAllTopics').onclick = () => {
    const content = document.getElementById('topicsContent').textContent;
    if(content && content !== 'é»æ“Šã€Œç²å–éˆæ„Ÿã€é–‹å§‹ç”Ÿæˆé¸é¡Œå»ºè­°ã€‚'){
      copyText(content, 'é¸é¡Œå»ºè­°å·²è¤‡è£½ï¼');
    } else {
      showToast('æš«ç„¡å¯è¤‡è£½å…§å®¹');
    }
  };

  // æ¸…ç©ºå°è©±
  document.getElementById('clearPositioningChat').onclick = () => {
    document.getElementById('chatPositioning').innerHTML = '';
    state.messagesPositioning = [];
    showPositioningWelcome();
  };

  // é‡æ–°ç”Ÿæˆé¸é¡Œ
  document.getElementById('refreshTopics').onclick = getTopics;

  // æ­·å²è¨˜éŒ„
  document.getElementById('viewTopicHistory').onclick = async () => {
    try{
      const resp = await fetch(`${API_BASE}/agent/topics/history?user_id=${state.userId}&limit=5`);
      const data = await resp.json();
      if(data.suggestions && data.suggestions.length > 0){
        let history = 'ğŸ“… é¸é¡Œæ­·å²è¨˜éŒ„ï¼š\n\n';
        data.suggestions.forEach((s, i) => {
          history += `${i+1}. ${s.suggested_date}\n${JSON.parse(s.topics || '{}').suggestions || s.reasoning}\n\n`;
        });
        showToast('æ­·å²è¨˜éŒ„å·²é¡¯ç¤ºåœ¨å°è©±ä¸­');
        appendMsg(document.getElementById('chatTopics'), 'assistant', history);
      } else {
        showToast('æš«ç„¡æ­·å²è¨˜éŒ„');
      }
    }catch(e){
      showToast('è¼‰å…¥æ­·å²è¨˜éŒ„å¤±æ•—');
    }
  };

  // å„²å­˜æª”æ¡ˆ
  document.getElementById('saveProfile').onclick = async () => {
    if(!state.userProfile){
      showToast('æš«ç„¡æª”æ¡ˆå¯å„²å­˜');
      return;
    }
    
    try{
      const resp = await fetch(`${API_BASE}/agent/positioning/profile`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          user_id: state.userId,
          profile_data: state.userProfile
        })
      });
      
      const data = await resp.json();
      if(data.success){
        showToast('æª”æ¡ˆå„²å­˜æˆåŠŸï¼');
      } else {
        showToast('æª”æ¡ˆå„²å­˜å¤±æ•—');
      }
    }catch(e){
      showToast('å„²å­˜å¤±æ•—ï¼š' + e.message);
    }
  };

  // ä¸€éµç”Ÿæˆå®šä½
  document.getElementById('oneClickPositioning').onclick = async () => {
    const theme = prompt('è«‹è¼¸å…¥ä½ çš„ç”¢å“ã€æœå‹™æˆ–ä¸»é¡Œï¼š', '');
    if (!theme || !theme.trim()) {
      showToast('è«‹è¼¸å…¥ä¸»é¡Œ');
      return;
    }
    
    const chat = document.getElementById('chatPositioning');
    const input = document.getElementById('inputPositioning');
    
    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    showLoadingMsg(chat, 'AIæ­£åœ¨åˆ†æä½ çš„ä¸»é¡Œä¸¦ç”Ÿæˆå®šä½...');
    
    try {
      const payload = {
        user_id: state.userId,
        theme: theme.trim()
      };
      
      const resp = await fetch(`${API_BASE}/agent/positioning/generate`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      
      const data = await resp.json();
      
      // éš±è—è¼‰å…¥ç‹€æ…‹
      hideLoadingMsg(chat);
      
      if (!resp.ok) {
        throw new Error(data?.error || `HTTP ${resp.status}`);
      }
      
      if (data.response) {
        // é¡¯ç¤º AI å›æ‡‰
        appendMsg(chat, 'assistant', data.response, true);
        
        // æ›´æ–°å®šä½æª”æ¡ˆ
        if (data.user_profile) {
          state.userProfile = data.user_profile;
          updateProfileDisplay();
        }
        
        // åˆ·æ–°å®šä½ç­†è¨˜
        await refreshPositioningProfile();
        
        showToast('å®šä½ç”Ÿæˆå®Œæˆï¼');
      }
      
    } catch (e) {
      // éš±è—è¼‰å…¥ç‹€æ…‹
      hideLoadingMsg(chat);
      appendMsg(chat, 'assistant', `âŒ éŒ¯èª¤ï¼š${e.message}`);
      showToast('ç”Ÿæˆå¤±æ•—ï¼š' + e.message);
    }
  };

  // æ¨¡å¼åˆ‡æ›åŠŸèƒ½
  document.getElementById('guideMode').onclick = () => {
    // åˆ‡æ›åˆ°å¼•å°æ¨¡å¼
    document.getElementById('guideBar').style.display = 'block';
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    document.getElementById('guideMode').classList.add('active');
    document.getElementById('freeMode').classList.remove('active');
    document.getElementById('oneClickScript').classList.remove('active');
    // æ›´æ–°å…¨å±€ç‹€æ…‹
    state.scriptMode = 'guide';
  };

  document.getElementById('freeMode').onclick = () => {
    // åˆ‡æ›åˆ°è‡ªç”±æ¨¡å¼
    document.getElementById('guideBar').style.display = 'none';
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    document.getElementById('freeMode').classList.add('active');
    document.getElementById('guideMode').classList.remove('active');
    document.getElementById('oneClickScript').classList.remove('active');
    // æ›´æ–°å…¨å±€ç‹€æ…‹
    state.scriptMode = 'free';
  };

  // ä¸€éµç”Ÿæˆè…³æœ¬åŠŸèƒ½
  document.getElementById('oneClickScript').onclick = async () => {
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    document.getElementById('oneClickScript').classList.add('active');
    document.getElementById('guideMode').classList.remove('active');
    document.getElementById('freeMode').classList.remove('active');
    
    const theme = prompt('è«‹è¼¸å…¥æ‚¨çš„ä¸»é¡Œæˆ–è…³æœ¬å…§å®¹ï¼š', '');
    if (!theme || !theme.trim()) {
      showToast('è«‹è¼¸å…¥ä¸»é¡Œ');
      return;
    }
    
    const chat = document.getElementById('chatScript');
    
    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    showLoadingMsg(chat, 'AIæ­£åœ¨ç”Ÿæˆè…³æœ¬...');
    
    try {
      const payload = {
        user_id: state.userId,
        theme: theme.trim(),
        template_type: state.templateType,
        duration: state.duration
      };
      
      const resp = await fetch(`${API_BASE}/agent/script/generate`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      
      const data = await resp.json();
      
      // éš±è—è¼‰å…¥ç‹€æ…‹
      hideLoadingMsg(chat);
      
      if (!resp.ok) {
        throw new Error(data?.error || `HTTP ${resp.status}`);
      }
      
      if (data.assistant_message) {
        // é¡¯ç¤º AI å›æ‡‰
        appendMsg(chat, 'assistant', data.assistant_message, true);
        
        // æ›´æ–°è…³æœ¬åˆ†æ®µé¡¯ç¤ºï¼ˆå¯«å…¥ç‹€æ…‹ä¸¦æ¸²æŸ“åˆ°ã€Œè…³æœ¬åˆ†æ®µ / æ™‚é–“è»¸ã€ï¼‰
        if (data.segments && data.segments.length > 0) {
          try {
            state.segments = data.segments;
            if (typeof renderSegments === 'function') {
              renderSegments();
            } else {
              // è‹¥èˆŠç‰ˆå‡½æ•¸ä¸å­˜åœ¨ï¼Œé€€è€Œä½¿ç”¨æ–°æ¸²æŸ“æ–¹å¼
              updateScriptSegmentsDisplay(data.segments);
            }
          } catch(e) {
            updateScriptSegmentsDisplay(data.segments);
          }
        } else if (data.generated_content?.segments) {
          // è™•ç†ä¸åŒçš„å›æ‡‰æ ¼å¼
          state.segments = data.generated_content.segments;
          if (typeof renderSegments === 'function') {
            renderSegments();
          } else {
            updateScriptSegmentsDisplay(data.generated_content.segments);
          }
        }
        
        // åˆ·æ–°è…³æœ¬ç­†è¨˜
        await refreshScriptNotes();
        
        // ç¢ºä¿è…³æœ¬åˆ†æ®µå€åŸŸå¯è¦‹
        const segmentsWrap = document.getElementById('segmentsWrap');
        if (segmentsWrap) {
          segmentsWrap.scrollTop = 0;
        }
        
        showToast('è…³æœ¬ç”Ÿæˆå®Œæˆï¼');
      }
      
    } catch (e) {
      // éš±è—è¼‰å…¥ç‹€æ…‹
      hideLoadingMsg(chat);
      appendMsg(chat, 'assistant', `âŒ éŒ¯èª¤ï¼š${e.message}`);
      showToast('ç”Ÿæˆå¤±æ•—ï¼š' + e.message);
    }
  };

  // åˆå§‹åŒ–è…³æœ¬æ¨¡å¼æŒ‰éˆ•ç‹€æ…‹
  function initScriptModeButtons() {
    // è¨­ç½®åˆå§‹ç‹€æ…‹ï¼šå¼•å°æ¨¡å¼ç‚ºé¸ä¸­
    document.getElementById('guideMode').classList.add('active');
    document.getElementById('freeMode').classList.remove('active');
    document.getElementById('oneClickScript').classList.remove('active');
    state.scriptMode = 'guide';
  }

  // åˆå§‹åŒ–
  goPage('home');
  initScriptModeButtons();
  
  // ç¢ºä¿è…³æœ¬é é¢è¼¸å…¥æ¡†å¯è¦‹
  setTimeout(() => {
    const inputScript = document.getElementById('inputScript');
    const inputbar = document.querySelector('#page-script .inputbar');
    if(inputScript) {
      console.log('è…³æœ¬è¼¸å…¥æ¡†æ‰¾åˆ°:', inputScript);
      inputScript.style.display = 'block';
      inputScript.style.visibility = 'visible';
      inputScript.style.opacity = '1';
    } else {
      console.error('è…³æœ¬è¼¸å…¥æ¡†æœªæ‰¾åˆ°!');
    }
    if(inputbar) {
      inputbar.style.display = 'flex';
      inputbar.style.visibility = 'visible';
      inputbar.style.opacity = '1';
      console.log('è¼¸å…¥æ¡†å€åŸŸå·²ç¢ºä¿å¯è¦‹');
    }
  }, 100);
  </script>
</body>
</html>
